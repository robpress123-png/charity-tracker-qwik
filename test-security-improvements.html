<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Improvements Test Suite - v2.11.61</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-group {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
        }
        h2 {
            color: #667eea;
            margin-top: 0;
        }
        h3 {
            color: #555;
            margin-bottom: 10px;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .pass {
            color: #28a745;
            font-weight: bold;
        }
        .fail {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #5a67d8;
        }
        .danger-button {
            background: #dc3545;
        }
        .danger-button:hover {
            background: #c82333;
        }
        .success-button {
            background: #28a745;
        }
        .success-button:hover {
            background: #218838;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-pass {
            background: #d4edda;
            color: #155724;
        }
        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }
        .storage-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .storage-box {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .storage-box h4 {
            margin-top: 0;
            color: #495057;
        }
        .manual-test {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .manual-test h4 {
            color: #856404;
            margin-top: 0;
        }
        .manual-test ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .manual-test li {
            margin: 5px 0;
        }
    </style>
    <script src="/js/storage-helper.js"></script>
</head>
<body>
    <h1>üîí Security Improvements Test Suite - v2.11.61</h1>

    <div class="test-section">
        <h2>üìã Test Overview</h2>
        <p>This page tests the security improvements implemented in v2.11.61:</p>
        <ul>
            <li>‚úÖ Test credentials removed from production code</li>
            <li>‚úÖ sessionStorage used for sensitive authentication data</li>
            <li>‚úÖ Automatic migration from localStorage to sessionStorage</li>
            <li>‚úÖ Backward compatibility maintained</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîç 1. Test Credential Removal Tests</h2>

        <div class="test-group">
            <h3>Test 1.1: Verify test@example.com Cannot Login Without Database</h3>
            <button onclick="testCredentialRemoval()">Run Test</button>
            <div id="test-credential-result" class="test-results"></div>
        </div>

        <div class="test-group">
            <h3>Test 1.2: Check reset-test-user.js Endpoint</h3>
            <button onclick="testResetEndpoint()">Run Test</button>
            <div id="test-reset-result" class="test-results"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>üíæ 2. Storage Security Tests</h2>

        <div class="test-group">
            <h3>Test 2.1: Storage Helper Availability</h3>
            <button onclick="testStorageHelper()">Run Test</button>
            <div id="test-storage-helper-result" class="test-results"></div>
        </div>

        <div class="test-group">
            <h3>Test 2.2: Auto-Migration from localStorage</h3>
            <button onclick="testAutoMigration()">Run Test</button>
            <div id="test-migration-result" class="test-results"></div>
        </div>

        <div class="test-group">
            <h3>Test 2.3: Session Storage Priority</h3>
            <button onclick="testStoragePriority()">Run Test</button>
            <div id="test-priority-result" class="test-results"></div>
        </div>

        <div class="test-group">
            <h3>Test 2.4: Secure Storage Functions</h3>
            <button onclick="testSecureStorageFunctions()">Run Test</button>
            <div id="test-functions-result" class="test-results"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîê 3. Current Storage Status</h2>
        <button onclick="displayCurrentStorage()">Refresh Storage Display</button>

        <div class="storage-display">
            <div class="storage-box">
                <h4>üì¶ localStorage Contents:</h4>
                <pre id="localStorage-content">Click "Refresh" to view</pre>
            </div>
            <div class="storage-box">
                <h4>üîí sessionStorage Contents:</h4>
                <pre id="sessionStorage-content">Click "Refresh" to view</pre>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ 4. Manual Integration Tests</h2>

        <div class="manual-test">
            <h4>Test 4.1: Login Flow Test</h4>
            <ol>
                <li>Open <a href="/login.html" target="_blank">Login Page</a> in a new tab</li>
                <li>Open Developer Tools (F12) ‚Üí Application ‚Üí Storage</li>
                <li>Clear all localStorage and sessionStorage</li>
                <li>Login with valid credentials</li>
                <li>Verify token is in <strong>sessionStorage</strong>, not localStorage</li>
                <li>Close the tab completely</li>
                <li>Open a new tab and go to dashboard - should require login</li>
            </ol>
            <button onclick="clearAllStorage()" class="danger-button">Clear All Storage</button>
        </div>

        <div class="manual-test">
            <h4>Test 4.2: Registration Flow Test</h4>
            <ol>
                <li>Open <a href="/register.html" target="_blank">Registration Page</a> in a new tab</li>
                <li>Register a new account</li>
                <li>Check that authentication data is in sessionStorage</li>
                <li>Verify automatic redirect to dashboard</li>
                <li>Logout and verify storage is cleared</li>
            </ol>
        </div>

        <div class="manual-test">
            <h4>Test 4.3: Admin Login Security</h4>
            <ol>
                <li>Open <a href="/admin-login.html" target="_blank">Admin Login</a> in a new tab</li>
                <li>Login with admin credentials</li>
                <li>Verify adminToken is in sessionStorage only</li>
                <li>Close browser tab</li>
                <li>Reopen admin dashboard - should require re-authentication</li>
            </ol>
        </div>

        <div class="manual-test">
            <h4>Test 4.4: Backward Compatibility Test</h4>
            <ol>
                <li>Manually set a token in localStorage:</li>
            </ol>
            <button onclick="simulateOldSession()">Simulate Old Session</button>
            <div id="old-session-result" class="test-results"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>‚úÖ 5. Automated Test Results Summary</h2>
        <button onclick="runAllTests()" class="success-button">Run All Automated Tests</button>
        <div id="summary-results" class="test-results"></div>
    </div>

    <script>
        // Test 1.1: Test Credential Removal
        async function testCredentialRemoval() {
            const resultDiv = document.getElementById('test-credential-result');
            resultDiv.innerHTML = '<span class="info">Testing...</span>';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });

                const data = await response.json();

                if (response.status === 503) {
                    resultDiv.innerHTML = `
                        <span class="pass">‚úÖ PASS</span> - Test credentials properly removed!<br>
                        Server returned: "${data.error}"<br>
                        <small>This means hardcoded test credentials are no longer in the code.</small>
                    `;
                } else if (response.status === 401) {
                    resultDiv.innerHTML = `
                        <span class="pass">‚úÖ PASS</span> - Invalid credentials rejected<br>
                        <small>Test credentials not accepted (as expected).</small>
                    `;
                } else if (data.success) {
                    resultDiv.innerHTML = `
                        <span class="warning">‚ö†Ô∏è WARNING</span> - test@example.com exists in database<br>
                        <small>This is OK if the test user was previously created in the database.</small>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="fail">‚ùå FAIL</span> - Unexpected response<br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="fail">‚ùå ERROR</span> - ${error.message}<br>
                    <small>This might mean the API is not accessible locally.</small>
                `;
            }
        }

        // Test 1.2: Reset Endpoint Test
        async function testResetEndpoint() {
            const resultDiv = document.getElementById('test-reset-result');
            resultDiv.innerHTML = '<span class="info">Testing...</span>';

            try {
                const response = await fetch('/api/auth/reset-test-user', {
                    method: 'GET'
                });

                if (response.status === 404) {
                    resultDiv.innerHTML = `
                        <span class="pass">‚úÖ PASS</span> - reset-test-user.js properly removed!<br>
                        <small>Endpoint returns 404 as expected.</small>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="fail">‚ùå FAIL</span> - Endpoint still exists<br>
                        Status: ${response.status}<br>
                        <small>The reset-test-user.js file may not have been deleted.</small>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="pass">‚úÖ PASS</span> - Endpoint not found<br>
                    <small>The file has been properly removed.</small>
                `;
            }
        }

        // Test 2.1: Storage Helper Availability
        function testStorageHelper() {
            const resultDiv = document.getElementById('test-storage-helper-result');
            const tests = [];

            // Check if secureStorage is defined
            tests.push({
                name: 'secureStorage object exists',
                pass: typeof secureStorage !== 'undefined'
            });

            // Check for required functions
            if (typeof secureStorage !== 'undefined') {
                tests.push({
                    name: 'secureStorage.setAuth function',
                    pass: typeof secureStorage.setAuth === 'function'
                });
                tests.push({
                    name: 'secureStorage.getAuth function',
                    pass: typeof secureStorage.getAuth === 'function'
                });
                tests.push({
                    name: 'secureStorage.clearAuth function',
                    pass: typeof secureStorage.clearAuth === 'function'
                });
                tests.push({
                    name: 'secureStorage.isAuthenticated function',
                    pass: typeof secureStorage.isAuthenticated === 'function'
                });
            }

            const allPass = tests.every(t => t.pass);
            let html = allPass ?
                '<span class="pass">‚úÖ All storage helper functions available</span><br>' :
                '<span class="fail">‚ùå Some functions missing</span><br>';

            html += '<ul>';
            tests.forEach(test => {
                html += `<li>${test.pass ? '‚úÖ' : '‚ùå'} ${test.name}</li>`;
            });
            html += '</ul>';

            resultDiv.innerHTML = html;
        }

        // Test 2.2: Auto-Migration
        function testAutoMigration() {
            const resultDiv = document.getElementById('test-migration-result');

            // Clear both storages first
            sessionStorage.clear();
            localStorage.clear();

            // Simulate old session in localStorage
            const testToken = 'test-token-' + Date.now();
            const testUser = { id: 1, email: 'migration@test.com', name: 'Test User' };

            localStorage.setItem('token', testToken);
            localStorage.setItem('user', JSON.stringify(testUser));

            resultDiv.innerHTML = '<span class="info">Set test data in localStorage...</span><br>';

            // Trigger migration by reloading storage helper
            const script = document.createElement('script');
            script.src = '/js/storage-helper.js?' + Date.now();
            script.onload = function() {
                // Check if migration occurred
                const sessionToken = sessionStorage.getItem('token');
                const localToken = localStorage.getItem('token');

                if (sessionToken === testToken && !localToken) {
                    resultDiv.innerHTML = `
                        <span class="pass">‚úÖ PASS</span> - Auto-migration successful!<br>
                        Token migrated from localStorage to sessionStorage<br>
                        <small>Original token: ${testToken.substring(0, 20)}...</small>
                    `;
                } else if (sessionToken === testToken && localToken) {
                    resultDiv.innerHTML = `
                        <span class="warning">‚ö†Ô∏è PARTIAL</span> - Migration occurred but localStorage not cleared<br>
                        <small>This might be intentional for backward compatibility.</small>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="fail">‚ùå FAIL</span> - Migration did not occur<br>
                        sessionStorage token: ${sessionToken}<br>
                        localStorage token: ${localToken}
                    `;
                }

                // Clean up
                sessionStorage.clear();
                localStorage.clear();
            };
            document.head.appendChild(script);
        }

        // Test 2.3: Storage Priority
        function testStoragePriority() {
            const resultDiv = document.getElementById('test-priority-result');

            if (typeof secureStorage === 'undefined') {
                resultDiv.innerHTML = '<span class="fail">‚ùå secureStorage not loaded</span>';
                return;
            }

            // Clear both storages
            sessionStorage.clear();
            localStorage.clear();

            // Set different values in each storage
            const sessionToken = 'session-token-123';
            const localToken = 'local-token-456';
            const sessionUser = { id: 1, source: 'session' };
            const localUser = { id: 2, source: 'local' };

            sessionStorage.setItem('token', sessionToken);
            sessionStorage.setItem('user', JSON.stringify(sessionUser));
            localStorage.setItem('token', localToken);
            localStorage.setItem('user', JSON.stringify(localUser));

            // Test which one is retrieved
            const auth = secureStorage.getAuth();

            if (auth && auth.token === sessionToken && auth.user.source === 'session') {
                resultDiv.innerHTML = `
                    <span class="pass">‚úÖ PASS</span> - sessionStorage has priority<br>
                    Retrieved token from sessionStorage, ignoring localStorage<br>
                    <small>This is the correct behavior for security.</small>
                `;
            } else if (auth && auth.token === localToken) {
                resultDiv.innerHTML = `
                    <span class="warning">‚ö†Ô∏è WARNING</span> - localStorage was used<br>
                    This might indicate the storage helper needs updating.
                `;
            } else {
                resultDiv.innerHTML = `
                    <span class="fail">‚ùå FAIL</span> - Could not retrieve auth data<br>
                    <pre>${JSON.stringify(auth, null, 2)}</pre>
                `;
            }

            // Clean up
            sessionStorage.clear();
            localStorage.clear();
        }

        // Test 2.4: Secure Storage Functions
        function testSecureStorageFunctions() {
            const resultDiv = document.getElementById('test-functions-result');

            if (typeof secureStorage === 'undefined') {
                resultDiv.innerHTML = '<span class="fail">‚ùå secureStorage not loaded</span>';
                return;
            }

            let results = [];

            // Clear storage
            secureStorage.clearAuth();

            // Test 1: Set auth
            const testToken = 'func-test-token-' + Date.now();
            const testUser = { id: 99, email: 'func@test.com' };

            secureStorage.setAuth(testToken, testUser);
            results.push({
                test: 'setAuth',
                pass: sessionStorage.getItem('token') === testToken
            });

            // Test 2: Get auth
            const retrieved = secureStorage.getAuth();
            results.push({
                test: 'getAuth',
                pass: retrieved && retrieved.token === testToken && retrieved.user.email === 'func@test.com'
            });

            // Test 3: Is authenticated
            results.push({
                test: 'isAuthenticated (with data)',
                pass: secureStorage.isAuthenticated() === true
            });

            // Test 4: Clear auth
            secureStorage.clearAuth();
            results.push({
                test: 'clearAuth',
                pass: sessionStorage.getItem('token') === null && sessionStorage.getItem('user') === null
            });

            // Test 5: Is authenticated after clear
            results.push({
                test: 'isAuthenticated (after clear)',
                pass: secureStorage.isAuthenticated() === false
            });

            const allPass = results.every(r => r.pass);
            let html = allPass ?
                '<span class="pass">‚úÖ All functions work correctly</span><br>' :
                '<span class="fail">‚ùå Some functions failed</span><br>';

            html += '<ul>';
            results.forEach(r => {
                html += `<li>${r.pass ? '‚úÖ' : '‚ùå'} ${r.test}</li>`;
            });
            html += '</ul>';

            resultDiv.innerHTML = html;
        }

        // Display current storage contents
        function displayCurrentStorage() {
            const localContent = {};
            const sessionContent = {};

            // Get localStorage contents
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                try {
                    localContent[key] = JSON.parse(value);
                } catch {
                    localContent[key] = value;
                }
            }

            // Get sessionStorage contents
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                try {
                    sessionContent[key] = JSON.parse(value);
                } catch {
                    sessionContent[key] = value;
                }
            }

            document.getElementById('localStorage-content').textContent =
                Object.keys(localContent).length > 0 ?
                JSON.stringify(localContent, null, 2) :
                'Empty';

            document.getElementById('sessionStorage-content').textContent =
                Object.keys(sessionContent).length > 0 ?
                JSON.stringify(sessionContent, null, 2) :
                'Empty';
        }

        // Clear all storage
        function clearAllStorage() {
            localStorage.clear();
            sessionStorage.clear();
            alert('All storage cleared! Refresh the storage display to confirm.');
            displayCurrentStorage();
        }

        // Simulate old session
        function simulateOldSession() {
            const resultDiv = document.getElementById('old-session-result');

            // Set token in localStorage (simulating old version)
            const oldToken = 'old-version-token-' + Date.now();
            const oldUser = { id: 5, email: 'old@version.com', name: 'Old User' };

            localStorage.setItem('token', oldToken);
            localStorage.setItem('user', JSON.stringify(oldUser));

            resultDiv.innerHTML = `
                <span class="info">‚ÑπÔ∏è Old session simulated in localStorage</span><br>
                Token: ${oldToken.substring(0, 30)}...<br>
                User: ${oldUser.email}<br><br>
                <strong>Next steps:</strong><br>
                1. Go to <a href="/dashboard.html" target="_blank">Dashboard</a><br>
                2. Check if you're logged in (backward compatibility)<br>
                3. Check Developer Tools to see if data migrated to sessionStorage
            `;

            displayCurrentStorage();
        }

        // Run all tests
        async function runAllTests() {
            const resultDiv = document.getElementById('summary-results');
            resultDiv.innerHTML = '<span class="info">Running all tests...</span>';

            let results = [];

            // Run each test and collect results
            await testCredentialRemoval();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testResetEndpoint();
            await new Promise(resolve => setTimeout(resolve, 500));

            testStorageHelper();
            testStoragePriority();
            testSecureStorageFunctions();

            // Count results
            const passCount = document.querySelectorAll('.pass').length;
            const failCount = document.querySelectorAll('.fail').length;
            const warningCount = document.querySelectorAll('.warning').length;

            resultDiv.innerHTML = `
                <h3>Test Results Summary:</h3>
                <div style="font-size: 18px;">
                    <span class="pass">‚úÖ Passed: ${passCount}</span><br>
                    <span class="warning">‚ö†Ô∏è Warnings: ${warningCount}</span><br>
                    <span class="fail">‚ùå Failed: ${failCount}</span><br><br>
                    ${failCount === 0 ?
                        '<strong class="pass">üéâ All critical tests passed!</strong>' :
                        '<strong class="fail">‚ö†Ô∏è Some tests failed - review results above</strong>'}
                </div>
            `;

            displayCurrentStorage();
        }

        // Auto-display storage on load
        window.addEventListener('load', () => {
            displayCurrentStorage();
        });
    </script>
</body>
</html>