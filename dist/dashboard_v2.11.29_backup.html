<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>Dashboard - Charity Tracker v2.11.49</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            background: #f3f4f6;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Responsive scaling for different resolutions */
        @media (max-width: 1440px) {
            body { font-size: 14px; }
            .stat-card { padding: 1rem !important; }
            .section { margin-bottom: 0.75rem !important; }
        }

        @media (min-width: 2560px) {
            body { font-size: 16px; }
            .dashboard-content { max-width: 2400px !important; }
        }

        /* Ultrawide monitor support (21:9 aspect ratio) */
        @media (min-aspect-ratio: 21/9) {
            .dashboard-content {
                max-width: calc(100vw - 4rem) !important;
                padding: 1rem 2rem !important;
            }
        }

        /* Header styles updated for contained layout */

        .version {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation menu */
        .nav-menu {
            background: rgba(0,0,0,0.1);
            padding: 0 1rem;
        }

        .nav-menu-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
        }

        .nav-item {
            color: white;
            padding: 0.6rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background 0.2s;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: white;
        }

        .main-content {
            flex: 1;
            overflow: visible;
            padding: 0.5rem;
            padding-bottom: 2rem; /* Small buffer for ultrawide */
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .section h2 {
            color: #333;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .btn-action {
            background: #667eea;
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            margin: 0 0.125rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            min-width: 40px;
            height: 36px;
        }

        .btn-action:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.6);
        }

        .btn-action:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Date input specific styling */
        input[type="date"] {
            max-width: 200px;
        }

        /* Year selector dropdown styling */
        #globalYearFilter {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        #globalYearFilter option {
            background: #374151; /* Dark gray background */
            color: white; /* White text */
            padding: 0.5rem;
        }

        #globalYearFilter option:hover {
            background: #4b5563; /* Lighter gray on hover */
        }

        /* Fix for report year dropdown too */
        #reportYear option {
            background: #374151;
            color: white;
        }

        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 100;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #f3f4f6;
        }

        .autocomplete-item-name {
            font-weight: 500;
            color: #111827;
        }

        .autocomplete-item-ein {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .autocomplete-item-category {
            display: inline-block;
            font-size: 0.75rem;
            color: #667eea;
            margin-left: 0.5rem;
        }

        .autocomplete-add-new {
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            cursor: pointer;
            font-weight: 500;
            color: #667eea;
        }

        .autocomplete-add-new:hover {
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        .autocomplete-loading {
            padding: 0.75rem;
            text-align: center;
            color: #6b7280;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .charity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .charity-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s;
        }

        .charity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .charity-card h3 {
            color: #111827;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
        }

        .charity-ein {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0.25rem 0;
        }

        .charity-category {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 0.5rem 0;
        }

        /* Responsive improvements */
        @media (min-width: 1400px) {
            .container {
                max-width: 1800px;
            }
            .header-content,
            .nav-menu-content {
                max-width: 1800px;
            }
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .stat-card {
                padding: 0.75rem;
            }
            .stat-value {
                font-size: 1.25rem;
            }
        }

        .charity-description {
            color: #4b5563;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .charity-count {
            text-align: center;
            color: #6b7280;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        /* Enhanced charity card styles */
        .charity-card.enhanced {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .charity-card.enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .charity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .charity-name {
            margin: 0 !important;
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: #1e293b !important;
            line-height: 1.3 !important;
            flex: 1;
            margin-right: 1rem !important;
        }

        .charity-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid currentColor;
            white-space: nowrap;
        }

        .charity-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
        }

        .charity-card.enhanced .charity-ein,
        .charity-card.enhanced .charity-category {
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }

        .charity-card.enhanced .charity-ein strong,
        .charity-card.enhanced .charity-category strong {
            color: #475569;
        }

        .charity-card.enhanced .charity-description {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0.75rem 0;
        }

        /* Enhanced Tools Section Styles */
        .tool-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tool-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .tool-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
            font-size: 2rem;
            color: white;
            margin-bottom: 0;
        }

        .tool-content {
            padding: 1.5rem;
        }

        .tool-title {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 0.75rem 0;
            line-height: 1.3;
        }

        .tool-description {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.6;
            margin: 0 0 1rem 0;
        }

        .tool-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feature-tag {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #475569;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
        }

        .tools-grid {
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }

            .tool-content {
                padding: 1rem;
            }

            .tool-icon {
                height: 60px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Container -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%;">
        <div style="max-width: 1600px; margin: 0 auto; padding: 0 1rem;">
            <!-- Version Announcement Banner -->
            <div style="color: white; padding: 0.75rem; font-size: 0.875rem; border-bottom: 2px solid rgba(255,255,255,0.3); text-align: center;">
                <strong>🎯 Charity Tracker v2.11.49</strong> - Proper relational items tracking with donation_items table!
            </div>
            <!-- Main Header -->
            <div style="color: white;">
                <div style="padding: 0.3rem 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; margin: 0;">🎯 Charity Tracker <span class="version">v2.11.49</span></h1>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span id="userName">Loading...</span>
                            <button class="logout-btn" onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500;">Logout</button>
                        </div>
                    </div>
                </div>
                <!-- Navigation Menu -->
                <nav style="background: rgba(0,0,0,0.1); padding: 0 1rem;">
                    <div style="display: flex; align-items: center;">
                        <button class="nav-item active" onclick="showSection('dashboard')">
                            📊 Dashboard
                        </button>
                        <button class="nav-item" onclick="showSection('donations')">
                            ➕ Add Donation
                        </button>
                        <button class="nav-item" onclick="showSection('reports')">
                            📈 Reports
                        </button>
                        <button class="nav-item" onclick="showSection('profile')">
                            👤 Profile
                        </button>
                        <button class="nav-item" onclick="showSection('tools')">
                            🔧 Tools
                        </button>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                            <label style="color: white; font-size: 0.9rem; font-weight: 500;">Tax Year:</label>
                            <select id="globalYearFilter" onchange="updateYearFilter()">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </div>

    <main class="main-content">
    <div class="container" style="width: 100%; max-width: 1600px; margin: 0 auto; padding: 1rem;">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content dashboard-content" style="display: flex; flex-direction: column; min-height: 100%; overflow: visible; gap: 0.5rem;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div>
                        <div class="stat-label" id="totalDonationsLabel">Total Donations</div>
                        <div class="stat-value" id="totalDonations">$0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Charities Supported</div>
                        <div class="stat-value" id="charityCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label" id="taxSavingsLabel">Est. Tax Savings</div>
                        <div class="stat-value" id="taxSavings">$0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Donation Count</div>
                        <div class="stat-value" id="donationCount">0</div>
                    </div>
                </div>
            </div>

            <div class="section" style="flex: 1; display: flex; flex-direction: column; min-height: 0; max-height: calc(45vh - 60px); width: 100%;">
                <div class="section-header" style="flex-shrink: 0;">
                    <h2 id="donationHistoryTitle">Donation History</h2>
                </div>
                <!-- Search/Filter Bar -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                    <input type="text" id="donationSearch" placeholder="Search by charity or notes..."
                           style="flex: 1; padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;"
                           oninput="filterDonations()">
                    <select id="donationTypeFilter" onchange="filterDonations()"
                            style="padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;">
                        <option value="all">All Types</option>
                        <option value="cash">Cash</option>
                        <option value="items">Items</option>
                        <option value="miles">Mileage</option>
                        <option value="stock">Stock</option>
                        <option value="crypto">Crypto</option>
                    </select>
                    <input type="month" id="donationMonthFilter" onchange="filterDonations()"
                           style="padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;">
                </div>
                <div id="donationsContent" style="overflow-y: auto; flex: 1; min-height: 0;">
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <p>No donations yet. Add your first donation to get started!</p>
                    </div>
                </div>
            </div>

            <!-- Row with My Charities and Quick Insights as separate boxes -->
            <div style="display: flex; gap: 1.5rem; height: calc(45vh - 60px); overflow: hidden;">
                <!-- My Charities Box (60% width) -->
                <div class="section" style="flex: 1 1 500px; min-width: 0; display: flex; flex-direction: column; height: 100%;">
                    <div class="section-header" style="flex-shrink: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h2 style="color: white; font-weight: 600;">My Charities</h2>
                    </div>
                    <div style="display: flex; flex-direction: column; flex: 1; min-height: 0; padding: 1rem; overflow: hidden;">
                        <!-- Fixed header -->
                        <div style="display: flex; align-items: center; padding: 0.75rem 0.5rem; border-bottom: 2px solid #667eea; background: #f9fafb; font-weight: 700; font-size: 0.875rem; color: #374151;">
                            <div style="flex: 1; padding-right: 1rem;">Charity Name</div>
                            <div style="width: 100px; text-align: center;">2024</div>
                            <div style="width: 100px; text-align: center;">2025</div>
                            <div style="width: 60px; text-align: center;">Actions</div>
                        </div>
                        <!-- Scrollable content -->
                        <div id="charitiesContent" style="flex: 1; overflow-y: auto;">
                            <div class="empty-state">
                                <div class="empty-state-icon">🏛️</div>
                                <p>Loading your charities...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Insights Box (40% width) -->
                <div class="section" style="flex: 1 1 300px; min-width: 0; display: flex; flex-direction: column; height: 100%;">
                    <div class="section-header" style="flex-shrink: 0; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <h2 style="color: white; font-weight: 600;">Quick Insights</h2>
                    </div>
                    <div style="padding: 1rem; flex: 1; overflow-y: auto;">
                        <div id="insightsContent">
                            <p style="color: #6b7280; font-size: 0.875rem;">Loading insights...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Donation Section (hidden by default) -->
        <div id="addDonationSection" class="section-content" style="display:none;">
            <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; max-height: calc(90vh - 200px); overflow-y: auto;">
                <!-- Left: Donation Type Selection -->
                <div class="section">
                    <div class="section-header">
                        <h2>➕ Add New Donation</h2>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p style="margin-bottom: 1.5rem;">Select the type of donation:</p>
                        <div style="display: grid; gap: 1rem;">
                            <button class="btn-primary" onclick="openDonationModal('cash')">
                                💵 Cash Donation
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('items')">
                                📦 Donated Items
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('miles')">
                                🚗 Mileage
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('stock')">
                                📈 Stock/Securities
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('crypto')">
                                ₿ Cryptocurrency
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right: My Charities Quick Select -->
                <div class="section">
                    <div class="section-header">
                        <h2>⚡ Quick Add from My Charities</h2>
                    </div>
                    <div id="myCharitiesQuickAdd" style="padding: 1rem; max-height: 400px; overflow-y: auto;">
                        <p style="text-align: center; color: #6b7280;">Loading your charities...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section (hidden by default) -->
        <div id="reportsSection" class="section-content" style="display:none;">
            <div class="section" style="max-height: calc(90vh - 200px); overflow-y: auto;">
            <div class="section-header">
                <h2>📈 Tax Reports & Export</h2>
            </div>
            <div style="display: grid; gap: 1rem;">
                <div class="form-group">
                    <label>Report Tax Year</label>
                    <select id="reportYear" style="width: 200px;">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="exportCSV()">
                        📄 Download CSV
                    </button>
                    <button class="btn-primary" onclick="exportPDF()">
                        📑 Download PDF Report
                    </button>
                    <button class="btn-primary" onclick="viewSummary()">
                        👁️ View Summary
                    </button>
                </div>
                <div id="reportSummary" style="margin-top: 2rem;"></div>
                </div>
            </div>
        </div>

        <!-- Profile Section (hidden by default) -->
        <div id="profileSection" class="section-content" style="display:none;">
            <div class="section" style="max-height: calc(90vh - 200px); overflow-y: auto;">
                <div class="section-header">
                    <h2>👤 Profile Settings</h2>
                </div>
                <div style="padding: 1rem;">
                    <!-- Personal Information Section -->
                    <h3 style="color: #667eea; margin-bottom: 1rem; font-size: 1.1rem;">📝 Personal Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="profileName" placeholder="Enter your full name" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="profileEmail" placeholder="your@email.com" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Street Address</label>
                            <input type="text" id="profileAddress" placeholder="123 Main Street" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="profileCity" placeholder="Your City" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <select id="profileState" style="width: 100%;">
                                <option value="">Select State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ZIP Code</label>
                            <input type="text" id="profileZip" placeholder="12345" maxlength="10" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Tax Information Section -->
                    <h3 style="color: #667eea; margin-bottom: 1rem; margin-top: 2rem; font-size: 1.1rem;">💰 Tax Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Tax Year</label>
                            <select id="taxYear" style="width: 100%;" onchange="loadTaxBrackets()">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026 (with OBBBA rules)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filing Status</label>
                            <select id="filingStatus" style="width: 100%;" onchange="loadTaxBrackets()">
                                <option value="single">Single</option>
                                <option value="married_jointly">Married Filing Jointly</option>
                                <option value="married_separately">Married Filing Separately</option>
                                <option value="head_of_household">Head of Household</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div class="form-group">
                            <label>Tax Bracket <small>(Privacy: Select bracket, not income)</small></label>
                            <select id="taxBracket" style="width: 100%;" onchange="updateTaxDisplay()">
                                <option value="">Loading brackets...</option>
                            </select>
                        </div>
                        <div class="form-group" id="agiEstimateGroup" style="display: none;">
                            <label>AGI Estimate (for 2026 OBBBA) <small>Optional</small></label>
                            <input type="number" id="agiEstimate" placeholder="Estimated AGI (optional)" style="width: 100%;">
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h3 style="margin-bottom: 1rem;">Your Tax Information</h3>

                        <!-- All Years Grid Display -->
                        <div id="allYearsTaxInfo" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <!-- 2024 Column -->
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 0.75rem; border-radius: 6px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 0.25rem;">2024</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Filing Status</div>
                                <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;" id="status2024">Not Set</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Tax Bracket</div>
                                <div style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;" id="rate2024">-</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Standard Deduction</div>
                                <div style="font-size: 0.875rem;" id="deduction2024">-</div>
                            </div>

                            <!-- 2025 Column -->
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 0.75rem; border-radius: 6px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 0.25rem;">2025</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Filing Status</div>
                                <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;" id="status2025">Not Set</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Tax Bracket</div>
                                <div style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;" id="rate2025">-</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Standard Deduction</div>
                                <div style="font-size: 0.875rem;" id="deduction2025">-</div>
                            </div>

                            <!-- 2026 Column -->
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 0.75rem; border-radius: 6px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 0.25rem;">2026 (OBBBA)</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Filing Status</div>
                                <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;" id="status2026">Not Set</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Tax Bracket</div>
                                <div style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;" id="rate2026">-</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">AGI Estimate</div>
                                <div style="font-size: 0.875rem; margin-bottom: 0.5rem;" id="agi2026">-</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">OBBBA Threshold (0.5%)</div>
                                <div style="font-size: 0.875rem; font-weight: 500; color: #fbbf24; margin-bottom: 0.5rem;" id="threshold2026" title="First 0.5% of AGI must be donated before tax benefits apply">-</div>
                                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Standard Deduction</div>
                                <div style="font-size: 0.875rem;" id="deduction2026">-</div>
                            </div>
                        </div>

                        <!-- Current Selection Helper Text -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3); text-align: center; font-size: 0.875rem; opacity: 0.9;">
                            Currently editing: <strong id="currentEditYear">2024</strong> tax settings
                        </div>
                    </div>
                    <!-- Update Profile Button - moved up and centered -->
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <button id="saveProfileBtn" class="btn-primary" onclick="saveProfile()" style="padding: 0.75rem 2rem;">
                            💾 Update Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Section (hidden by default) -->
        <div id="toolsSection" class="section-content" style="display:none;">
            <div class="section" style="max-height: calc(90vh - 200px); overflow-y: auto;">
                <div class="section-header">
                    <h2>🛠️ Tools & Utilities</h2>
                </div>
                <div style="padding: 2rem;">
                    <!-- Tools Introduction -->
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #cbd5e1;">
                        <h3 style="color: #334155; margin: 0 0 0.5rem 0; font-size: 1.1rem;">Powerful Tools to Manage Your Charitable Giving</h3>
                        <p style="color: #64748b; margin: 0; font-size: 0.875rem; line-height: 1.5;">Streamline your donation tracking with our comprehensive suite of tools designed to make charitable giving easier and more organized.</p>
                    </div>

                    <!-- Tools Grid -->
                    <div class="tools-grid" style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">

                        <!-- Import Donations Tool -->
                        <div class="tool-card" onclick="showImportDonations()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                📥
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Import Donations</h4>
                                <p class="tool-description">Upload CSV files to bulk import your donation records. Automatically matches charity names to our database.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">CSV Upload</span>
                                    <span class="feature-tag">Auto-matching</span>
                                    <span class="feature-tag">Bulk Import</span>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Charity Management Tool -->
                        <div class="tool-card" onclick="showPersonalCharities()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                🏛️
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Personal Charities</h4>
                                <p class="tool-description">Manage your personal charity list. Add, edit, and track charities not in our database.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Add Custom</span>
                                    <span class="feature-tag">Edit Details</span>
                                    <span class="feature-tag">Track Status</span>
                                </div>
                            </div>
                        </div>

                        <!-- Verify Charity Tool -->
                        <div class="tool-card" onclick="showCharityVerification()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                🔍
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Verify Charity</h4>
                                <p class="tool-description">Check if a charity is IRS-approved and eligible for tax-deductible donations.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">IRS Database</span>
                                    <span class="feature-tag">EIN Lookup</span>
                                    <span class="feature-tag">Instant Verify</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tax Calculator Tool -->
                        <div class="tool-card" onclick="calculateTaxSavings()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                💰
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Tax Savings Calculator</h4>
                                <p class="tool-description">Calculate potential tax deductions and savings from your charitable donations based on your tax bracket.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Tax Deductions</span>
                                    <span class="feature-tag">Savings Analysis</span>
                                    <span class="feature-tag">Bracket Aware</span>
                                </div>
                            </div>
                        </div>

                        <!-- Receipt Manager Tool -->
                        <div class="tool-card" onclick="manageReceipts()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                📸
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Receipt Manager</h4>
                                <p class="tool-description">Upload, organize, and manage receipt photos for your donations. Keep digital records for tax purposes.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Photo Upload</span>
                                    <span class="feature-tag">Organization</span>
                                    <span class="feature-tag">Tax Records</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Export Tool -->
                        <div class="tool-card" onclick="backupData()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                💾
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Data Export & Backup</h4>
                                <p class="tool-description">Export all your donation data for backup or use in external applications. Multiple formats supported.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Full Export</span>
                                    <span class="feature-tag">Backup Ready</span>
                                    <span class="feature-tag">Multiple Formats</span>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Personal Charities Panel -->
                    <div id="personalCharitiesPanel" style="display:none; margin-top: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">🏛️ Manage Personal Charities</h3>
                        <div style="margin-bottom: 1.5rem;">
                            <button class="btn-primary" onclick="showAddPersonalCharity()">+ Add Personal Charity</button>
                        </div>
                        <div id="personalCharitiesList"></div>
                    </div>

                    <!-- Charity Verification Panel -->
                    <div id="charityVerificationPanel" style="display:none; margin-top: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">🔍 Verify Charity Status</h3>
                        <div class="form-group">
                            <label>Enter Charity Name or EIN</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="verifyCharityInput" placeholder="e.g., Red Cross or 53-0196605" style="flex: 1;">
                                <button class="btn-primary" onclick="performCharityVerification()">Verify</button>
                            </div>
                        </div>
                        <div id="verificationResults" style="margin-top: 1.5rem;"></div>
                    </div>

                    <!-- Import Donations Panel - Full Screen Experience -->
                    <div id="importDonationsPanel" style="display:none; margin-top: 1rem; position: fixed; top: 100px; left: 0; right: 0; bottom: 0; background: white; z-index: 100; overflow: auto;">
                        <div style="max-width: 1400px; margin: 0 auto; padding: 2rem; height: 100%; display: flex; flex-direction: column;">
                            <!-- Header with close button -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: #1e293b; margin: 0;">📥 Import Donations from CSV</h2>
                                <button class="btn-secondary" onclick="closeImportPanel()" style="padding: 0.5rem 1rem;">✕ Close</button>
                            </div>

                            <!-- Main content area - horizontal layout to minimize scrolling -->
                            <div style="flex: 1; display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; min-height: 0;">

                                <!-- Left Column: Upload & Instructions -->
                                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                                    <!-- Drop Zone -->
                                    <div id="csvDropZone" style="border: 2px dashed #667eea; border-radius: 12px; padding: 2rem; text-align: center; background: #f9fafb; cursor: pointer;">
                                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">📁</div>
                                        <p style="font-size: 1rem; color: #4b5563; margin-bottom: 0.25rem;">Drag & Drop CSV File</p>
                                        <p style="color: #9ca3af; font-size: 0.875rem;">or click to browse</p>
                                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                                    </div>

                                    <!-- Format Guide -->
                                    <div style="background: #f0f9ff; border-radius: 8px; padding: 1rem; border: 1px solid #bfdbfe;">
                                        <h4 style="color: #1e40af; margin: 0 0 0.5rem 0; font-size: 0.95rem;">CSV Format Guide</h4>
                                        <div style="font-size: 0.8rem; color: #1e40af;">
                                            <p style="margin: 0.25rem 0;"><strong>Required columns:</strong></p>
                                            <code style="background: white; padding: 0.25rem; border-radius: 4px; display: block; margin: 0.25rem 0;">charity_name, donation_date, amount, donation_type</code>

                                            <p style="margin: 0.5rem 0 0.25rem 0;"><strong>Optional columns:</strong></p>
                                            <code style="background: white; padding: 0.25rem; border-radius: 4px; display: block; margin: 0.25rem 0; font-size: 0.75rem;">notes, receipt_url, miles_driven, stock_symbol, crypto_symbol, items</code>

                                            <p style="margin: 0.5rem 0 0.25rem 0;"><strong>Donation types:</strong></p>
                                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem;">
                                                <span style="background: #dbeafe; padding: 0.125rem 0.5rem; border-radius: 4px;">cash</span>
                                                <span style="background: #dbeafe; padding: 0.125rem 0.5rem; border-radius: 4px;">stock</span>
                                                <span style="background: #dbeafe; padding: 0.125rem 0.5rem; border-radius: 4px;">crypto</span>
                                                <span style="background: #dbeafe; padding: 0.125rem 0.5rem; border-radius: 4px;">miles</span>
                                                <span style="background: #dbeafe; padding: 0.125rem 0.5rem; border-radius: 4px;">items</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Features -->
                                    <div style="background: #f0fdf4; border-radius: 8px; padding: 1rem; border: 1px solid #bbf7d0;">
                                        <h4 style="color: #166534; margin: 0 0 0.5rem 0; font-size: 0.95rem;">✨ Smart Features</h4>
                                        <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.8rem; color: #166534;">
                                            <li>Automatic charity name matching</li>
                                            <li>Fuzzy search for similar names</li>
                                            <li>Confirmation before import</li>
                                            <li>Support for all donation types</li>
                                            <li>Bulk import capability</li>
                                        </ul>
                                    </div>

                                    <!-- Import Stats (shown after file selection) -->
                                    <div id="importStats" style="display: none; background: #fef3c7; border-radius: 8px; padding: 1rem; border: 1px solid #fde047;">
                                        <h4 style="color: #713f12; margin: 0 0 0.5rem 0; font-size: 0.95rem;">📊 Import Summary</h4>
                                        <div id="importStatsContent" style="font-size: 0.8rem; color: #713f12;"></div>
                                    </div>
                                </div>

                                <!-- Right Column: Preview & Results -->
                                <div style="display: flex; flex-direction: column; min-height: 0;">
                                    <!-- Status Bar -->
                                    <div id="importStatusBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <span id="importStatusIcon">⏳</span>
                                            <span id="importStatusText">Ready to import...</span>
                                        </div>
                                    </div>

                                    <!-- Main Preview Area -->
                                    <div id="importPreview" style="flex: 1; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; overflow: hidden; display: flex; flex-direction: column;">
                                        <!-- Default State -->
                                        <div id="importEmptyState" style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
                                            <div>
                                                <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">📋</div>
                                                <h3 style="color: #9ca3af; margin: 0;">No file selected</h3>
                                                <p style="color: #9ca3af; margin-top: 0.5rem;">Upload a CSV file to preview donations</p>
                                            </div>
                                        </div>

                                        <!-- Preview Table (hidden by default) -->
                                        <div id="previewContent" style="display: none; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                            <div style="padding: 1rem; background: white; border-bottom: 1px solid #e5e7eb;">
                                                <h3 style="margin: 0; color: #1e293b;">Preview Donations</h3>
                                            </div>
                                            <div id="previewTable" style="flex: 1; overflow: auto; padding: 1rem;"></div>
                                        </div>

                                        <!-- Charity Matching (hidden by default) -->
                                        <div id="charityMatchingContent" style="display: none; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                            <div style="padding: 1rem; background: white; border-bottom: 1px solid #e5e7eb;">
                                                <h3 style="margin: 0; color: #1e293b;">🔍 Confirm Charity Matches</h3>
                                                <p style="margin: 0.25rem 0 0 0; color: #64748b; font-size: 0.875rem;">Review and confirm charity selections before importing</p>
                                            </div>
                                            <div id="charityMatchTable" style="flex: 1; overflow: auto; padding: 1rem;"></div>
                                        </div>

                                        <!-- Import Results (hidden by default) -->
                                        <div id="importResultsContent" style="display: none; flex: 1; overflow: auto; padding: 1rem;">
                                            <div id="importResultsDetails"></div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div id="importActions" style="margin-top: 1rem; display: none; gap: 1rem;">
                                        <button id="validateBtn" class="btn-primary" onclick="validateImport()" style="display: none;">
                                            🔍 Validate & Match Charities
                                        </button>
                                        <button id="confirmBtn" class="btn-primary" onclick="confirmImport()" style="display: none;">
                                            ✅ Confirm Import
                                        </button>
                                        <button id="cancelBtn" class="btn-secondary" onclick="cancelImport()">
                                            Cancel
                                        </button>
                                        <button id="doneBtn" class="btn-primary" onclick="closeImportPanel()" style="display: none;">
                                            ✓ Done
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Add Donation Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content" style="max-width: 1400px; width: 95%;">
            <div class="modal-header">
                <h2 id="donationModalTitle">Add Cash Donation</h2>
            </div>
            <div>
                    <form id="donationForm">
                <input type="hidden" id="donationType" value="cash">
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0284c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="donationTypeIcon" style="font-size: 2rem;">💵</span>
                        <div>
                            <div style="font-weight: 600; color: #075985; font-size: 1.1rem;" id="donationTypeLabel">Cash/Check Donation</div>
                            <div style="font-size: 0.875rem; color: #0369a1; margin-top: 0.25rem;" id="donationTypeDesc">Record a monetary donation</div>
                        </div>
                    </div>
                </div>
                <!-- Charity and Donation Date side-by-side -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="donationCharity">Charity *</label>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <div class="autocomplete-wrapper" style="flex: 1;">
                                <input type="text"
                                       id="donationCharity"
                                       class="autocomplete-input"
                                       placeholder="Start typing to search charities..."
                                       required
                                       autocomplete="off">
                                <input type="hidden" id="selectedCharityId">
                                <input type="hidden" id="selectedCharitySource">
                                <div id="charityDropdown" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="donationDate">Donation Date *</label>
                        <input type="date" id="donationDate" required style="width: 100%;">
                    </div>
                </div>
                <!-- Cash donation fields -->
                <div id="cashFields" class="donation-type-fields">
                    <div class="form-group">
                        <label for="donationAmount">Amount</label>
                        <input type="number" id="donationAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <!-- Item donation fields -->
                <div id="itemsFields" class="donation-type-fields" style="display:none;">
                    <!-- IRS Compliance Warning -->
                    <div class="alert" style="background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-size:0.875rem;">
                        <strong>⚠️ IRS:</strong> Only "good condition or better" items qualify for tax deductions
                    </div>

                    <!-- Two column layout: Entry on left, Receipt on right -->
                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.5rem;">
                        <!-- Left Column: Item Entry -->
                        <div>
                            <!-- Horizontal layout for category, item, quality selection -->
                            <div style="display: grid; grid-template-columns: 1.8fr 2.2fr 1.2fr 0.6fr auto; gap: 0.75rem; align-items: end; margin-bottom: 1rem;">
                        <!-- Category Dropdown -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Category</label>
                            <select id="itemCategory" onchange="categoryChanged()" style="font-size:0.875rem;width:100%;padding:0.375rem;">
                                <option value="">Select category...</option>
                            </select>
                        </div>

                        <!-- Item Search -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Item</label>
                            <div style="position:relative;">
                                <input type="text"
                                       id="itemSearch"
                                       placeholder="Search items (select category first)"
                                       oninput="searchItems(this.value)"
                                       onfocus="showItemDropdown()"
                                       disabled
                                       style="font-size:0.875rem;width:100%;padding:0.375rem;">
                                <input type="hidden" id="itemSelect">
                                <!-- Item Dropdown -->
                                <div id="itemDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Quality -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Condition</label>
                            <select id="itemQuality" onchange="updateItemValue()" style="font-size:0.875rem;width:100%;padding:0.375rem;" disabled>
                                <option value="fair">Fair (Not IRS Deductible)</option>
                                <option value="good">Good</option>
                                <option value="very_good" selected>Very Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Qty</label>
                            <input type="number" id="itemQuantity" value="1" min="1" onchange="updateItemValue()" style="font-size:0.875rem;width:100%;padding:0.375rem;" disabled>
                        </div>

                        <!-- Add Button -->
                        <div>
                            <button type="button" id="addItemBtn" onclick="addItemToList()" disabled style="padding:0.5rem 1rem;background:#9ca3af;color:white;border:none;border-radius:6px;cursor:not-allowed;font-size:0.875rem;font-weight:600;white-space:nowrap;">
                                + Add Item
                            </button>
                        </div>
                            </div>

                            <!-- Value Preview (shown when item selected) -->
                            <div id="itemValueDisplay" style="display:none;background:#f0f9ff;padding:0.5rem;border-radius:6px;border:1px solid #bae6fd;margin-bottom:1rem;">
                                <span id="selectedItemName" style="font-weight:600;color:#075985;"></span>
                                <span style="margin-left:1rem;color:#0369a1;">Value: <strong id="itemValuePreview">$0.00</strong></span>
                            </div>
                        </div>

                        <!-- Right Column: Receipt Display -->
                        <div>
                            <div style="background:white; border:2px solid #e5e7eb; border-radius:8px; padding:1rem; min-height:300px;">
                                <div style="border-bottom:2px dashed #d1d5db; padding-bottom:0.5rem; margin-bottom:0.75rem;">
                                    <h4 style="font-size:1rem;font-weight:700;color:#374151;text-align:center;margin:0;">📋 DONATION RECEIPT</h4>
                                    <p style="font-size:0.75rem;color:#6b7280;text-align:center;margin-top:0.25rem;">Items for Tax Deduction</p>
                                </div>
                                <div id="selectedItemsList" style="min-height:180px; max-height:250px; overflow-y:auto;font-size:0.875rem;">
                                    <div class="empty-state" style="color:#9ca3af; text-align:center; padding:2rem; font-size:0.875rem;">
                                        No items added yet
                                    </div>
                                </div>
                                <div style="border-top:2px solid #374151; margin-top:0.75rem; padding-top:0.75rem; display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="font-size:1rem;">Total Value:</strong>
                                    <span style="font-size:1.5rem; font-weight:bold; color:#667eea;">$<span id="receiptTotal">0.00</span></span>
                                </div>
                                <!-- Save button appears when items are added -->
                                <div id="saveItemsDonationBtn" style="display:none; margin-top:1rem;">
                                    <button type="submit" style="width:100%; padding:0.75rem; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;">
                                        💾 Save Donation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="estimatedValue">
                    <input type="hidden" id="itemDescription">
                </div>
                <!-- Mileage donation fields -->
                <div id="milesFields" class="donation-type-fields" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="milesDriven">Miles Driven</label>
                            <input type="number" id="milesDriven" step="0.1" min="0" onchange="calculateMileageDeduction()" oninput="calculateMileageDeduction()">
                        </div>
                        <div class="form-group">
                            <label for="mileagePurpose">Purpose</label>
                            <input type="text" id="mileagePurpose" placeholder="e.g., Deliver meals">
                        </div>
                    </div>
                    <div style="background:#f3f4f6; padding:0.5rem; border-radius:8px; margin-top:0.5rem;">
                        <small>IRS Rate: $<span id="mileageRateDisplay">0.14</span>/mile | Deduction: $<span id="mileageDeduction">0.00</span></small>
                    </div>
                </div>
                <!-- Stock donation fields -->
                <div id="stockFields" class="donation-type-fields" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="stockName">Stock Name</label>
                            <input type="text" id="stockName" placeholder="e.g., Apple Inc." required>
                        </div>
                        <div class="form-group">
                            <label for="stockSymbol">Stock Symbol</label>
                            <input type="text" id="stockSymbol" placeholder="e.g., AAPL" style="text-transform:uppercase;" required>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="stockQuantity">Number of Shares</label>
                            <input type="number" id="stockQuantity" step="0.001" min="0" onchange="calculateStockTotal()" oninput="calculateStockTotal()" required>
                        </div>
                        <div class="form-group">
                            <label for="fairMarketValue">Closing Price per Share</label>
                            <input type="number" id="fairMarketValue" step="0.01" min="0" placeholder="$ per share" onchange="calculateStockTotal()" oninput="calculateStockTotal()" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="costBasis">Cost Basis (optional)</label>
                        <input type="number" id="costBasis" step="0.01" min="0" placeholder="Total cost basis">
                        <small style="color:#6b7280;">Automatic price lookup coming soon</small>
                    </div>
                    <div style="background:#f0f9ff; padding:0.75rem; border-radius:6px; margin-top:1rem; border:1px solid #bae6fd;">
                        <div style="font-size:0.875rem; color:#0369a1; font-weight:600;">Total Stock Donation:</div>
                        <div id="stockTotalDisplay" style="font-size:1.5rem; font-weight:bold; color:#075985;">$0.00</div>
                        <div style="font-size:0.75rem; color:#0c4a6e; margin-top:0.25rem;">
                            <span id="stockCalculation">0 shares × $0.00 = $0.00</span>
                        </div>
                    </div>
                </div>
                <!-- Crypto donation fields -->
                <div id="cryptoFields" class="donation-type-fields" style="display:none;">
                    <!-- IRS Notice -->
                    <div class="alert" style="background:#e0f2fe;border:1px solid #0284c7;color:#075985;padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-size:0.875rem;">
                        <strong>📊 IRS Rule:</strong> Use fair market value at exact time of donation. For crypto held >1 year, deduct full FMV. For ≤1 year, deduct lesser of cost basis or FMV.
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group" style="position:relative;">
                            <label for="cryptoName">Cryptocurrency Name</label>
                            <input type="text" id="cryptoName" placeholder="Start typing to search..." required
                                   oninput="searchCrypto(this.value)" onfocus="showCryptoDropdown()" autocomplete="off">
                            <!-- Crypto Dropdown -->
                            <div id="cryptoDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cryptoSymbol">Symbol/Ticker</label>
                            <input type="text" id="cryptoSymbol" placeholder="Auto-populated or enter manually" style="text-transform:uppercase;" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cryptoDonationTime">Exact Time (for price verification)</label>
                        <input type="time" id="cryptoDonationTime" step="1" required>
                        <small style="color:#6b7280;">Critical for IRS valuation - use with date field below</small>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="cryptoQuantity">Quantity</label>
                            <input type="number" id="cryptoQuantity" step="0.00000001" min="0" onchange="calculateCryptoTotal()" oninput="calculateCryptoTotal()" placeholder="Amount" required>
                        </div>
                        <div class="form-group">
                            <label for="cryptoPricePerUnit">Price per Unit (USD)</label>
                            <input type="number" id="cryptoPricePerUnit" step="0.01" min="0" onchange="calculateCryptoTotal()" oninput="calculateCryptoTotal()" placeholder="$ per coin/token at exact time" required>
                        </div>
                        <div class="form-group">
                            <label for="cryptoExchange">Exchange/Source</label>
                            <input type="text" id="cryptoExchange" placeholder="e.g., Coinbase, Binance" required>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="cryptoCostBasis">Cost Basis (optional)</label>
                            <input type="number" id="cryptoCostBasis" step="0.01" min="0" placeholder="Total purchase cost">
                            <small style="color:#6b7280;">Your original purchase price</small>
                        </div>
                        <div class="form-group">
                            <label for="cryptoHoldingPeriod">Holding Period</label>
                            <select id="cryptoHoldingPeriod">
                                <option value="long">Over 1 year (Long-term)</option>
                                <option value="short">1 year or less (Short-term)</option>
                            </select>
                            <small style="color:#6b7280;">Affects deduction calculation</small>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div style="background:#f0f9ff; padding:0.75rem; border-radius:6px; margin-top:1rem; border:1px solid #bae6fd;">
                        <div style="font-size:0.875rem; color:#0369a1; font-weight:600;">Total Crypto Donation Value:</div>
                        <div id="cryptoTotalDisplay" style="font-size:1.5rem; font-weight:bold; color:#075985;">$0.00</div>
                        <div style="font-size:0.75rem; color:#0c4a6e; margin-top:0.25rem;">
                            <span id="cryptoCalculation">0 units × $0.00 = $0.00</span>
                        </div>
                        <div id="cryptoDeductionNote" style="font-size:0.75rem; color:#0c4a6e; margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid #bae6fd;">
                            <strong>Tax Deduction:</strong> <span id="cryptoDeductionAmount">$0.00</span>
                        </div>
                    </div>
                </div>
                <!-- Date field moved to be side-by-side with Charity above -->
                <div class="form-group">
                    <label for="donationNotes">Notes (optional)</label>
                    <textarea id="donationNotes" rows="3"></textarea>
                </div>
                <!-- Tax Savings Calculator -->
                <div style="background: #f0fdf4; border: 2px solid #86efac; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;">💰 Estimated Tax Savings</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Donation Amount</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="donationAmountDisplay">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Tax Savings (<span id="taxRateDisplay">22</span>%)</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="taxSavingsDisplay">$0</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #666;">
                        * Based on your marginal tax rate. Actual savings depend on itemizing deductions.
                    </div>
                </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" onclick="closeDonationModal()">Cancel</button>
                            <button type="submit" class="btn-primary" id="donationSubmitBtn">Add Donation</button>
                        </div>
                    </form>
            </div>
        </div>
    </div>

    <!-- Edit Cash Donation Modal -->
    <div id="editCashDonationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>✏️ Edit Cash Donation</h2>
                <button class="close-btn" onclick="closeEditCashModal()">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <form id="editCashDonationForm">
                    <input type="hidden" id="editCashDonationId">
                    <input type="hidden" id="editCashCharityId">
                    <input type="hidden" id="editCashCharitySource">

                    <!-- Charity Section -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">Charity</label>
                        <div style="padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <div id="editCashCharityName" style="font-weight: 500; color: #111827;"></div>
                            <div id="editCashCharityEIN" style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;"></div>
                        </div>
                    </div>

                    <!-- Date Section -->
                    <div style="margin-bottom: 1.5rem;">
                        <label for="editCashDate" style="font-size: 0.875rem; font-weight: 600; color: #374151;">Donation Date</label>
                        <input type="date" id="editCashDate" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>

                    <!-- Amount Section -->
                    <div style="margin-bottom: 1.5rem;">
                        <label for="editCashAmount" style="font-size: 0.875rem; font-weight: 600; color: #374151;">Amount ($)</label>
                        <input type="number" id="editCashAmount" step="0.01" min="0" required
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;"
                               oninput="updateEditCashTaxSavings()">
                    </div>

                    <!-- Tax Savings Display -->
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0284c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem; color: #0369a1;">Estimated Tax Savings:</span>
                            <span style="font-size: 1.25rem; font-weight: bold; color: #0284c7;">$<span id="editCashTaxSavings">0</span></span>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div style="margin-bottom: 1.5rem;">
                        <label for="editCashNotes" style="font-size: 0.875rem; font-weight: 600; color: #374151;">Notes</label>
                        <textarea id="editCashNotes" rows="3"
                                  style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="closeEditCashModal()"
                                style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                        <button type="submit"
                                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            💾 Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Item Donation Modal -->
    <div id="editItemDonationModal" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>✏️ Edit Item Donation</h2>
                <button class="close-btn" onclick="closeEditItemModal()">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <!-- Charity and Date Section -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">Charity</label>
                        <div style="position: relative;">
                            <input type="text"
                                   id="editItemCharity"
                                   placeholder="Search for charity..."
                                   autocomplete="off"
                                   oninput="searchEditCharities(this.value)"
                                   onfocus="showEditCharityDropdown()"
                                   style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                            <input type="hidden" id="editItemCharityId">
                            <!-- Dropdown for charity search results -->
                            <div id="editCharityDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 2px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100;">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">Donation Date</label>
                        <input type="date" id="editItemDate" onchange="renderEditItems()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                </div>

                <!-- Two column layout: Items on left, Receipt on right -->
                <div style="display: grid; grid-template-columns: 1.8fr 1fr; gap: 1.5rem;">
                    <!-- Left Column: Items List -->
                    <div>
                        <!-- Items List Section -->
                        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Donated Items</h3>
                            <div id="editItemsList" style="max-height: 400px; overflow-y: auto; overflow-x: hidden; padding-right: 0.5rem;">
                                <!-- Items will be loaded here -->
                            </div>

                            <!-- Add New Item Button -->
                            <button type="button" onclick="addNewItemRow()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                + Add New Item
                            </button>
                        </div>

                        <!-- Notes Section -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">Notes</label>
                            <textarea id="editItemNotes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                    </div>

                    <!-- Right Column: Receipt Preview -->
                    <div>
                        <div style="background:white; border:2px solid #e5e7eb; border-radius:8px; padding:1rem; position: sticky; top: 0;">
                            <div style="border-bottom:2px dashed #d1d5db; padding-bottom:0.5rem; margin-bottom:0.75rem;">
                                <h4 style="font-size:1rem;font-weight:700;color:#374151;text-align:center;margin:0;">📋 DONATION RECEIPT</h4>
                                <p style="font-size:0.75rem;color:#6b7280;text-align:center;margin-top:0.25rem;">Items for Tax Deduction</p>
                            </div>
                            <div id="editReceiptItemsList" style="min-height:200px; max-height:350px; overflow-y:auto;font-size:0.875rem;">
                                <div class="empty-state" style="color:#9ca3af; text-align:center; padding:2rem; font-size:0.875rem;">
                                    No items added yet
                                </div>
                            </div>
                            <div style="border-top:2px solid #374151; margin-top:0.75rem; padding-top:0.75rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="font-size:1rem;">Total Value:</strong>
                                    <span style="font-size:1.5rem; font-weight:bold; color:#667eea;">$<span id="editReceiptTotal">0.00</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">Tax Savings (<span id="editReceiptTaxRate">0</span>%):</span>
                                    <span style="font-size: 1rem; font-weight: bold; color: #10b981;">$<span id="editReceiptTaxSavings">0.00</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tax Savings Calculator (Green Box like Add Form) -->
                <div style="background: #f0fdf4; border: 2px solid #86efac; padding: 1rem; border-radius: 8px; margin-top: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;">💰 Estimated Tax Savings</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Donation Amount</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;">$<span id="editItemTotal">0.00</span></div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Tax Savings (<span id="editItemTaxRate">0</span>%)</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;">$<span id="editItemTaxSavings">0.00</span></div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #666;">
                        * Based on your marginal tax rate. Actual savings depend on itemizing deductions.
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="closeEditItemModal()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Cancel
                    </button>
                    <button type="button" onclick="saveEditedItemDonation()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        💾 Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Charity Modal -->
    <div id="charityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Charity</h2>
            </div>
            <form id="charityForm">
                <div class="form-group">
                    <label for="charityName">Charity Name</label>
                    <input type="text" id="charityName" required>
                </div>
                <div class="form-group">
                    <label for="charityEIN">EIN (optional)</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="charityEIN" style="flex: 1;">
                        <button type="button"
                                onclick="alert('IRS Verification Coming Soon!\n\nThis feature will automatically verify charity tax-exempt status with the IRS database.')"
                                style="padding: 0.5rem 1rem; background: #9ca3af; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;"
                                title="Future Feature: Verify IRS tax-exempt status">
                            🔍 Verify (Coming Soon)
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="charityCategory">Category</label>
                    <select id="charityCategory">
                        <option value="">Select category...</option>
                        <option value="Arts & Culture">Arts & Culture</option>
                        <option value="Community">Community</option>
                        <option value="Education">Education</option>
                        <option value="Environment">Environment</option>
                        <option value="Health">Health</option>
                        <option value="Human Services">Human Services</option>
                        <option value="International">International</option>
                        <option value="Religion">Religion</option>
                        <option value="Research">Research</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="charityAddress">Street Address</label>
                    <input type="text" id="charityAddress" placeholder="123 Main St">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <label for="charityCity">City</label>
                        <input type="text" id="charityCity" placeholder="New York">
                    </div>
                    <div>
                        <label for="charityState">State</label>
                        <input type="text" id="charityState" placeholder="NY" maxlength="2">
                    </div>
                    <div>
                        <label for="charityZip">ZIP Code</label>
                        <input type="text" id="charityZip" placeholder="10001" pattern="[0-9]{5}(-[0-9]{4})?">
                    </div>
                </div>
                <div class="form-group">
                    <label for="charityPhone">Phone Number</label>
                    <input type="tel" id="charityPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="charityWebsite">Website (optional)</label>
                    <input type="url" id="charityWebsite" placeholder="https://example.org">
                </div>
                <div class="form-group">
                    <label for="charityDescription">Description (optional)</label>
                    <textarea id="charityDescription" rows="3" placeholder="Brief description of the charity's mission"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeCharityModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Charity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Charity Modal -->
    <div id="editCharityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Charity</h2>
            </div>
            <form id="editCharityForm">
                <input type="hidden" id="editCharityId">
                <div class="form-group">
                    <label for="editCharityName">Charity Name</label>
                    <input type="text" id="editCharityName" required>
                </div>
                <div class="form-group">
                    <label for="editCharityEIN">EIN (optional)</label>
                    <input type="text" id="editCharityEIN">
                </div>
                <div class="form-group">
                    <label for="editCharityCategory">Category</label>
                    <select id="editCharityCategory">
                        <option value="">Select category...</option>
                        <option value="Arts & Culture">Arts & Culture</option>
                        <option value="Community">Community</option>
                        <option value="Education">Education</option>
                        <option value="Environment">Environment</option>
                        <option value="Health">Health</option>
                        <option value="Human Services">Human Services</option>
                        <option value="International">International</option>
                        <option value="Religion">Religion</option>
                        <option value="Research">Research</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCharityAddress">Street Address</label>
                    <input type="text" id="editCharityAddress" placeholder="123 Main St">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <label for="editCharityCity">City</label>
                        <input type="text" id="editCharityCity" placeholder="New York">
                    </div>
                    <div>
                        <label for="editCharityState">State</label>
                        <input type="text" id="editCharityState" placeholder="NY" maxlength="2">
                    </div>
                    <div>
                        <label for="editCharityZip">ZIP Code</label>
                        <input type="text" id="editCharityZip" placeholder="10001" pattern="[0-9]{5}(-[0-9]{4})?">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editCharityPhone">Phone Number</label>
                    <input type="tel" id="editCharityPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="editCharityWebsite">Website (optional)</label>
                    <input type="url" id="editCharityWebsite" placeholder="https://example.org">
                </div>
                <div class="form-group">
                    <label for="editCharityDescription">Description (optional)</label>
                    <textarea id="editCharityDescription" rows="3" placeholder="Brief description of the charity's mission"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditCharityModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Update Charity</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
            window.location.href = '/login.html';
        } else {
            // Try to get name from profile first, then fall back to user data
            const savedProfile = localStorage.getItem('userProfile');
            let displayName = user.email;
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                displayName = profile.name || user.name || user.email;
            } else {
                displayName = user.name || user.email;
            }
            document.getElementById('userName').textContent = displayName;
        }

        // Set today's date as default for donation form (use local date string to avoid timezone issues)
        const today = new Date();
        const localDate = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
        document.getElementById('donationDate').value = localDate;

        // Format currency with commas and optional cents
        function formatCurrency(amount, includeCents = false) {
            const num = parseFloat(amount) || 0;
            if (includeCents) {
                return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
        }

        // Helper function to parse donation notes safely
        function parseNotesDisplay(notes) {
            if (!notes) return '';

            // Handle JSON format (legacy)
            if (typeof notes === 'string' && notes.startsWith('{')) {
                try {
                    const notesObj = JSON.parse(notes);
                    return notesObj.notes || '';
                } catch (e) {
                    // Use as-is if not valid JSON
                    return notes;
                }
            }

            // Handle ITEMS format - extract only user notes, not ITEMS data
            if (typeof notes === 'string' && notes.startsWith('ITEMS:')) {
                // Find the end of the ITEMS data (last closing bracket)
                const lastBracketIndex = notes.lastIndexOf(']');
                if (lastBracketIndex !== -1) {
                    // Extract any text after the ITEMS data
                    const userNotes = notes.substring(lastBracketIndex + 1).trim();
                    // If there's a separator like " | " or just space, remove it
                    return userNotes.replace(/^\|?\s*/, '').trim();
                }
                return ''; // No user notes, just ITEMS data
            }

            return notes;
        }

        // Function to update donation type (for edit form)
        function updateDonationType(type) {
            // Update the hidden field
            const donationType = document.getElementById('donationType');
            if (donationType) {
                donationType.value = type;
            }

            // Update the display elements
            const typeIcon = document.getElementById('donationTypeIcon');
            const typeLabel = document.getElementById('donationTypeLabel');
            const modalTitle = document.getElementById('donationModalTitle');

            const typeConfig = {
                cash: { icon: '💵', label: 'Cash/Check Donation', title: 'Add Cash Donation' },
                items: { icon: '🎁', label: 'Item Donation', title: 'Add Item Donation' },
                miles: { icon: '🚗', label: 'Mileage Donation', title: 'Add Mileage Donation' },
                stock: { icon: '📈', label: 'Stock/Securities Donation', title: 'Add Stock Donation' },
                crypto: { icon: '🪙', label: 'Cryptocurrency Donation', title: 'Add Crypto Donation' }
            };

            const config = typeConfig[type] || typeConfig.cash;

            if (typeIcon) typeIcon.textContent = config.icon;
            if (typeLabel) typeLabel.textContent = config.label;
            if (modalTitle) modalTitle.textContent = config.title;

            // Update the form fields
            updateDonationFields();
        }

        // Function to update donation fields based on type
        function updateDonationFields() {
            const donationType = document.getElementById('donationType').value;
            console.log('Updating donation fields for type:', donationType);

            // Hide all type-specific fields
            document.querySelectorAll('.donation-type-fields').forEach(el => {
                el.style.display = 'none';
                // Remove required from hidden fields
                el.querySelectorAll('input, textarea, select').forEach(field => {
                    field.removeAttribute('required');
                });
            });

            // Show relevant fields and set required
            const fieldsToShow = document.getElementById(donationType + 'Fields');
            console.log('Looking for element:', donationType + 'Fields', 'Found:', fieldsToShow);
            if (fieldsToShow) {
                fieldsToShow.style.display = 'block';
                console.log('Showing fields for', donationType);

                // Show/hide crypto time field
                const cryptoTimeField = document.getElementById('cryptoTimeField');
                if (cryptoTimeField) {
                    cryptoTimeField.style.display = donationType === 'crypto' ? 'block' : 'none';
                    if (donationType === 'crypto') {
                        document.getElementById('cryptoDonationTime').setAttribute('required', '');
                    } else {
                        document.getElementById('cryptoDonationTime').removeAttribute('required');
                    }
                }

                // Add required to visible amount fields
                if (donationType === 'cash') {
                    document.getElementById('donationAmount').setAttribute('required', '');
                } else if (donationType === 'miles') {
                    document.getElementById('milesDriven').setAttribute('required', '');
                } else if (donationType === 'items') {
                    document.getElementById('itemDescription').setAttribute('required', '');
                    document.getElementById('estimatedValue').setAttribute('required', '');
                } else if (donationType === 'stock') {
                    document.getElementById('stockQuantity').setAttribute('required', '');
                    document.getElementById('fairMarketValue').setAttribute('required', '');
                } else if (donationType === 'crypto') {
                    // Fix: Use correct crypto field IDs
                    const cryptoSymbol = document.getElementById('cryptoSymbol');
                    const cryptoQty = document.getElementById('cryptoQuantity');
                    const cryptoPricePerUnit = document.getElementById('cryptoPricePerUnit');
                    if (cryptoSymbol) cryptoSymbol.setAttribute('required', '');
                    if (cryptoQty) cryptoQty.setAttribute('required', '');
                    if (cryptoPricePerUnit) cryptoPricePerUnit.setAttribute('required', '');
                }
            }
        }

        // Calculate mileage deduction
        document.getElementById('milesDriven')?.addEventListener('input', (e) => {
            const miles = parseFloat(e.target.value) || 0;
            const rate = 0.14; // 2024 IRS rate
            const deduction = (miles * rate).toFixed(2);
            document.getElementById('mileageDeduction').textContent = deduction;
        });

        // Modal functions
        function showAddDonation() {
            document.getElementById('donationModal').classList.add('active');
            // Initialize charity autocomplete every time modal opens
            initCharityAutocomplete();
            // Also initialize item categories if it's an item donation
            if (document.getElementById('donationType').value === 'items') {
                loadItemCategories();
            }

            // Set default date for crypto donations too
            const today = new Date();
            const localDate = today.getFullYear() + '-' +
                           String(today.getMonth() + 1).padStart(2, '0') + '-' +
                           String(today.getDate()).padStart(2, '0');
            // Crypto now uses the general date field

            // Don't load My Charities in modal anymore - removed that section
        }

        // Load charities for quick add in donation modal
        async function loadMyCharitiesQuickAdd() {
            // Can be called for either the modal or the Add Donation page
            const containerModal = document.getElementById('myCharitiesQuickList');
            const containerPage = document.getElementById('myCharitiesQuickAdd');
            const container = containerModal || containerPage;

            if (!container) return;
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            try {
                const token = localStorage.getItem('token');

                // Fetch all donations to get unique charities
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    // Group donations by charity
                    const charitiesMap = new Map();
                    data.donations.forEach(donation => {
                        const charityId = donation.unified_charity_id || donation.charity_id || donation.user_charity_id;
                        if (!charityId) return;

                        if (!charitiesMap.has(charityId)) {
                            charitiesMap.set(charityId, {
                                id: charityId,
                                name: donation.charity_name || 'Unknown',
                                source: donation.charity_source || 'system',
                                total: 0,
                                count: 0
                            });
                        }
                        const charity = charitiesMap.get(charityId);
                        const donationAmount = donation.donation_type === 'items' ? parseFloat(donation.estimated_value || donation.amount || 0) : parseFloat(donation.amount || 0);
                        charity.total += donationAmount;
                        charity.count++;
                    });

                    // Convert to array and sort alphabetically
                    const charities = Array.from(charitiesMap.values())
                        .sort((a, b) => a.name.localeCompare(b.name));

                    // Check if we're in the modal or the page
                    const isModal = container.id === 'myCharitiesQuickList';
                    const onClickFunc = isModal ? 'quickSelectCharity' : 'quickAddDonation';

                    let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                    charities.forEach(charity => {
                        const personalBadge = charity.source === 'personal'
                            ? '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">Personal</span>'
                            : '';

                        html += `
                            <div style="padding: 0.75rem; background: #f9fafb; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                                 onmouseover="this.style.background='#f3f4f6'"
                                 onmouseout="this.style.background='#f9fafb'"
                                 onclick="${onClickFunc}('${charity.id}', '${charity.name.replace(/'/g, "\\'")}', '${charity.source || 'system'}')">
                                <div style="font-weight: 500; color: #111827;">${charity.name}${personalBadge}</div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${charity.count} donation${charity.count !== 1 ? 's' : ''} · $${formatCurrency(charity.total, true)}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 2rem;">No charities with donations yet</div>';
                }
            } catch (error) {
                console.error('Failed to load My Charities for quick add:', error);
                container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 2rem;">Failed to load charities</div>';
            }
        }

        // Quick select charity from My Charities list
        function quickSelectCharity(charityId, charityName) {
            // Get selected donation type from quick selector
            const donationType = document.getElementById('quickDonationType').value;

            // Open donation modal with pre-filled charity
            openDonationModal(donationType, charityId, charityName);

            // Focus on amount field for quick entry
            setTimeout(() => {
                const amountField = document.getElementById('donationAmount') ||
                                  document.getElementById('stockQuantity') ||
                                  document.getElementById('cryptoQuantity') ||
                                  document.getElementById('milesDriven');
                if (amountField) amountField.focus();
            }, 100);
        }

        // Update quick donation type (just for visual feedback)
        function updateQuickDonationType() {
            // This is just to track what type will be used when clicking a charity
            const selectedType = document.getElementById('quickDonationType').value;
            console.log('Quick donation type changed to:', selectedType);
        }

        function closeDonationModal() {
            document.getElementById('donationModal').classList.remove('active');
            document.getElementById('donationForm').reset();

            // Explicitly clear all amount fields (check if they exist first)
            const fieldsToClean = [
                'donationAmount', 'estimatedValue', 'milesDriven', 'fairMarketValue',
                'cryptoValue', 'numberOfShares', 'pricePerShare', 'purchasePricePerShare',
                'cryptoPriceUSD', 'cryptoQuantity'
            ];

            fieldsToClean.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });

            // Clear tax savings display
            const taxDisplay = document.getElementById('taxSavingsDisplay');
            if (taxDisplay) {
                taxDisplay.textContent = '$0';
            }

            // Clear charity selection
            document.getElementById('selectedCharityId').value = '';
            document.getElementById('donationCharity').value = '';
            document.getElementById('charityDropdown').classList.remove('show');
            window.lastSelectedCharityName = null;

            // Clear edit mode
            window.editingDonationId = null;
            window.isEditing = false;

            // Reset item selection
            selectedDonationItems = [];
            updateSelectedItemsDisplay();

            // Reset item fields if they exist
            const itemFields = {
                'itemCategory': { value: '' },
                'itemSearch': { value: '', disabled: true },
                'itemQuality': { disabled: true },
                'itemQuantity': { disabled: true },
                'addItemBtn': { disabled: true }
            };

            Object.entries(itemFields).forEach(([fieldId, updates]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    Object.entries(updates).forEach(([prop, val]) => {
                        field[prop] = val;
                    });
                }
            });
            const itemSearchField = document.getElementById('itemSearch');
            if (itemSearchField) itemSearchField.value = '';
            const itemSelectField = document.getElementById('itemSelect');
            if (itemSelectField) itemSelectField.value = '';
            // Clear editing flag
            window.editingDonationId = null;
        }

        function showAddCharity() {
            document.getElementById('charityModal').classList.add('active');
        }

        function closeCharityModal() {
            document.getElementById('charityModal').classList.remove('active');
            document.getElementById('charityForm').reset();
        }

        // Edit charity functions
        function closeEditCharityModal() {
            document.getElementById('editCharityModal').classList.remove('active');
            document.getElementById('editCharityForm').reset();
        }

        async function editPersonalCharity(charityId) {
            try {
                console.log('Opening edit modal for charity ID:', charityId);

                // Get auth token
                const token = localStorage.getItem('token');

                // Fetch charity data
                const response = await fetch(`/api/charities/personal/${charityId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.charity) {
                    const charity = data.charity;

                    // Populate form fields
                    document.getElementById('editCharityId').value = charity.id;
                    document.getElementById('editCharityName').value = charity.name || '';
                    document.getElementById('editCharityEIN').value = charity.ein || '';
                    document.getElementById('editCharityCategory').value = charity.category || '';
                    document.getElementById('editCharityAddress').value = charity.address || '';
                    document.getElementById('editCharityCity').value = charity.city || '';
                    document.getElementById('editCharityState').value = charity.state || '';
                    document.getElementById('editCharityZip').value = charity.zip_code || '';
                    document.getElementById('editCharityPhone').value = charity.phone || '';
                    document.getElementById('editCharityWebsite').value = charity.website || '';
                    document.getElementById('editCharityDescription').value = charity.description || '';

                    // Show modal
                    document.getElementById('editCharityModal').classList.add('active');
                } else {
                    showToast('Failed to load charity data: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading charity for edit:', error);
                showToast('Failed to load charity data. Please try again.', 'error');
            }
        }

        async function deletePersonalCharity(charityId) {
            if (!confirm('Are you sure you want to delete this charity? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('Deleting charity ID:', charityId);

                // Get auth token
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/charities/delete-personal/${charityId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Charity deleted successfully!', 'success');
                    loadCharities(); // Refresh the main charity list
                    loadPersonalCharities(); // Refresh the personal charities panel if open
                } else {
                    // Show more detailed error message for donation conflicts
                    if (data.error && data.error.includes('existing donation')) {
                        showToast(data.error, 'warning');
                    } else {
                        showToast('Failed to delete charity: ' + (data.error || 'Unknown error'), 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting charity:', error);
                showToast('Failed to delete charity. Please try again.', 'error');
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Autocomplete functionality
        let allCharities = [];
        let selectedCharityIndex = -1;
        let searchTimeout;

        async function initCharityAutocomplete() {
            console.log('Initializing charity autocomplete...');

            // Load top charities for quick access
            if (allCharities.length === 0) {
                try {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const token = user.token || localStorage.getItem('token') || 'test-token';

                    const response = await fetch('/api/charities?limit=2000', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (data.success && data.charities) {
                        allCharities = data.charities;
                        console.log(`Loaded ${allCharities.length} charities (including personal)`);
                    }
                } catch (error) {
                    console.error('Failed to load charities:', error);
                }
            }

            const input = document.getElementById('donationCharity');
            const dropdown = document.getElementById('charityDropdown');
            const hiddenInput = document.getElementById('selectedCharityId');

            if (!input || !dropdown) {
                console.error('Charity input or dropdown not found', 'Input:', input, 'Dropdown:', dropdown);
                return;
            }

            // Remove any existing listeners first to avoid duplicates
            if (input._charityListenersAdded) {
                console.log('Charity listeners already added');
                return; // Already initialized
            }

            // Setup event listeners - use anonymous functions to ensure they're attached
            input.addEventListener('input', function(e) {
                console.log('Input event fired');
                handleCharitySearch(e);
            });
            input.addEventListener('focus', function(e) {
                console.log('Focus event fired');
                handleCharitySearch(e);
            });
            input.addEventListener('keydown', function(e) {
                handleCharityKeydown(e);
            });

            // Mark as initialized
            input._charityListenersAdded = true;
            console.log('Charity autocomplete initialized - listeners attached to:', input);
        }

        function handleCharitySearch(e) {
            const query = e.target.value.toLowerCase();
            const dropdown = document.getElementById('charityDropdown');
            console.log('Charity search for:', query);

            // Only clear the selected charity ID if the text has actually changed from what was selected
            const currentCharityId = document.getElementById('selectedCharityId').value;
            const currentCharityName = document.getElementById('donationCharity').value;

            // Check if this is a programmatically set value (has an ID but user is typing something different)
            if (currentCharityId && window.lastSelectedCharityName && currentCharityName !== window.lastSelectedCharityName) {
                // User is typing something different from what was selected
                document.getElementById('selectedCharityId').value = '';
                window.lastSelectedCharityName = null;
            } else if (!currentCharityId) {
                // No charity was selected, safe to clear
                document.getElementById('selectedCharityId').value = '';
            }

            clearTimeout(searchTimeout);
            selectedCharityIndex = -1;

            if (query.length < 2) {
                dropdown.classList.remove('show');
                dropdown.style.display = 'none';
                return;
            }

            // Show loading state
            dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
            dropdown.classList.add('show');
            dropdown.style.display = 'block';

            // Debounce search
            searchTimeout = setTimeout(async () => {
                // First, filter local charities for immediate results
                let results = allCharities.filter(charity =>
                    charity.name.toLowerCase().includes(query) ||
                    (charity.ein && charity.ein.toLowerCase().includes(query))
                ).slice(0, 10);

                // Always search the full database to ensure we find all matches
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/charities?search=${encodeURIComponent(query)}&limit=100`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (data.success && data.charities) {
                        // Merge results, avoiding duplicates and prioritizing local results
                        const existingIds = new Set(results.map(r => r.id));
                        const newResults = data.charities.filter(c => !existingIds.has(c.id));
                        // Keep local results first (they're ranked higher), then add API results
                        results = [...results, ...newResults].slice(0, 100);
                        console.log(`Found ${results.length} total charities matching "${query}"`);
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                }

                displayCharityResults(results, query);
            }, 300);
        }

        function displayCharityResults(results, query) {
            const dropdown = document.getElementById('charityDropdown');

            if (results.length === 0) {
                dropdown.innerHTML = `
                    <div class="autocomplete-add-new" onclick="showAddCharityFromSearch('${query}')">
                        + Add new charity "${query}"
                    </div>
                `;
            } else {
                let html = '';
                results.forEach((charity, index) => {
                    const personalBadge = charity.source === 'personal'
                        ? '<span style="background: #fbbf24; color: #92400e; font-size: 0.7rem; padding: 0.125rem 0.375rem; border-radius: 4px; margin-left: 0.5rem; font-weight: 500;">Personal</span>'
                        : '';
                    html += `
                        <div class="autocomplete-item ${index === selectedCharityIndex ? 'selected' : ''}"
                             data-id="${charity.id}"
                             data-index="${index}"
                             data-source="${charity.source || 'system'}"
                             onclick="selectCharity('${charity.id}', '${charity.name.replace(/'/g, "\\'")}', '${charity.source || 'system'}')">
                            <div class="autocomplete-item-name">${charity.name}${personalBadge}</div>
                            ${charity.ein ? `<span class="autocomplete-item-ein">EIN: ${charity.ein}</span>` : ''}
                            ${charity.category ? `<span class="autocomplete-item-category">${charity.category}</span>` : ''}
                        </div>
                    `;
                });

                // If we have many results, we likely hit the limit - show indicator
                if (results.length >= 100) {
                    html += `
                        <div style="padding: 8px 12px; color: #6b7280; font-size: 0.875rem; text-align: center; border-top: 1px solid #e5e7eb;">
                            Showing first 100 results - keep typing to refine search
                        </div>
                    `;
                }

                // Add "Add new charity" option at the end
                html += `
                    <div class="autocomplete-add-new" onclick="showAddCharityFromSearch('${query}')">
                        + Add new charity
                    </div>
                `;

                dropdown.innerHTML = html;
            }

            dropdown.classList.add('show');
            dropdown.style.display = 'block';
        }

        function handleCharityKeydown(e) {
            const dropdown = document.getElementById('charityDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (!dropdown.classList.contains('show') || items.length === 0) return;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedCharityIndex = Math.min(selectedCharityIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedCharityIndex = Math.max(selectedCharityIndex - 1, -1);
                    updateSelectedItem(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedCharityIndex >= 0 && items[selectedCharityIndex]) {
                        items[selectedCharityIndex].click();
                    }
                    break;
                case 'Escape':
                    dropdown.classList.remove('show');
                    selectedCharityIndex = -1;
                    break;
            }
        }

        function updateSelectedItem(items) {
            items.forEach((item, index) => {
                if (index === selectedCharityIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectCharity(id, name, source) {
            document.getElementById('selectedCharityId').value = id;
            document.getElementById('selectedCharitySource').value = source || 'system';
            document.getElementById('donationCharity').value = name;
            // Track the selected charity name to prevent clearing on input events
            window.lastSelectedCharityName = name;
            const dropdown = document.getElementById('charityDropdown');
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
            selectedCharityIndex = -1;
            console.log('Selected charity:', name, 'ID:', id, 'Source:', source);
        }

        // Quick add donation from My Charities
        // Toggle charity menu dropdown
        function toggleCharityMenu(event, charityIndex) {
            event.stopPropagation();
            const menu = document.getElementById(`charityMenu-${charityIndex}`);
            const button = event.target;

            // Close all other menus
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.style.display = 'none';
            });

            // Toggle this menu
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
            } else {
                menu.style.display = 'none';
            }
        }

        // Show charity info modal
        async function showCharityInfo(charityId, charityName, ein, category, source) {
            // Close any open dropdown menus
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                m.style.display = 'none';
            });

            // Try to fetch more details about the charity
            let charityDetails = null;
            let description = '';
            let address = '';
            let city = '';
            let state = '';
            let website = '';

            try {
                const token = localStorage.getItem('token');
                // Try personal charity endpoint first if it's a personal charity
                const endpoint = source === 'personal'
                    ? `/api/charities/personal/${charityId}`
                    : `/api/charities/${charityId}`;

                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Charity API response:', data);
                    if (data.success && data.charity) {
                        charityDetails = data.charity;
                        console.log('Charity details received:', {
                            name: charityDetails.name,
                            description: charityDetails.description,
                            hasDescription: !!charityDetails.description,
                            descriptionLength: charityDetails.description ? charityDetails.description.length : 0
                        });
                        description = charityDetails.description || charityDetails.mission || charityDetails.purpose || '';
                        address = charityDetails.address || '';
                        city = charityDetails.city || '';
                        state = charityDetails.state || '';
                        website = charityDetails.website || '';
                        // Update ein and category if we got more info
                        ein = ein || charityDetails.ein || '';
                        category = category || charityDetails.category || '';
                    }
                }
            } catch (error) {
                console.log('Could not fetch additional charity details');
            }

            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1.5rem;">
                        <div style="flex: 1;">
                            <h2 style="color: #1f2937; margin: 0;">${charityName}</h2>
                            ${source === 'personal' ? '<span style="display: inline-block; margin-top: 0.5rem; background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600;">✨ Personal Charity</span>' : ''}
                        </div>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0; margin-left: 1rem;">×</button>
                    </div>

                    ${description ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                        <label style="font-size: 0.875rem; color: #4b5563; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; margin-bottom: 0.5rem; display: block;">Purpose / Mission</label>
                        <div style="color: #1f2937; line-height: 1.6;">${description}</div>
                    </div>` : ''}

                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        ${ein ? `
                        <div>
                            <label style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">EIN (Tax ID)</label>
                            <div style="color: #1f2937; font-weight: 500; margin-top: 0.25rem;">${ein}</div>
                        </div>` : ''}

                        <div>
                            <label style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Category</label>
                            <div style="color: #1f2937; font-weight: 500; margin-top: 0.25rem;">${category || 'Not specified'}</div>
                        </div>

                        ${(address || city || state) ? `
                        <div>
                            <label style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Location</label>
                            <div style="color: #1f2937; font-weight: 500; margin-top: 0.25rem;">
                                ${address ? address + '<br>' : ''}
                                ${city ? city + ', ' : ''}${state || ''}
                            </div>
                        </div>` : ''}

                        ${website ? `
                        <div>
                            <label style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Website</label>
                            <div style="margin-top: 0.25rem;">
                                <a href="${website.startsWith('http') ? website : 'https://' + website}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.25rem;">
                                    ${website}
                                    <span style="font-size: 0.75rem;">↗</span>
                                </a>
                            </div>
                        </div>` : ''}

                        <div>
                            <label style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Data Source</label>
                            <div style="color: #1f2937; font-weight: 500; margin-top: 0.25rem;">${source === 'personal' ? '👤 User Added' : '🏛️ IRS Database'}</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button onclick="this.closest('div').parentElement.remove(); quickAddDonation('${charityId}', '${charityName.replace(/'/g, "\\'")}, '${source}')"
                                class="btn-primary" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            ➕ Quick Add Donation
                        </button>
                        <button onclick="this.closest('div').parentElement.remove()"
                                style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #4b5563; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function quickAddDonation(charityId, charityName, charitySource) {
            console.log('[QUICK ADD] Charity ID:', charityId);
            console.log('[QUICK ADD] Charity Name:', charityName);
            console.log('[QUICK ADD] Charity Source:', charitySource);

            // UUID detection helper
            const isUUID = (str) => {
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                return uuidRegex.test(str);
            };

            // Auto-detect charity type if source is missing or incorrect
            if (isUUID(charityId)) {
                console.log('[QUICK ADD] Detected UUID format - forcing source to personal');
                charitySource = 'personal';
            } else if (!isNaN(charityId)) {
                console.log('[QUICK ADD] Detected numeric format - forcing source to system');
                charitySource = 'system';
            }
            console.log('[QUICK ADD] Final charity source:', charitySource);

            // Store the selected charity
            document.getElementById('selectedCharityId').value = charityId;
            document.getElementById('selectedCharitySource').value = charitySource || 'personal';
            document.getElementById('donationCharity').value = charityName;
            // Track the selected charity name to prevent clearing on input events
            window.lastSelectedCharityName = charityName;

            // Show a quick donation type selector
            const donationTypes = [
                { type: 'cash', label: '💵 Cash', desc: 'Cash/Check' },
                { type: 'items', label: '📦 Items', desc: 'Donated Items' },
                { type: 'miles', label: '🚗 Miles', desc: 'Mileage' },
                { type: 'stock', label: '📈 Stock', desc: 'Securities' },
                { type: 'crypto', label: '₿ Crypto', desc: 'Cryptocurrency' }
            ];

            let html = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 10001; max-width: 400px;">
                    <h3 style="margin-bottom: 1rem; color: #333;">Quick Donation to ${charityName}</h3>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Select donation type:</p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
            `;

            donationTypes.forEach(dt => {
                html += `
                    <button onclick="quickSelectType('${dt.type}', '${charityId}', '${charityName.replace(/'/g, "\\\\'")}')"
                            style="padding: 0.75rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;"
                            onmouseover="this.style.background='#e5e7eb'"
                            onmouseout="this.style.background='#f3f4f6'">
                        <div style="font-size: 1.5rem;">${dt.label.split(' ')[0]}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">${dt.desc}</div>
                    </button>
                `;
            });

            html += `
                    </div>
                    <button onclick="document.getElementById('quickDonationSelector').remove()"
                            style="margin-top: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
                        Cancel
                    </button>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="document.getElementById('quickDonationSelector').remove()"></div>
            `;

            const selector = document.createElement('div');
            selector.id = 'quickDonationSelector';
            selector.innerHTML = html;
            document.body.appendChild(selector);
        }

        function quickSelectType(type, charityId, charityName) {
            // Remove the selector
            const selector = document.getElementById('quickDonationSelector');
            if (selector) selector.remove();

            // Get the charity source from the stored value
            let charitySource = document.getElementById('selectedCharitySource').value || 'personal';

            // UUID detection helper
            const isUUID = (str) => {
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                return uuidRegex.test(str);
            };

            // Double-check with UUID detection
            if (isUUID(charityId)) {
                console.log('[QUICK SELECT] Detected UUID - forcing source to personal');
                charitySource = 'personal';
            } else if (!isNaN(charityId)) {
                console.log('[QUICK SELECT] Detected numeric - forcing source to system');
                charitySource = 'system';
            }

            // Open the donation modal with the selected type and pre-filled charity
            openDonationModal(type, charityId, charityName, charitySource);
        }

        function showAddCharityFromSearch(searchQuery) {
            // Mark that we're adding from donation modal
            window.addingCharityFromDonation = true;
            // Close donation modal
            closeDonationModal();
            // Open charity modal with pre-filled name
            showAddCharity();
            document.getElementById('charityName').value = searchQuery;
        }

        // Form submissions
        document.getElementById('donationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const charityId = document.getElementById('selectedCharityId').value;
            console.log('[DEBUG] Selected charity ID:', charityId);
            console.log('[DEBUG] Selected charity name:', document.getElementById('donationCharity').value);

            if (!charityId) {
                alert('Please select a charity from the dropdown');
                return;
            }

            const donationType = document.getElementById('donationType').value;
            const isEditing = window.editingDonationId !== null && window.editingDonationId !== undefined;

            // UUID detection helper
            const isUUID = (str) => {
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                return uuidRegex.test(str);
            };

            // Determine if this is a user charity or system charity
            let charitySource = document.getElementById('selectedCharitySource').value || 'system';

            // Override with UUID detection for safety
            if (isUUID(charityId)) {
                console.log('[FORM SUBMIT] Detected UUID format - overriding to personal charity');
                charitySource = 'personal';
            } else if (!isNaN(charityId)) {
                console.log('[FORM SUBMIT] Detected numeric format - overriding to system charity');
                charitySource = 'system';
            }

            const isUserCharity = charitySource === 'personal';

            console.log('[DEBUG] Charity Source:', charitySource);
            console.log('[DEBUG] Is User Charity:', isUserCharity);
            console.log('[DEBUG] Charity ID:', charityId);

            const formData = {
                donation_type: donationType,
                donation_date: document.getElementById('donationDate').value,  // API will map this to 'date'
                notes: document.getElementById('donationNotes').value
            };

            // Set the appropriate charity ID field based on type
            if (isUserCharity) {
                console.log('[DEBUG] Setting user_charity_id:', charityId);
                formData.user_charity_id = charityId;
                formData.charity_source = 'personal';
            } else {
                console.log('[DEBUG] Setting charity_id:', charityId);
                formData.charity_id = charityId;
                formData.charity_source = 'system';
            }

            console.log('[DEBUG] Form data being submitted:', formData);
            console.log('[DEBUG] Is editing?', isEditing);

            // Add type-specific data
            switch(donationType) {
                case 'cash':
                    formData.amount = parseFloat(document.getElementById('donationAmount').value);
                    break;
                case 'items':
                    // For items donation, use the selectedDonationItems array (not on window object)
                    const itemsArray = selectedDonationItems || [];
                    if (itemsArray.length === 0) {
                        alert('Please add at least one item to the donation');
                        return;
                    }

                    // Calculate total from items
                    let totalAmount = 0;
                    formData.items = itemsArray.map(item => {
                        const itemValue = parseFloat(item.value || item.totalValue || 0);
                        totalAmount += itemValue;
                        const itemData = {
                            item_name: item.name || item.itemName,
                            category: item.category || item.categoryName,
                            condition: item.condition || item.quality,
                            quantity: parseInt(item.quantity) || 1,
                            unit_value: item.unit_value || item.unitValue || (itemValue / (parseInt(item.quantity) || 1)),
                            total_value: itemValue
                        };
                        // Include value_source for custom items
                        if (item.value_source) {
                            itemData.value_source = item.value_source;
                        }
                        return itemData;
                    });

                    formData.amount = totalAmount;

                    // Just use the user's notes directly - items are now stored in donation_items table
                    formData.notes = document.getElementById('donationNotes').value || '';
                    break;
                case 'miles':
                    const miles = parseFloat(document.getElementById('milesDriven').value);
                    const rate = 0.14; // 2024 IRS rate
                    formData.miles_driven = miles;
                    formData.mileage_rate = rate;
                    formData.mileage_purpose = document.getElementById('mileagePurpose').value;
                    formData.amount = miles * rate; // Calculate deduction amount
                    break;
                case 'stock':
                    const shares = parseFloat(document.getElementById('stockQuantity').value);
                    const pricePerShare = parseFloat(document.getElementById('fairMarketValue').value); // User enters closing price per share
                    formData.stock_symbol = document.getElementById('stockSymbol').value.toUpperCase();
                    formData.stock_quantity = shares;
                    formData.fair_market_value = shares * pricePerShare; // Calculate and store total value
                    formData.cost_basis = parseFloat(document.getElementById('costBasis').value) || 0;
                    formData.amount = shares * pricePerShare; // Total donation value
                    break;
                case 'crypto':
                    const cryptoQuantity = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
                    const cryptoPricePerUnit = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0; // Price at time of donation
                    const cryptoDate = document.getElementById('donationDate').value;

                    // Get crypto type from name or default
                    const cryptoName = document.getElementById('cryptoName').value;
                    formData.crypto_type = cryptoName; // Full name like "Bitcoin"
                    formData.crypto_symbol = document.getElementById('cryptoSymbol').value.toUpperCase();
                    formData.crypto_quantity = cryptoQuantity;
                    formData.fair_market_value = cryptoQuantity * cryptoPricePerUnit; // Calculate and store total value
                    formData.cost_basis = parseFloat(document.getElementById('cryptoCostBasis').value) || 0;
                    formData.amount = cryptoQuantity * cryptoPricePerUnit; // Total donation value
                    formData.donation_date = cryptoDate;
                    break;
            }

            try {
                const url = isEditing ? `/api/donations/${window.editingDonationId}` : '/api/donations';
                const method = isEditing ? 'PUT' : 'POST';

                // Get user token for authorization
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                console.log('[DEBUG] Sending request to:', url);
                console.log('[DEBUG] Request method:', method);
                console.log('[DEBUG] Request body:', JSON.stringify(formData, null, 2));

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('[DEBUG] Response status:', response.status);

                // Check if response is JSON (API available) or HTML (404)
                const contentType = response.headers.get("content-type");
                let data;

                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    // API endpoint not available - simulate success for demo
                    if (isEditing) {
                        showToast('⚠️ Edit saved locally only (API endpoint not yet implemented)', 'info');
                    }
                    data = { success: true };
                }

                if (data.success) {
                    closeDonationModal();
                    // Clear editing flag
                    delete window.editingDonationId;
                    // Reset modal title
                    document.querySelector('#donationModal .modal-header h2').textContent = 'Add Donation';

                    // Show success message
                    showToast(isEditing ? 'Donation updated successfully!' : '✅ Donation added successfully!', 'success');

                    // Switch to dashboard view
                    showSection('dashboard');

                    // Refresh the dashboard to show new donation
                    loadDonations();
                    loadStats();
                    loadCharities(); // Refresh charities to show the one with donation
                } else {
                    console.error('[DEBUG] API error response:', data);
                    showToast(`Failed to ${isEditing ? 'update' : 'add'} donation: ` + data.error, 'error');
                }
            } catch (error) {
                console.error(`[DEBUG] Error ${isEditing ? 'updating' : 'adding'} donation:`, error);
                console.error('[DEBUG] Error stack:', error.stack);
                alert(`Failed to ${isEditing ? 'update' : 'add'} donation. Check console for details.`);
            }
        });

        document.getElementById('charityForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('=== ADD CHARITY FORM SUBMISSION ===');

            // Check for missing form elements
            const requiredFields = ['charityName', 'charityEIN', 'charityCategory', 'charityAddress',
                                   'charityCity', 'charityState', 'charityZip', 'charityPhone',
                                   'charityWebsite', 'charityDescription'];

            for (const fieldId of requiredFields) {
                const element = document.getElementById(fieldId);
                if (!element) {
                    const errorMsg = `ERROR: Missing form element with ID: ${fieldId}`;
                    console.error(errorMsg);
                    showToast(`Form error: Missing field ${fieldId}. Please refresh the page.`, 'error');
                    return;
                }
            }

            const formData = {
                name: document.getElementById('charityName').value,
                ein: document.getElementById('charityEIN').value,
                category: document.getElementById('charityCategory').value,
                address: document.getElementById('charityAddress').value,
                city: document.getElementById('charityCity').value,
                state: document.getElementById('charityState').value,
                zip_code: document.getElementById('charityZip').value,
                phone: document.getElementById('charityPhone').value,
                website: document.getElementById('charityWebsite').value,
                description: document.getElementById('charityDescription').value
            };

            console.log('Form data collected:', formData);

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                console.log('Sending request to /api/charities/add-personal');
                console.log('Auth token:', token ? 'Present' : 'Missing');

                const response = await fetch('/api/charities/add-personal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Response was:', responseText);
                    showToast('Server error: Invalid response format', 'error');
                    return;
                }

                console.log('Parsed response data:', data);

                if (data.success) {
                    console.log('SUCCESS: Charity added successfully');
                    showToast('Personal charity added successfully! It\'s now available for your donations.', 'success');
                    closeCharityModal();

                    // If we came from the donation modal, re-open it with the new charity selected
                    if (window.addingCharityFromDonation) {
                        showAddDonation();
                        // Pre-select the new charity
                        const charityInput = document.getElementById('donationCharity');
                        const charityIdInput = document.getElementById('selectedCharityId');
                        if (charityInput && charityIdInput) {
                            charityInput.value = formData.name;
                            charityIdInput.value = data.charity.id;
                            // Track the selected charity name to prevent clearing on input events
                            window.lastSelectedCharityName = formData.name;
                        }
                        window.addingCharityFromDonation = false;
                    }
                } else {
                    showToast('Failed to add charity: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error adding charity:', error);
                showToast('Failed to add charity. Please try again.', 'error');
            }
        });

        // Edit charity form submission handler
        document.getElementById('editCharityForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('=== EDIT CHARITY FORM SUBMISSION ===');

            // Check for missing form elements
            const requiredFields = ['editCharityId', 'editCharityName', 'editCharityEIN', 'editCharityCategory',
                                   'editCharityAddress', 'editCharityCity', 'editCharityState', 'editCharityZip',
                                   'editCharityPhone', 'editCharityWebsite', 'editCharityDescription'];

            for (const fieldId of requiredFields) {
                const element = document.getElementById(fieldId);
                if (!element) {
                    const errorMsg = `ERROR: Missing form element with ID: ${fieldId}`;
                    console.error(errorMsg);
                    showToast(`Form error: Missing field ${fieldId}. Please refresh the page.`, 'error');
                    return;
                }
            }

            const charityId = document.getElementById('editCharityId').value;
            const formData = {
                name: document.getElementById('editCharityName').value,
                ein: document.getElementById('editCharityEIN').value,
                category: document.getElementById('editCharityCategory').value,
                address: document.getElementById('editCharityAddress').value,
                city: document.getElementById('editCharityCity').value,
                state: document.getElementById('editCharityState').value,
                zip_code: document.getElementById('editCharityZip').value,
                phone: document.getElementById('editCharityPhone').value,
                website: document.getElementById('editCharityWebsite').value,
                description: document.getElementById('editCharityDescription').value
            };

            console.log('Edit form data collected:', formData);
            console.log('Charity ID:', charityId);

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                console.log(`Sending request to /api/charities/update-personal/${charityId}`);
                console.log('Auth token:', token ? 'Present' : 'Missing');

                const response = await fetch(`/api/charities/update-personal/${charityId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Response was:', responseText);
                    showToast('Server error: Invalid response format', 'error');
                    return;
                }

                console.log('Parsed response data:', data);

                if (data.success) {
                    console.log('SUCCESS: Charity updated successfully');
                    showToast('Charity updated successfully!', 'success');
                    closeEditCharityModal();
                    loadCharities(); // Refresh the charity list
                } else {
                    showToast('Failed to update charity: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error updating charity:', error);
                showToast('Failed to update charity. Please try again.', 'error');
            }
        });

        // Update year filter
        function updateYearFilter() {
            const year = document.getElementById('globalYearFilter').value;
            console.log('[YEAR FILTER] Changed to:', year);

            // Sync with report year dropdown
            const reportYear = document.getElementById('reportYear');
            if (reportYear) {
                reportYear.value = year;
            }

            // Reload data with new filter
            console.log('[YEAR FILTER] Reloading data for year:', year);
            loadDonations();
            loadStats();
            loadCharities();
        }

        // Load and display donations
        async function loadDonations() {
            const container = document.getElementById('donationsContent');
            // Default to current year if no year selected
            const year = document.getElementById('globalYearFilter')?.value || new Date().getFullYear().toString();

            console.log('[LOAD DONATIONS] Loading donations for year:', year);

            // Update the title to show the year
            const titleElement = document.getElementById('donationHistoryTitle');
            if (titleElement) {
                titleElement.textContent = `Donation History (${year === 'all' ? 'All Years' : year})`;
            }

            try {
                // Load ALL donations for the year, not just 10
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }
                console.log('[LOAD DONATIONS] API URL:', url);

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    // Update global variable for filtering (no localStorage cache)
                    allDonations = data.donations; // Update global variable for filtering

                    // Display ALL donations for the selected year (no limit)
                    let html = `<div style="margin-bottom: 0.5rem; color: #6b7280; font-size: 0.875rem;">Showing ${data.donations.length} donation${data.donations.length !== 1 ? 's' : ''} for ${year === 'all' ? 'all years' : year}</div>`;
                    html += '<table class="table"><thead><tr><th>Donation Date</th><th>Charity</th><th>Type</th><th>Amount</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
                    data.donations.forEach(donation => {
                        // Parse date correctly to avoid timezone issues
                        const dateStr = donation.date || donation.donation_date;
                        let date;
                        if (dateStr) {
                            // If date is in YYYY-MM-DD format, parse it correctly
                            if (dateStr.includes('-')) {
                                const [year, month, day] = dateStr.split('-');
                                date = `${month}/${day}/${year}`;
                            } else {
                                date = new Date(dateStr).toLocaleDateString();
                            }
                        } else {
                            date = 'Unknown';
                        }
                        const typeIcons = {
                            'cash': '💵',
                            'items': '🎁',
                            'miles': '🚗',
                            'stock': '📈',
                            'crypto': '🪙'
                        };
                        const typeIcon = typeIcons[donation.donation_type] || '💵';

                        // Build type display - just show the donation type
                        let typeDisplay = `${typeIcon} ${donation.donation_type || 'cash'}`;
                        if (donation.donation_type === 'miles') {
                            typeDisplay = `${typeIcon} mileage`;
                        }

                        // Only show user-entered notes, nothing else
                        let displayNotes = parseNotesDisplay(donation.notes || '');

                        // Add personal charity indicator
                        const isPersonalCharity = !!donation.user_charity_id;
                        const charityDisplay = isPersonalCharity
                            ? `${donation.charity_name || 'Unknown'} <span style="background: #fbbf24; color: #78350f; font-size: 0.7rem; padding: 0.125rem 0.375rem; border-radius: 3px; font-weight: bold; margin-left: 0.25rem;">P</span>`
                            : (donation.charity_name || 'Unknown');

                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${charityDisplay}</td>
                                <td>${typeDisplay}</td>
                                <td>$${formatCurrency(donation.donation_type === 'items' ? (donation.estimated_value || donation.amount) : donation.amount, true)}</td>
                                <td>${displayNotes}</td>
                                <td style="white-space: nowrap; position: relative;">
                                    <div class="dropdown" style="display: inline-block;">
                                        <button class="btn-action" onclick="toggleActionMenu(event, '${donation.id}')" title="Actions">⋯</button>
                                        <div id="actionMenu-${donation.id}" class="dropdown-menu" style="display: none; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 150px;">
                                            <button onclick="viewDonationDetails('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; hover: background: #f3f4f6;">👁️ View Details</button>
                                            <button onclick="editDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">✏️ Edit</button>
                                            <button onclick="addReceipt('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">📎 Add Receipt</button>
                                            <hr style="margin: 0; border: none; border-top: 1px solid #e5e7eb;">
                                            <button onclick="deleteDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: #ef4444;">🗑️ Delete</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;

                    // Apply current filters after loading
                    filterDonations();
                } else {
                    // Keep empty state
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>No donations yet. Add your first donation to get started!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load donations:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            // Default to current year if no year selected
            const year = document.getElementById('globalYearFilter')?.value || new Date().getFullYear().toString();

            // Update labels with selected year (tax percentage will be updated after fetching rate)
            if (year === 'all') {
                document.getElementById('totalDonationsLabel').textContent = 'Total Donations (All Years)';
            } else {
                document.getElementById('totalDonationsLabel').textContent = `Total Donations (${year})`;
            }

            try {
                // Fetch donations for the selected year
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations) {
                    // Calculate totals from donations
                    const totalAmount = data.donations.reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);

                    // Count unique charities
                    const uniqueCharities = new Set(data.donations.map(d => d.charity_id)).size;

                    // Calculate tax savings based on year-specific tax rate
                    let taxRate = 0;
                    let hasValidTaxSettings = false;

                    // Get tax rate for the selected year (or current year if "all")
                    const taxYear = year === 'all' ? new Date().getFullYear().toString() : year;
                    taxRate = await getTaxRateForYear(taxYear);
                    hasValidTaxSettings = taxRate > 0;

                    // Update currentTaxRate for display purposes
                    currentTaxRate = taxRate;

                    const estimatedSavings = totalAmount * taxRate;

                    // Update display with proper formatting
                    document.getElementById('totalDonations').textContent = `$${formatCurrency(totalAmount)}`;
                    document.getElementById('donationCount').textContent = (data.total || data.donations.length).toString();
                    document.getElementById('charityCount').textContent = uniqueCharities.toString();

                    // Update tax savings label with percentage
                    const percentage = Math.round(taxRate * 100);
                    document.getElementById('taxSavingsLabel').textContent =
                        percentage > 0 ? `Est. Tax Savings (${percentage}%)` : 'Est. Tax Savings (Not Set)';

                    // Update tax savings display
                    if (!hasValidTaxSettings && totalAmount > 0) {
                        document.getElementById('taxSavings').innerHTML =
                            '<a href="#" onclick="showSection(\'profile\'); return false;" style="color: #667eea; text-decoration: underline; font-size: 0.9rem;">Set tax info</a>';
                    } else {
                        document.getElementById('taxSavings').textContent = `$${formatCurrency(estimatedSavings)}`;
                    }
                } else {
                    // No donations, show zeros
                    document.getElementById('totalDonations').textContent = '$0';
                    document.getElementById('donationCount').textContent = '0';
                    document.getElementById('charityCount').textContent = '0';
                    document.getElementById('taxSavings').textContent = '$0';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
                // Show zeros on error
                document.getElementById('totalDonations').textContent = '$0';
                document.getElementById('donationCount').textContent = '0';
                document.getElementById('charityCount').textContent = '0';
                document.getElementById('taxSavings').textContent = '$0';
            }
        }

        // Load and display all charities with donations
        async function loadCharities() {
            const container = document.getElementById('charitiesContent');
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            try {
                // Get auth token
                const token = localStorage.getItem('token');

                // Fetch all donations to get unique charities (get all years for comparison)
                let url = '/api/donations?limit=10000';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    // Group donations by charity and year
                    const charitiesMap = new Map();
                    data.donations.forEach(donation => {
                        // Use unified_charity_id which combines charity_id and user_charity_id
                        const charityId = donation.unified_charity_id || donation.charity_id || donation.user_charity_id;
                        if (!charityId) return; // Skip if no charity ID

                        // Get donation year
                        const donationDate = new Date(donation.date || donation.donation_date);
                        const donationYear = donationDate.getFullYear();

                        if (!charitiesMap.has(charityId)) {
                            charitiesMap.set(charityId, {
                                id: charityId,
                                name: donation.charity_name || 'Unknown',
                                ein: donation.charity_ein,
                                category: donation.charity_category || 'Other',
                                source: donation.charity_source || 'system',
                                total2024: 0,
                                total2025: 0,
                                count2024: 0,
                                count2025: 0,
                                lastDonation: donation.date || donation.donation_date
                            });
                        }
                        const charity = charitiesMap.get(charityId);
                        const donationAmount = donation.donation_type === 'items' ? parseFloat(donation.estimated_value || donation.amount || 0) : parseFloat(donation.amount || 0);

                        // Add to appropriate year
                        if (donationYear === 2024) {
                            charity.total2024 += donationAmount;
                            charity.count2024++;
                        } else if (donationYear === 2025) {
                            charity.total2025 += donationAmount;
                            charity.count2025++;
                        }

                        if ((donation.date || donation.donation_date) > charity.lastDonation) {
                            charity.lastDonation = donation.date || donation.donation_date;
                        }
                    });

                    // Convert to array and sort alphabetically by name
                    const charities = Array.from(charitiesMap.values())
                        .sort((a, b) => a.name.localeCompare(b.name));

                    // Create minimalist list for left side with 2024/2025 columns
                    let html = '<div style="font-size: 0.9rem;">';

                    charities.forEach((charity, index) => {
                        // Create compact single-line format with year columns
                        const format2024 = charity.total2024 > 0 ? `$${formatCurrency(charity.total2024, true)}` : '-';
                        const format2025 = charity.total2025 > 0 ? `$${formatCurrency(charity.total2025, true)}` : '-';
                        const charityIndex = 'charity_' + index;

                        html += `
                            <div style="display: flex; align-items: center; padding: 0.625rem 0.5rem; border-bottom: 1px solid #e5e7eb; position: relative;"
                                 onmouseover="this.style.backgroundColor='#f9fafb'"
                                 onmouseout="this.style.backgroundColor='transparent'">
                                <div style="flex: 1; min-width: 0; overflow: hidden; padding-right: 1rem;">
                                    <span style="font-weight: 500; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                                        ${charity.name}
                                    </span>
                                </div>
                                <div style="width: 100px; text-align: center; color: #059669; font-weight: 600;">
                                    ${format2024}
                                </div>
                                <div style="width: 100px; text-align: center; color: #059669; font-weight: 600;">
                                    ${format2025}
                                </div>
                                <div style="width: 60px; text-align: center; position: relative;">
                                    <button class="btn-action" onclick="toggleCharityMenu(event, '${charityIndex}')"
                                            style="padding: 0.25rem 0.4rem; font-size: 0.875rem;" title="Actions">
                                        ⋯
                                    </button>
                                    <div id="charityMenu-${charityIndex}" class="dropdown-menu"
                                         style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #e5e7eb;
                                                border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 180px;">
                                        <a onclick="showCharityInfo('${charity.id}', '${charity.name.replace(/'/g, "\\''")}', '${charity.ein || ''}', '${charity.category || ''}', '${charity.source || 'system'}')"
                                           style="display: block; padding: 0.5rem 1rem; color: #374151; text-decoration: none; cursor: pointer; font-size: 0.875rem;"
                                           onmouseover="this.style.backgroundColor='#f3f4f6'"
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            ℹ️ Charity Info
                                        </a>
                                        <a onclick="quickAddDonation('${charity.id}', '${charity.name.replace(/'/g, "\\''")}', '${charity.source || 'system'}')"
                                           style="display: block; padding: 0.5rem 1rem; color: #374151; text-decoration: none; cursor: pointer; font-size: 0.875rem;"
                                           onmouseover="this.style.backgroundColor='#f3f4f6'"
                                           onmouseout="this.style.backgroundColor='transparent'">
                                            ➕ Quick Add
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;

                    // Update insights panel with year-over-year data
                    const insightsContainer = document.getElementById('insightsContent');
                    if (insightsContainer && charities.length > 0) {
                        // Calculate totals for each year
                        let total2024 = 0;
                        let total2025 = 0;
                        let charitiesWithBothYears = 0;

                        charities.forEach(charity => {
                            total2024 += charity.total2024;
                            total2025 += charity.total2025;
                            if (charity.total2024 > 0 && charity.total2025 > 0) {
                                charitiesWithBothYears++;
                            }
                        });

                        // Find top charity by total amount
                        const topCharity = charities.reduce((max, charity) => {
                            const charityTotal = charity.total2024 + charity.total2025;
                            const maxTotal = max.total2024 + max.total2025;
                            return charityTotal > maxTotal ? charity : max;
                        }, charities[0]);

                        // Find charity with biggest YoY growth
                        let topGrowthCharity = null;
                        let topGrowthPercent = 0;
                        charities.forEach(charity => {
                            if (charity.total2024 > 0 && charity.total2025 > 0) {
                                const growthPercent = ((charity.total2025 - charity.total2024) / charity.total2024) * 100;
                                if (growthPercent > topGrowthPercent) {
                                    topGrowthPercent = growthPercent;
                                    topGrowthCharity = charity;
                                }
                            }
                        });

                        // Calculate YoY change
                        const yoyChange = total2024 > 0 ? ((total2025 - total2024) / total2024 * 100).toFixed(1) : 0;
                        const yoyColor = yoyChange > 0 ? '#059669' : yoyChange < 0 ? '#dc2626' : '#6b7280';
                        const yoySymbol = yoyChange > 0 ? '↑' : yoyChange < 0 ? '↓' : '';

                        insightsContainer.innerHTML = `
                            <div style="margin-bottom: 1.25rem;">
                                <div style="font-size: 0.875rem; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.025em; margin-bottom: 0.5rem; border-bottom: 2px solid #10b981; padding-bottom: 0.25rem;">Year-over-Year</div>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                                    <span style="color: #6b7280; font-size: 0.875rem;">2024:</span>
                                    <span style="font-weight: 500;">$${formatCurrency(total2024, true)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                                    <span style="color: #6b7280; font-size: 0.875rem;">2025:</span>
                                    <span style="font-weight: 500;">$${formatCurrency(total2025, true)}</span>
                                </div>
                                ${total2024 > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-top: 0.25rem;">
                                    <span style="color: #6b7280; font-size: 0.875rem;">Change:</span>
                                    <span style="color: ${yoyColor}; font-weight: 600;">${yoySymbol} ${Math.abs(yoyChange)}%</span>
                                </div>` : ''}
                            </div>
                            <div style="margin-bottom: 1.25rem;">
                                <div style="font-size: 0.875rem; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.025em; margin-bottom: 0.5rem; border-bottom: 2px solid #10b981; padding-bottom: 0.25rem;">Top Charity Overall</div>
                                <div style="font-weight: 600; color: #1f2937; margin-top: 0.25rem; font-size: 0.95rem;">${topCharity.name}</div>
                                <div style="color: #059669; font-weight: 500;">$${formatCurrency(topCharity.total2024 + topCharity.total2025, true)}</div>
                            </div>
                            ${topGrowthCharity ? `
                            <div>
                                <div style="font-size: 0.875rem; color: #1f2937; font-weight: 700; text-transform: uppercase; letter-spacing: 0.025em; margin-bottom: 0.5rem; border-bottom: 2px solid #10b981; padding-bottom: 0.25rem;">Highest Growth</div>
                                <div style="font-weight: 600; color: #1f2937; margin-top: 0.25rem; font-size: 0.95rem;">${topGrowthCharity.name}</div>
                                <div style="color: #059669; font-size: 0.875rem;">↑ ${topGrowthPercent.toFixed(0)}% YoY</div>
                            </div>` : ''}
                        `;
                    } else if (insightsContainer) {
                        insightsContainer.innerHTML = '<p style="color: #9ca3af; font-size: 0.875rem;">Add donations to see insights</p>';
                    }
                } else {
                    // Show empty state when no donations exist
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🏛️</div>
                            <p>No charities with donations yet. Add your first donation to get started!</p>
                        </div>
                    `;
                }

                // Update charity count in stats if not already updated
                // This is handled in loadStats() so we don't need to do it again

            } catch (error) {
                console.error('Failed to load charities:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <p>Failed to load charities. Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        // Export functions
        async function exportCSV() {
            try {
                // Fetch all donations for the selected year
                const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || new Date().getFullYear().toString();
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    alert('No donations to export');
                    return;
                }

                // Create CSV content with ALL columns for proper re-import
                let csvContent = 'date,charity_name,donation_type,amount,notes,' +
                    'miles_driven,mileage_rate,mileage_purpose,' +
                    'stock_symbol,stock_quantity,fair_market_value,' +
                    'crypto_symbol,crypto_quantity,crypto_type,' +
                    'item_description,estimated_value,description\n';

                data.donations.forEach(donation => {
                    const date = new Date(donation.donation_date || donation.date).toLocaleDateString();
                    const charity = (donation.charity_name || 'Unknown').replace(/,/g, ';');
                    const type = donation.donation_type || 'cash';
                    const amount = parseFloat(donation.amount).toFixed(2);
                    const notes = (donation.notes || '').replace(/,/g, ';').replace(/"/g, '""');

                    // Type-specific fields
                    const miles_driven = donation.miles_driven || '';
                    const mileage_rate = donation.mileage_rate || '';
                    const mileage_purpose = (donation.mileage_purpose || '').replace(/,/g, ';');

                    const stock_symbol = donation.stock_symbol || '';
                    const stock_quantity = donation.stock_quantity || '';
                    const fair_market_value = donation.fair_market_value || '';

                    const crypto_symbol = donation.crypto_symbol || '';
                    const crypto_quantity = donation.crypto_quantity || '';
                    const crypto_type = (donation.crypto_type || '').replace(/,/g, ';');

                    const item_description = (donation.item_description || '').replace(/,/g, ';');
                    const estimated_value = donation.estimated_value || '';

                    // Human-readable description for reference
                    const description = getDescriptionForType(donation).replace(/,/g, ';').replace(/"/g, '""');

                    csvContent += `${date},"${charity}",${type},${amount},"${notes}",` +
                        `${miles_driven},${mileage_rate},"${mileage_purpose}",` +
                        `${stock_symbol},${stock_quantity},${fair_market_value},` +
                        `${crypto_symbol},${crypto_quantity},"${crypto_type}",` +
                        `"${item_description}",${estimated_value},"${description}"\n`;
                });

                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const filename = selectedYear === 'all' ? 'donations_all.csv' : `donations_${selectedYear}.csv`;
                link.download = filename;
                link.click();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export donations. Please try again.');
            }
        }

        async function exportPDF() {
            try {
                // Fetch all donations for the selected year
                const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || new Date().getFullYear().toString();
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    alert('No donations to export');
                    return;
                }

                // Create HTML content for PDF
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Donation Report ${selectedYear === 'all' ? 'All Years' : selectedYear}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; }
                            h1 { color: #667eea; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .summary { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
                            .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                        </style>
                    </head>
                    <body>
                        <h1>Tax Deductible Donations - ${selectedYear === 'all' ? 'All Years' : selectedYear}</h1>
                        <div class="summary">
                            <h2>Summary</h2>
                            <p><strong>Total Donations:</strong> $${data.donations.reduce((sum, d) => sum + parseFloat(d.amount), 0).toFixed(2)}</p>
                            <p><strong>Number of Donations:</strong> ${data.donations.length}</p>
                            <p><strong>Report Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Donation Date</th>
                                    <th>Charity</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.donations.forEach(donation => {
                    const date = new Date(donation.donation_date).toLocaleDateString();
                    const description = getDescriptionForType(donation);
                    htmlContent += `
                        <tr>
                            <td>${date}</td>
                            <td>${donation.charity_name || 'Unknown'}</td>
                            <td>${donation.donation_type || 'cash'}</td>
                            <td>$${formatCurrency(donation.donation_type === 'items' ? (donation.estimated_value || donation.amount) : donation.amount, true)}</td>
                            <td>${description}</td>
                            <td>${parseNotesDisplay(donation.notes)}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>This report is for tax preparation purposes. Please consult with your tax advisor.</p>
                            <p>Generated by Charity Tracker v2.11.49</p>
                        </div>
                    </body>
                    </html>
                `;

                // Open in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export donations. Please try again.');
            }
        }

        function getDescriptionForType(donation) {
            switch(donation.donation_type) {
                case 'items':
                    return donation.item_description || 'Donated items';
                case 'miles':
                    return `${donation.miles_driven || 0} miles @ $${donation.mileage_rate || 0.14}/mile - ${donation.mileage_purpose || 'Charity work'}`;
                case 'stock':
                    const stockTotal = (donation.shares_donated || 0) * (donation.fair_market_value || 0);
                    return `${donation.stock_symbol || 'Stock'}: ${donation.shares_donated || 0} shares @ $${donation.fair_market_value || 0}/share = $${stockTotal.toFixed(2)}`;
                case 'crypto':
                    const cryptoTotal = (donation.crypto_quantity || 0) * (donation.crypto_price_per_unit || 0);
                    const cryptoTime = donation.crypto_donation_datetime ? new Date(donation.crypto_donation_datetime).toLocaleTimeString() : '';
                    return `${donation.crypto_symbol || 'Crypto'}: ${donation.crypto_quantity || 0} units @ $${donation.crypto_price_per_unit || 0}/unit = $${cryptoTotal.toFixed(2)} (${cryptoTime})`;
                case 'cash':
                default:
                    return 'Cash donation';
            }
        }

        // Tax rate calculations (2024 rates)
        const taxBrackets = {
            single: [
                {min: 0, max: 11600, rate: 0.10},
                {min: 11600, max: 47150, rate: 0.12},
                {min: 47150, max: 100525, rate: 0.22},
                {min: 100525, max: 191950, rate: 0.24},
                {min: 191950, max: 243725, rate: 0.32},
                {min: 243725, max: 609350, rate: 0.35},
                {min: 609350, max: Infinity, rate: 0.37}
            ],
            married_jointly: [
                {min: 0, max: 23200, rate: 0.10},
                {min: 23200, max: 94300, rate: 0.12},
                {min: 94300, max: 201050, rate: 0.22},
                {min: 201050, max: 383900, rate: 0.24},
                {min: 383900, max: 487450, rate: 0.32},
                {min: 487450, max: 731200, rate: 0.35},
                {min: 731200, max: Infinity, rate: 0.37}
            ],
            married_separately: [
                {min: 0, max: 11600, rate: 0.10},
                {min: 11600, max: 47150, rate: 0.12},
                {min: 47150, max: 100525, rate: 0.22},
                {min: 100525, max: 191950, rate: 0.24},
                {min: 191950, max: 243725, rate: 0.32},
                {min: 243725, max: 365600, rate: 0.35},
                {min: 365600, max: Infinity, rate: 0.37}
            ],
            head_of_household: [
                {min: 0, max: 16550, rate: 0.10},
                {min: 16550, max: 63100, rate: 0.12},
                {min: 63100, max: 100500, rate: 0.22},
                {min: 100500, max: 191950, rate: 0.24},
                {min: 191950, max: 243700, rate: 0.32},
                {min: 243700, max: 609350, rate: 0.35},
                {min: 609350, max: Infinity, rate: 0.37}
            ]
        };

        const standardDeductions = {
            single: 14600,
            married_jointly: 29200,
            married_separately: 14600,
            head_of_household: 21900
        };

        let currentTaxRate = 0; // Default 0% until loaded from user settings
        let currentTaxBrackets = [];
        let currentStandardDeduction = 0; // Default 0 until loaded from database
        let taxRatesByYear = {}; // Store tax rates for each year

        // Load all tax info for all years at startup
        async function loadAllYearsTaxInfo() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = user.token || localStorage.getItem('token');
            const userId = user.id || user.userId;

            if (!userId || !token) return;

            const years = ['2024', '2025', '2026'];

            for (const year of years) {
                try {
                    const response = await fetch(`/api/tax/rates?year=${year}&user_id=${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Cache the tax rate
                        if (data.tax_bracket) {
                            taxRatesByYear[year] = data.tax_bracket;
                        } else {
                            taxRatesByYear[year] = 0;
                        }

                        // Update the display
                        const rateElem = document.getElementById(`rate${year}`);
                        const statusElem = document.getElementById(`status${year}`);
                        const deductionElem = document.getElementById(`deduction${year}`);

                        if (rateElem) {
                            if (data.tax_bracket) {
                                const percentage = Math.round(data.tax_bracket * 100);
                                rateElem.textContent = `${percentage}%`;
                            } else {
                                rateElem.textContent = '-';
                            }
                        }

                        if (statusElem) {
                            // Convert filing status to display format
                            const statusDisplay = {
                                'single': 'Single',
                                'married_jointly': 'Married Filing Jointly',
                                'married_separately': 'Married Filing Separately',
                                'head_of_household': 'Head of Household'
                            };
                            statusElem.textContent = statusDisplay[data.filing_status] || 'Not Set';
                        }

                        if (deductionElem) {
                            if (data.standard_deduction) {
                                deductionElem.textContent = `$${data.standard_deduction.toLocaleString()}`;
                            } else {
                                deductionElem.textContent = '-';
                            }
                        }

                        // Special handling for 2026 AGI and OBBBA threshold
                        if (year === '2026') {
                            const agiElem = document.getElementById('agi2026');
                            const thresholdElem = document.getElementById('threshold2026');

                            if (agiElem && data.agi_estimate) {
                                agiElem.textContent = `$${data.agi_estimate.toLocaleString()}`;
                            }

                            if (thresholdElem && data.agi_estimate) {
                                const threshold = Math.round(data.agi_estimate * 0.005);
                                thresholdElem.textContent = `$${threshold.toLocaleString()}`;
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Error loading tax info for ${year}:`, error);
                    taxRatesByYear[year] = 0;
                }
            }
        }

        // Load tax brackets from database
        async function loadTaxBrackets() {
            // Get elements and check if they exist
            const taxYearElem = document.getElementById('taxYear');
            const filingStatusElem = document.getElementById('filingStatus');
            const agiEstimateGroup = document.getElementById('agiEstimateGroup');

            // If core elements don't exist, we're not in the profile section
            if (!taxYearElem || !filingStatusElem) {
                return;
            }

            const taxYear = taxYearElem.value;
            const filingStatus = filingStatusElem.value;
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = user.token || localStorage.getItem('token') || 'test-token';

            // Show/hide AGI estimate field for 2026
            if (agiEstimateGroup) {
                agiEstimateGroup.style.display = taxYear === '2026' ? 'block' : 'none';
            }

            try {
                const userId = user.id || user.userId;
                const response = await fetch(`/api/tax/rates?year=${taxYear}&filing_status=${filingStatus}&user_id=${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    currentTaxBrackets = data.brackets || [];
                    currentStandardDeduction = data.standard_deduction || 0;

                    // Populate bracket dropdown
                    const bracketSelect = document.getElementById('taxBracket');
                    bracketSelect.innerHTML = '<option value="">Select your tax bracket</option>';

                    currentTaxBrackets.forEach(bracket => {
                        const rate = Math.round(bracket.rate * 100);
                        const minFormatted = '$' + bracket.min_income.toLocaleString();
                        const maxFormatted = bracket.max_income ?
                            '$' + bracket.max_income.toLocaleString() :
                            'and above';

                        const option = document.createElement('option');
                        option.value = bracket.rate;
                        option.textContent = `${rate}% (${minFormatted} - ${maxFormatted})`;
                        bracketSelect.appendChild(option);
                    });

                    // Update standard deduction display if element exists
                    const standardDeductionElem = document.getElementById('standardDeduction');
                    if (standardDeductionElem) {
                        if (currentStandardDeduction > 0) {
                            standardDeductionElem.textContent = '$' + currentStandardDeduction.toLocaleString();
                        } else {
                            standardDeductionElem.textContent = 'Not set';
                            standardDeductionElem.style.color = '#6b7280';
                            standardDeductionElem.style.fontStyle = 'italic';
                        }
                    }

                    // If user has saved settings for this year, select them
                    if (data.tax_bracket) {
                        bracketSelect.value = data.tax_bracket;

                        // Also update filing status if it came from saved settings
                        if (data.source === 'user_settings' && data.filing_status) {
                            document.getElementById('filingStatus').value = data.filing_status;
                        }

                        // Load AGI estimate if available
                        if (data.agi_range && document.getElementById('agiEstimate')) {
                            document.getElementById('agiEstimate').value = data.agi_range;
                        }

                        updateTaxDisplay();
                    } else {
                        // No saved settings for this year - clear the display
                        updateTaxDisplay();
                    }
                }
            } catch (error) {
                console.error('Error loading tax brackets:', error);
                showToast('❌ Failed to load tax brackets', 'error');
            }
        }

        // Update tax display when bracket is selected
        function updateTaxDisplay() {
            const taxYearElem = document.getElementById('taxYear');
            const taxBracketElem = document.getElementById('taxBracket');

            if (!taxYearElem || !taxBracketElem) {
                return; // Elements not ready yet
            }

            const taxYear = taxYearElem.value;
            const bracketRate = parseFloat(taxBracketElem.value);

            // Update current editing year
            const currentEditYear = document.getElementById('currentEditYear');
            if (currentEditYear) currentEditYear.textContent = taxYear;

            // Update donation form display
            if (bracketRate) {
                currentTaxRate = bracketRate;
                const percentage = Math.round(bracketRate * 100);
                const rateDisplay = document.getElementById('taxRateDisplay');
                if (rateDisplay) rateDisplay.textContent = percentage;
                updateTaxSavings();
            } else {
                // No bracket selected
                currentTaxRate = 0;
                const rateDisplay = document.getElementById('taxRateDisplay');
                if (rateDisplay) rateDisplay.textContent = '0';
                updateTaxSavings();
            }

            // Load all years summary
            loadAllYearsSummary();
        }

        // Load and display tax settings for all configured years
        async function loadAllYearsSummary() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = user.token || localStorage.getItem('token') || 'test-token';
            const userId = user.id || user.userId;

            if (!userId) return;

            try {
                const years = ['2024', '2025', '2026'];

                for (const year of years) {
                    // Don't hardcode filing status - let API return user's saved settings
                    const response = await fetch(`/api/tax/rates?year=${year}&user_id=${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Format filing status display
                        const formatFilingStatus = (status) => {
                            if (!status) return 'Not Set';
                            const labels = {
                                'single': 'Single',
                                'married_jointly': 'Married Joint',
                                'married_separately': 'Married Sep.',
                                'head_of_household': 'Head of House'
                            };
                            return labels[status] || status;
                        };

                        // Update filing status
                        const statusElem = document.getElementById(`status${year}`);
                        if (statusElem) {
                            statusElem.textContent = data.filing_status ?
                                formatFilingStatus(data.filing_status) : 'Not Set';
                        }

                        // Update tax bracket
                        const rateElem = document.getElementById(`rate${year}`);
                        if (rateElem) {
                            if (data.tax_bracket) {
                                const rate = Math.round(data.tax_bracket * 100);
                                rateElem.textContent = `${rate}%`;
                            } else {
                                rateElem.textContent = '-';
                            }
                        }

                        // Update standard deduction
                        const deductionElem = document.getElementById(`deduction${year}`);
                        if (deductionElem) {
                            if (data.standard_deduction) {
                                deductionElem.textContent = `$${data.standard_deduction.toLocaleString()}`;
                            } else {
                                deductionElem.textContent = '-';
                            }
                        }

                        // For 2026, update AGI and threshold
                        if (year === '2026') {
                            const agiElem = document.getElementById('agi2026');
                            const thresholdElem = document.getElementById('threshold2026');

                            if (agiElem) {
                                if (data.agi_range) {
                                    agiElem.textContent = `$${parseInt(data.agi_range).toLocaleString()}`;

                                    // Calculate and display OBBBA threshold (0.5% of AGI)
                                    if (thresholdElem) {
                                        const threshold = parseInt(data.agi_range) * 0.005;
                                        thresholdElem.textContent = `$${Math.round(threshold).toLocaleString()}`;
                                    }
                                } else {
                                    agiElem.textContent = '-';
                                    if (thresholdElem) thresholdElem.textContent = '-';
                                }
                            }
                        }
                    } else {
                        // No data for this year - show defaults
                        const statusElem = document.getElementById(`status${year}`);
                        const rateElem = document.getElementById(`rate${year}`);
                        const deductionElem = document.getElementById(`deduction${year}`);

                        if (statusElem) statusElem.textContent = 'Not Set';
                        if (rateElem) rateElem.textContent = '-';
                        if (deductionElem) deductionElem.textContent = '-';

                        if (year === '2026') {
                            const agiElem = document.getElementById('agi2026');
                            const thresholdElem = document.getElementById('threshold2026');
                            if (agiElem) agiElem.textContent = '-';
                            if (thresholdElem) thresholdElem.textContent = '-';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading all years summary:', error);
            }
        }

        // Legacy function for compatibility
        function updateTaxRate() {
            loadTaxBrackets();
        }

        // Get tax rate for a specific year
        async function getTaxRateForYear(year) {
            // Check if we have it cached
            if (taxRatesByYear[year] !== undefined) {
                return taxRatesByYear[year];
            }

            // Load it from database
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = user.token || localStorage.getItem('token') || 'test-token';
            const userId = user.id || user.userId;

            if (!userId) {
                taxRatesByYear[year] = 0;
                return 0;
            }

            try {
                const response = await fetch(`/api/tax/rates?year=${year}&user_id=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.tax_bracket) {
                        taxRatesByYear[year] = data.tax_bracket;
                        return data.tax_bracket;
                    }
                }
            } catch (error) {
                console.error(`Error loading tax rate for year ${year}:`, error);
            }

            // Default to 0 if not found
            taxRatesByYear[year] = 0;
            return 0;
        }

        // Save profile information
        async function saveProfile() {
            const taxYear = document.getElementById('taxYear').value;
            const profileData = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                address: document.getElementById('profileAddress').value,
                city: document.getElementById('profileCity').value,
                state: document.getElementById('profileState').value,
                zipCode: document.getElementById('profileZip').value,
                filingStatus: document.getElementById('filingStatus').value,
                taxBracket: document.getElementById('taxBracket').value
            };

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                // Save to database via API
                const response = await fetch('/api/users/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (data.success) {
                    // Now save tax settings to user_tax_settings table
                    const taxSettingsData = {
                        user_id: user.id || user.userId,
                        tax_year: parseInt(taxYear),
                        filing_status: document.getElementById('filingStatus').value,
                        tax_bracket: parseFloat(document.getElementById('taxBracket').value),
                        agi_range: document.getElementById('agiEstimate') ?
                            document.getElementById('agiEstimate').value : null
                    };

                    // Save tax settings via the tax API
                    const taxResponse = await fetch('/api/tax/rates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(taxSettingsData)
                    });

                    const taxData = await taxResponse.json();

                    if (!taxData.success) {
                        console.error('Failed to save tax settings:', taxData.error);
                    } else {
                        // Update the cache with the new tax rate
                        taxRatesByYear[taxYear] = parseFloat(document.getElementById('taxBracket').value);
                    }

                    // Clear old localStorage data after successful save
                    localStorage.removeItem('userProfile');
                    localStorage.removeItem('taxRate');
                    localStorage.removeItem('filingStatus');
                    localStorage.removeItem('income');

                    // Update tax calculations and reload all years info
                    updateTaxDisplay();

                    // Reload all years tax info to update the display
                    await loadAllYearsTaxInfo();

                    // Reload stats to use new tax rate
                    await loadStats();

                    // Clear unsaved changes indicator
                    clearUnsavedChanges();

                    showToast('✅ Profile and tax settings saved successfully!', 'success');
                } else {
                    showToast('❌ Failed to save profile: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast('❌ Failed to save profile. Please try again.', 'error');
            }
        }

        // Load profile information
        async function loadProfile() {
            const userEmail = localStorage.getItem('userEmail');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = user.token || localStorage.getItem('token') || 'test-token';

            try {
                // First try to load from database
                const response = await fetch('/api/users/settings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.settings) {
                        const profile = data.settings;

                        // Load personal information
                        document.getElementById('profileName').value = profile.name || '';
                        document.getElementById('profileEmail').value = profile.email || userEmail || '';
                        document.getElementById('profileAddress').value = profile.address || '';
                        document.getElementById('profileCity').value = profile.city || '';
                        document.getElementById('profileState').value = profile.state || '';
                        document.getElementById('profileZip').value = profile.zipCode || '';

                        // Load tax information - set current year as default
                        const currentYear = new Date().getFullYear();
                        document.getElementById('taxYear').value = currentYear.toString();
                        document.getElementById('filingStatus').value = profile.filingStatus || 'single';

                        // Load tax brackets for current settings
                        await loadTaxBrackets();

                        // Load all years summary
                        await loadAllYearsSummary();

                        // ONE-TIME MIGRATION: If localStorage has data but database doesn't, migrate it
                        const savedProfile = localStorage.getItem('userProfile');
                        if (savedProfile && (!profile.filingStatus || !profile.incomeRange)) {
                            const localProfile = JSON.parse(savedProfile);
                            if (localProfile.filingStatus || localProfile.income) {
                                // Migrate localStorage tax settings to database
                                const migrateResponse = await fetch('/api/users/settings', {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        filingStatus: localProfile.filingStatus || profile.filingStatus || 'single',
                                        incomeRange: localProfile.income || localProfile.incomeRange || profile.incomeRange || '50000'
                                    })
                                });

                                if (migrateResponse.ok) {
                                    console.log('Successfully migrated tax settings from localStorage to database');
                                    // Clear localStorage after successful migration
                                    localStorage.removeItem('userProfile');
                                    localStorage.removeItem('taxRate');
                                    localStorage.removeItem('filingStatus');
                                    localStorage.removeItem('income');
                                }
                            }
                        }

                        // Update tax calculations
                        updateTaxRate();
                        return;
                    }
                }

                // If we can't load from database, show error
                showToast('⚠️ Could not load profile settings. Please check your connection.', 'warning');

            } catch (error) {
                console.error('Error loading profile from database:', error);
                showToast('⚠️ Could not load profile settings. Please check your connection.', 'warning');
            }

            // Set default values if no data available
            if (!document.getElementById('profileEmail').value) {
                document.getElementById('profileEmail').value = userEmail || '';
            }
            if (!document.getElementById('taxYear').value) {
                const currentYear = new Date().getFullYear();
                document.getElementById('taxYear').value = currentYear.toString();
            }
            if (!document.getElementById('filingStatus').value) {
                document.getElementById('filingStatus').value = 'single';
            }
            // Load tax brackets after setting defaults
            if (document.getElementById('taxBracket').options.length <= 1) {
                await loadTaxBrackets();
            }

            // Update tax calculations with defaults
            updateTaxRate();

            // Clear any unsaved changes indicator since we just loaded fresh data
            clearUnsavedChanges();
        }

        async function updateTaxSavings() {
            let amount = 0;
            const donationType = document.getElementById('donationType').value;

            // Get amount based on donation type
            switch(donationType) {
                case 'cash':
                    amount = parseFloat(document.getElementById('donationAmount').value) || 0;
                    break;
                case 'items':
                    amount = parseFloat(document.getElementById('estimatedValue').value) || 0;
                    break;
                case 'miles':
                    const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
                    amount = miles * 0.14;
                    break;
                case 'stock':
                    const stockShares = parseFloat(document.getElementById('stockQuantity').value) || 0;
                    const stockPrice = parseFloat(document.getElementById('fairMarketValue').value) || 0;
                    amount = stockShares * stockPrice; // Total = shares × price
                    break;
                case 'crypto':
                    const cryptoQty = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
                    const cryptoPrice = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
                    amount = cryptoQty * cryptoPrice;
                    break;
            }

            // Get year from donation date
            const dateStr = document.getElementById('donationDate').value;
            let taxRate = 0;

            if (dateStr) {
                const year = dateStr.split('-')[0]; // Date is in YYYY-MM-DD format
                taxRate = await getTaxRateForYear(year);
            } else {
                // Use current year if no date selected
                const currentYear = new Date().getFullYear().toString();
                taxRate = await getTaxRateForYear(currentYear);
            }

            // Update display
            document.getElementById('donationAmountDisplay').textContent = '$' + amount.toFixed(2);

            if (taxRate === 0) {
                // User hasn't set tax information for this year
                document.getElementById('taxRateDisplay').textContent = '0';
                document.getElementById('taxSavingsDisplay').innerHTML =
                    '<a href="#" onclick="showSection(\'profile\'); return false;" style="color: #667eea; text-decoration: underline;">Update profile for tax estimate</a>';
            } else {
                const savings = amount * taxRate;
                const percentage = Math.round(taxRate * 100);
                document.getElementById('taxRateDisplay').textContent = percentage.toString();
                document.getElementById('taxSavingsDisplay').textContent = '$' + savings.toFixed(2);
            }
        }

        // CSV Import functionality
        let importData = [];

        function showImportDonations() {
            // Navigate to tools section first
            showSection('tools');
            // Hide other panels
            document.getElementById('personalCharitiesPanel').style.display = 'none';
            document.getElementById('charityVerificationPanel').style.display = 'none';
            // Show import panel as full-screen overlay
            document.getElementById('importDonationsPanel').style.display = 'block';
        }

        function closeImportPanel() {
            document.getElementById('importDonationsPanel').style.display = 'none';
            // Reset the import state
            cancelImport();
        }

        function showPersonalCharities() {
            // Navigate to tools section first
            showSection('tools');
            // Hide other panels
            document.getElementById('importDonationsPanel').style.display = 'none';
            document.getElementById('charityVerificationPanel').style.display = 'none';
            // Show personal charities panel
            document.getElementById('personalCharitiesPanel').style.display = 'block';
            // Load personal charities
            loadPersonalCharities();
            // Scroll to the panel
            document.getElementById('personalCharitiesPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function showCharityVerification() {
            // Navigate to tools section first
            showSection('tools');
            // Hide other panels
            document.getElementById('importDonationsPanel').style.display = 'none';
            document.getElementById('personalCharitiesPanel').style.display = 'none';
            // Show verification panel
            document.getElementById('charityVerificationPanel').style.display = 'block';
            // Scroll to the panel
            document.getElementById('charityVerificationPanel').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadPersonalCharities() {
            const container = document.getElementById('personalCharitiesList');
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/charities/personal', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.charities && data.charities.length > 0) {
                    let html = '<div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">';
                    data.charities.forEach(charity => {
                        const statusColor = charity.is_approved ? '#10b981' : '#f59e0b';
                        const statusText = charity.is_approved ? 'Approved' : 'Pending';
                        html += `
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: #1f2937;">${charity.name}</h4>
                                    <span style="background: ${statusColor}22; color: ${statusColor}; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${statusText}</span>
                                </div>
                                ${charity.ein ? `<p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0;">EIN: ${charity.ein}</p>` : ''}
                                ${charity.category ? `<p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0;">Category: ${charity.category}</p>` : ''}
                                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                    <button class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="editPersonalCharity('${charity.id}')">Edit</button>
                                    <button class="btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="deletePersonalCharity('${charity.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No personal charities yet. Click "Add Personal Charity" to get started!</div>';
                }
            } catch (error) {
                console.error('Error loading personal charities:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Failed to load personal charities</div>';
            }
        }

        function showAddPersonalCharity() {
            // Open the add charity modal
            document.getElementById('addCharityModal').style.display = 'flex';
        }

        async function performCharityVerification() {
            const input = document.getElementById('verifyCharityInput').value.trim();
            const resultsDiv = document.getElementById('verificationResults');

            if (!input) {
                showToast('Please enter a charity name or EIN', 'warning');
                return;
            }

            resultsDiv.innerHTML = '<div style="padding: 1rem; background: #f3f4f6; border-radius: 8px;">🔍 Verifying...</div>';

            try {
                const response = await fetch(`/api/charities/verify?name=${encodeURIComponent(input)}`);
                const data = await response.json();

                if (data.success && data.verification) {
                    const v = data.verification;
                    if (v.isVerified) {
                        resultsDiv.innerHTML = `
                            <div style="padding: 1.5rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px;">
                                <h4 style="color: #065f46; margin: 0 0 1rem 0;">✅ Charity Verified!</h4>
                                <div style="color: #047857;">
                                    <p><strong>Name:</strong> ${v.name}</p>
                                    <p><strong>EIN:</strong> ${v.ein}</p>
                                    <p><strong>City:</strong> ${v.city}, ${v.state}</p>
                                    <p><strong>Status:</strong> IRS 501(c)(3) Approved</p>
                                </div>
                            </div>
                        `;
                    } else {
                        let html = `
                            <div style="padding: 1.5rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">
                                <h4 style="color: #92400e; margin: 0 0 1rem 0;">⚠️ Not Found in IRS Database</h4>
                                <p style="color: #92400e;">This charity was not found in the IRS Publication 78 database.</p>
                        `;
                        if (v.suggestions && v.suggestions.length > 0) {
                            html += '<p style="color: #92400e; margin-top: 1rem;"><strong>Did you mean:</strong></p><ul style="color: #92400e;">';
                            v.suggestions.forEach(s => {
                                html += `<li>${s.name} (${s.city}, ${s.state})</li>`;
                            });
                            html += '</ul>';
                        }
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    }
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 1rem; background: #fee; color: #c00; border-radius: 8px;">Verification failed. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error verifying charity:', error);
                resultsDiv.innerHTML = '<div style="padding: 1rem; background: #fee; color: #c00; border-radius: 8px;">Error verifying charity. Please try again.</div>';
            }
        }

        // Setup drag and drop
        const dropZone = document.getElementById('csvDropZone');
        const fileInput = document.getElementById('csvFileInput');

        dropZone?.addEventListener('click', () => fileInput.click());

        dropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#e0e7ff';
        });

        dropZone?.addEventListener('dragleave', () => {
            dropZone.style.background = '#f9fafb';
        });

        dropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#f9fafb';
            const files = e.dataTransfer.files;
            if (files.length) handleCSVFile(files[0]);
        });

        fileInput?.addEventListener('change', (e) => {
            if (e.target.files.length) handleCSVFile(e.target.files[0]);
        });

        function handleCSVFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            // Proper CSV parsing that handles quoted fields
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            const lines = csv.split('\n').filter(line => line.trim());
            const headers = parseCSVLine(lines[0].toLowerCase()).map(h => h.trim());

            importData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const donation = {};
                headers.forEach((header, index) => {
                    donation[header] = values[index] || '';
                });
                importData.push(donation);
            }

            showPreview();
        }

        function showPreview() {
            // Hide empty state, show preview content
            document.getElementById('importEmptyState').style.display = 'none';
            document.getElementById('previewContent').style.display = 'flex';
            document.getElementById('charityMatchingContent').style.display = 'none';
            document.getElementById('importResultsContent').style.display = 'none';

            // Show action buttons
            document.getElementById('importActions').style.display = 'flex';
            document.getElementById('validateBtn').style.display = 'inline-block';
            document.getElementById('confirmBtn').style.display = 'none';
            document.getElementById('doneBtn').style.display = 'none';

            // Show status bar
            document.getElementById('importStatusBar').style.display = 'block';
            document.getElementById('importStatusIcon').textContent = '📋';
            document.getElementById('importStatusText').textContent = `${importData.length} donations ready for validation`;

            // Calculate and show stats
            let totalAmount = 0;
            const typeCount = {};
            const charityCount = {};

            importData.forEach(d => {
                totalAmount += parseFloat(d.amount) || 0;
                const type = d.donation_type || d.type || 'cash';
                typeCount[type] = (typeCount[type] || 0) + 1;
                const charity = d.charity_name || 'Unknown';
                charityCount[charity] = (charityCount[charity] || 0) + 1;
            });

            // Update import stats
            document.getElementById('importStats').style.display = 'block';
            document.getElementById('importStatsContent').innerHTML = `
                <p style="margin: 0.25rem 0;"><strong>Total Rows:</strong> ${importData.length}</p>
                <p style="margin: 0.25rem 0;"><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
                <p style="margin: 0.25rem 0;"><strong>Unique Charities:</strong> ${Object.keys(charityCount).length}</p>
                <p style="margin: 0.25rem 0;"><strong>Types:</strong> ${Object.entries(typeCount).map(([type, count]) => `${type} (${count})`).join(', ')}</p>
            `;

            // Create preview table
            const table = document.getElementById('previewTable');
            let html = `<table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f3f4f6;">
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Row</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Charity</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Donation Date</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Type</th>
                        <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Amount</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Notes</th>
                    </tr>
                </thead>
                <tbody>`;

            importData.forEach((donation, index) => {
                const rowColor = index % 2 === 0 ? 'white' : '#f9fafb';
                html += `<tr style="background: ${rowColor};">
                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${index + 1}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${donation.charity_name || 'Unknown'}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${donation.donation_date || donation.date || ''}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">${donation.donation_type || donation.type || 'cash'}</td>
                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb;">$${(parseFloat(donation.amount) || 0).toFixed(2)}</td>
                    <td style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem;">${donation.notes || ''}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            table.innerHTML = html;
        }

        let charityMappings = {}; // Store user's charity selections
        let validationData = null; // Store validation results

        async function validateImport() {
            // Update status
            document.getElementById('importStatusIcon').textContent = '🔍';
            document.getElementById('importStatusText').textContent = 'Validating donations and matching charities...';

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                // Call validation API
                const response = await fetch('/api/donations/validate-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        donations: importData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    validationData = data.validation;

                    if (validationData.requiresUserAction) {
                        showCharityMatching(validationData);
                    } else if (validationData.canAutoImport) {
                        // All charities matched with high confidence
                        document.getElementById('importStatusIcon').textContent = '✅';
                        document.getElementById('importStatusText').textContent = 'All charities matched! Ready to import.';
                        document.getElementById('validateBtn').style.display = 'none';
                        document.getElementById('confirmBtn').style.display = 'inline-block';
                    }
                } else {
                    showToast('Validation failed: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Error validating import: ' + error.message, 'error');
            }
        }

        function showCharityMatching(validation) {
            // Hide preview, show charity matching
            document.getElementById('previewContent').style.display = 'none';
            document.getElementById('charityMatchingContent').style.display = 'flex';

            // Update status
            document.getElementById('importStatusIcon').textContent = '⚠️';
            document.getElementById('importStatusText').textContent = `${validation.rowsNeedingConfirmation} donations need charity confirmation`;

            // Build matching interface
            const matchTable = document.getElementById('charityMatchTable');
            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';

            Object.entries(validation.charityMatches).forEach(([rowNum, matchData]) => {
                if (matchData.needsConfirmation) {
                    html += `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.75rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0; color: #1e293b;">Row ${rowNum}: "${matchData.searchName}"</h4>
                                    <p style="margin: 0.25rem 0 0 0; color: #64748b; font-size: 0.875rem;">
                                        Select the matching charity or create as personal charity
                                    </p>
                                </div>
                            </div>`;

                    if (matchData.matches && matchData.matches.length > 0) {
                        // Create a proper scrollable window for matches
                        html += `
                            <div style="margin-top: 0.75rem;">
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem;">
                                    Select from ${matchData.matches.length} potential match${matchData.matches.length > 1 ? 'es' : ''}:
                                </div>
                                <div style="border: 2px solid #e5e7eb; border-radius: 8px; background: white; max-height: 280px; overflow-y: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="padding: 0.5rem;">`;

                        matchData.matches.forEach((match, index) => {
                            const isSelected = index === 0; // Default to first match
                            const bgColor = isSelected ? '#eff6ff' : (index % 2 === 0 ? 'white' : '#f9fafb');
                            html += `
                                <label style="display: flex; align-items: center; padding: 0.625rem; background: ${bgColor}; border: 2px solid ${isSelected ? '#3b82f6' : 'transparent'}; border-radius: 6px; cursor: pointer; margin-bottom: 0.25rem; transition: all 0.15s;"
                                       onmouseover="if(!this.querySelector('input').checked) this.style.background='#f0f9ff'"
                                       onmouseout="if(!this.querySelector('input').checked) this.style.background='${bgColor}'">
                                    <input type="radio" name="charity_${rowNum}" value="${match.charity.id}" ${isSelected ? 'checked' : ''}
                                           onchange="selectImportCharity(${rowNum}, '${match.charity.id}', '${match.charity.type}'); updateMatchSelection(this)"
                                           style="margin-right: 0.75rem; flex-shrink: 0;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 500; color: #1e293b; overflow: hidden; text-overflow: ellipsis;" title="${match.charity.name}">
                                            ${match.charity.name}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.125rem;">
                                            ${match.charity.ein ? `EIN: ${match.charity.ein} • ` : ''}
                                            <span style="font-weight: 500; color: ${match.confidence >= 80 ? '#10b981' : match.confidence >= 60 ? '#f59e0b' : '#6b7280'};">
                                                ${match.confidence}% match
                                            </span>
                                        </div>
                                    </div>
                                    <span style="background: ${match.charity.type === 'system' ? '#10b981' : '#8b5cf6'}22;
                                                 color: ${match.charity.type === 'system' ? '#10b981' : '#8b5cf6'};
                                                 padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; white-space: nowrap; margin-left: 0.5rem; font-weight: 500;">
                                        ${match.charity.type === 'system' ? 'IRS' : 'Personal'}
                                    </span>
                                </label>`;
                        });
                        html += '</div></div></div>';

                        // Auto-select first match
                        if (matchData.matches[0]) {
                            charityMappings[rowNum] = matchData.matches[0].charity;
                        }
                    }

                    // Option to create as personal charity
                    const hasMatches = matchData.matches && matchData.matches.length > 0;

                    // If no matches, auto-select personal charity creation
                    if (!hasMatches) {
                        // Auto-select this option since it's the only choice
                        charityMappings[rowNum] = { name: matchData.searchName, type: 'personal_new' };

                        html += `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dcfce7; border: 1px solid #10b981; border-radius: 6px;">
                                <div style="display: flex; align-items: center;">
                                    <div style="margin-right: 0.75rem;">✅</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #065f46;">Personal Charity will be created</div>
                                        <div style="font-size: 0.75rem; color: #047857;">
                                            No matches found - "${matchData.searchName}" will be automatically added to your personal charities
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    } else {
                        // Show as selectable option when there are other choices
                        html += `
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                <label style="display: flex; align-items: center; padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; cursor: pointer;">
                                    <input type="radio" name="charity_${rowNum}" value="personal_${matchData.searchName}"
                                           onchange="selectPersonalCharity(${rowNum}, '${matchData.searchName}')"
                                           style="margin-right: 0.75rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #92400e;">Create as Personal Charity</div>
                                        <div style="font-size: 0.75rem; color: #92400e;">
                                            "${matchData.searchName}" will be added to your personal charities
                                        </div>
                                    </div>
                                </label>
                            </div>`;
                    }

                    html += '</div>';
                }
            });

            html += '</div>';
            matchTable.innerHTML = html;

            // Update buttons
            document.getElementById('validateBtn').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'inline-block';
        }

        function selectImportCharity(rowNum, charityId, charityType) {
            charityMappings[rowNum] = { id: charityId, type: charityType };
        }

        function selectPersonalCharity(rowNum, charityName) {
            charityMappings[rowNum] = { name: charityName, type: 'personal_new' };
        }

        function updateMatchSelection(radio) {
            // Update visual state for all radio buttons in the same group
            const name = radio.getAttribute('name');
            const allRadios = document.querySelectorAll(`input[name="${name}"]`);

            allRadios.forEach(r => {
                const label = r.closest('label');
                if (label) {
                    if (r.checked) {
                        label.style.background = '#eff6ff';
                        label.style.borderColor = '#3b82f6';
                    } else {
                        const index = Array.from(allRadios).indexOf(r);
                        label.style.background = index % 2 === 0 ? 'white' : '#f9fafb';
                        label.style.borderColor = 'transparent';
                    }
                }
            });
        }

        async function confirmImport() {
            // Update status
            document.getElementById('importStatusIcon').textContent = '⏳';
            document.getElementById('importStatusText').textContent = 'Importing donations...';

            // Hide charity matching if visible, show results
            document.getElementById('previewContent').style.display = 'none';
            document.getElementById('charityMatchingContent').style.display = 'none';
            document.getElementById('importResultsContent').style.display = 'block';

            const resultsDiv = document.getElementById('importResultsDetails');

            // Add progress bar
            resultsDiv.innerHTML = `
                <div style="padding: 2rem; background: #e0f2fe; border-radius: 12px; margin-bottom: 1.5rem;">
                    <h3 style="color: #0369a1; margin-bottom: 1rem;">📤 Importing Donations...</h3>
                    <div style="background: #cbd5e1; border-radius: 8px; overflow: hidden; height: 30px; margin-bottom: 1rem;">
                        <div id="importProgressBar" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center;">
                            <span id="importProgressText" style="color: white; font-weight: 500; font-size: 0.875rem;"></span>
                        </div>
                    </div>
                    <p id="importProgressStatus" style="color: #0369a1; margin: 0;">Preparing import...</p>
                </div>
            `;

            // Simulate progress stages
            const updateProgress = (percent, status) => {
                const bar = document.getElementById('importProgressBar');
                const text = document.getElementById('importProgressText');
                const statusText = document.getElementById('importProgressStatus');
                if (bar) {
                    bar.style.width = percent + '%';
                    text.textContent = percent + '%';
                }
                if (statusText) {
                    statusText.textContent = status;
                }
            };

            // Start progress
            updateProgress(5, 'Validating data...');
            await new Promise(resolve => setTimeout(resolve, 100));
            updateProgress(15, 'Creating charity mappings...');

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                // Apply charity mappings from user selections
                const mappedData = importData.map((donation, index) => {
                    const rowNum = index + 1;
                    if (charityMappings[rowNum]) {
                        const mapping = charityMappings[rowNum];
                        if (mapping.type === 'personal_new') {
                            // Will be created as personal charity
                            return { ...donation, charity_name: mapping.name, create_personal: true };
                        } else {
                            // Use the mapped charity ID and remove charity_name to avoid confusion
                            const { charity_name, ...donationWithoutName } = donation;
                            return { ...donationWithoutName, charity_id: mapping.id, charity_name: null };
                        }
                    }
                    // If no mapping (shouldn't happen after validation), keep original
                    return donation;
                });

                updateProgress(25, `Preparing ${mappedData.length} donations...`);
                await new Promise(resolve => setTimeout(resolve, 100));

                // CHUNKED IMPORT IMPLEMENTATION
                const CHUNK_SIZE = 25; // Process 25 donations at a time
                const chunks = [];
                for (let i = 0; i < mappedData.length; i += CHUNK_SIZE) {
                    chunks.push(mappedData.slice(i, i + CHUNK_SIZE));
                }

                let totalAdded = 0;
                let totalFailed = 0;
                let totalSkipped = 0;
                let allErrors = [];
                let allCreatedCharities = [];
                let personalCharitiesCreated = 0;

                // Process chunks sequentially
                for (let chunkIndex = 0; chunkIndex < chunks.length; chunkIndex++) {
                    const chunk = chunks[chunkIndex];
                    const startIdx = chunkIndex * CHUNK_SIZE + 1;
                    const endIdx = Math.min(startIdx + chunk.length - 1, mappedData.length);

                    // Calculate progress (30% to 85% for actual processing)
                    const progressPercent = 30 + (chunkIndex / chunks.length * 55);
                    updateProgress(Math.floor(progressPercent), `Processing donations ${startIdx}-${endIdx} of ${mappedData.length}...`);

                    try {
                        // Send chunk to server without value calculations
                        const response = await fetch('/api/donations/import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                donations: chunk,
                                skipValues: true  // New flag to skip value calculations
                            })
                        });

                        const chunkData = await response.json();

                        if (chunkData.success) {
                            totalAdded += chunkData.results.added || 0;
                            totalFailed += chunkData.results.failed || 0;
                            totalSkipped += chunkData.results.skipped || 0;
                            personalCharitiesCreated += chunkData.results.personalCharitiesCreated || 0;
                            if (chunkData.results.errors) {
                                allErrors = allErrors.concat(chunkData.results.errors);
                            }
                            if (chunkData.results.createdCharities) {
                                allCreatedCharities = allCreatedCharities.concat(chunkData.results.createdCharities);
                            }
                        } else {
                            // If chunk fails, add all donations in chunk to failed count
                            totalFailed += chunk.length;
                            allErrors.push(`Chunk ${chunkIndex + 1} failed: ${chunkData.error || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error(`Error processing chunk ${chunkIndex + 1}:`, error);
                        totalFailed += chunk.length;
                        allErrors.push(`Chunk ${chunkIndex + 1} error: ${error.message}`);
                    }

                    // Small delay between chunks to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // After all chunks are imported, assign values in a single batch
                updateProgress(85, 'Calculating item values...');

                try {
                    const valueResponse = await fetch('/api/donations/assign-values', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            // Send identifiers for the donations that need values assigned
                            importBatch: true  // Flag to indicate this is a batch value assignment
                        })
                    });

                    const valueData = await valueResponse.json();
                    if (!valueData.success) {
                        console.error('Failed to assign values:', valueData.error);
                        allErrors.push(`Value assignment failed: ${valueData.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error assigning values:', error);
                    allErrors.push(`Value assignment error: ${error.message}`);
                }

                updateProgress(95, 'Finalizing import...');

                // Prepare the data structure expected by the existing UI code
                const data = {
                    success: totalAdded > 0 || personalCharitiesCreated > 0,
                    results: {
                        added: totalAdded,
                        failed: totalFailed,
                        skipped: totalSkipped,
                        errors: allErrors,
                        personalCharitiesCreated: personalCharitiesCreated,
                        createdCharities: allCreatedCharities
                    }
                };

                if (data.success) {
                    updateProgress(100, 'Import complete!');
                    // Update status
                    document.getElementById('importStatusIcon').textContent = '✅';
                    document.getElementById('importStatusText').textContent = `Import complete! ${data.results.added} donations added.`;

                    let resultHtml = `
                        <div style="padding: 2rem; background: #d1fae5; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #10b981;">
                            <h2 style="color: #065f46; margin: 0 0 1rem 0;">✅ Import Successful!</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #065f46;">${data.results.added}</div>
                                    <div style="font-size: 0.875rem; color: #047857;">Successfully Imported</div>
                                </div>
                                ${data.results.failed > 0 ? `
                                <div style="background: #fee2e2; padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #dc2626;">${data.results.failed}</div>
                                    <div style="font-size: 0.875rem; color: #b91c1c;">Failed to Import</div>
                                </div>` : ''}
                                ${data.results.skipped > 0 ? `
                                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #d97706;">${data.results.skipped}</div>
                                    <div style="font-size: 0.875rem; color: #92400e;">Skipped</div>
                                </div>` : ''}
                            </div>
                        </div>
                    `;

                    if (data.results.errors && data.results.errors.length > 0) {
                        resultHtml += `
                            <details style="margin-bottom: 1rem; background: #fee2e2; padding: 1rem; border-radius: 8px;">
                                <summary style="color: #dc2626; cursor: pointer; font-weight: 500;">
                                    ❌ Import Errors (${data.results.errors.length})
                                </summary>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: #b91c1c;">
                                    ${data.results.errors.slice(0, 10).map(error => `<li style="margin: 0.25rem 0;">${error}</li>`).join('')}
                                    ${data.results.errors.length > 10 ? `<li style="font-style: italic;">... and ${data.results.errors.length - 10} more errors</li>` : ''}
                                </ul>
                            </details>
                        `;
                    }

                    if (data.results.personalCharitiesCreated > 0) {
                        resultHtml += `
                            <details open style="background: #e0f2fe; padding: 1rem; border-radius: 8px;">
                                <summary style="color: #0369a1; cursor: pointer; font-weight: 500;">
                                    ✨ Personal Charities Created (${data.results.personalCharitiesCreated})
                                </summary>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: #075985;">
                                    ${data.results.charityMatches?.notFound?.map(name => `<li>${name}</li>`).join('') || ''}
                                </ul>
                                <p style="font-size: 0.875rem; color: #0369a1; margin-top: 0.5rem;">
                                    These charities were automatically added to your personal charities list.
                                </p>
                            </details>
                        `;
                    }

                    resultsDiv.innerHTML = resultHtml;

                    // Update buttons
                    document.getElementById('validateBtn').style.display = 'none';
                    document.getElementById('confirmBtn').style.display = 'none';
                    document.getElementById('cancelBtn').style.display = 'none';
                    document.getElementById('doneBtn').style.display = 'inline-block';
                } else {
                    resultsDiv.innerHTML = `
                        <div style="padding: 1rem; background: #fee2e2; border-radius: 8px;">
                            <h3 style="color: #dc2626;">❌ Import Failed</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="padding: 1rem; background: #fee2e2; border-radius: 8px;">
                        <h3 style="color: #dc2626;">❌ Import Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function cancelImport() {
            // Reset all UI states
            document.getElementById('importEmptyState').style.display = 'flex';
            document.getElementById('previewContent').style.display = 'none';
            document.getElementById('charityMatchingContent').style.display = 'none';
            document.getElementById('importResultsContent').style.display = 'none';
            document.getElementById('importStatusBar').style.display = 'none';
            document.getElementById('importStats').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';

            // Reset file input
            document.getElementById('csvFileInput').value = '';

            // Clear data
            importData = [];
            charityMappings = {};
            validationData = null;

            // Reload main data if on dashboard
            if (document.getElementById('dashboardSection').style.display !== 'none') {
                loadDonations();
                loadStats();
                loadCharities();
            }
        }

        // Load saved tax settings (now handled by loadProfile which loads from database)
        function loadTaxSettings() {
            // Tax settings are now loaded from database in loadProfile()
            // This function is kept for backward compatibility but just triggers loadProfile
            loadProfile();
        }

        // View Summary function
        async function viewSummary() {
            const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
            const summaryDiv = document.getElementById('reportSummary');

            summaryDiv.innerHTML = '<p>Loading summary...</p>';

            try {
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    summaryDiv.innerHTML = '<p style="color: #666;">No donations found for the selected year.</p>';
                    return;
                }

                // Calculate summary statistics
                const donations = data.donations;
                const totalAmount = donations.reduce((sum, d) => sum + parseFloat(d.amount), 0);

                // Get tax rate for the selected year
                let taxRate = 0;
                if (selectedYear === 'all') {
                    // Use current year's rate for 'all years' view
                    const currentYear = new Date().getFullYear().toString();
                    taxRate = taxRatesByYear[currentYear] || 0;
                } else {
                    taxRate = taxRatesByYear[selectedYear] || 0;
                }
                const taxSavings = totalAmount * taxRate;

                // Group by charity
                const charityTotals = {};
                donations.forEach(d => {
                    const charity = d.charity_name || 'Unknown';
                    charityTotals[charity] = (charityTotals[charity] || 0) + parseFloat(d.amount);
                });

                // Group by type
                const typeTotals = {
                    cash: 0,
                    items: 0,
                    miles: 0,
                    stock: 0,
                    crypto: 0
                };
                donations.forEach(d => {
                    const type = d.donation_type || 'cash';
                    typeTotals[type] = (typeTotals[type] || 0) + parseFloat(d.amount);
                });

                // Generate HTML summary
                let html = `
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">Tax Year ${selectedYear === 'all' ? 'All Years' : selectedYear} Summary</h3>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Total Donations</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #667eea;">$${totalAmount.toFixed(2)}</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Est. Tax Savings</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #16a34a;">$${taxSavings.toFixed(2)}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Number of Donations</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #dc2626;">${donations.length}</div>
                            </div>
                        </div>

                        <h4 style="color: #4b5563; margin-bottom: 0.5rem;">Donations by Type</h4>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                `;

                Object.entries(typeTotals).forEach(([type, amount]) => {
                    if (amount > 0) {
                        const percentage = ((amount / totalAmount) * 100).toFixed(1);
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="text-transform: capitalize;">${type}</span>
                                <span><strong>$${amount.toFixed(2)}</strong> (${percentage}%)</span>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>

                        <h4 style="color: #4b5563; margin-bottom: 0.5rem;">Top Charities</h4>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                `;

                // Sort charities by total amount
                const sortedCharities = Object.entries(charityTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                sortedCharities.forEach(([charity, amount]) => {
                    const percentage = ((amount / totalAmount) * 100).toFixed(1);
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                            <span>${charity}</span>
                            <span><strong>$${amount.toFixed(2)}</strong> (${percentage}%)</span>
                        </div>
                    `;
                });

                html += `
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <p style="font-size: 0.875rem; color: #92400e;">
                                <strong>Note:</strong> Tax savings shown are estimates based on your ${Math.round(taxRate * 100)}% marginal tax rate.
                                Actual savings depend on itemizing deductions vs. standard deduction ($${(standardDeductions[document.getElementById('filingStatus')?.value] || 14600).toLocaleString()}).
                            </p>
                        </div>
                    </div>
                `;

                summaryDiv.innerHTML = html;

            } catch (error) {
                console.error('Failed to generate summary:', error);
                summaryDiv.innerHTML = '<p style="color: #dc2626;">Failed to generate summary. Please try again.</p>';
            }
        }

        // Item donation management
        let itemCategories = [];
        let currentItems = [];
        let selectedDonationItems = [];

        // Load categories on page load
        async function loadItemCategories() {
            console.log('Loading item categories...');
            try {
                const response = await fetch('/api/items?type=categories');
                const data = await response.json();
                console.log('Categories response:', data);

                if (data.success) {
                    itemCategories = data.categories;
                    console.log(`Loaded ${itemCategories.length} categories`);

                    // Populate the category dropdown
                    const categorySelect = document.getElementById('itemCategory');
                    if (categorySelect) {
                        categorySelect.innerHTML = '<option value="">Select category...</option>';
                        itemCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = `${cat.icon || ''} ${cat.name}`;
                            categorySelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        // Handle category selection change
        async function categoryChanged() {
            const categoryId = document.getElementById('itemCategory').value;
            const itemSearch = document.getElementById('itemSearch');
            const itemQuality = document.getElementById('itemQuality');
            const itemQuantity = document.getElementById('itemQuantity');
            const addBtn = document.getElementById('addItemBtn');

            if (!categoryId) {
                // No category selected, disable everything
                itemSearch.disabled = true;
                itemSearch.placeholder = 'Select category first';
                itemSearch.value = '';
                itemQuality.disabled = true;
                itemQuantity.disabled = true;
                addBtn.disabled = true;
                addBtn.style.background = '#9ca3af';
                addBtn.style.cursor = 'not-allowed';
                currentItems = [];
                document.getElementById('itemValueDisplay').style.display = 'none';
                return;
            }

            // Category selected, enable item search and clear previous selection
            itemSearch.disabled = false;
            itemSearch.placeholder = 'Type to search items...';
            itemSearch.value = '';  // Clear any previous item selection
            const itemSelectEl = document.getElementById('itemSelect');
            if (itemSelectEl) itemSelectEl.value = '';  // Clear hidden select
            const valueDisplay = document.getElementById('itemValueDisplay');
            if (valueDisplay) valueDisplay.style.display = 'none';  // Hide value display

            // Load items for this category
            console.log(`Loading items for category ${categoryId}`);
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                console.log('Items API response status:', response.status);
                const data = await response.json();
                console.log('Items data:', data);

                if (data.success) {
                    currentItems = data.items || [];
                    console.log(`Loaded ${currentItems.length} items`);
                } else {
                    console.error('Failed to load items:', data.error);
                    currentItems = [];
                }
            } catch (error) {
                console.error('Failed to load items:', error);
                currentItems = [];
            }
        }

        // Show category dropdown (for backwards compatibility)
        function showCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            const searchValue = document.getElementById('itemCategorySearch') ? document.getElementById('itemCategorySearch').value.toLowerCase() : '';

            let html = '';
            const filteredCategories = searchValue
                ? itemCategories.filter(cat => cat.name.toLowerCase().includes(searchValue))
                : itemCategories;

            if (filteredCategories.length === 0) {
                html = '<div style="padding:0.75rem;color:#6b7280;text-align:center;">No categories found</div>';
            } else {
                filteredCategories.forEach(cat => {
                    html += `
                        <div onclick="selectCategory(${cat.id}, '${cat.name}', '${cat.icon}')"
                             style="padding:0.75rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;transition:background 0.2s;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='white'">
                            <span style="font-size:1.25rem;">${cat.icon}</span>
                            <span style="flex:1;">${cat.name}</span>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        // Search categories
        function searchCategories(value) {
            showCategoryDropdown();
        }

        // Select a category
        async function selectCategory(categoryId, categoryName, categoryIcon) {
            document.getElementById('itemCategory').value = categoryId;
            document.getElementById('itemCategorySearch').value = categoryName;
            document.getElementById('selectedCategoryIcon').textContent = categoryIcon;
            document.getElementById('categoryDropdown').style.display = 'none';

            // Check if element exists before setting
            const categoryNameElement = document.getElementById('selectedCategoryName');
            if (categoryNameElement) {
                categoryNameElement.textContent = categoryName;
            }

            // Show item search section
            document.getElementById('itemSearchSection').style.display = 'block';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemDetailsSection').style.display = 'none';

            // Load items for this category
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                console.log('Items API response status:', response.status);
                const data = await response.json();
                console.log('Items data:', data);

                if (data.success) {
                    currentItems = data.items || [];
                    console.log(`Loaded ${currentItems.length} items for category ${categoryName}`);
                    // Show dropdown immediately if there are items
                    if (currentItems.length > 0) {
                        showItemDropdown();
                    }
                } else {
                    console.error('Failed to load items:', data.error);
                    currentItems = [];
                }
            } catch (error) {
                console.error('Failed to load items:', error);
            }
        }

        // Show item dropdown
        function showItemDropdown() {
            const dropdown = document.getElementById('itemDropdown');
            const searchValue = document.getElementById('itemSearch').value.toLowerCase();

            let html = '';
            const filteredItems = searchValue
                ? currentItems.filter(item =>
                    item.name.toLowerCase().includes(searchValue) ||
                    (item.description && item.description.toLowerCase().includes(searchValue))
                  )
                : currentItems;

            // Get current category name for display
            const categoryId = document.getElementById('itemCategory').value;
            const category = itemCategories.find(c => c.id == categoryId);
            const categoryName = category ? category.name : 'this category';

            // Always show "Other Item" option at the top for the current category
            html = `
                <div onclick="selectCustomItem()"
                     style="padding:0.75rem;cursor:pointer;border-bottom:2px solid #e5e7eb;transition:background 0.2s;background:#fef3c7;"
                     onmouseover="this.style.background='#fde68a'"
                     onmouseout="this.style.background='#fef3c7'">
                    <div style="font-weight:600;color:#92400e;">📦 Other item in ${categoryName}</div>
                    <div style="font-size:0.75rem;color:#92400e;">Item not listed? Enter your own description and value</div>
                </div>
            `;

            if (filteredItems.length === 0) {
                html += '<div style="padding:0.75rem;color:#6b7280;text-align:center;">No matching items found in database</div>';
            } else {
                filteredItems.forEach(item => {
                    const veryGoodValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
                    const priceRange = `Fair: $0 | Good: $${item.value_good || 0} | Very Good: $${veryGoodValue.toFixed(0)} | Excellent: $${item.value_excellent || 0}`;
                    // Store item ID as data attribute to avoid quote escaping issues
                    html += `
                        <div onclick="selectItemByElement(this)"
                             data-item-id="${item.id}"
                             style="padding:0.75rem;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='white'">
                            <div style="font-weight:500;">${item.name}</div>
                            <div style="font-size:0.75rem;color:#6b7280;">${item.description || ''}</div>
                            <div style="font-size:0.75rem;color:#667eea;margin-top:0.25rem;">${priceRange}</div>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            console.log('Showing dropdown with', filteredItems.length, 'items');
        }

        // Search items
        function searchItems(value) {
            console.log('Searching items with value:', value);
            showItemDropdown();
        }

        // Select an item by element (gets ID from data attribute)
        function selectItemByElement(element) {
            const itemId = element.getAttribute('data-item-id');
            selectItem(itemId);
        }

        // Select an item
        function selectItem(itemId) {
            const item = currentItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('itemSelect').value = itemId;
            document.getElementById('itemSearch').value = item.name;
            document.getElementById('itemDropdown').style.display = 'none';

            // Enable quality, quantity, and add button
            document.getElementById('itemQuality').disabled = false;
            document.getElementById('itemQuantity').disabled = false;
            const addBtn = document.getElementById('addItemBtn');
            addBtn.disabled = false;
            addBtn.style.background = '#667eea';
            addBtn.style.cursor = 'pointer';

            // Show value display
            document.getElementById('itemValueDisplay').style.display = 'block';
            document.getElementById('selectedItemName').textContent = `${item.name} - ${item.description || ''}`;

            // Reset quality and quantity
            document.getElementById('itemQuality').value = 'very_good';
            document.getElementById('itemQuantity').value = '1';

            // Update value preview
            updateItemValue();
        }

        // Select custom item option
        function selectCustomItem() {
            // Set item to custom
            document.getElementById('itemSelect').value = 'custom';
            document.getElementById('itemSearch').value = 'Custom Item';
            document.getElementById('itemDropdown').style.display = 'none';

            // Enable fields
            document.getElementById('itemQuality').disabled = false;
            document.getElementById('itemQuantity').disabled = false;
            const addBtn = document.getElementById('addItemBtn');
            addBtn.disabled = false;
            addBtn.style.background = '#667eea';
            addBtn.style.cursor = 'pointer';

            // Show custom item input
            document.getElementById('itemValueDisplay').style.display = 'block';
            document.getElementById('selectedItemName').innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <input type="text" id="customItemName" placeholder="Enter item description..."
                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <input type="number" id="customItemValue" placeholder="Enter value per item..." step="0.01" min="0"
                           onchange="updateCustomItemValue()"
                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div>
                    <input type="text" id="customValueSource" placeholder="Value source (e.g., eBay, retail price)..."
                           style="width: 100%; padding: 0.5rem; border: 1px solid #fbbf24; border-radius: 4px; background: #fffbeb;">
                    <small style="color: #92400e; font-size: 0.75rem;">Required for tax documentation</small>
                </div>
            `;

            // Reset fields
            document.getElementById('itemQuality').value = 'very_good';
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemValuePreview').textContent = '$0.00';
        }

        // Update custom item value
        function updateCustomItemValue() {
            const value = parseFloat(document.getElementById('customItemValue')?.value || 0);
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            const total = value * quantity;
            document.getElementById('itemValuePreview').textContent = `$${total.toFixed(2)}`;
        }

        // Update value based on selected item and quality
        function updateItemValue() {
            const itemId = document.getElementById('itemSelect').value;
            const quality = document.getElementById('itemQuality').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

            if (!itemId) return;

            // Handle custom items
            if (itemId === 'custom') {
                updateCustomItemValue();
                return;
            }

            const item = currentItems.find(i => i.id == itemId);
            if (!item) return;

            // Use quality-specific values from database (IRS only accepts good or better)
            let unitValue = 0;
            if (quality === 'fair') {
                // Fair items are not IRS deductible
                unitValue = 0;
            } else if (quality === 'good') {
                unitValue = item.value_good || 0;
            } else if (quality === 'very_good') {
                // Very good is the average of good and excellent
                unitValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
            } else if (quality === 'excellent') {
                unitValue = item.value_excellent || 0;
            }
            const totalValue = unitValue * quantity;

            // Update the preview
            document.getElementById('itemValuePreview').textContent = `$${totalValue.toFixed(2)}`;
        }

        // Add item to list
        function addItemToList() {
            const categoryId = document.getElementById('itemCategory').value;
            const itemId = document.getElementById('itemSelect').value;
            const quality = document.getElementById('itemQuality').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

            if (!categoryId || !itemId) {
                alert('Please select category and item');
                return;
            }

            const category = itemCategories.find(c => c.id == categoryId);

            // Check if this is a custom item
            if (itemId === 'custom') {
                // Get custom item details
                const customName = document.getElementById('customItemName')?.value;
                const customValue = parseFloat(document.getElementById('customItemValue')?.value || 0);
                const customSource = document.getElementById('customValueSource')?.value;

                if (!customName) {
                    alert('Please enter a description for the custom item');
                    return;
                }
                if (customValue <= 0) {
                    alert('Please enter a valid value for the custom item');
                    return;
                }
                if (!customSource) {
                    alert('Please enter the value source for tax documentation');
                    return;
                }

                // Add custom item
                selectedDonationItems.push({
                    categoryName: category.name,
                    itemName: customName,
                    quality: quality,
                    qualityLabel: quality === 'fair' ? 'Fair (Not Deductible)' :
                                  quality === 'good' ? 'Good' :
                                  quality === 'very_good' ? 'Very Good' : 'Excellent',
                    quantity: quantity,
                    unitValue: customValue,
                    totalValue: customValue * quantity,
                    value_source: customSource,  // Store value source for custom items
                    isCustom: true  // Flag to identify custom items
                });

                updateSelectedItemsDisplay();

                // Reset form
                document.getElementById('itemSelect').value = '';
                document.getElementById('itemSearch').value = '';
                document.getElementById('itemQuality').value = 'very_good';
                document.getElementById('itemQuality').disabled = true;
                document.getElementById('itemQuantity').value = '1';
                document.getElementById('itemQuantity').disabled = true;
                document.getElementById('itemValueDisplay').style.display = 'none';

                const addBtn = document.getElementById('addItemBtn');
                addBtn.disabled = true;
                addBtn.style.background = '#9ca3af';
                addBtn.style.cursor = 'not-allowed';

                return;
            }

            const item = currentItems.find(i => i.id == itemId);

            // Determine quality label (IRS only accepts good or better)
            let qualityLabel;
            if (quality === 'fair') {
                qualityLabel = 'Fair (Not Deductible)';
            } else if (quality === 'good') {
                qualityLabel = 'Good';
            } else if (quality === 'very_good') {
                qualityLabel = 'Very Good';
            } else if (quality === 'excellent') {
                qualityLabel = 'Excellent';
            }

            // Use quality-specific values from database (IRS only accepts good or better)
            let unitValue = 0;
            if (quality === 'fair') {
                // Fair items are not IRS deductible
                unitValue = 0;
            } else if (quality === 'good') {
                unitValue = item.value_good || 0;
            } else if (quality === 'very_good') {
                // Very good is the average of good and excellent
                unitValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
            } else if (quality === 'excellent') {
                unitValue = item.value_excellent || 0;
            }

            selectedDonationItems.push({
                categoryName: category.name,
                itemName: item.name,
                quality: quality,  // Use the actual value (very_good) not the label (Very Good)
                qualityLabel: qualityLabel,  // Keep label for display purposes
                quantity: quantity,
                unitValue: unitValue,
                totalValue: unitValue * quantity
            });

            updateSelectedItemsDisplay();

            // Reset form for next item (check if fields exist)
            const itemSelectReset = document.getElementById('itemSelect');
            if (itemSelectReset) itemSelectReset.value = '';
            const itemSearchReset = document.getElementById('itemSearch');
            if (itemSearchReset) itemSearchReset.value = '';  // Clear item search field
            const itemQualityReset = document.getElementById('itemQuality');
            if (itemQualityReset) {
                itemQualityReset.value = 'very_good';  // Reset to default
                itemQualityReset.disabled = true;  // Disable until next item selected
            }
            const itemQuantityReset = document.getElementById('itemQuantity');
            if (itemQuantityReset) {
                itemQuantityReset.value = '1';
                itemQuantityReset.disabled = true;
            }
            const itemValueDisplayReset = document.getElementById('itemValueDisplay');
            if (itemValueDisplayReset) itemValueDisplayReset.style.display = 'none';  // Hide value display

            // Disable add button until next item is selected
            const addBtn = document.getElementById('addItemBtn');
            if (addBtn) {
                addBtn.disabled = true;
                addBtn.style.background = '#9ca3af';
                addBtn.style.cursor = 'not-allowed';
            }
        }

        function updateSelectedItemsDisplay() {
            const container = document.getElementById('selectedItemsList');
            const receiptTotal = document.getElementById('receiptTotal');
            const addItemBtn = document.getElementById('addItemBtn');
            const saveBtn = document.getElementById('saveItemsDonationBtn');

            if (selectedDonationItems.length === 0) {
                container.innerHTML = '<div class="empty-state" style="color:#9ca3af;text-align:center;padding:2rem;">No items added yet</div>';
                document.getElementById('estimatedValue').value = '0.00';
                if (receiptTotal) receiptTotal.textContent = '0.00';  // No $ needed, already in HTML
                if (addItemBtn) addItemBtn.style.display = 'block';
                if (saveBtn) saveBtn.style.display = 'none';  // Hide save button when no items
                return;
            }

            // Create receipt-style display
            let html = '<div style="font-family:monospace;font-size:0.875rem;background:#f9fafb;padding:0.75rem;border-radius:4px;">';
            html += '<div style="border-bottom:1px dashed #d1d5db;padding-bottom:0.5rem;margin-bottom:0.5rem;">';
            html += '<div style="text-align:center;font-weight:bold;margin-bottom:0.25rem;">DONATION RECEIPT</div>';
            html += '<div style="text-align:center;font-size:0.75rem;color:#6b7280;">Items for Tax Deduction</div>';
            html += '</div>';

            let totalValue = 0;

            selectedDonationItems.forEach((item, index) => {
                const lineTotal = item.totalValue;
                totalValue += lineTotal;

                html += `
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.375rem;font-size:0.8125rem;">
                        <div style="flex:1;padding-right:0.5rem;">
                            <div style="display:flex;justify-content:space-between;">
                                <span>${item.quantity}x ${item.itemName}</span>
                                <span>$${lineTotal.toFixed(2)}</span>
                            </div>
                            <div style="color:#6b7280;font-size:0.75rem;margin-left:1rem;">
                                ${item.categoryName} • ${item.quality.replace('_', ' ')}
                            </div>
                        </div>
                        <button type="button" onclick="removeItemFromList(${index})" style="color:#ef4444;background:none;border:none;cursor:pointer;padding:0;margin-left:0.25rem;font-size:1rem;line-height:1;">×</button>
                    </div>
                `;
            });

            html += '<div style="border-top:1px dashed #d1d5db;margin-top:0.5rem;padding-top:0.5rem;">';
            html += `<div style="display:flex;justify-content:space-between;font-weight:bold;">
                        <span>TOTAL VALUE:</span>
                        <span style="color:#667eea;">$${totalValue.toFixed(2)}</span>
                     </div>`;
            html += `<div style="font-size:0.75rem;color:#6b7280;margin-top:0.25rem;text-align:center;">
                        ${selectedDonationItems.length} item${selectedDonationItems.length > 1 ? 's' : ''}
                     </div>`;
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            document.getElementById('estimatedValue').value = totalValue.toFixed(2);
            if (receiptTotal) receiptTotal.textContent = totalValue.toFixed(2);  // No $ needed, already in HTML

            // Update tax savings when items change
            updateTaxSavings();

            // Show save button when there are items
            if (saveBtn) saveBtn.style.display = 'block';

            // Show add item button when there are items
            if (addItemBtn) addItemBtn.style.display = selectedDonationItems.length > 0 ? 'block' : 'none';

            // Update item description for database
            const descriptions = selectedDonationItems.map(i =>
                `${i.itemName} (${i.quality}, qty: ${i.quantity})`
            ).join('; ');
            document.getElementById('itemDescription').value = descriptions;
        }

        function removeItemFromList(index) {
            selectedDonationItems.splice(index, 1);
            updateSelectedItemsDisplay();
        }

        // Helper function to handle donation type changes
        function handleDonationTypeChange(event) {
            updateDonationFields();
        }

        // Edit donation function
        async function editDonation(donationId) {
            try {
                let donation = null;
                const token = localStorage.getItem('token');

                // First try to fetch from API for the most accurate data
                try {
                    const response = await fetch(`/api/donations/${donationId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.donation) {
                            donation = data.donation;
                            console.log('[DEBUG] Fetched donation from API:', donation);
                        }
                    }
                } catch (apiError) {
                    console.log('[DEBUG] API fetch failed, falling back to localStorage:', apiError);
                }

                // No fallback - if API fails, show error
                if (!donation) {
                    console.error('[DEBUG] Failed to fetch donation from API');
                    showToast('Failed to load donation. Please try again.', 'error');
                    return;
                }

                if (donation) {
                    // Store the donation ID for update
                    window.editingDonationId = donationId;
                    window.isEditing = true;

                    const donationType = donation.donation_type || 'cash';

                    // Use special edit modal for item donations
                    if (donationType === 'items') {
                        openEditItemDonationModal(donation);
                        return;
                    }

                    // Use specific edit modal for cash donations
                    if (donationType === 'cash') {
                        openEditCashDonationModal(donation);
                        return;
                    }

                    // For other types, use the regular modal (for now)
                    // IMPORTANT: For personal charities, user_charity_id is the ID and charity_id is null
                    const isPersonalCharity = !!donation.user_charity_id;
                    const charityId = isPersonalCharity ? donation.user_charity_id : donation.charity_id || '';
                    const charityName = donation.charity_name || '';
                    const charitySource = isPersonalCharity ? 'personal' : 'system';

                    console.log('[EDIT] Opening modal for donation:', {
                        charityId,
                        charityName,
                        charitySource,
                        isPersonalCharity,
                        user_charity_id: donation.user_charity_id,
                        charity_id: donation.charity_id,
                        raw_donation: donation
                    });

                    // Open modal with pre-filled data
                    openDonationModal(donationType, charityId, charityName, charitySource);

                    // Wait for the modal to be ready
                    setTimeout(() => {
                        // Populate the date field
                        const donationDate = document.getElementById('donationDate');
                        if (donationDate) donationDate.value = donation.date || donation.donation_date || '';

                        // Populate the notes field
                        const donationNotes = document.getElementById('donationNotes');
                        if (donationNotes) {
                            // Parse notes if it's a JSON string
                            let notes = donation.notes;
                            if (typeof notes === 'string' && notes.startsWith('{')) {
                                try {
                                    const notesObj = JSON.parse(notes);
                                    notes = notesObj.notes || '';
                                } catch (e) {
                                    // Use as-is if not valid JSON
                                }
                            }
                            donationNotes.value = notes || '';
                        }

                        // Set type-specific fields
                        updateDonationFields();

                        if (donation.donation_type === 'cash') {
                            const amountField = document.getElementById('donationAmount');
                            if (amountField) amountField.value = donation.amount;
                        } else if (donation.donation_type === 'items') {
                            // For editing, we can't recreate the item list from the description alone
                            const itemDescription = document.getElementById('itemDescription');
                            const estimatedValue = document.getElementById('estimatedValue');
                            if (itemDescription) itemDescription.value = donation.item_description || '';
                            if (estimatedValue) estimatedValue.value = donation.estimated_value || donation.amount;
                            selectedDonationItems = [];
                            updateSelectedItemsDisplay();
                        } else if (donation.donation_type === 'miles') {
                            const milesDriven = document.getElementById('milesDriven');
                            const mileagePurpose = document.getElementById('mileagePurpose');
                            // Debug: log what we're trying to populate
                            console.log('[DEBUG] Editing mileage donation:', {
                                miles_driven: donation.miles_driven,
                                mileage_rate: donation.mileage_rate,
                                mileage_purpose: donation.mileage_purpose,
                                amount: donation.amount
                            });
                            if (milesDriven) milesDriven.value = donation.miles_driven || '';
                            if (mileagePurpose) mileagePurpose.value = donation.mileage_purpose || '';
                            // Trigger calculation to show rate and deduction
                            calculateMileageDeduction();
                        } else if (donation.donation_type === 'stock') {
                            const stockName = document.getElementById('stockName');
                            const stockSymbol = document.getElementById('stockSymbol');
                            const stockQuantity = document.getElementById('stockQuantity');
                            const fairMarketValue = document.getElementById('fairMarketValue');
                            const costBasis = document.getElementById('costBasis');

                            // Debug logging
                            console.log('[DEBUG] Editing stock donation:', {
                                stock_symbol: donation.stock_symbol,
                                stock_quantity: donation.stock_quantity,
                                fair_market_value: donation.fair_market_value,
                                cost_basis: donation.cost_basis,
                                amount: donation.amount
                            });

                            // Stock name is not in database, but symbol is
                            if (stockName) stockName.value = donation.stock_name || donation.stock_symbol || '';
                            if (stockSymbol) stockSymbol.value = donation.stock_symbol || '';
                            if (stockQuantity) stockQuantity.value = donation.stock_quantity || donation.quantity || '';

                            // Calculate price per share from total amount and quantity if FMV not stored
                            if (fairMarketValue) {
                                if (donation.fair_market_value) {
                                    // If we have FMV, it's the total value, so calculate price per share
                                    const qty = parseFloat(donation.stock_quantity || donation.quantity || 0);
                                    if (qty > 0) {
                                        const pricePerShare = parseFloat(donation.fair_market_value) / qty;
                                        fairMarketValue.value = pricePerShare.toFixed(2);
                                    } else {
                                        fairMarketValue.value = donation.fair_market_value || '';
                                    }
                                } else if (donation.amount && (donation.stock_quantity || donation.quantity)) {
                                    // Use amount / quantity to get price per share
                                    const qty = parseFloat(donation.stock_quantity || donation.quantity || 0);
                                    if (qty > 0) {
                                        const pricePerShare = parseFloat(donation.amount) / qty;
                                        fairMarketValue.value = pricePerShare.toFixed(2);
                                    }
                                } else {
                                    fairMarketValue.value = '';
                                }
                            }

                            if (costBasis) costBasis.value = donation.cost_basis || '';
                            // Calculate and display the total
                            calculateStockTotal();
                        } else if (donation.donation_type === 'crypto') {
                            const cryptoName = document.getElementById('cryptoName');
                            const cryptoSymbol = document.getElementById('cryptoSymbol');
                            const cryptoQuantity = document.getElementById('cryptoQuantity');
                            const cryptoPricePerUnit = document.getElementById('cryptoPricePerUnit');
                            const cryptoCostBasis = document.getElementById('cryptoCostBasis');

                            // Debug logging
                            console.log('[DEBUG] Editing crypto donation:', {
                                crypto_type: donation.crypto_type,
                                crypto_symbol: donation.crypto_symbol,
                                crypto_quantity: donation.crypto_quantity,
                                fair_market_value: donation.fair_market_value,
                                cost_basis: donation.cost_basis,
                                amount: donation.amount
                            });

                            if (cryptoName) cryptoName.value = donation.crypto_type || donation.crypto_name || '';
                            if (cryptoSymbol) cryptoSymbol.value = donation.crypto_symbol || '';
                            if (cryptoQuantity) cryptoQuantity.value = donation.crypto_quantity || donation.quantity || '';

                            // Calculate price per unit from total amount and quantity
                            if (cryptoPricePerUnit) {
                                if (donation.fair_market_value && donation.crypto_quantity) {
                                    const qty = parseFloat(donation.crypto_quantity || donation.quantity || 0);
                                    if (qty > 0) {
                                        const pricePerUnit = parseFloat(donation.fair_market_value) / qty;
                                        cryptoPricePerUnit.value = pricePerUnit.toFixed(2);
                                    }
                                } else if (donation.amount && (donation.crypto_quantity || donation.quantity)) {
                                    const qty = parseFloat(donation.crypto_quantity || donation.quantity || 0);
                                    if (qty > 0) {
                                        const pricePerUnit = parseFloat(donation.amount) / qty;
                                        cryptoPricePerUnit.value = pricePerUnit.toFixed(2);
                                    }
                                } else {
                                    cryptoPricePerUnit.value = '';
                                }
                            }

                            if (cryptoCostBasis) cryptoCostBasis.value = donation.cost_basis || '';
                            // Calculate and display the total
                            calculateCryptoTotal();
                        }

                        // Update submit button text
                        const submitBtn = document.querySelector('#donationSection button[onclick="saveDonation()"]');
                        if (submitBtn) submitBtn.textContent = 'Update Donation';
                    }, 100);
                } else {
                    // Donation not found in localStorage
                    showToast('Please refresh the donations list and try again', 'error');
                }
            } catch (error) {
                console.error('Error editing donation:', error);
                showToast('Error loading donation for editing', 'error');
            }
        }

        // Delete donation function
        async function deleteDonation(donationId) {
            if (!confirm('Are you sure you want to delete this donation?')) {
                return;
            }

            try {
                // Get auth token
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                // Check if response is JSON or HTML
                const contentType = response.headers.get("content-type");
                let data;

                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    // API endpoint might not exist, simulate success for demo
                    // In production, the endpoint we created will handle this
                    console.log('Delete API not available, removing from local view');
                    data = { success: true };
                }

                if (data.success) {
                    showToast('✅ Donation deleted successfully', 'success');
                    // Refresh the dashboard
                    loadDonations();
                    loadStats();
                    loadCharities();
                } else {
                    showToast('❌ Failed to delete donation', 'error');
                }
            } catch (error) {
                console.error('Error deleting donation:', error);
                showToast('❌ Error deleting donation', 'error');
            }
        }

        // Helper function to open donation modal with specific type
        function openDonationModal(type, preselectedCharityId = null, preselectedCharityName = null, preselectedCharitySource = null) {
            // Don't clear editing state if we're already editing
            // This preserves the edit mode when called from editDonation
            const preserveEditState = window.isEditing === true;

            // If not explicitly preserving edit state, clear any leftover edit state
            if (!preserveEditState) {
                window.editingDonationId = null;
                window.isEditing = false;
            }

            // Check if we're in edit mode
            const isEditMode = preserveEditState || (window.editingDonationId !== null && window.editingDonationId !== undefined);
            const titlePrefix = isEditMode ? 'Edit' : 'Add';

            const typeInfo = {
                cash: {
                    title: `${titlePrefix} Cash Donation`,
                    icon: '💵',
                    label: 'Cash/Check Donation',
                    desc: 'Record a monetary donation'
                },
                items: {
                    title: `${titlePrefix} Item Donation`,
                    icon: '📦',
                    label: 'Item/Goods Donation',
                    desc: 'Record donated items with values'
                },
                miles: {
                    title: `${titlePrefix} Mileage Donation`,
                    icon: '🚗',
                    label: 'Mileage Donation',
                    desc: 'Record miles driven for charity'
                },
                stock: {
                    title: `${titlePrefix} Stock Donation`,
                    icon: '📈',
                    label: 'Stock/Securities Donation',
                    desc: 'Record donated stocks or securities'
                },
                crypto: {
                    title: `${titlePrefix} Crypto Donation`,
                    icon: '₿',
                    label: 'Cryptocurrency Donation',
                    desc: 'Record cryptocurrency donations'
                }
            };

            const info = typeInfo[type] || typeInfo.cash;

            // Only reset form if not preserving edit state
            if (!preserveEditState) {
                document.getElementById('donationForm').reset();
            }

            // Explicitly clear all amount fields to ensure they're reset (check if they exist first)
            const fieldsToClean = [
                'donationAmount', 'estimatedValue', 'milesDriven', 'fairMarketValue',
                'cryptoValue', 'numberOfShares', 'pricePerShare', 'purchasePricePerShare',
                'cryptoPriceUSD', 'cryptoQuantity'
            ];

            fieldsToClean.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });

            // Clear tax savings display
            const taxDisplay = document.getElementById('taxSavingsDisplay');
            if (taxDisplay) {
                taxDisplay.textContent = '$0';
            }

            // UUID detection helper
            const isUUID = (str) => {
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                return uuidRegex.test(str);
            };

            // Set charity if provided (for both edit and quick add)
            if (preselectedCharityId && preselectedCharityName) {
                // Auto-detect source if not provided or incorrect
                if (isUUID(preselectedCharityId)) {
                    preselectedCharitySource = 'personal';
                } else if (!isNaN(preselectedCharityId)) {
                    preselectedCharitySource = 'system';
                }

                document.getElementById('selectedCharityId').value = preselectedCharityId;
                document.getElementById('selectedCharitySource').value = preselectedCharitySource || 'system';
                document.getElementById('donationCharity').value = preselectedCharityName;
                // Track the selected charity name to prevent clearing on input events
                window.lastSelectedCharityName = preselectedCharityName;

                // Also set it again after a small delay to handle any race conditions
                setTimeout(() => {
                    const charityInput = document.getElementById('donationCharity');
                    if (charityInput && (!charityInput.value || charityInput.value !== preselectedCharityName)) {
                        console.log('[EDIT] Re-setting charity name after delay:', preselectedCharityName);
                        charityInput.value = preselectedCharityName;
                        window.lastSelectedCharityName = preselectedCharityName;
                    }
                }, 100);
            } else if (!preserveEditState) {
                // Only clear if not preserving edit state
                document.getElementById('selectedCharityId').value = '';
                document.getElementById('selectedCharitySource').value = '';
                document.getElementById('donationCharity').value = '';
                window.lastSelectedCharityName = null;
            }
            document.getElementById('charityDropdown').classList.remove('show');

            // Reset item selection
            selectedDonationItems = [];
            updateSelectedItemsDisplay();

            // Reset item fields if they exist
            const itemFields = {
                'itemCategory': { value: '' },
                'itemSearch': { value: '', disabled: true },
                'itemQuality': { disabled: true },
                'itemQuantity': { disabled: true },
                'addItemBtn': { disabled: true }
            };

            Object.entries(itemFields).forEach(([fieldId, updates]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    Object.entries(updates).forEach(([prop, val]) => {
                        field[prop] = val;
                    });
                }
            });

            // Update modal header and type display
            document.getElementById('donationModalTitle').textContent = info.title;
            document.getElementById('donationTypeIcon').textContent = info.icon;
            document.getElementById('donationTypeLabel').textContent = info.label;
            document.getElementById('donationTypeDesc').textContent = info.desc;
            document.getElementById('donationType').value = type;

            updateDonationFields();

            // Update submit button text based on edit mode
            const submitBtn = document.getElementById('donationSubmitBtn');
            if (submitBtn) {
                submitBtn.textContent = window.editingDonationId ? 'Update Donation' : 'Add Donation';
            }

            showAddDonation();
        }

        // Section navigation
        function showSection(sectionName) {
            // Clear edit state when navigating to donations normally (not through edit button)
            if (sectionName === 'donations' && !window.isEditing) {
                window.editingDonationId = null;
                // Reset the form
                const form = document.getElementById('donationForm');
                if (form) form.reset();
                // Reset button text
                const submitBtn = form?.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Add Donation';
            }

            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Reset isEditing flag after using it
            if (sectionName === 'donations') {
                window.isEditing = false;
            }

            // Show the selected section
            const sectionMap = {
                'dashboard': 'dashboardSection',
                'donations': 'addDonationSection',
                'addDonation': 'addDonationSection',  // Support both 'donations' and 'addDonation'
                'reports': 'reportsSection',
                'profile': 'profileSection',
                'tools': 'toolsSection'
            };

            const sectionId = sectionMap[sectionName];
            if (sectionId) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }

                // Mark nav item as active
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }

                // Load My Charities when showing Add Donation section
                if (sectionId === 'addDonationSection') {
                    loadMyCharitiesQuickAdd();
                }
            }

            // If showing dashboard, reload data
            if (sectionName === 'dashboard') {
                loadCharities();
                loadDonations();
                loadStats();
            }

            // If showing profile, reload profile data
            if (sectionName === 'profile') {
                loadProfile();
            }
        }

        // Add event listeners for tax savings updates
        document.getElementById('donationAmount')?.addEventListener('input', updateTaxSavings);
        document.getElementById('estimatedValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('milesDriven')?.addEventListener('input', updateTaxSavings);
        document.getElementById('fairMarketValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('cryptoValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('donationType')?.addEventListener('change', updateTaxSavings);

        // Items Import Functions
        let itemsImportData = [];

        function showImportItems() {
            document.getElementById('importItemsPanel').style.display = 'block';
            document.getElementById('importDonationsPanel').style.display = 'none';
        }

        function handleItemsCsvSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processItemsCsvFile(file);
            }
        }

        function processItemsCsvFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseItemsCsv(csvText);
            };
            reader.readAsText(file);
        }

        function parseItemsCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            itemsImportData = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = [];
                let current = '';
                let inQuotes = false;

                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                const item = {};
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });

                itemsImportData.push(item);
            }

            // Show preview
            const preview = document.getElementById('itemsImportPreview');
            const table = document.getElementById('itemsPreviewTable');

            let html = '<table class="table"><thead><tr><th>Category</th><th>Name</th><th>Good</th><th>Very Good</th><th>Excellent</th></tr></thead><tbody>';

            itemsImportData.slice(0, 10).forEach(item => {
                const categoryNames = {
                    '1': 'Women\'s', '2': 'Men\'s', '3': 'Children\'s',
                    '4': 'Household', '5': 'Electronics', '6': 'Furniture',
                    '7': 'Books', '8': 'Sports', '9': 'Toys',
                    '10': 'Appliances', '11': 'Jewelry', '12': 'Tools'
                };
                html += `<tr>
                    <td>${categoryNames[item.category_id] || item.category_id}</td>
                    <td>${item.name}</td>
                    <td>$${parseFloat(item.value_good || 0).toFixed(2)}</td>
                    <td>$${parseFloat(item.value_very_good || 0).toFixed(2)}</td>
                    <td>$${parseFloat(item.value_excellent || 0).toFixed(2)}</td>
                </tr>`;
            });

            if (itemsImportData.length > 10) {
                html += `<tr><td colspan="5" style="text-align: center; font-style: italic;">... and ${itemsImportData.length - 10} more items</td></tr>`;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
            preview.style.display = 'block';
        }

        async function confirmItemsImport() {
            const updateExisting = document.getElementById('updateExistingItems').checked;
            const resultsDiv = document.getElementById('itemsImportResults');
            const resultsContent = document.getElementById('itemsResultsContent');

            resultsContent.innerHTML = '<p>Importing items...</p>';
            resultsDiv.style.display = 'block';

            try {
                const response = await fetch('/api/items/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        csvData: [Object.keys(itemsImportData[0]).join(',')]
                            .concat(itemsImportData.map(row =>
                                Object.keys(itemsImportData[0]).map(k => row[k]).join(',')
                            )).join('\n'),
                        updateExisting: updateExisting
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultsContent.innerHTML = `
                        <div style="color: #10b981; margin-bottom: 1rem;">
                            <strong>✅ Import Successful!</strong>
                        </div>
                        <div>
                            <p>Processed: ${data.results.processed} items</p>
                            <p>Added: ${data.results.added} new items</p>
                            <p>Updated: ${data.results.updated} existing items</p>
                            <p>Failed: ${data.results.failed} items</p>
                        </div>
                        ${data.results.errors.length > 0 ? `
                            <div style="margin-top: 1rem; color: #ef4444;">
                                <strong>Errors:</strong>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    ${data.results.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `;

                    // Reload item categories if we're on the donation form
                    loadItemCategories();
                } else {
                    resultsContent.innerHTML = `
                        <div style="color: #ef4444;">
                            <strong>❌ Import Failed</strong>
                            <p style="margin-top: 0.5rem;">${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsContent.innerHTML = `
                    <div style="color: #ef4444;">
                        <strong>❌ Import Error</strong>
                        <p style="margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }

            document.getElementById('itemsImportPreview').style.display = 'none';
        }

        function cancelItemsImport() {
            document.getElementById('itemsImportPreview').style.display = 'none';
            document.getElementById('itemsCsvFileInput').value = '';
            itemsImportData = [];
        }

        function closeItemsImport() {
            document.getElementById('importItemsPanel').style.display = 'none';
            document.getElementById('itemsImportResults').style.display = 'none';
            document.getElementById('itemsCsvFileInput').value = '';
            itemsImportData = [];
        }

        // Setup drag and drop for items CSV
        document.addEventListener('DOMContentLoaded', function() {
            const itemsDropZone = document.getElementById('itemsCsvDropZone');
            if (itemsDropZone) {
                itemsDropZone.addEventListener('click', () => {
                    document.getElementById('itemsCsvFileInput').click();
                });

                itemsDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    itemsDropZone.style.borderColor = '#059669';
                    itemsDropZone.style.background = '#d1fae5';
                });

                itemsDropZone.addEventListener('dragleave', () => {
                    itemsDropZone.style.borderColor = '#10b981';
                    itemsDropZone.style.background = '#f0fdf4';
                });

                itemsDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    itemsDropZone.style.borderColor = '#10b981';
                    itemsDropZone.style.background = '#f0fdf4';

                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].name.endsWith('.csv')) {
                        processItemsCsvFile(files[0]);
                    }
                });
            }
        });

        // Calculate stock donation total
        function calculateStockTotal() {
            const shares = parseFloat(document.getElementById('stockQuantity').value) || 0;
            const pricePerShare = parseFloat(document.getElementById('fairMarketValue').value) || 0;
            const total = shares * pricePerShare;

            document.getElementById('stockTotalDisplay').textContent = '$' + total.toFixed(2);
            document.getElementById('stockCalculation').textContent =
                `${shares} shares × $${pricePerShare.toFixed(2)} = $${total.toFixed(2)}`;

            // Update tax savings when stock total changes
            updateTaxSavings();
        }

        // Calculate crypto donation total
        function calculateCryptoTotal() {
            const quantity = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
            const pricePerUnit = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
            const total = quantity * pricePerUnit;
            const costBasis = parseFloat(document.getElementById('cryptoCostBasis').value) || 0;
            const holdingPeriod = document.getElementById('cryptoHoldingPeriod').value;

            document.getElementById('cryptoTotalDisplay').textContent = '$' + total.toFixed(2);
            document.getElementById('cryptoCalculation').textContent =
                `${quantity} units × $${pricePerUnit.toFixed(2)} = $${total.toFixed(2)}`;

            // Update tax savings display
            updateTaxSavings();

            // Calculate tax deduction based on holding period
            let deduction = total;
            let note = '';
            if (holdingPeriod === 'short' && costBasis > 0) {
                deduction = Math.min(costBasis, total);
                note = deduction === costBasis ? ' (limited to cost basis)' : ' (at fair market value)';
            }

            document.getElementById('cryptoDeductionAmount').textContent = '$' + deduction.toFixed(2) + note;
        }

        // Calculate mileage deduction
        function calculateMileageDeduction() {
            const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
            // Use stored rate if editing, otherwise use current IRS rate
            let rate = 0.14; // 2024 IRS rate
            if (window.editingDonationId && allDonations) {
                const donation = allDonations.find(d => d.id === window.editingDonationId);
                if (donation && donation.mileage_rate) {
                    rate = donation.mileage_rate;
                }
            }
            const deduction = miles * rate;
            document.getElementById('mileageDeduction').textContent = deduction.toFixed(2);
            // Update the rate display
            const rateDisplay = document.getElementById('mileageRateDisplay');
            if (rateDisplay) {
                rateDisplay.textContent = rate.toFixed(2);
            }
            // Update tax savings when mileage changes
            updateTaxSavings();
        }

        // Function to populate year dropdowns dynamically
        function populateYearSelectors() {
            // Simple fixed range of tax years
            const currentYear = new Date().getFullYear(); // Get actual current year

            // Show previous year, current year, next year, and "All Years" option
            const years = [
                { value: 'all', label: 'All Years' },
                { value: currentYear - 1, label: (currentYear - 1).toString() },
                { value: currentYear, label: currentYear.toString() },
                { value: currentYear + 1, label: (currentYear + 1).toString() }
            ];

            // Populate global year filter
            const globalFilter = document.getElementById('globalYearFilter');
            if (globalFilter) {
                globalFilter.innerHTML = years.map(year =>
                    `<option value="${year.value}" ${year.value === currentYear ? 'selected' : ''}>${year.label}</option>`
                ).join('');
            }

            // Populate report year filter
            const reportFilter = document.getElementById('reportYear');
            if (reportFilter) {
                reportFilter.innerHTML = years.map(year =>
                    `<option value="${year.value}" ${year.value === currentYear ? 'selected' : ''}>${year.label}</option>`
                ).join('');
            }
        }

        // Common cryptocurrencies list
        const cryptoList = [
            { name: 'Bitcoin', symbol: 'BTC' },
            { name: 'Ethereum', symbol: 'ETH' },
            { name: 'Tether', symbol: 'USDT' },
            { name: 'BNB', symbol: 'BNB' },
            { name: 'Solana', symbol: 'SOL' },
            { name: 'XRP', symbol: 'XRP' },
            { name: 'USDC', symbol: 'USDC' },
            { name: 'Cardano', symbol: 'ADA' },
            { name: 'Avalanche', symbol: 'AVAX' },
            { name: 'Dogecoin', symbol: 'DOGE' },
            { name: 'TRON', symbol: 'TRX' },
            { name: 'Chainlink', symbol: 'LINK' },
            { name: 'Polygon', symbol: 'MATIC' },
            { name: 'Polkadot', symbol: 'DOT' },
            { name: 'Wrapped Bitcoin', symbol: 'WBTC' },
            { name: 'Shiba Inu', symbol: 'SHIB' },
            { name: 'Dai', symbol: 'DAI' },
            { name: 'Litecoin', symbol: 'LTC' },
            { name: 'Bitcoin Cash', symbol: 'BCH' },
            { name: 'Uniswap', symbol: 'UNI' },
            { name: 'Stellar', symbol: 'XLM' },
            { name: 'Cosmos', symbol: 'ATOM' },
            { name: 'Ethereum Classic', symbol: 'ETC' },
            { name: 'Monero', symbol: 'XMR' },
            { name: 'Internet Computer', symbol: 'ICP' },
            { name: 'Aptos', symbol: 'APT' },
            { name: 'Filecoin', symbol: 'FIL' },
            { name: 'Hedera', symbol: 'HBAR' },
            { name: 'Arbitrum', symbol: 'ARB' },
            { name: 'VeChain', symbol: 'VET' },
            { name: 'Near Protocol', symbol: 'NEAR' },
            { name: 'Optimism', symbol: 'OP' },
            { name: 'Aave', symbol: 'AAVE' },
            { name: 'Algorand', symbol: 'ALGO' },
            { name: 'The Graph', symbol: 'GRT' },
            { name: 'Fantom', symbol: 'FTM' },
            { name: 'Decentraland', symbol: 'MANA' },
            { name: 'Axie Infinity', symbol: 'AXS' },
            { name: 'The Sandbox', symbol: 'SAND' },
            { name: 'Theta', symbol: 'THETA' },
            { name: 'Tezos', symbol: 'XTZ' },
            { name: 'Flow', symbol: 'FLOW' },
            { name: 'Zcash', symbol: 'ZEC' },
            { name: 'Enjin Coin', symbol: 'ENJ' },
            { name: 'Maker', symbol: 'MKR' },
            { name: 'Compound', symbol: 'COMP' },
            { name: 'Curve', symbol: 'CRV' },
            { name: 'Pancakeswap', symbol: 'CAKE' },
            { name: 'Yearn Finance', symbol: 'YFI' },
            { name: 'Basic Attention Token', symbol: 'BAT' }
        ];

        // Function to search cryptocurrencies
        function searchCrypto(query) {
            const dropdown = document.getElementById('cryptoDropdown');
            if (!query) {
                dropdown.style.display = 'none';
                return;
            }

            const filtered = cryptoList.filter(crypto =>
                crypto.name.toLowerCase().includes(query.toLowerCase()) ||
                crypto.symbol.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding:0.5rem;color:#6b7280;">No cryptocurrencies found</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = filtered.map(crypto => `
                <div style="padding:0.5rem;cursor:pointer;hover:background:#f3f4f6;"
                     onmouseover="this.style.background='#f3f4f6'"
                     onmouseout="this.style.background='white'"
                     onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                    <strong>${crypto.name}</strong> (${crypto.symbol})
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        // Function to show all cryptos when field is focused
        function showCryptoDropdown() {
            const query = document.getElementById('cryptoName').value;
            if (!query) {
                // Show top cryptos if no query
                const dropdown = document.getElementById('cryptoDropdown');
                const topCryptos = cryptoList.slice(0, 10);
                dropdown.innerHTML = topCryptos.map(crypto => `
                    <div style="padding:0.5rem;cursor:pointer;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='white'"
                         onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                        <strong>${crypto.name}</strong> (${crypto.symbol})
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            } else {
                searchCrypto(query);
            }
        }

        // Function to select a cryptocurrency
        function selectCrypto(name, symbol) {
            document.getElementById('cryptoName').value = name;
            document.getElementById('cryptoSymbol').value = symbol;
            document.getElementById('cryptoDropdown').style.display = 'none';
            // Focus on next field
            document.getElementById('cryptoDonationTime').focus();
        }

        // Hide crypto dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#cryptoName') && !e.target.closest('#cryptoDropdown')) {
                const dropdown = document.getElementById('cryptoDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });

        // Global variable to store all donations for filtering
        let allDonations = [];

        // Function to filter donations
        function filterDonations() {
            const searchTerm = document.getElementById('donationSearch').value.toLowerCase();
            const typeFilter = document.getElementById('donationTypeFilter').value;
            const monthFilter = document.getElementById('donationMonthFilter').value;

            // Use stored donations - if empty, just return (loadDonations will call filterDonations when done)
            if (!allDonations || allDonations.length === 0) {
                return;
            }

            let filtered = allDonations;

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(d =>
                    (d.charity_name && d.charity_name.toLowerCase().includes(searchTerm)) ||
                    (parseNotesDisplay(d.notes) && parseNotesDisplay(d.notes).toLowerCase().includes(searchTerm)) ||
                    (d.crypto_symbol && d.crypto_symbol.toLowerCase().includes(searchTerm)) ||
                    (d.stock_symbol && d.stock_symbol.toLowerCase().includes(searchTerm))
                );
            }

            // Filter by type - handle both donation_type field and parsed JSON notes
            if (typeFilter !== 'all') {
                filtered = filtered.filter(d => {
                    // First check if donation_type is directly available
                    if (d.donation_type) {
                        return d.donation_type === typeFilter;
                    }
                    // Otherwise try to parse from notes JSON
                    if (d.notes && d.notes.startsWith('{')) {
                        try {
                            const notesObj = JSON.parse(d.notes);
                            return notesObj.donation_type === typeFilter;
                        } catch (e) {
                            return false;
                        }
                    }
                    // Default to cash if no type specified
                    return typeFilter === 'cash';
                });
            }

            // Filter by month
            if (monthFilter) {
                const [year, month] = monthFilter.split('-');
                filtered = filtered.filter(d => {
                    const date = d.date || d.donation_date;
                    return date && date.startsWith(`${year}-${month}`);
                });
            }

            // Display filtered donations
            displayFilteredDonations(filtered);
        }

        // Helper function to display filtered donations
        function displayFilteredDonations(donations) {
            const container = document.getElementById('donationsContent');

            if (!donations || donations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><p>No donations found matching your search criteria.</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Donation Date</th><th>Charity</th><th>Type</th><th>Amount</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
            donations.forEach(donation => {
                // Parse date correctly to avoid timezone issues
                const dateStr = donation.date || donation.donation_date;
                let date;
                if (dateStr) {
                    if (dateStr.includes('-')) {
                        const [year, month, day] = dateStr.split('-');
                        date = `${month}/${day}/${year}`;
                    } else {
                        date = new Date(dateStr).toLocaleDateString();
                    }
                }

                const donationType = donation.donation_type || 'cash';
                const typeIcon = {
                    cash: '💵',
                    items: '🎁',
                    miles: '🚗',
                    stock: '📈',
                    crypto: '🪙'
                }[donationType] || '💰';

                // Add personal charity indicator
                const isPersonalCharity = !!donation.user_charity_id;
                const charityDisplay = isPersonalCharity
                    ? `${donation.charity_name || 'Unknown'} <span style="background: #fbbf24; color: #78350f; font-size: 0.7rem; padding: 0.125rem 0.375rem; border-radius: 3px; font-weight: bold; margin-left: 0.25rem;">P</span>`
                    : (donation.charity_name || 'Unknown');

                html += `
                    <tr>
                        <td>${date || 'N/A'}</td>
                        <td>${charityDisplay}</td>
                        <td><span title="${donationType}">${typeIcon}</span></td>
                        <td>$${formatCurrency(donation.donation_type === 'items' ? (donation.estimated_value || donation.amount) : donation.amount, true)}</td>
                        <td>${parseNotesDisplay(donation.notes) || '-'}</td>
                        <td style="position: relative;">
                            <div class="dropdown" style="display: inline-block;">
                                <button class="btn-action" onclick="toggleActionMenu(event, '${donation.id}')" title="Actions">⋯</button>
                                <div id="actionMenu-${donation.id}" class="dropdown-menu" style="display: none; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 150px;">
                                    <button onclick="viewDonationDetails('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">👁️ View Details</button>
                                    <button onclick="editDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">✏️ Edit</button>
                                    <button onclick="addReceipt('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">📎 Add Receipt</button>
                                    <hr style="margin: 0; border: none; border-top: 1px solid #e5e7eb;">
                                    <button onclick="deleteDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: #ef4444;">🗑️ Delete</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Global variable to store all personal charities for filtering
        let allPersonalCharities = [];

        // Function to filter personal charities
        function filterPersonalCharities() {
            const searchTerm = document.getElementById('charitySearch').value.toLowerCase();

            if (!allPersonalCharities || allPersonalCharities.length === 0) {
                // Get personal charities from the displayed content or storage
                // Personal charities should come from API, not localStorage
                const storedCharities = [];
                allPersonalCharities = storedCharities;
            }

            let filtered = allPersonalCharities;

            // Filter by search term (name or EIN)
            if (searchTerm) {
                filtered = filtered.filter(charity =>
                    (charity.name && charity.name.toLowerCase().includes(searchTerm)) ||
                    (charity.ein && charity.ein.toLowerCase().includes(searchTerm))
                );
            }

            // Display filtered charities
            displayFilteredPersonalCharities(filtered);
        }

        // Helper function to display filtered personal charities
        function displayFilteredPersonalCharities(charities) {
            const container = document.getElementById('charitiesContent');

            if (!charities || charities.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏛️</div><p>No charities found matching your search criteria.</p></div>';
                return;
            }

            let html = '';
            charities.forEach(charity => {
                html += `
                    <div class="charity-item">
                        <div class="charity-info">
                            <div class="charity-name">${charity.name}</div>
                            <div class="charity-details">
                                EIN: ${charity.ein || 'Not specified'} | Category: ${charity.category || 'Not specified'}
                            </div>
                        </div>
                        <div class="charity-actions">
                            <button onclick="editCharity('${charity.id}')" class="small-btn" title="Edit">✏️</button>
                            <button onclick="deleteCharity('${charity.id}')" class="small-btn danger" title="Delete">🗑️</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Function to add receipt to donation
        // Toggle action dropdown menu
        function toggleActionMenu(event, donationId) {
            event.stopPropagation();
            const menu = document.getElementById(`actionMenu-${donationId}`);
            const button = event.target;

            // Close all other menus
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.style.display = 'none';
            });

            // Toggle this menu
            if (menu.style.display === 'none' || !menu.style.display) {
                // Use fixed positioning for better control
                menu.style.position = 'fixed';
                menu.style.display = 'block';
                menu.style.visibility = 'hidden'; // Hide temporarily to get dimensions

                // Get measurements
                const buttonRect = button.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                const windowHeight = window.innerHeight;
                const windowWidth = window.innerWidth;

                // Calculate available space
                const spaceBelow = windowHeight - buttonRect.bottom;
                const spaceAbove = buttonRect.top;
                const menuHeight = menuRect.height;
                const menuWidth = menuRect.width;

                // Reset positioning styles
                menu.style.top = '';
                menu.style.bottom = '';
                menu.style.left = '';
                menu.style.right = '';
                menu.style.maxHeight = '';
                menu.style.overflowY = '';

                // Vertical positioning
                if (spaceBelow >= menuHeight + 10) {
                    // Enough space below
                    menu.style.top = `${buttonRect.bottom + 5}px`;
                } else if (spaceAbove >= menuHeight + 10) {
                    // Not enough space below, but enough above
                    menu.style.top = `${buttonRect.top - menuHeight - 5}px`;
                } else {
                    // Not enough space either way - position at visible area with scroll
                    if (spaceBelow > spaceAbove) {
                        // More space below - attach to button and add scroll
                        menu.style.top = `${buttonRect.bottom + 5}px`;
                        menu.style.maxHeight = `${Math.max(100, spaceBelow - 15)}px`;
                        menu.style.overflowY = 'auto';
                    } else {
                        // More space above
                        menu.style.top = `${Math.max(10, buttonRect.top - menuHeight - 5)}px`;
                        if (buttonRect.top - menuHeight - 5 < 10) {
                            menu.style.top = '10px';
                            menu.style.maxHeight = `${buttonRect.top - 15}px`;
                            menu.style.overflowY = 'auto';
                        }
                    }
                }

                // Horizontal positioning - prefer right alignment with button
                if (buttonRect.right - menuWidth >= 10) {
                    // Align right edge with button right edge
                    menu.style.left = `${buttonRect.right - menuWidth}px`;
                } else if (buttonRect.left + menuWidth <= windowWidth - 10) {
                    // Align left edge with button left edge
                    menu.style.left = `${buttonRect.left}px`;
                } else {
                    // Center in viewport if neither works
                    menu.style.left = `${Math.max(10, Math.min(windowWidth - menuWidth - 10, buttonRect.left))}px`;
                }

                // Make visible
                menu.style.visibility = 'visible';
                menu.style.zIndex = '1000';
            } else {
                menu.style.display = 'none';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                m.style.display = 'none';
            });
        });

        // Cash Donation Edit Modal Functions
        function openEditCashDonationModal(donation) {
            const modal = document.getElementById('editCashDonationModal');
            if (!modal) return;

            // Store donation ID for saving
            document.getElementById('editCashDonationId').value = donation.id;

            // Store charity info
            const charityId = donation.charity_id || donation.user_charity_id || '';
            const charitySource = donation.charity_source || (donation.user_charity_id ? 'personal' : 'system');
            document.getElementById('editCashCharityId').value = charityId;
            document.getElementById('editCashCharitySource').value = charitySource;

            // Display charity name and EIN
            document.getElementById('editCashCharityName').textContent = donation.charity_name || 'Unknown Charity';
            const einDisplay = document.getElementById('editCashCharityEIN');
            if (donation.charity_ein) {
                einDisplay.textContent = `EIN: ${donation.charity_ein}`;
                einDisplay.style.display = 'block';
            } else {
                einDisplay.style.display = 'none';
            }

            // Populate form fields
            document.getElementById('editCashDate').value = donation.date || donation.donation_date || '';
            document.getElementById('editCashAmount').value = donation.amount || '';

            // Parse notes if needed
            let notes = donation.notes || '';
            if (typeof notes === 'string' && notes.startsWith('{')) {
                try {
                    const notesObj = JSON.parse(notes);
                    notes = notesObj.notes || notesObj.userNotes || '';
                } catch (e) {
                    // Use as-is if not valid JSON
                }
            }
            document.getElementById('editCashNotes').value = notes;

            // Calculate tax savings
            updateEditCashTaxSavings();

            // Show modal
            modal.classList.add('active');
        }

        function closeEditCashModal() {
            document.getElementById('editCashDonationModal').classList.remove('active');
            document.getElementById('editCashDonationForm').reset();
        }

        async function updateEditCashTaxSavings() {
            const amount = parseFloat(document.getElementById('editCashAmount').value) || 0;
            const dateStr = document.getElementById('editCashDate').value;

            // Get year from donation date
            let taxRate = 0;
            if (dateStr) {
                const year = dateStr.split('-')[0]; // Date is in YYYY-MM-DD format
                taxRate = await getTaxRateForYear(year);
            } else {
                // Fallback to current year if no date
                const currentYear = new Date().getFullYear().toString();
                taxRate = await getTaxRateForYear(currentYear);
            }

            const savings = (amount * taxRate).toFixed(2);
            document.getElementById('editCashTaxSavings').textContent = formatCurrency(savings, true);
        }

        // Handle Edit Cash Donation Form Submit
        document.getElementById('editCashDonationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const donationId = document.getElementById('editCashDonationId').value;
            const charityId = document.getElementById('editCashCharityId').value;
            const charitySource = document.getElementById('editCashCharitySource').value;

            const formData = {
                donation_type: 'cash',
                donation_date: document.getElementById('editCashDate').value,
                amount: parseFloat(document.getElementById('editCashAmount').value),
                notes: document.getElementById('editCashNotes').value
            };

            // Set the appropriate charity ID field based on source
            if (charitySource === 'personal') {
                formData.user_charity_id = charityId;
                formData.charity_source = 'personal';
            } else {
                formData.charity_id = charityId;
                formData.charity_source = 'system';
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('✅ Cash donation updated successfully!', 'success');
                    closeEditCashModal();
                    await loadDonations();
                    await loadStats();
                    await loadCharities();
                } else {
                    showToast(`❌ Failed to update donation: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error updating donation:', error);
                showToast('❌ Failed to update donation', 'error');
            }
        });

        // Item Donation Edit Modal Functions
        let editingItemsArray = [];

        function openEditItemDonationModal(donation) {
            const modal = document.getElementById('editItemDonationModal');
            if (!modal) return;

            // Store donation for saving
            window.currentEditingDonation = donation;
            editingItemsArray = [];

            // Populate charity and date
            const charityName = donation.charity_name || '';
            const charityId = donation.user_charity_id || donation.charity_id || '';

            document.getElementById('editItemCharity').value = charityName;
            document.getElementById('editItemCharityId').value = charityId;
            document.getElementById('editItemDate').value = donation.date || donation.donation_date || '';

            // Also set charity again after a delay to handle any race conditions
            if (charityName) {
                setTimeout(() => {
                    const charityInput = document.getElementById('editItemCharity');
                    if (charityInput && !charityInput.value) {
                        console.log('[EDIT ITEM] Setting charity name after delay:', charityName);
                        charityInput.value = charityName;
                    }
                }, 100);
            }

            // Extract user notes
            let userNotes = '';
            if (donation.notes) {
                if (donation.notes.startsWith('ITEMS:')) {
                    const lastBracketIndex = donation.notes.lastIndexOf(']');
                    if (lastBracketIndex !== -1) {
                        userNotes = donation.notes.substring(lastBracketIndex + 1).replace(/^\|?\s*/, '').trim();
                    }
                } else {
                    userNotes = donation.notes;
                }

                // Check if userNotes is JSON and extract the actual note
                if (userNotes.startsWith('{') && userNotes.includes('userNotes')) {
                    try {
                        const parsed = JSON.parse(userNotes);
                        userNotes = parsed.userNotes || '';
                    } catch (e) {
                        // Not valid JSON, use as-is
                    }
                }
            }
            document.getElementById('editItemNotes').value = userNotes;

            // Load items
            if (donation.items && donation.items.length > 0) {
                donation.items.forEach(item => {
                    // Check if this is a custom item (category is 'Other' or has value_source)
                    const isCustom = item.category === 'Other' || item.isCustom || item.value_source;

                    editingItemsArray.push({
                        item_name: item.item_name,
                        category: item.category,
                        condition: item.condition,
                        quantity: item.quantity,
                        unit_value: item.unit_value,
                        total_value: item.total_value,
                        value_source: item.value_source || '',
                        isCustom: isCustom
                    });
                });
            }

            // Render items
            renderEditItems();

            // Show modal
            modal.style.display = 'flex';
        }

        function closeEditItemModal() {
            const modal = document.getElementById('editItemDonationModal');
            if (modal) modal.style.display = 'none';
            window.currentEditingDonation = null;
            editingItemsArray = [];
        }

        async function renderEditItems() {
            const container = document.getElementById('editItemsList');
            const totalElement = document.getElementById('editItemTotal');

            if (!container) return;

            if (editingItemsArray.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 2rem;">No items added yet</p>';
                if (totalElement) totalElement.textContent = '0.00';
                // Clear tax savings display
                const taxSavingsElem = document.getElementById('editItemTaxSavings');
                if (taxSavingsElem) taxSavingsElem.textContent = '0.00';
                return;
            }

            let html = '';
            let total = 0;

            editingItemsArray.forEach((item, index) => {
                const itemTotal = parseFloat(item.total_value) || 0;
                total += itemTotal;

                // Check if this is a new item that needs dropdowns
                if (item.is_new && !item.isCustom) {
                    html += `
                        <div style="background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; position: relative;">
                            <div style="display: grid; grid-template-columns: 1.5fr 2fr 1fr 0.8fr 0.8fr 1fr; gap: 0.5rem; align-items: start;">
                                <!-- Category Dropdown -->
                                <div>
                                    <label style="font-size: 0.75rem; color: #374151; font-weight: 600; display: block; margin-bottom: 0.25rem;">Category</label>
                                    <select id="editItemCategory_${index}"
                                            onchange="editCategoryChanged(${index})"
                                            style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                                        <option value="">Select category...</option>
                                        ${itemCategories ? itemCategories.map(cat =>
                                            `<option value="${cat.id}">${cat.name}</option>`
                                        ).join('') : ''}
                                    </select>
                                </div>

                                <!-- Item Dropdown -->
                                <div>
                                    <label style="font-size: 0.75rem; color: #374151; font-weight: 600; display: block; margin-bottom: 0.25rem;">Item</label>
                                    <div id="editItemSearchContainer_${index}">
                                        <div style="position: relative;">
                                            <input type="text"
                                                   id="editItemSearch_${index}"
                                                   placeholder="${item.category_id ? 'Search items...' : 'Select category first'}"
                                                   oninput="searchEditItemsInline(${index}, this.value)"
                                                   onfocus="showEditItemDropdown(${index})"
                                                   ${!item.category_id ? 'disabled' : ''}
                                                   style="width: 100%; padding: 0.375rem; border: 1px solid ${item.category_id ? '#d1d5db' : '#e5e7eb'}; border-radius: 4px; font-size: 0.875rem;">
                                            <input type="hidden" id="editItemSelect_${index}">
                                            <!-- Item Dropdown -->
                                            <div id="editItemDropdown_${index}" style="display:none;position:absolute;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:1000;min-width:300px;">
                                                <!-- Populated dynamically -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    `;
                } else if (item.isCustom) {
                    // Custom "Other" item - show with special input fields
                    html += `
                        <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; position: relative;">
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.875rem; font-weight: 600; color: #92400e;">Custom Item Details</label>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <!-- Item Description (Read-only like regular items) -->
                                <div>
                                    <label style="font-size: 0.75rem; color: #92400e; display: block; margin-bottom: 0.25rem;">Custom Item Description</label>
                                    <input type="text"
                                           value="${item.item_name}"
                                           readonly
                                           style="width: 100%; padding: 0.375rem; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.875rem; background: #fffbeb; color: #92400e; font-weight: 500;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr; gap: 0.5rem; align-items: end;">
                                    <!-- Condition -->
                                    <div>
                                        <label style="font-size: 0.75rem; color: #92400e; display: block; margin-bottom: 0.25rem;">Condition</label>
                                        <select onchange="updateEditItem(${index}, 'condition', this.value)"
                                                style="width: 100%; padding: 0.375rem; border: 1px solid #fbbf24; border-radius: 4px; font-size: 0.875rem;">
                                            <option value="fair" ${item.condition === 'fair' ? 'selected' : ''}>Fair</option>
                                            <option value="good" ${item.condition === 'good' ? 'selected' : ''}>Good</option>
                                            <option value="very_good" ${item.condition === 'very_good' ? 'selected' : ''}>Very Good</option>
                                            <option value="excellent" ${item.condition === 'excellent' ? 'selected' : ''}>Excellent</option>
                                        </select>
                                    </div>
                                    <!-- Quantity -->
                                    <div>
                                        <label style="font-size: 0.75rem; color: #92400e; display: block; margin-bottom: 0.25rem;">Quantity</label>
                                        <input type="number"
                                               value="${item.quantity}"
                                               onchange="updateEditItemQuantity(${index}, this.value)"
                                               min="1"
                                               style="width: 100%; padding: 0.375rem; border: 1px solid #fbbf24; border-radius: 4px; font-size: 0.875rem;">
                                    </div>
                                    <!-- Value per Item -->
                                    <div>
                                        <label style="font-size: 0.75rem; color: #92400e; display: block; margin-bottom: 0.25rem;">Value/Item</label>
                                        <input type="number"
                                               value="${item.unit_value || 0}"
                                               onchange="updateEditCustomValue(${index}, this.value)"
                                               placeholder="$0.00"
                                               step="0.01"
                                               min="0"
                                               style="width: 100%; padding: 0.375rem; border: 1px solid #fbbf24; border-radius: 4px; font-size: 0.875rem;">
                                    </div>
                                    <!-- Total Value -->
                                    <div>
                                        <label style="font-size: 0.75rem; color: #92400e; display: block; margin-bottom: 0.25rem;">Total Value</label>
                                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                                            <input type="number"
                                                   value="${(parseFloat(item.total_value) || 0).toFixed(2)}"
                                                   readonly
                                                   style="flex: 1; padding: 0.375rem; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.875rem; background: #fffbeb; font-weight: 600;">
                                            <button type="button"
                                                    onclick="removeEditItem(${index})"
                                                    title="Remove item"
                                                    style="width: 28px; height: 28px; padding: 0; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.125rem; line-height: 1; display: flex; align-items: center; justify-content: center;">
                                                ×
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Value Source -->
                                <div>
                                    <label style="font-size: 0.75rem; color: #92400e; display: block; margin-bottom: 0.25rem;">Value Source/Justification (Required for tax documentation)</label>
                                    <input type="text"
                                           value="${item.value_source || ''}"
                                           onchange="updateEditItem(${index}, 'value_source', this.value)"
                                           placeholder="e.g., eBay comparable, retail price, appraisal..."
                                           style="width: 100%; padding: 0.375rem; border: 1px solid #fbbf24; border-radius: 4px; font-size: 0.875rem; background: #fffbeb;">
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Existing item - show as readonly
                    html += `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; position: relative;">
                            <div style="display: grid; grid-template-columns: 1.5fr 2fr 1fr 0.8fr 0.8fr 1fr; gap: 0.5rem; align-items: start;">
                                <!-- Category -->
                                <div>
                                    <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">Category</label>
                                    <input type="text"
                                           value="${item.category}"
                                           readonly
                                           style="width: 100%; padding: 0.375rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem; background: #f9fafb; color: #6b7280;">
                                </div>

                                <!-- Item Name -->
                                <div>
                                    <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">
                                        ${item.category === 'Other' || item.isCustom ? 'Custom Item Description' : 'Item Name'}
                                    </label>
                                    <input type="text"
                                           value="${item.item_name}"
                                           ${item.category === 'Other' || item.isCustom ? `onchange="updateEditItem(${index}, 'item_name', this.value)"` : 'readonly'}
                                           style="width: 100%; padding: 0.375rem; border: 1px solid ${item.category === 'Other' || item.isCustom ? '#d1d5db' : '#e5e7eb'}; border-radius: 4px; font-size: 0.875rem; background: ${item.category === 'Other' || item.isCustom ? 'white' : '#f9fafb'}; color: ${item.category === 'Other' || item.isCustom ? '#374151' : '#6b7280'};">
                                </div>
                    `;
                }

                html += `

                            <!-- Condition -->
                            <div>
                                <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">Condition</label>
                                <select onchange="updateEditItem(${index}, 'condition', this.value)"
                                        style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                                    <option value="fair" ${item.condition === 'fair' ? 'selected' : ''}>Fair</option>
                                    <option value="good" ${item.condition === 'good' ? 'selected' : ''}>Good</option>
                                    <option value="very_good" ${item.condition === 'very_good' ? 'selected' : ''}>Very Good</option>
                                    <option value="excellent" ${item.condition === 'excellent' ? 'selected' : ''}>Excellent</option>
                                </select>
                            </div>

                            <!-- Quantity -->
                            <div>
                                <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">Qty</label>
                                <input type="number"
                                       value="${item.quantity}"
                                       onchange="updateEditItemQuantity(${index}, this.value)"
                                       min="1"
                                       style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                            </div>

                            <!-- Unit Value -->
                            <div>
                                <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">FMV</label>
                                <input type="number"
                                       value="${(item.unit_value || 0).toFixed(2)}"
                                       readonly
                                       step="0.01"
                                       style="width: 100%; padding: 0.375rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem; background: #f9fafb; color: #6b7280;">
                            </div>

                            <!-- Total Value with Delete -->
                            <div>
                                <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">Total $</label>
                                <div style="display: flex; gap: 0.25rem; align-items: center;">
                                    <input type="number"
                                           value="${itemTotal.toFixed(2)}"
                                           ${item.category === 'Other' || item.isCustom ? `onchange="updateEditItemValue(${index}, this.value)"` : 'readonly'}
                                           step="0.01"
                                           min="0"
                                           style="flex: 1; padding: 0.375rem; border: 1px solid ${item.category === 'Other' || item.isCustom ? '#d1d5db' : '#e5e7eb'}; border-radius: 4px; font-size: 0.875rem; background: ${item.category === 'Other' || item.isCustom ? 'white' : '#f9fafb'}; color: ${item.category === 'Other' || item.isCustom ? '#374151' : '#6b7280'};">
                                    <button type="button"
                                            onclick="removeEditItem(${index})"
                                            title="Remove item"
                                            style="width: 28px; height: 28px; padding: 0; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.125rem; line-height: 1; display: flex; align-items: center; justify-content: center;">
                                        ×
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${item.is_new && !item.isCustom ? `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #dbeafe; border-radius: 4px;">
                            <small style="color: #1e40af; font-size: 0.75rem;">
                                💡 Select a category, then search and select an item from the dropdown
                            </small>
                        </div>
                        ` : ''}
                        ${(item.category === 'Other' || item.isCustom) && !item.is_new ? `
                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: #fef3c7; border-radius: 4px;">
                            <label style="font-size: 0.75rem; color: #92400e; font-weight: 600; display: block; margin-bottom: 0.25rem;">
                                Value Source/Justification
                            </label>
                            <input type="text"
                                   value="${item.value_source || ''}"
                                   onchange="updateEditItem(${index}, 'value_source', this.value)"
                                   placeholder="e.g., eBay comparable, retail price, appraisal"
                                   style="width: 100%; padding: 0.375rem; border: 1px solid #fbbf24; border-radius: 4px; font-size: 0.875rem; background: white;">
                            <small style="color: #92400e; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                                IRS requires reasonable valuation method for custom items
                            </small>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
            if (totalElement) totalElement.textContent = total.toFixed(2);

            // Update receipt preview
            updateEditReceiptPreview(total);

            // Update tax savings display using donation year's rate
            const taxRateElem = document.getElementById('editItemTaxRate');
            const taxSavingsElem = document.getElementById('editItemTaxSavings');
            if (taxRateElem && taxSavingsElem) {
                // Get the donation date to determine year
                const dateStr = document.getElementById('editItemDate')?.value;
                let taxRate = 0;

                if (dateStr) {
                    const year = dateStr.split('-')[0];
                    // Use cached rate if available
                    taxRate = taxRatesByYear[year] || 0;
                } else {
                    // Fallback to current year's rate
                    const currentYear = new Date().getFullYear().toString();
                    taxRate = taxRatesByYear[currentYear] || 0;
                }

                const percentage = Math.round(taxRate * 100);
                taxRateElem.textContent = percentage;
                const savings = total * taxRate;
                taxSavingsElem.textContent = savings.toFixed(2);
            }
        }

        function updateEditReceiptPreview(total) {
            const receiptItemsList = document.getElementById('editReceiptItemsList');
            const receiptTotal = document.getElementById('editReceiptTotal');
            const receiptTaxRate = document.getElementById('editReceiptTaxRate');
            const receiptTaxSavings = document.getElementById('editReceiptTaxSavings');

            if (!receiptItemsList) return;

            // Update items list in receipt
            if (editingItemsArray.length === 0) {
                receiptItemsList.innerHTML = '<div class="empty-state" style="color:#9ca3af; text-align:center; padding:2rem; font-size:0.875rem;">No items added yet</div>';
                if (receiptTotal) receiptTotal.textContent = '0.00';
                if (receiptTaxSavings) receiptTaxSavings.textContent = '0.00';
            } else {
                let receiptHtml = '';
                editingItemsArray.forEach((item, index) => {
                    if (!item.is_new || (item.is_new && item.item_name)) {  // Only show items that are complete
                        const itemTotal = parseFloat(item.total_value) || 0;
                        receiptHtml += `
                            <div style="padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #111827; font-size: 0.875rem;">${item.item_name || 'New Item'}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem;">
                                            ${item.category} • ${item.condition ? item.condition.replace('_', ' ') : 'good'} • Qty: ${item.quantity}
                                        </div>
                                    </div>
                                    <div style="text-align: right; white-space: nowrap;">
                                        <div style="font-weight: 600; color: #374151;">$${itemTotal.toFixed(2)}</div>
                                        ${item.quantity > 1 ? `<div style="font-size: 0.75rem; color: #9ca3af;">$${(item.unit_value || 0).toFixed(2)} each</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                if (receiptHtml === '') {
                    receiptHtml = '<div style="color:#9ca3af; text-align:center; padding:2rem; font-size:0.875rem;">Add items to see receipt preview</div>';
                }

                receiptItemsList.innerHTML = receiptHtml;
                if (receiptTotal) receiptTotal.textContent = total.toFixed(2);

                // Update tax savings in receipt
                const dateStr = document.getElementById('editItemDate')?.value;
                let taxRate = 0;

                if (dateStr) {
                    const year = dateStr.split('-')[0];
                    taxRate = taxRatesByYear[year] || 0;
                } else {
                    const currentYear = new Date().getFullYear().toString();
                    taxRate = taxRatesByYear[currentYear] || 0;
                }

                const percentage = Math.round(taxRate * 100);
                if (receiptTaxRate) receiptTaxRate.textContent = percentage;
                const savings = total * taxRate;
                if (receiptTaxSavings) receiptTaxSavings.textContent = savings.toFixed(2);
            }
        }

        async function updateEditItem(index, field, value) {
            if (editingItemsArray[index]) {
                editingItemsArray[index][field] = value;

                // If condition or category changed and not a custom "Other" item, lookup new value
                if ((field === 'condition' || field === 'category') && editingItemsArray[index].category !== 'Other') {
                    await updateItemValueForCondition(index);
                }

                // Always re-render to show updated values
                renderEditItems();
            }
        }

        // Fetch item value based on condition from the items database
        async function updateItemValueForCondition(index) {
            const item = editingItemsArray[index];
            if (!item || !item.category) return;

            // For 'Other' category items, prompt user to update value manually
            if (item.category === 'Other') {
                console.log('[EDIT ITEM] Other category item - prompting user to update value');
                showItemValueUpdatePrompt(index);
                return;
            }

            console.log('[EDIT ITEM] Updating value for item:', item.item_name, 'Condition:', item.condition);

            try {
                // Find the category ID
                const category = itemCategories.find(cat => cat.name === item.category);
                if (!category) return;

                // Fetch items for this category
                const response = await fetch(`/api/items?category_id=${category.id}`);
                const data = await response.json();

                if (data.success && data.items) {
                    // Find matching item by name
                    const matchingItem = data.items.find(dbItem =>
                        dbItem.name.toLowerCase() === item.item_name.toLowerCase()
                    );

                    if (matchingItem) {
                        console.log('[EDIT ITEM] Found matching item in DB:', matchingItem);
                        // Get value based on condition
                        let newValue = 0;
                        const quantity = item.quantity || 1;

                        switch(item.condition) {
                            case 'fair':
                                newValue = 0; // IRS rule: fair condition = $0
                                break;
                            case 'good':
                                newValue = matchingItem.value_good || matchingItem.low_value || 0;
                                break;
                            case 'very_good':
                                // Use value_verygood if available, otherwise calculate mid value
                                newValue = matchingItem.value_verygood || matchingItem.mid_value ||
                                          ((parseFloat(matchingItem.low_value) + parseFloat(matchingItem.high_value)) / 2) || 0;
                                break;
                            case 'excellent':
                                newValue = matchingItem.value_excellent || matchingItem.high_value || 0;
                                break;
                        }

                        console.log('[EDIT ITEM] New value for', item.condition, ':', newValue);

                        // Update the item values
                        editingItemsArray[index].unit_value = newValue;
                        editingItemsArray[index].total_value = newValue * quantity;

                        // Force re-render after value update
                        renderEditItems();
                    } else {
                        console.log('[EDIT ITEM] No matching item found in database for:', item.item_name);
                        console.log('[EDIT ITEM] User must manually update value for new condition');
                        // Show notification to user
                        showItemValueUpdatePrompt(index);
                    }
                }
            } catch (error) {
                console.log('Could not fetch item value:', error);
                // Show notification for manual update
                showItemValueUpdatePrompt(index);
            }
        }

        // Show prompt for user to manually update value for custom items
        function showItemValueUpdatePrompt(index) {
            const item = editingItemsArray[index];
            if (!item) return;

            // Find the value input field for this item
            const itemRow = document.querySelector(`#editItemsList > div:nth-child(${index + 1})`);
            if (!itemRow) return;

            const valueInput = itemRow.querySelector('input[type="number"][onchange*="updateEditItemValue"]');
            if (!valueInput) return;

            // Highlight the value field
            valueInput.style.border = '2px solid #f59e0b';
            valueInput.style.backgroundColor = '#fef3c7';

            // Add a tooltip/message
            const existingMessage = itemRow.querySelector('.value-update-message');
            if (!existingMessage) {
                const message = document.createElement('div');
                message.className = 'value-update-message';
                message.style.cssText = 'color: #92400e; font-size: 0.75rem; margin-top: 0.25rem; font-style: italic;';
                message.textContent = `Please update value for "${item.condition}" condition`;
                valueInput.parentElement.appendChild(message);
            }

            // Focus the field for easy editing
            valueInput.focus();
            valueInput.select();
        }

        function updateEditItemQuantity(index, value) {
            if (editingItemsArray[index]) {
                const quantity = parseInt(value) || 1;
                editingItemsArray[index].quantity = quantity;

                // Recalculate total value based on unit value (NOT the other way around)
                const unitValue = parseFloat(editingItemsArray[index].unit_value) || 0;
                editingItemsArray[index].total_value = unitValue * quantity;

                console.log('[EDIT ITEM] Quantity updated to', quantity, ', Unit value:', unitValue, ', Total:', editingItemsArray[index].total_value);
                renderEditItems();
            }
        }

        function updateEditCustomValue(index, value) {
            if (editingItemsArray[index]) {
                const unitValue = parseFloat(value) || 0;
                const quantity = parseInt(editingItemsArray[index].quantity) || 1;
                editingItemsArray[index].unit_value = unitValue;
                editingItemsArray[index].total_value = unitValue * quantity;
                renderEditItems();
            }
        }

        // Handle custom item field updates from inline form
        function updateEditCustomItemField(index, field, value) {
            if (editingItemsArray[index]) {
                editingItemsArray[index][field] = value;
                renderEditItems();
            }
        }

        // Handle custom item value updates from inline form
        function updateEditCustomItemValue(index, value) {
            if (editingItemsArray[index]) {
                const unitValue = parseFloat(value) || 0;
                const quantity = parseInt(editingItemsArray[index].quantity) || 1;
                editingItemsArray[index].unit_value = unitValue;
                editingItemsArray[index].total_value = unitValue * quantity;
                renderEditItems();
            }
        }

        function updateEditItemValue(index, value) {
            if (editingItemsArray[index]) {
                const totalValue = parseFloat(value) || 0;
                const quantity = parseInt(editingItemsArray[index].quantity) || 1;
                editingItemsArray[index].total_value = totalValue;
                editingItemsArray[index].unit_value = totalValue / quantity;

                // Clear any value update prompts when user enters a new value
                const itemRow = document.querySelector(`#editItemsList > div:nth-child(${index + 1})`);
                if (itemRow) {
                    const valueInput = itemRow.querySelector('input[type="number"][onchange*="updateEditItemValue"]');
                    if (valueInput) {
                        valueInput.style.border = '';
                        valueInput.style.backgroundColor = '';
                    }
                    const message = itemRow.querySelector('.value-update-message');
                    if (message) {
                        message.remove();
                    }
                }

                renderEditItems();
            }
        }

        function removeEditItem(index) {
            editingItemsArray.splice(index, 1);
            renderEditItems();
        }

        function addNewItemRow() {
            // Add a new empty row with category dropdown (like the main add form)
            editingItemsArray.push({
                item_name: '',
                category: '',
                category_id: '',
                condition: 'good',
                quantity: 1,
                unit_value: 0,
                total_value: 0,
                is_new: true  // Flag to identify new rows that need dropdowns
            });
            renderEditItems();
        }

        function showEditItemCategoryModal() {
            // Create modal for category selection
            const modalHtml = `
                <div id="editItemCategoryModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 600;">Select Item Category</h3>

                        <!-- Search box -->
                        <input type="text"
                               id="editItemCategorySearch"
                               placeholder="Search categories..."
                               oninput="filterEditItemCategories(this.value)"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 1rem;">

                        <!-- Categories grid -->
                        <div id="editItemCategoriesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem;">
                            <!-- Will be populated dynamically -->
                        </div>

                        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
                            <button onclick="closeEditItemCategoryModal()"
                                    style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv.firstElementChild);

            // Populate categories
            populateEditItemCategories();
        }

        function populateEditItemCategories() {
            const grid = document.getElementById('editItemCategoriesGrid');
            if (!grid || !itemCategories) return;

            let html = '';
            itemCategories.forEach(cat => {
                html += `
                    <div onclick="selectEditItemCategory(${cat.id}, '${cat.name}', '${cat.icon || '📦'}')"
                         style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;"
                         onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';"
                         onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${cat.icon || '📦'}</div>
                        <div style="font-size: 0.875rem; font-weight: 500;">${cat.name}</div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function filterEditItemCategories(search) {
            const grid = document.getElementById('editItemCategoriesGrid');
            if (!grid || !itemCategories) return;

            const searchLower = search.toLowerCase();
            let html = '';

            itemCategories.forEach(cat => {
                if (cat.name.toLowerCase().includes(searchLower)) {
                    html += `
                        <div onclick="selectEditItemCategory(${cat.id}, '${cat.name}', '${cat.icon || '📦'}')"
                             style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';"
                             onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">${cat.icon || '📦'}</div>
                            <div style="font-size: 0.875rem; font-weight: 500;">${cat.name}</div>
                        </div>
                    `;
                }
            });

            grid.innerHTML = html || '<p style="text-align: center; color: #6b7280; grid-column: 1/-1;">No categories found</p>';
        }

        function closeEditItemCategoryModal() {
            const modal = document.getElementById('editItemCategoryModal');
            if (modal) modal.remove();
        }

        async function selectEditItemCategory(categoryId, categoryName, categoryIcon) {
            // Close category modal
            closeEditItemCategoryModal();

            // Now show item selection modal for this category
            showEditItemSelectionModal(categoryId, categoryName, categoryIcon);
        }

        async function showEditItemSelectionModal(categoryId, categoryName, categoryIcon) {
            // Create item selection modal
            const modalHtml = `
                <div id="editItemSelectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600;">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">${categoryIcon}</span>
                            Select ${categoryName} Item
                        </h3>

                        <!-- Search box -->
                        <input type="text"
                               id="editItemSearch"
                               placeholder="Search items in ${categoryName}..."
                               oninput="searchEditItems(${categoryId}, this.value)"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 1rem;">

                        <!-- Items list -->
                        <div id="editItemsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <div style="padding: 1rem; text-align: center; color: #6b7280;">Loading items...</div>
                        </div>

                        <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="showEditItemCategoryModal()"
                                    style="padding: 0.5rem 1rem; color: #3b82f6; background: white; border: none; cursor: pointer; text-decoration: underline;">
                                ← Back to categories
                            </button>
                            <button onclick="closeEditItemSelectionModal()"
                                    style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv.firstElementChild);

            // Load items for this category
            await loadEditItemsForCategory(categoryId, categoryName);
        }

        async function loadEditItemsForCategory(categoryId, categoryName) {
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                const data = await response.json();

                const listDiv = document.getElementById('editItemsList');
                if (!listDiv) return;

                if (data.success && data.items && data.items.length > 0) {
                    let html = '';
                    data.items.forEach(item => {
                        const values = [
                            item.value_good || item.low_value || 0,
                            item.value_verygood || item.mid_value || ((parseFloat(item.low_value) + parseFloat(item.high_value)) / 2) || 0,
                            item.value_excellent || item.high_value || 0
                        ];

                        html += `
                            <div onclick="selectEditItem('${item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${categoryName}', ${values[0]}, ${item.id})"
                                 style="padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                                 onmouseover="this.style.background='#f9fafb';"
                                 onmouseout="this.style.background='white';">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500; color: #111827;">${item.name}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                            Good: $${values[0].toFixed(2)} | Very Good: $${values[1].toFixed(2)} | Excellent: $${values[2].toFixed(2)}
                                        </div>
                                    </div>
                                    <div style="color: #3b82f6; font-size: 1.25rem;">→</div>
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280;">No items found in this category</div>';
                }
            } catch (error) {
                console.error('Error loading items:', error);
                const listDiv = document.getElementById('editItemsList');
                if (listDiv) {
                    listDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: #ef4444;">Error loading items</div>';
                }
            }
        }

        async function searchEditItems(categoryId, searchTerm) {
            const listDiv = document.getElementById('editItemsList');
            if (!listDiv) return;

            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                const data = await response.json();

                if (data.success && data.items) {
                    const filtered = data.items.filter(item =>
                        item.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );

                    if (filtered.length > 0) {
                        let html = '';
                        const category = itemCategories.find(c => c.id == categoryId);
                        const categoryName = category ? category.name : 'Unknown';

                        filtered.forEach(item => {
                            const values = [
                                item.value_good || item.low_value || 0,
                                item.value_verygood || item.mid_value || ((parseFloat(item.low_value) + parseFloat(item.high_value)) / 2) || 0,
                                item.value_excellent || item.high_value || 0
                            ];

                            html += `
                                <div onclick="selectEditItem('${item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${categoryName}', ${values[0]}, ${item.id})"
                                     style="padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;"
                                     onmouseover="this.style.background='#f9fafb';"
                                     onmouseout="this.style.background='white';">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 500; color: #111827;">${item.name}</div>
                                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                                Good: $${values[0].toFixed(2)} | Very Good: $${values[1].toFixed(2)} | Excellent: $${values[2].toFixed(2)}
                                            </div>
                                        </div>
                                        <div style="color: #3b82f6; font-size: 1.25rem;">→</div>
                                    </div>
                                </div>
                            `;
                        });
                        listDiv.innerHTML = html;
                    } else {
                        listDiv.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280;">No matching items found</div>';
                    }
                }
            } catch (error) {
                console.error('Error searching items:', error);
            }
        }

        function closeEditItemSelectionModal() {
            const modal = document.getElementById('editItemSelectionModal');
            if (modal) modal.remove();
        }

        function selectEditItem(itemName, categoryName, defaultValue, itemId) {
            // Add the selected item to the array
            editingItemsArray.push({
                item_name: itemName,
                category: categoryName,
                condition: 'good',
                quantity: 1,
                unit_value: defaultValue,
                total_value: defaultValue,
                item_id: itemId  // Store item ID for reference
            });

            // Close the modal
            closeEditItemSelectionModal();

            // Re-render the items list
            renderEditItems();
        }

        // New inline functions for edit form
        async function editCategoryChanged(index) {
            const categorySelect = document.getElementById(`editItemCategory_${index}`);
            const itemSearch = document.getElementById(`editItemSearch_${index}`);

            if (!categorySelect || !itemSearch) return;

            const categoryId = categorySelect.value;
            const category = itemCategories.find(c => c.id == categoryId);

            if (categoryId && category) {
                // Update the item in the array
                editingItemsArray[index].category_id = categoryId;
                editingItemsArray[index].category = category.name;

                // Enable item search
                itemSearch.disabled = false;
                itemSearch.placeholder = `Search ${category.name} items...`;
                itemSearch.value = '';

                // Load items for this category
                await loadEditItemsForCategory(index, categoryId);
            } else {
                // Disable item search if no category
                itemSearch.disabled = true;
                itemSearch.placeholder = 'Select category first';
                itemSearch.value = '';
                editingItemsArray[index].category_id = '';
                editingItemsArray[index].category = '';
            }
        }

        async function loadEditItemsForCategory(index, categoryId) {
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                const data = await response.json();

                if (data.success && data.items) {
                    // Store items for this category
                    window[`editCategoryItems_${index}`] = data.items;
                }
            } catch (error) {
                console.error('Error loading items for category:', error);
            }
        }

        function showEditItemDropdown(index) {
            const dropdown = document.getElementById(`editItemDropdown_${index}`);
            const searchInput = document.getElementById(`editItemSearch_${index}`);

            if (!dropdown || !searchInput || searchInput.disabled) return;

            const items = window[`editCategoryItems_${index}`] || [];
            const searchTerm = searchInput.value.toLowerCase();
            const category = itemCategories.find(c => c.id == editingItemsArray[index].category_id);
            const categoryName = category ? category.name : 'this category';

            let html = '';

            // Always show "Other Item" option at the top (like Add form does)
            html = `
                <div onclick="selectEditCustomItem(${index})"
                     style="padding: 0.75rem; cursor: pointer; border-bottom: 2px solid #e5e7eb; background: #fef3c7;"
                     onmouseover="this.style.background='#fde68a'"
                     onmouseout="this.style.background='#fef3c7'">
                    <div style="font-weight: 600; color: #92400e;">📦 Other item in ${categoryName}</div>
                    <div style="font-size: 0.75rem; color: #92400e;">Item not listed? Enter your own description and value</div>
                </div>
            `;

            const filteredItems = searchTerm
                ? items.filter(item => item.name.toLowerCase().includes(searchTerm))
                : items.slice(0, 10); // Show first 10 if no search

            if (items.length === 0) {
                html += '<div style="padding: 0.75rem; color: #6b7280; text-align: center;">No items in database for this category</div>';
            } else if (filteredItems.length === 0) {
                html += '<div style="padding: 0.75rem; color: #6b7280; text-align: center;">No matching items found</div>';
            } else {
                filteredItems.forEach(item => {
                    const goodValue = item.value_good || item.low_value || 0;
                    // Use data attributes to avoid quote escaping issues
                    html += `
                        <div onclick="selectEditItemByElement(this, ${index})"
                             data-item-id="${item.id}"
                             data-item-name="${item.name.replace(/"/g, '&quot;')}"
                             data-item-value="${goodValue}"
                             style="padding: 0.5rem 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: pointer;"
                             onmouseover="this.style.background='#f9fafb';"
                             onmouseout="this.style.background='white';">
                            <div style="font-size: 0.875rem; font-weight: 500;">${item.name}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Value: $${goodValue.toFixed(2)}</div>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            positionEditDropdown(searchInput, dropdown);
        }

        function positionEditDropdown(input, dropdown) {
            // Get input position
            const inputRect = input.getBoundingClientRect();
            const dropdownHeight = 200; // Max height of dropdown
            const viewportHeight = window.innerHeight;

            // Check if dropdown would go off bottom of screen
            const spaceBelow = viewportHeight - inputRect.bottom;
            const spaceAbove = inputRect.top;

            if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
                // Position above the input
                dropdown.style.bottom = '100%';
                dropdown.style.top = 'auto';
                dropdown.style.marginBottom = '2px';
                dropdown.style.marginTop = '0';
            } else {
                // Position below the input (default)
                dropdown.style.top = '100%';
                dropdown.style.bottom = 'auto';
                dropdown.style.marginTop = '2px';
                dropdown.style.marginBottom = '0';
            }

            // Ensure minimum width
            dropdown.style.left = '0';
            dropdown.style.right = 'auto';
            dropdown.style.minWidth = Math.max(300, inputRect.width) + 'px';
        }

        function searchEditItemsInline(index, searchTerm) {
            showEditItemDropdown(index);
        }

        // Select item using data attributes (avoids quote escaping issues)
        function selectEditItemByElement(element, index) {
            const itemId = element.getAttribute('data-item-id');
            const itemName = element.getAttribute('data-item-name');
            const itemValue = parseFloat(element.getAttribute('data-item-value'));

            selectEditItemInline(index, itemName, itemValue, itemId);
        }

        function selectEditItemInline(index, itemName, defaultValue, itemId) {
            // Update the item in the array
            editingItemsArray[index].item_name = itemName;
            editingItemsArray[index].item_id = itemId;
            editingItemsArray[index].unit_value = defaultValue;
            editingItemsArray[index].total_value = defaultValue * editingItemsArray[index].quantity;
            editingItemsArray[index].is_new = false; // No longer a new item
            editingItemsArray[index].isCustom = false; // Not a custom item

            // Update the search input
            const searchInput = document.getElementById(`editItemSearch_${index}`);
            if (searchInput) {
                searchInput.value = itemName;
            }

            // Hide dropdown
            const dropdown = document.getElementById(`editItemDropdown_${index}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }

            // Re-render to show as regular item
            renderEditItems();
        }

        // Handle selection of custom/other item in edit form
        function selectEditCustomItem(index) {
            // Update the item to be a custom "Other" item
            editingItemsArray[index].item_name = '';
            editingItemsArray[index].item_id = 'custom';
            editingItemsArray[index].category = 'Other';
            editingItemsArray[index].unit_value = 0;
            editingItemsArray[index].total_value = 0;
            editingItemsArray[index].is_new = false;
            editingItemsArray[index].isCustom = true;
            editingItemsArray[index].value_source = '';

            // Hide dropdown
            const dropdown = document.getElementById(`editItemDropdown_${index}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }

            // Update the search input to show custom item fields (like Add form)
            const searchContainer = document.getElementById(`editItemSearchContainer_${index}`);
            if (searchContainer) {
                searchContainer.innerHTML = `
                    <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; border: 1px solid #fbbf24;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">📦 Custom Item Details</div>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text"
                                   id="editCustomItemName_${index}"
                                   placeholder="Enter item description..."
                                   onchange="updateEditCustomItemField(${index}, 'item_name', this.value)"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="number"
                                   id="editCustomItemValue_${index}"
                                   placeholder="Enter value per item..."
                                   step="0.01"
                                   min="0"
                                   onchange="updateEditCustomItemValue(${index}, this.value)"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div>
                            <input type="text"
                                   id="editCustomValueSource_${index}"
                                   placeholder="Value source (e.g., eBay, retail price)..."
                                   onchange="updateEditCustomItemField(${index}, 'value_source', this.value)"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #fbbf24; border-radius: 4px; background: #fffbeb;">
                            <small style="color: #92400e; font-size: 0.75rem;">Required for tax documentation</small>
                        </div>
                    </div>
                `;
            }

            // Re-render to show as editable custom item with input fields
            renderEditItems();
        }

        // Charity search functions for edit modal
        function searchEditCharities(query) {
            const dropdown = document.getElementById('editCharityDropdown');
            if (!dropdown) return;

            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            // For demo, use a static list - in production this would be an API call
            const charities = window.allCharities || [];
            const filtered = charities.filter(c =>
                c.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 0.75rem; color: #6b7280;">No charities found</div>';
                dropdown.style.display = 'block';
                return;
            }

            let html = '';
            filtered.forEach(charity => {
                html += `
                    <div onclick="selectEditCharity('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')"
                         style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #e5e7eb;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='white'">
                        <div style="font-weight: 500;">${charity.name}</div>
                        ${charity.ein ? `<div style="font-size: 0.75rem; color: #6b7280;">EIN: ${charity.ein}</div>` : ''}
                    </div>
                `;
            });

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function showEditCharityDropdown() {
            const query = document.getElementById('editItemCharity').value;
            if (query.length >= 2) {
                searchEditCharities(query);
            }
        }

        function selectEditCharity(charityId, charityName) {
            document.getElementById('editItemCharity').value = charityName;
            document.getElementById('editItemCharityId').value = charityId;
            document.getElementById('editCharityDropdown').style.display = 'none';
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.matches('#editItemCharity')) {
                const dropdown = document.getElementById('editCharityDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Hide edit item dropdowns
            editingItemsArray.forEach((item, index) => {
                if (!e.target.matches(`#editItemSearch_${index}`) && !e.target.closest(`#editItemDropdown_${index}`)) {
                    const dropdown = document.getElementById(`editItemDropdown_${index}`);
                    if (dropdown) dropdown.style.display = 'none';
                }
            });
        });

        async function saveEditedItemDonation() {
            if (!window.currentEditingDonation || !window.editingDonationId) {
                alert('Error: No donation being edited');
                return;
            }

            if (editingItemsArray.length === 0) {
                alert('Please add at least one item to the donation');
                return;
            }

            const charityId = document.getElementById('editItemCharityId').value;
            if (!charityId) {
                alert('Please select a charity');
                return;
            }

            // Determine if this is a user charity or system charity
            // Check if the charity ID exists in the donations data to get source
            let charitySource = 'system';
            const donation = allDonations ? allDonations.find(d => d.id === window.editingDonationId) : null;
            if (donation) {
                if (donation.user_charity_id) {
                    charitySource = 'personal';
                }
            }
            const isUserCharity = charitySource === 'personal';

            // Prepare the update data
            const formData = {
                donation_type: 'items',
                donation_date: document.getElementById('editItemDate').value,
                items: editingItemsArray,
                amount: editingItemsArray.reduce((sum, item) => sum + (parseFloat(item.total_value) || 0), 0)
            };

            // Set the appropriate charity ID field based on type
            if (isUserCharity) {
                formData.user_charity_id = charityId;
                formData.charity_source = 'personal';
            } else {
                formData.charity_id = charityId;
                formData.charity_source = 'system';
            }

            // Just use the user's notes directly - items are now stored in donation_items table
            formData.notes = document.getElementById('editItemNotes').value || '';

            console.log('[SAVE EDIT] Sending PUT request with data:', JSON.stringify(formData, null, 2));
            console.log('[SAVE EDIT] Items array:', editingItemsArray);
            console.log('[SAVE EDIT] Donation ID:', window.editingDonationId);

            try {
                const token = localStorage.getItem('token') || 'test-token';
                const requestBody = JSON.stringify(formData);
                console.log('[SAVE EDIT] Request body length:', requestBody.length);

                const response = await fetch(`/api/donations/${window.editingDonationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: requestBody
                });

                console.log('[SAVE EDIT] Response status:', response.status);
                console.log('[SAVE EDIT] Response headers:', response.headers);

                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                    console.log('[SAVE EDIT] Response data:', data);
                } else {
                    // If not JSON, it's probably an error page
                    const text = await response.text();
                    console.error('[SAVE EDIT] Non-JSON response:', text.substring(0, 500));
                    throw new Error(`Server returned non-JSON response: ${response.status}`);
                }

                if (data.success || response.ok) {
                    showToast('Donation updated successfully!', 'success');
                    closeEditItemModal();

                    // Refresh donations list
                    await loadDonations();
                } else {
                    console.error('[SAVE EDIT] API returned error:', data);
                    showToast(data.error || 'Failed to update donation', 'error');
                }
            } catch (error) {
                console.error('[SAVE EDIT] Error updating donation:', error);
                showToast('Error updating donation: ' + error.message, 'error');
            }
        }

        // View donation details
        async function viewDonationDetails(donationId) {
            const donations = allDonations || [];
            const donation = donations.find(d => d.id === donationId);

            if (!donation) {
                alert('Donation details not found');
                return;
            }

            // Parse the donation type and notes
            const displayAmount = donation.donation_type === 'items' ? (donation.estimated_value || donation.amount) : donation.amount;
            let details = `
                <strong>Date:</strong> ${donation.date || donation.donation_date}<br>
                <strong>Charity:</strong> ${donation.charity_name}<br>
                <strong>Type:</strong> ${donation.donation_type}<br>
                <strong>Amount:</strong> $${formatCurrency(displayAmount, true)}<br>
            `;

            // Add type-specific details
            if (donation.donation_type === 'stock') {
                details += '<br><strong>Stock Details:</strong><ul style="margin: 0.5rem 0;">';
                if (donation.stock_symbol) {
                    details += `<li>Symbol: ${donation.stock_symbol}</li>`;
                }
                if (donation.stock_quantity) {
                    details += `<li>Quantity: ${donation.stock_quantity} shares</li>`;
                }
                // Calculate and show price per share
                if (donation.fair_market_value && donation.stock_quantity) {
                    const pricePerShare = parseFloat(donation.fair_market_value) / parseFloat(donation.stock_quantity);
                    details += `<li>Price per Share (at donation): $${pricePerShare.toFixed(2)}</li>`;
                }
                if (donation.cost_basis) {
                    details += `<li>Cost Basis: $${formatCurrency(donation.cost_basis, true)}</li>`;
                }
                if (donation.fair_market_value) {
                    details += `<li>Fair Market Value: $${formatCurrency(donation.fair_market_value, true)}</li>`;
                    if (donation.cost_basis) {
                        const gain = parseFloat(donation.fair_market_value) - parseFloat(donation.cost_basis);
                        const gainPercent = ((gain / parseFloat(donation.cost_basis)) * 100).toFixed(1);
                        details += `<li>Capital Gain: $${formatCurrency(gain, true)} (${gainPercent}%)</li>`;
                    }
                }
                details += '</ul>';
            } else if (donation.donation_type === 'crypto') {
                details += '<br><strong>Crypto Details:</strong><ul style="margin: 0.5rem 0;">';
                if (donation.crypto_symbol) {
                    details += `<li>Symbol: ${donation.crypto_symbol}</li>`;
                }
                if (donation.crypto_type) {
                    details += `<li>Type: ${donation.crypto_type}</li>`;
                }
                if (donation.crypto_quantity) {
                    details += `<li>Quantity: ${donation.crypto_quantity}</li>`;
                }
                if (donation.cost_basis) {
                    details += `<li>Cost Basis: $${formatCurrency(donation.cost_basis, true)}</li>`;
                }
                if (donation.fair_market_value) {
                    details += `<li>Fair Market Value: $${formatCurrency(donation.fair_market_value, true)}</li>`;
                    if (donation.cost_basis) {
                        const gain = parseFloat(donation.fair_market_value) - parseFloat(donation.cost_basis);
                        const gainPercent = ((gain / parseFloat(donation.cost_basis)) * 100).toFixed(1);
                        details += `<li>Capital Gain: $${formatCurrency(gain, true)} (${gainPercent}%)</li>`;
                    }
                }
                details += '</ul>';
            } else if (donation.donation_type === 'miles') {
                details += '<br><strong>Mileage Details:</strong><ul style="margin: 0.5rem 0;">';
                if (donation.miles_driven) {
                    details += `<li>Miles Driven: ${donation.miles_driven}</li>`;
                }
                if (donation.mileage_rate) {
                    details += `<li>IRS Rate: $${donation.mileage_rate}/mile</li>`;
                }
                if (donation.mileage_purpose) {
                    details += `<li>Purpose: ${donation.mileage_purpose}</li>`;
                }
                details += '</ul>';
            } else if (donation.donation_type === 'items' && donation.notes) {
                // First try JSON format (legacy)
                if (donation.notes.startsWith('{')) {
                    try {
                        const notesData = JSON.parse(donation.notes);
                        if (notesData.items && notesData.items.length > 0) {
                            details += '<br><strong>Items Donated:</strong><ul>';
                            notesData.items.forEach(item => {
                                details += `<li>${item.quantity}x ${item.name} (${item.condition}) - $${item.value}</li>`;
                            });
                            details += '</ul>';
                        }
                        if (notesData.notes) {
                            details += `<strong>Notes:</strong> ${notesData.notes}<br>`;
                        }
                    } catch (e) {
                        if (donation.notes) {
                            details += `<strong>Notes:</strong> ${donation.notes}<br>`;
                        }
                    }
                }
                // Handle ITEMS: format (new format)
                else if (donation.notes.startsWith('ITEMS:')) {
                    const itemsMatch = donation.notes.match(/ITEMS:(\[.*?\])+/);
                    if (itemsMatch) {
                        details += '<br><strong>Items Donated:</strong><ul>';
                        // Extract all items between brackets
                        const itemsData = itemsMatch[0].substring(6); // Remove "ITEMS:"
                        const itemRegex = /\[([^\]]+)\]/g;
                        let match;
                        while ((match = itemRegex.exec(itemsData)) !== null) {
                            const parts = match[1].split('|');
                            if (parts.length >= 5) {
                                const [name, category, condition, quantity, value] = parts;
                                details += `<li>${quantity}x ${name} (${condition}) - $${value}</li>`;
                            }
                        }
                        details += '</ul>';

                        // Extract user notes after ITEMS data
                        const lastBracketIndex = donation.notes.lastIndexOf(']');
                        if (lastBracketIndex !== -1) {
                            let userNotes = donation.notes.substring(lastBracketIndex + 1).replace(/^\|?\s*/, '').trim();

                            // Check if userNotes is JSON and extract the actual note
                            if (userNotes.startsWith('{') && userNotes.includes('userNotes')) {
                                try {
                                    const parsed = JSON.parse(userNotes);
                                    userNotes = parsed.userNotes || '';
                                } catch (e) {
                                    // Not valid JSON, use as-is
                                }
                            }

                            if (userNotes) {
                                details += `<strong>Notes:</strong> ${userNotes}<br>`;
                            }
                        }
                    }
                } else {
                    // Fallback to showing notes as-is
                    details += `<strong>Notes:</strong> ${donation.notes}<br>`;
                }
            } else if (donation.donation_type === 'stock') {
                if (donation.stock_name) details += `<strong>Company:</strong> ${donation.stock_name}<br>`;
                if (donation.stock_symbol) details += `<strong>Stock Symbol:</strong> ${donation.stock_symbol}<br>`;
                if (donation.stock_quantity || donation.shares_donated) {
                    const shares = donation.stock_quantity || donation.shares_donated;
                    details += `<strong>Shares:</strong> ${shares}<br>`;
                }
                if (donation.fair_market_value || donation.price_per_share) {
                    const price = donation.fair_market_value || donation.price_per_share;
                    details += `<strong>Price per Share:</strong> $${parseFloat(price).toFixed(2)}<br>`;
                }
                if (donation.cost_basis) details += `<strong>Cost Basis:</strong> $${parseFloat(donation.cost_basis).toFixed(2)}<br>`;
            } else if (donation.donation_type === 'crypto') {
                if (donation.crypto_symbol) {
                    // Handle case where crypto_symbol might contain "ETH Ether" format
                    const cryptoSymbol = donation.crypto_symbol.split(' ')[0];
                    details += `<strong>Crypto:</strong> ${cryptoSymbol}<br>`;
                }
                if (donation.crypto_quantity) details += `<strong>Amount:</strong> ${donation.crypto_quantity}<br>`;
            } else if (donation.donation_type === 'miles') {
                details += '<br><strong>Mileage Details:</strong><ul style="margin: 0.5rem 0;">';
                if (donation.miles_driven) {
                    details += `<li>Miles Driven: ${donation.miles_driven}</li>`;
                }
                if (donation.mileage_rate) {
                    details += `<li>IRS Rate: $${donation.mileage_rate}/mile</li>`;
                }
                // Calculate total if we have both miles and rate
                if (donation.miles_driven && donation.mileage_rate) {
                    const mileageTotal = parseFloat(donation.miles_driven) * parseFloat(donation.mileage_rate);
                    details += `<li>Deduction: ${donation.miles_driven} × $${donation.mileage_rate} = $${mileageTotal.toFixed(2)}</li>`;
                } else if (donation.miles_driven && displayAmount) {
                    // If we don't have rate but have amount, show it
                    const impliedRate = parseFloat(displayAmount) / parseFloat(donation.miles_driven);
                    details += `<li>Implied Rate: $${impliedRate.toFixed(2)}/mile</li>`;
                }
                if (donation.mileage_purpose) {
                    details += `<li>Purpose: ${donation.mileage_purpose}</li>`;
                }
                details += '</ul>';
            }

            // Always show user notes at the end if they exist
            const userNotes = parseNotesDisplay(donation.notes);
            if (userNotes) {
                details += `<br><strong>Notes:</strong> ${userNotes}<br>`;
            }

            // Show in a modal
            const modal = document.createElement('div');
            modal.id = 'donationDetailsModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h2 style="margin-bottom: 1rem;">Donation Details</h2>
                        <div style="line-height: 1.6;">
                            ${details}
                        </div>
                        <div style="margin-top: 1.5rem; text-align: right;">
                            <button onclick="document.getElementById('donationDetailsModal').remove()" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Also allow clicking the overlay to close
            modal.firstElementChild.addEventListener('click', (e) => {
                if (e.target === modal.firstElementChild) {
                    modal.remove();
                }
            });
        }

        async function addReceipt(donationId) {
            // Store the donation ID for later use
            window.currentDonationId = donationId;

            // Get donation details to show in modal
            const donations = allDonations || [];
            const donation = donations.find(d => d.id === donationId);

            // Show receipt upload modal
            const modal = document.getElementById('receiptModal');
            if (modal) {
                if (donation) {
                    const info = document.getElementById('donationInfo');
                    // Handle both date formats and invalid dates
                    const dateValue = donation.date || donation.donation_date;
                    let dateDisplay = 'Invalid Date';
                    if (dateValue) {
                        try {
                            const parsedDate = new Date(dateValue);
                            if (!isNaN(parsedDate.getTime())) {
                                dateDisplay = parsedDate.toLocaleDateString();
                            }
                        } catch (e) {
                            console.error('Date parsing error:', e);
                        }
                    }
                    // Use charity_name which is the actual field name
                    const charityName = donation.charity_name || donation.charity?.name || 'Unknown Charity';
                    info.innerHTML = `
                        <p><strong>Charity:</strong> ${charityName}</p>
                        <p><strong>Date:</strong> ${dateDisplay}</p>
                        <p><strong>Amount:</strong> $${formatCurrency(donation.amount, true)}</p>
                    `;
                }
                modal.classList.add('active');

                // Clear any previous selections
                document.getElementById('receiptFile').value = '';
                document.getElementById('receiptUrl').value = '';
                document.getElementById('receiptNotes').value = '';
                document.getElementById('receiptPreview').innerHTML = '';
            }
        }

        // Handle file selection for receipt
        function handleReceiptFile(event) {
            const file = event.target.files[0];
            if (file) {
                const preview = document.getElementById('receiptPreview');
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];

                if (!validTypes.includes(file.type)) {
                    alert('Please select an image (JPG, PNG, GIF) or PDF file');
                    event.target.value = '';
                    return;
                }

                // Show file preview
                preview.innerHTML = `
                    <div style="padding: 1rem; background: #f3f4f6; border-radius: 8px; margin-top: 1rem;">
                        <p style="color: #666; font-size: 0.9rem;">📎 Selected file:</p>
                        <p style="font-weight: 600;">${file.name}</p>
                        <p style="color: #888; font-size: 0.85rem;">${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                `;

                // If it's an image, show thumbnail
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML += `
                            <img src="${e.target.result}" style="max-width: 200px; margin-top: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Compress image before storage
        async function compressImage(file, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Create canvas for compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Calculate new dimensions (maintain aspect ratio)
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        // Set canvas size
                        canvas.width = width;
                        canvas.height = height;

                        // Draw and compress image
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64 with compression
                        // For receipts, we can use lower quality (0.7 = 70%)
                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    // Convert blob to base64
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        resolve({
                                            data: e.target.result,
                                            size: blob.size,
                                            originalSize: file.size,
                                            compressionRatio: ((file.size - blob.size) / file.size * 100).toFixed(1)
                                        });
                                    };
                                    reader.readAsDataURL(blob);
                                } else {
                                    reject('Failed to compress image');
                                }
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.onerror = () => reject('Failed to load image');
                    img.src = e.target.result;
                };
                reader.onerror = () => reject('Failed to read file');
                reader.readAsDataURL(file);
            });
        }

        // Save receipt (file upload or URL)
        async function saveReceipt() {
            const donationId = window.currentDonationId;
            const fileInput = document.getElementById('receiptFile');
            const urlInput = document.getElementById('receiptUrl');
            const notesInput = document.getElementById('receiptNotes');

            if (!fileInput.files[0] && !urlInput.value) {
                alert('Please select a file or enter a URL');
                return;
            }

            try {
                const file = fileInput.files[0];

                if (file) {
                    showToast('🔄 Compressing image...', 'info');

                    let imageData;

                    // Handle different file types
                    if (file.type.startsWith('image/')) {
                        // Compress image files
                        try {
                            const compressed = await compressImage(file, 1200, 0.7);
                            imageData = compressed.data;

                            // Show compression result
                            showToast(`📦 Compressed by ${compressed.compressionRatio}% (${(compressed.size / 1024).toFixed(0)}KB)`, 'success');

                            // Check if compressed size is still too large
                            if (compressed.size > 500 * 1024) {
                                // Try more aggressive compression
                                const moreCompressed = await compressImage(file, 800, 0.5);
                                imageData = moreCompressed.data;
                                showToast(`📦 Further compressed to ${(moreCompressed.size / 1024).toFixed(0)}KB`, 'info');

                                if (moreCompressed.size > 500 * 1024) {
                                    alert('Image is still too large after compression. Please use a smaller image or provide a URL.');
                                    return;
                                }
                            }
                        } catch (error) {
                            console.error('Compression error:', error);
                            showToast('⚠️ Could not compress image, saving original', 'warning');

                            // Fall back to original if compression fails
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imageData = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    } else if (file.type === 'application/pdf') {
                        // PDFs can't be compressed easily, just check size
                        if (file.size > 500 * 1024) {
                            alert('PDF files must be under 500KB. Please use a URL for larger files.');
                            return;
                        }

                        // Read PDF as-is
                        const reader = new FileReader();
                        const result = await new Promise((resolve) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        imageData = result;
                    } else {
                        alert('Please select an image (JPG, PNG) or PDF file.');
                        return;
                    }

                    // Store compressed/processed image
                    const receiptData = {
                        receipt_data: imageData,
                        receipt_type: 'embedded',
                        file_name: file.name,
                        file_size: imageData.length,
                        notes: notesInput.value
                    };

                    await updateDonationReceipt(donationId, receiptData);

                } else if (urlInput.value) {
                    // Store external URL
                    const receiptData = {
                        receipt_url: urlInput.value,
                        receipt_type: 'url',
                        notes: notesInput.value
                    };

                    await updateDonationReceipt(donationId, receiptData);
                }
            } catch (error) {
                console.error('Error adding receipt:', error);
                showToast('❌ Error adding receipt', 'error');
            }
        }

        // Helper function to update donation with receipt
        async function updateDonationReceipt(donationId, receiptData) {
            try {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token')
                    },
                    body: JSON.stringify(receiptData)
                });

                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    if (data.success) {
                        showToast('✅ Receipt saved successfully!', 'success');
                        closeReceiptModal();
                        loadDonations();
                    } else {
                        showToast('❌ Failed to save receipt', 'error');
                    }
                } else {
                    // API not available, store locally
                    showToast('⚠️ Receipt saved locally only', 'info');
                    closeReceiptModal();
                }
            } catch (error) {
                console.error('Error updating receipt:', error);
                showToast('⚠️ Receipt saved locally', 'info');
                closeReceiptModal();
            }
        }

        // Close receipt modal
        function closeReceiptModal() {
            const modal = document.getElementById('receiptModal');
            if (modal) {
                modal.classList.remove('active');
                window.currentDonationId = null;
            }
        }

        // Track unsaved changes
        let hasUnsavedChanges = false;

        function markUnsavedChanges() {
            hasUnsavedChanges = true;
            const saveBtn = document.getElementById('saveProfileBtn');
            if (saveBtn) {
                saveBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                saveBtn.innerHTML = '⚠️ Save Changes';
            }
        }

        function clearUnsavedChanges() {
            hasUnsavedChanges = false;
            const saveBtn = document.getElementById('saveProfileBtn');
            if (saveBtn) {
                saveBtn.style.background = '';
                saveBtn.innerHTML = '💾 Update Profile';
            }
        }

        // Initialize everything when DOM is ready
        function initializeApp() {
            // Populate year selectors first
            populateYearSelectors();

            // Load data
            loadTaxSettings();
            loadProfile(); // Load user profile
            loadAllYearsTaxInfo(); // Load tax info for all years
            loadCharities();
            loadDonations();
            loadStats();
            loadItemCategories(); // Load item categories for donation form

            // Initialize auto-logout
            initializeAutoLogout();

            // Add change listeners to tax fields
            const taxFields = ['taxYear', 'filingStatus', 'taxBracket', 'agiEstimate'];
            taxFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', markUnsavedChanges);
                }
            });

            // Categories are now handled by a select dropdown, no search listeners needed

            // Setup event listeners for item search
            const itemSearchInput = document.getElementById('itemSearch');
            if (itemSearchInput) {
                itemSearchInput.addEventListener('input', function() {
                    searchItems();
                });
                itemSearchInput.addEventListener('focus', function() {
                    searchItems();
                });
            }
        }

        // Auto-logout functionality
        let logoutTimer = null;
        let logoutTimeout = 1800000; // Default 30 minutes

        async function fetchLogoutTimeout() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/settings/auto-logout-timeout', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.timeout) {
                        logoutTimeout = parseInt(data.timeout);
                        console.log('Auto-logout timeout set to:', logoutTimeout / 1000 / 60, 'minutes');
                    }
                }
            } catch (error) {
                console.log('Using default logout timeout');
            }
        }

        function resetLogoutTimer() {
            if (logoutTimer) {
                clearTimeout(logoutTimer);
            }

            logoutTimer = setTimeout(() => {
                // Show warning before logout
                const warningTime = 60000; // 1 minute warning
                const warningDiv = document.createElement('div');
                warningDiv.className = 'auto-logout-warning';
                warningDiv.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #f59e0b; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; display: flex; align-items: center; gap: 10px;">
                        <svg width="20" height="20" fill="white" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span>You will be logged out in 1 minute due to inactivity</span>
                        <button onclick="resetLogoutTimer(); this.parentElement.remove();" style="background: white; color: #f59e0b; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            Stay Logged In
                        </button>
                    </div>
                `;
                document.body.appendChild(warningDiv);

                setTimeout(() => {
                    // Perform logout
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login.html?timeout=true';
                }, warningTime);
            }, logoutTimeout - 60000); // Show warning 1 minute before logout
        }

        function initializeAutoLogout() {
            // Fetch timeout setting from server
            fetchLogoutTimeout();

            // Reset timer on any user activity
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetLogoutTimer, true);
            });

            // Start the timer
            resetLogoutTimer();

            // Store login timestamp
            if (!localStorage.getItem('loginTime')) {
                localStorage.setItem('loginTime', Date.now().toString());
            }
        }

        // Diagnostic function for debugging charity issues
        window.diagnoseCharityIssue = function() {
            console.log('=== CHARITY DIAGNOSTIC REPORT ===');

            // Check form fields
            console.log('\nForm Fields:');
            console.log('- selectedCharityId:', document.getElementById('selectedCharityId').value);
            console.log('- selectedCharitySource:', document.getElementById('selectedCharitySource').value);
            console.log('- donationCharity:', document.getElementById('donationCharity').value);

            // Check all charity buttons
            console.log('\nPersonal Charities in DOM:');
            document.querySelectorAll('[onclick*="quickAddDonation"]').forEach(el => {
                const onclick = el.getAttribute('onclick');
                const match = onclick.match(/quickAddDonation\('([^']+)',\s*'([^']+)',\s*'([^']*)'\)/);
                if (match) {
                    const [_, id, name, source] = match;
                    const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);
                    console.log(`- ${name}: ID=${id}, Source=${source || 'not set'}, Is UUID=${isUUID}`);
                }
            });

            // Check local storage
            console.log('\nLocal Storage:');
            console.log('- Token:', localStorage.getItem('token') ? 'Set' : 'Not set');
            console.log('- User:', JSON.parse(localStorage.getItem('user') || '{}'));

            console.log('\n=== END DIAGNOSTIC REPORT ===');
            console.log('\nTo test a quick donation, run:');
            console.log("quickAddDonation('375d4c33-c60f-4f73-8aca-567fabc9c84b', 'ACLU Foundation', 'personal')");
        };

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Close modals and dropdowns when clicking outside
        window.onclick = function(event) {
            // Close modals
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }

            // Close category dropdown
            if (!event.target.closest('#itemCategorySearch') && !event.target.closest('#categoryDropdown')) {
                const dropdown = document.getElementById('categoryDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Close item dropdown
            if (!event.target.closest('#itemSearch') && !event.target.closest('#itemDropdown')) {
                const dropdown = document.getElementById('itemDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Close charity search dropdown
            if (!event.target.closest('#donationCharity') && !event.target.closest('#charityDropdown')) {
                const dropdown = document.getElementById('charityDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        }

        // Verify charity function
        async function verifyCharity() {
            const charityName = document.getElementById('donationCharity').value.trim();
            const resultDiv = document.getElementById('charityVerificationResult');

            if (!charityName) {
                showToast('Please enter a charity name to verify', 'warning');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 0.5rem; background: #f3f4f6; border-radius: 4px;">🔍 Verifying charity...</div>';

            try {
                const response = await fetch(`/api/charities/verify?name=${encodeURIComponent(charityName)}`);
                const data = await response.json();

                if (data.success && data.verification) {
                    const verification = data.verification;

                    if (verification.isVerified) {
                        // Charity is verified
                        resultDiv.innerHTML = `
                            <div style="padding: 0.75rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; color: #065f46;">
                                <div style="display: flex; align-items: start; gap: 0.5rem;">
                                    <span style="font-size: 1.25rem;">✅</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Verified 501(c)(3) Organization</div>
                                        <div style="font-size: 0.875rem;">
                                            <strong>${verification.charity.name}</strong><br>
                                            EIN: ${verification.charity.ein}<br>
                                            Category: ${verification.charity.category || 'Not specified'}<br>
                                            ${verification.charity.city && verification.charity.state ? `Location: ${verification.charity.city}, ${verification.charity.state}` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Auto-select the verified charity
                        document.getElementById('selectedCharityId').value = verification.charity.id;
                        document.getElementById('donationCharity').value = verification.charity.name;
                        // Track the selected charity name to prevent clearing on input events
                        window.lastSelectedCharityName = verification.charity.name;

                    } else if (verification.suggestions && verification.suggestions.length > 0) {
                        // Show suggestions
                        let suggestionsHtml = verification.suggestions.map(s => `
                            <div style="padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer;"
                                 onclick="selectSuggestedCharity('${s.id}', '${s.name.replace(/'/g, "\\'")}')">
                                <strong>${s.name}</strong><br>
                                <span style="font-size: 0.875rem; color: #6b7280;">
                                    EIN: ${s.ein} | ${s.category || 'Category not specified'} | ${s.location}
                                </span>
                            </div>
                        `).join('');

                        resultDiv.innerHTML = `
                            <div style="padding: 0.75rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #92400e;">
                                    ⚠️ No exact match found
                                </div>
                                <div style="font-size: 0.875rem; color: #78350f; margin-bottom: 0.5rem;">
                                    ${verification.message}
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${suggestionsHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        // Not found
                        resultDiv.innerHTML = `
                            <div style="padding: 0.75rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                                <div style="display: flex; align-items: start; gap: 0.5rem;">
                                    <span style="font-size: 1.25rem;">❌</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Not Found in IRS Database</div>
                                        <div style="font-size: 0.875rem;">
                                            ${verification.message}<br><br>
                                            <strong>Tips:</strong>
                                            <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                                <li>Check the spelling of the charity name</li>
                                                <li>Try searching with the EIN if you have it</li>
                                                <li>The charity may be new or use a different legal name</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Verification error:', error);
                resultDiv.innerHTML = `
                    <div style="padding: 0.75rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ❌ Error verifying charity. Please try again.
                    </div>
                `;
            }
        }

        // Helper function to select a suggested charity
        function selectSuggestedCharity(id, name) {
            document.getElementById('selectedCharityId').value = id;
            document.getElementById('donationCharity').value = name;
            // Track the selected charity name to prevent clearing on input events
            window.lastSelectedCharityName = name;
            document.getElementById('charityVerificationResult').style.display = 'none';
            showToast('Charity selected: ' + name, 'success');
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');

            // Style based on type
            const styles = {
                success: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;',
                error: 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;',
                info: 'background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;'
            };

            toast.style.cssText = `
                ${styles[type]}
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease-out;
                min-width: 250px;
            `;

            toast.innerHTML = message;

            toastContainer.appendChild(toast);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>

    <!-- Receipt Upload Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: #333; font-size: 1.5rem;">📎 Add Receipt</h2>
                <button onclick="closeReceiptModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">×</button>
            </div>

            <div id="donationInfo" style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem;">
                <!-- Donation details will be inserted here -->
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #666; font-size: 1rem; margin-bottom: 1rem;">Upload Receipt Image or PDF</h3>

                <!-- File Upload Option -->
                <div style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 1.5rem; text-align: center; background: #fafafa;">
                    <label for="receiptFile" style="cursor: pointer; display: block;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📤</div>
                        <p style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">Click to browse or drag & drop</p>
                        <p style="color: #888; font-size: 0.85rem;">Supports: JPG, PNG, GIF, PDF<br><span style="color: #16a34a; font-size: 0.8rem;">✨ Images automatically compressed to save storage</span></p>
                    </label>
                    <input type="file" id="receiptFile" accept="image/*,.pdf" style="display: none;" onchange="handleReceiptFile(event)">
                </div>

                <div id="receiptPreview"></div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #666; font-size: 1rem; margin-bottom: 0.5rem;">OR Enter Receipt URL</h3>
                <input type="url" id="receiptUrl" placeholder="https://example.com/receipt.pdf" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Notes (Optional)</label>
                <textarea id="receiptNotes" rows="3" placeholder="Add any notes about this receipt..." style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeReceiptModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #666; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button onclick="saveReceipt()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Link Receipt</button>
            </div>
        </div>
    </div>

    </main>
</body>
</html>