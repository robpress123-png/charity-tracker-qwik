<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Charity Tracker v1.5.0</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            height: 100vh;
            background: #f3f4f6;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header-top {
            padding: 0.3rem 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .version {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation menu */
        .nav-menu {
            background: rgba(0,0,0,0.1);
            padding: 0 1rem;
        }

        .nav-menu-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
        }

        .nav-item {
            color: white;
            padding: 0.4rem 0.75rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background 0.2s;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: white;
        }

        .main-content {
            flex: 1;
            overflow: hidden;
            padding: 0.5rem;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 0 0.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stats-grid {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: nowrap;
        }

        .stat-card {
            background: white;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .section {
            background: white;
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .section h2 {
            color: #333;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 0.4rem;
            border-bottom: 2px solid #e5e7eb;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.875rem;
            position: sticky;
            top: 0;
            background: white;
        }

        .table td {
            padding: 0.4rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .btn-action {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            margin: 0 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }

        .btn-danger {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Date input specific styling */
        input[type="date"] {
            max-width: 200px;
        }

        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 100;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #f3f4f6;
        }

        .autocomplete-item-name {
            font-weight: 500;
            color: #111827;
        }

        .autocomplete-item-ein {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .autocomplete-item-category {
            display: inline-block;
            font-size: 0.75rem;
            color: #667eea;
            margin-left: 0.5rem;
        }

        .autocomplete-add-new {
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            cursor: pointer;
            font-weight: 500;
            color: #667eea;
        }

        .autocomplete-add-new:hover {
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        .autocomplete-loading {
            padding: 0.75rem;
            text-align: center;
            color: #6b7280;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .charity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .charity-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s;
        }

        .charity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .charity-card h3 {
            color: #111827;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
        }

        .charity-ein {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0.25rem 0;
        }

        .charity-category {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 0.5rem 0;
        }

        .charity-description {
            color: #4b5563;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .charity-count {
            text-align: center;
            color: #6b7280;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Version Announcement Banner -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.75rem; text-align: center; font-size: 0.875rem; border-bottom: 2px solid rgba(255,255,255,0.3);">
        <strong>üéØ Charity Tracker v1.5.0</strong> - Optimized UI with better screen real estate usage & compact layouts!
    </div>
    <header class="header">
        <div class="header-top">
            <div class="header-content">
                <div>
                    <h1>üéØ Charity Tracker <span class="version">v1.5.0</span></h1>
                </div>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-menu-content">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    üìä Dashboard
                </button>
                <button class="nav-item" onclick="showSection('donations')">
                    ‚ûï Add Donation
                </button>
                <button class="nav-item" onclick="showSection('reports')">
                    üìà Reports
                </button>
                <button class="nav-item" onclick="showSection('profile')">
                    üë§ Profile
                </button>
                <button class="nav-item" onclick="showSection('tools')">
                    üîß Tools
                </button>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; padding-right: 1rem;">
                    <label style="color: white; font-size: 0.9rem; font-weight: 500;">Tax Year:</label>
                    <select id="globalYearFilter" onchange="updateYearFilter()" style="padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem; cursor: pointer;">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div>
                        <div class="stat-label" id="totalDonationsLabel">Total Donations</div>
                        <div class="stat-value" id="totalDonations">$0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Charities Supported</div>
                        <div class="stat-value" id="charityCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label" id="taxSavingsLabel">Est. Tax Savings</div>
                        <div class="stat-value" id="taxSavings">$0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Donation Count</div>
                        <div class="stat-value" id="donationCount">0</div>
                    </div>
                </div>
            </div>

            <div class="section" style="flex: 1; display: flex; flex-direction: column; min-height: 0; max-height: calc(50vh - 100px);">
                <div class="section-header" style="flex-shrink: 0;">
                    <h2>Recent Donations</h2>
                </div>
                <div id="donationsContent" style="overflow-y: auto; flex: 1; min-height: 0;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No donations yet. Add your first donation to get started!</p>
                    </div>
                </div>
            </div>

            <div class="section" style="display: flex; flex-direction: column; min-height: 0; max-height: calc(40vh - 80px);">
                <div class="section-header" style="flex-shrink: 0;">
                    <h2>My Charities</h2>
                    <button class="btn-primary" onclick="showAddCharity()">Add Charity</button>
                </div>
                <div id="charitiesContent" style="overflow-y: auto; flex: 1; min-height: 0;">
                    <div class="empty-state">
                        <div class="empty-state-icon">üèõÔ∏è</div>
                        <p>No charities added yet. Add your favorite charities!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Donation Section (hidden by default) -->
        <div id="addDonationSection" class="section-content" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>‚ûï Add New Donation</h2>
                </div>
                <div style="padding: 2rem; text-align: center;">
                    <p style="margin-bottom: 2rem;">Select the type of donation you want to record:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; max-width: 800px; margin: 0 auto;">
                        <button class="btn-primary" onclick="openDonationModal('cash')">
                            üíµ Cash Donation
                        </button>
                        <button class="btn-primary" onclick="openDonationModal('items')">
                            üì¶ Donated Items
                        </button>
                        <button class="btn-primary" onclick="openDonationModal('miles')">
                            üöó Mileage
                        </button>
                        <button class="btn-primary" onclick="openDonationModal('stock')">
                            üìà Stock/Securities
                        </button>
                        <button class="btn-primary" onclick="openDonationModal('crypto')">
                            ‚Çø Cryptocurrency
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section (hidden by default) -->
        <div id="reportsSection" class="section-content" style="display:none;">
            <div class="section">
            <div class="section-header">
                <h2>üìà Tax Reports & Export</h2>
            </div>
            <div style="display: grid; gap: 1rem;">
                <div class="form-group">
                    <label>Report Tax Year</label>
                    <select id="reportYear" style="width: 200px;">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="exportCSV()">
                        üìÑ Download CSV
                    </button>
                    <button class="btn-primary" onclick="exportPDF()">
                        üìë Download PDF Report
                    </button>
                    <button class="btn-primary" onclick="viewSummary()">
                        üëÅÔ∏è View Summary
                    </button>
                </div>
                <div id="reportSummary" style="margin-top: 2rem;"></div>
                </div>
            </div>
        </div>

        <!-- Profile Section (hidden by default) -->
        <div id="profileSection" class="section-content" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>üë§ Profile Settings</h2>
                </div>
                <div style="padding: 1rem;">
                    <!-- Personal Information Section -->
                    <h3 style="color: #667eea; margin-bottom: 1rem; font-size: 1.1rem;">üìù Personal Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="profileName" placeholder="Enter your full name" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="profileEmail" placeholder="your@email.com" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Street Address</label>
                            <input type="text" id="profileAddress" placeholder="123 Main Street" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="profileCity" placeholder="Your City" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <select id="profileState" style="width: 100%;">
                                <option value="">Select State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ZIP Code</label>
                            <input type="text" id="profileZip" placeholder="12345" maxlength="10" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Tax Information Section -->
                    <h3 style="color: #667eea; margin-bottom: 1rem; margin-top: 2rem; font-size: 1.1rem;">üí∞ Tax Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Filing Status</label>
                        <select id="filingStatus" style="width: 100%;" onchange="updateTaxRate()">
                            <option value="single">Single</option>
                            <option value="married_jointly">Married Filing Jointly</option>
                            <option value="married_separately">Married Filing Separately</option>
                            <option value="head_of_household">Head of Household</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Annual Income</label>
                        <select id="incomeBracket" style="width: 100%;" onchange="updateTaxRate()">
                            <option value="22000">Up to $22,000</option>
                            <option value="50000">$22,001 - $50,000</option>
                            <option value="89075">$50,001 - $89,075</option>
                            <option value="100000">$89,076 - $100,000</option>
                            <option value="190750">$100,001 - $190,750</option>
                            <option value="200000">$190,751 - $200,000</option>
                            <option value="364200">$200,001 - $364,200</option>
                            <option value="500000">$364,201 - $500,000</option>
                            <option value="600000">$500,001+</option>
                        </select>
                    </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h3 style="margin-bottom: 0.5rem;">Your Tax Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Federal Marginal Tax Rate</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="marginalTaxRate">22%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Est. Tax Savings per $100</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="savingsPerHundred">$22</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 0.875rem; opacity: 0.9;">Standard Deduction (2024)</div>
                            <div style="font-size: 1.25rem; font-weight: 600;" id="standardDeduction">$14,600</div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveProfile()">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Tools Section (hidden by default) -->
        <div id="toolsSection" class="section-content" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>üõ†Ô∏è Tools & Utilities</h2>
                </div>
                <div style="padding: 2rem;">
                    <div style="display: grid; gap: 1rem; max-width: 600px;">
                        <button class="btn-primary" onclick="showImportDonations()">
                            üì• Import Donations (CSV)
                        </button>
                        <button class="btn-primary" onclick="calculateTaxSavings()">
                            üí∞ Tax Savings Calculator
                        </button>
                        <button class="btn-primary" onclick="importTransactions()">
                            üìä Import Bank Transactions
                        </button>
                        <button class="btn-primary" onclick="manageReceipts()">
                            üì∏ Manage Receipt Photos
                        </button>
                        <button class="btn-primary" onclick="backupData()">
                            üíæ Backup/Export All Data
                        </button>
                    </div>

                    <!-- Import Donations Panel -->
                    <div id="importDonationsPanel" style="display:none; margin-top: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">Import Donations from CSV</h3>

                        <div id="csvDropZone" style="border: 2px dashed #667eea; border-radius: 12px; padding: 3rem; text-align: center; background: #f9fafb; cursor: pointer;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                            <p style="font-size: 1.1rem; color: #4b5563; margin-bottom: 0.5rem;">Drag & Drop CSV File Here</p>
                            <p style="color: #9ca3af;">or click to browse</p>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        </div>

                        <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <p style="font-size: 0.875rem; color: #92400e;"><strong>CSV Format Required:</strong></p>
                            <code style="font-size: 0.75rem;">charity_id,amount,donation_date,donation_type,notes</code>
                            <p style="font-size: 0.75rem; color: #92400e; margin-top: 0.5rem;">
                                Example: 1,500.00,2025-01-15,cash,New Year donation
                            </p>
                        </div>

                        <div id="importPreview" style="display:none; margin-top: 1rem;">
                            <h4>Preview</h4>
                            <div id="previewTable" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;"></div>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                <button class="btn-primary" onclick="confirmImport()">
                                    ‚úÖ Import Donations
                                </button>
                                <button class="btn-secondary" onclick="cancelImport()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Add Donation Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
                <h2 id="donationModalTitle">Add Cash Donation</h2>
            </div>
            <form id="donationForm">
                <input type="hidden" id="donationType" value="cash">
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0284c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="donationTypeIcon" style="font-size: 2rem;">üíµ</span>
                        <div>
                            <div style="font-weight: 600; color: #075985; font-size: 1.1rem;" id="donationTypeLabel">Cash/Check Donation</div>
                            <div style="font-size: 0.875rem; color: #0369a1; margin-top: 0.25rem;" id="donationTypeDesc">Record a monetary donation</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="donationCharity">Charity *</label>
                    <div class="autocomplete-wrapper">
                        <input type="text"
                               id="donationCharity"
                               class="autocomplete-input"
                               placeholder="Start typing to search charities..."
                               required
                               autocomplete="off">
                        <input type="hidden" id="selectedCharityId">
                        <div id="charityDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <!-- Cash donation fields -->
                <div id="cashFields" class="donation-type-fields">
                    <div class="form-group">
                        <label for="donationAmount">Amount</label>
                        <input type="number" id="donationAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <!-- Item donation fields -->
                <div id="itemsFields" class="donation-type-fields" style="display:none;">
                    <!-- IRS Compliance Warning -->
                    <div class="alert" style="background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-size:0.875rem;">
                        <strong>‚ö†Ô∏è IRS:</strong> Only "good condition or better" items qualify for tax deductions
                    </div>

                    <!-- Two column layout: Entry on left, Receipt on right -->
                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.5rem;">
                        <!-- Left Column: Item Entry -->
                        <div>
                            <!-- Horizontal layout for category, item, quality selection -->
                            <div style="display: grid; grid-template-columns: 1.2fr 1.5fr 0.7fr 0.4fr auto; gap: 0.5rem; align-items: end; margin-bottom: 1rem;">
                        <!-- Category Dropdown -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Category</label>
                            <select id="itemCategory" onchange="categoryChanged()" style="font-size:0.875rem;width:100%;padding:0.375rem;">
                                <option value="">Select category...</option>
                            </select>
                        </div>

                        <!-- Item Search -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Item</label>
                            <div style="position:relative;">
                                <input type="text"
                                       id="itemSearch"
                                       placeholder="Search items (select category first)"
                                       oninput="searchItems(this.value)"
                                       onfocus="showItemDropdown()"
                                       disabled
                                       style="font-size:0.875rem;width:100%;padding:0.375rem;">
                                <input type="hidden" id="itemSelect">
                                <!-- Item Dropdown -->
                                <div id="itemDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Quality -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Condition</label>
                            <select id="itemQuality" onchange="updateItemValue()" style="font-size:0.875rem;width:100%;padding:0.375rem;" disabled>
                                <option value="fair">Fair (Not IRS Deductible)</option>
                                <option value="good">Good</option>
                                <option value="very_good" selected>Very Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Qty</label>
                            <input type="number" id="itemQuantity" value="1" min="1" onchange="updateItemValue()" style="font-size:0.875rem;width:100%;padding:0.375rem;" disabled>
                        </div>

                        <!-- Add Button -->
                        <div>
                            <button type="button" id="addItemBtn" onclick="addItemToList()" disabled style="padding:0.5rem 1rem;background:#9ca3af;color:white;border:none;border-radius:6px;cursor:not-allowed;font-size:0.875rem;font-weight:600;white-space:nowrap;">
                                + Add Item
                            </button>
                        </div>
                            </div>

                            <!-- Value Preview (shown when item selected) -->
                            <div id="itemValueDisplay" style="display:none;background:#f0f9ff;padding:0.5rem;border-radius:6px;border:1px solid #bae6fd;margin-bottom:1rem;">
                                <span id="selectedItemName" style="font-weight:600;color:#075985;"></span>
                                <span style="margin-left:1rem;color:#0369a1;">Value: <strong id="itemValuePreview">$0.00</strong></span>
                            </div>
                        </div>

                        <!-- Right Column: Receipt Display -->
                        <div>
                            <div style="background:white; border:2px solid #e5e7eb; border-radius:8px; padding:1rem; min-height:300px;">
                                <div style="border-bottom:2px dashed #d1d5db; padding-bottom:0.5rem; margin-bottom:0.75rem;">
                                    <h4 style="font-size:1rem;font-weight:700;color:#374151;text-align:center;margin:0;">üìã DONATION RECEIPT</h4>
                                    <p style="font-size:0.75rem;color:#6b7280;text-align:center;margin-top:0.25rem;">Items for Tax Deduction</p>
                                </div>
                                <div id="selectedItemsList" style="min-height:180px; max-height:250px; overflow-y:auto;font-size:0.875rem;">
                                    <div class="empty-state" style="color:#9ca3af; text-align:center; padding:2rem; font-size:0.875rem;">
                                        No items added yet
                                    </div>
                                </div>
                                <div style="border-top:2px solid #374151; margin-top:0.75rem; padding-top:0.75rem; display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="font-size:1rem;">Total Value:</strong>
                                    <span style="font-size:1.5rem; font-weight:bold; color:#667eea;">$<span id="receiptTotal">0.00</span></span>
                                </div>
                                <!-- Save button appears when items are added -->
                                <div id="saveItemsDonationBtn" style="display:none; margin-top:1rem;">
                                    <button type="submit" style="width:100%; padding:0.75rem; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;">
                                        üíæ Save Donation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="estimatedValue">
                    <input type="hidden" id="itemDescription">
                </div>
                <!-- Mileage donation fields -->
                <div id="milesFields" class="donation-type-fields" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="milesDriven">Miles Driven</label>
                            <input type="number" id="milesDriven" step="0.1" min="0" onchange="calculateMileageDeduction()" oninput="calculateMileageDeduction()">
                        </div>
                        <div class="form-group">
                            <label for="mileagePurpose">Purpose</label>
                            <input type="text" id="mileagePurpose" placeholder="e.g., Deliver meals">
                        </div>
                    </div>
                    <div style="background:#f3f4f6; padding:0.5rem; border-radius:8px; margin-top:0.5rem;">
                        <small>2024 IRS Rate: $0.14/mile | Deduction: $<span id="mileageDeduction">0.00</span></small>
                    </div>
                </div>
                <!-- Stock donation fields -->
                <div id="stockFields" class="donation-type-fields" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="stockName">Stock Name</label>
                            <input type="text" id="stockName" placeholder="e.g., Apple Inc." required>
                        </div>
                        <div class="form-group">
                            <label for="stockSymbol">Stock Symbol</label>
                            <input type="text" id="stockSymbol" placeholder="e.g., AAPL" style="text-transform:uppercase;" required>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="stockQuantity">Number of Shares</label>
                            <input type="number" id="stockQuantity" step="0.001" min="0" onchange="calculateStockTotal()" oninput="calculateStockTotal()" required>
                        </div>
                        <div class="form-group">
                            <label for="fairMarketValue">Closing Price per Share</label>
                            <input type="number" id="fairMarketValue" step="0.01" min="0" placeholder="$ per share" onchange="calculateStockTotal()" oninput="calculateStockTotal()" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="costBasis">Cost Basis (optional)</label>
                        <input type="number" id="costBasis" step="0.01" min="0" placeholder="Total cost basis">
                        <small style="color:#6b7280;">Automatic price lookup coming soon</small>
                    </div>
                    <div style="background:#f0f9ff; padding:0.75rem; border-radius:6px; margin-top:1rem; border:1px solid #bae6fd;">
                        <div style="font-size:0.875rem; color:#0369a1; font-weight:600;">Total Stock Donation:</div>
                        <div id="stockTotalDisplay" style="font-size:1.5rem; font-weight:bold; color:#075985;">$0.00</div>
                        <div style="font-size:0.75rem; color:#0c4a6e; margin-top:0.25rem;">
                            <span id="stockCalculation">0 shares √ó $0.00 = $0.00</span>
                        </div>
                    </div>
                </div>
                <!-- Crypto donation fields -->
                <div id="cryptoFields" class="donation-type-fields" style="display:none;">
                    <!-- IRS Notice -->
                    <div class="alert" style="background:#e0f2fe;border:1px solid #0284c7;color:#075985;padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-size:0.875rem;">
                        <strong>üìä IRS Rule:</strong> Use fair market value at exact time of donation. For crypto held >1 year, deduct full FMV. For ‚â§1 year, deduct lesser of cost basis or FMV.
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group" style="position:relative;">
                            <label for="cryptoName">Cryptocurrency Name</label>
                            <input type="text" id="cryptoName" placeholder="Start typing to search..." required
                                   oninput="searchCrypto(this.value)" onfocus="showCryptoDropdown()" autocomplete="off">
                            <!-- Crypto Dropdown -->
                            <div id="cryptoDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cryptoSymbol">Symbol/Ticker</label>
                            <input type="text" id="cryptoSymbol" placeholder="Auto-populated or enter manually" style="text-transform:uppercase;" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cryptoDonationTime">Exact Time (for price verification)</label>
                        <input type="time" id="cryptoDonationTime" step="1" required>
                        <small style="color:#6b7280;">Critical for IRS valuation - use with date field below</small>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="cryptoQuantity">Quantity</label>
                            <input type="number" id="cryptoQuantity" step="0.00000001" min="0" onchange="calculateCryptoTotal()" oninput="calculateCryptoTotal()" placeholder="Amount" required>
                        </div>
                        <div class="form-group">
                            <label for="cryptoPricePerUnit">Price per Unit (USD)</label>
                            <input type="number" id="cryptoPricePerUnit" step="0.01" min="0" onchange="calculateCryptoTotal()" oninput="calculateCryptoTotal()" placeholder="$ per coin/token at exact time" required>
                        </div>
                        <div class="form-group">
                            <label for="cryptoExchange">Exchange/Source</label>
                            <input type="text" id="cryptoExchange" placeholder="e.g., Coinbase, Binance" required>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="cryptoCostBasis">Cost Basis (optional)</label>
                            <input type="number" id="cryptoCostBasis" step="0.01" min="0" placeholder="Total purchase cost">
                            <small style="color:#6b7280;">Your original purchase price</small>
                        </div>
                        <div class="form-group">
                            <label for="cryptoHoldingPeriod">Holding Period</label>
                            <select id="cryptoHoldingPeriod">
                                <option value="long">Over 1 year (Long-term)</option>
                                <option value="short">1 year or less (Short-term)</option>
                            </select>
                            <small style="color:#6b7280;">Affects deduction calculation</small>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div style="background:#f0f9ff; padding:0.75rem; border-radius:6px; margin-top:1rem; border:1px solid #bae6fd;">
                        <div style="font-size:0.875rem; color:#0369a1; font-weight:600;">Total Crypto Donation Value:</div>
                        <div id="cryptoTotalDisplay" style="font-size:1.5rem; font-weight:bold; color:#075985;">$0.00</div>
                        <div style="font-size:0.75rem; color:#0c4a6e; margin-top:0.25rem;">
                            <span id="cryptoCalculation">0 units √ó $0.00 = $0.00</span>
                        </div>
                        <div id="cryptoDeductionNote" style="font-size:0.75rem; color:#0c4a6e; margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid #bae6fd;">
                            <strong>Tax Deduction:</strong> <span id="cryptoDeductionAmount">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="donationDate">Date</label>
                    <input type="date" id="donationDate" required style="max-width: 180px;">
                </div>
                <div class="form-group">
                    <label for="donationNotes">Notes (optional)</label>
                    <textarea id="donationNotes" rows="3"></textarea>
                </div>
                <!-- Tax Savings Calculator -->
                <div style="background: #f0fdf4; border: 2px solid #86efac; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;">üí∞ Estimated Tax Savings</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Donation Amount</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="donationAmountDisplay">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Tax Savings (<span id="taxRateDisplay">22</span>%)</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="taxSavingsDisplay">$0</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #666;">
                        * Based on your marginal tax rate. Actual savings depend on itemizing deductions.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeDonationModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Donation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Charity Modal -->
    <div id="charityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Charity</h2>
            </div>
            <form id="charityForm">
                <div class="form-group">
                    <label for="charityName">Charity Name</label>
                    <input type="text" id="charityName" required>
                </div>
                <div class="form-group">
                    <label for="charityEIN">EIN (optional)</label>
                    <input type="text" id="charityEIN">
                </div>
                <div class="form-group">
                    <label for="charityCategory">Category</label>
                    <select id="charityCategory">
                        <option value="">Select category...</option>
                        <option value="Education">Education</option>
                        <option value="Health">Health</option>
                        <option value="Environment">Environment</option>
                        <option value="Human Services">Human Services</option>
                        <option value="Arts & Culture">Arts & Culture</option>
                        <option value="International">International</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="charityWebsite">Website (optional)</label>
                    <input type="url" id="charityWebsite">
                </div>
                <div class="form-group">
                    <label for="charityDescription">Description (optional)</label>
                    <textarea id="charityDescription" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeCharityModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Charity</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
            window.location.href = '/login.html';
        } else {
            // Try to get name from profile first, then fall back to user data
            const savedProfile = localStorage.getItem('userProfile');
            let displayName = user.email;
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                displayName = profile.name || user.name || user.email;
            } else {
                displayName = user.name || user.email;
            }
            document.getElementById('userName').textContent = displayName;
        }

        // Set today's date as default for donation form (use local date string to avoid timezone issues)
        const today = new Date();
        const localDate = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
        document.getElementById('donationDate').value = localDate;

        // Format currency with commas and optional cents
        function formatCurrency(amount, includeCents = false) {
            const num = parseFloat(amount) || 0;
            if (includeCents) {
                return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
        }

        // Function to update donation fields based on type
        function updateDonationFields() {
            const donationType = document.getElementById('donationType').value;
            console.log('Updating donation fields for type:', donationType);

            // Hide all type-specific fields
            document.querySelectorAll('.donation-type-fields').forEach(el => {
                el.style.display = 'none';
                // Remove required from hidden fields
                el.querySelectorAll('input, textarea, select').forEach(field => {
                    field.removeAttribute('required');
                });
            });

            // Show relevant fields and set required
            const fieldsToShow = document.getElementById(donationType + 'Fields');
            console.log('Looking for element:', donationType + 'Fields', 'Found:', fieldsToShow);
            if (fieldsToShow) {
                fieldsToShow.style.display = 'block';
                console.log('Showing fields for', donationType);
                // Add required to visible amount fields
                if (donationType === 'cash') {
                    document.getElementById('donationAmount').setAttribute('required', '');
                } else if (donationType === 'miles') {
                    document.getElementById('milesDriven').setAttribute('required', '');
                } else if (donationType === 'items') {
                    document.getElementById('itemDescription').setAttribute('required', '');
                    document.getElementById('estimatedValue').setAttribute('required', '');
                } else if (donationType === 'stock') {
                    document.getElementById('stockQuantity').setAttribute('required', '');
                    document.getElementById('fairMarketValue').setAttribute('required', '');
                } else if (donationType === 'crypto') {
                    // Fix: Use correct crypto field IDs
                    const cryptoSymbol = document.getElementById('cryptoSymbol');
                    const cryptoQty = document.getElementById('cryptoQuantity');
                    const cryptoPricePerUnit = document.getElementById('cryptoPricePerUnit');
                    if (cryptoSymbol) cryptoSymbol.setAttribute('required', '');
                    if (cryptoQty) cryptoQty.setAttribute('required', '');
                    if (cryptoPricePerUnit) cryptoPricePerUnit.setAttribute('required', '');
                }
            }
        }

        // Calculate mileage deduction
        document.getElementById('milesDriven')?.addEventListener('input', (e) => {
            const miles = parseFloat(e.target.value) || 0;
            const rate = 0.14; // 2024 IRS rate
            const deduction = (miles * rate).toFixed(2);
            document.getElementById('mileageDeduction').textContent = deduction;
        });

        // Modal functions
        function showAddDonation() {
            document.getElementById('donationModal').classList.add('active');
            // Initialize charity autocomplete every time modal opens
            initCharityAutocomplete();
            // Also initialize item categories if it's an item donation
            if (document.getElementById('donationType').value === 'items') {
                loadItemCategories();
            }

            // Set default date for crypto donations too
            const today = new Date();
            const localDate = today.getFullYear() + '-' +
                           String(today.getMonth() + 1).padStart(2, '0') + '-' +
                           String(today.getDate()).padStart(2, '0');
            // Crypto now uses the general date field
        }

        function closeDonationModal() {
            document.getElementById('donationModal').classList.remove('active');
            document.getElementById('donationForm').reset();
            document.getElementById('selectedCharityId').value = '';
            document.getElementById('charityDropdown').classList.remove('show');
            // Reset item selection
            selectedDonationItems = [];
            updateSelectedItemsDisplay();
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSearch').disabled = true;
            document.getElementById('itemQuality').disabled = true;
            document.getElementById('itemQuantity').disabled = true;
            document.getElementById('addItemBtn').disabled = true;
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSelect').value = '';
            // Clear editing flag
            window.editingDonationId = null;
        }

        function showAddCharity() {
            document.getElementById('charityModal').classList.add('active');
        }

        function closeCharityModal() {
            document.getElementById('charityModal').classList.remove('active');
            document.getElementById('charityForm').reset();
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Autocomplete functionality
        let allCharities = [];
        let selectedCharityIndex = -1;
        let searchTimeout;

        async function initCharityAutocomplete() {
            console.log('Initializing charity autocomplete...');

            // Load top charities for quick access
            if (allCharities.length === 0) {
                try {
                    const response = await fetch('/api/charities?limit=500');
                    const data = await response.json();
                    if (data.success && data.charities) {
                        allCharities = data.charities;
                        console.log(`Loaded ${allCharities.length} charities`);
                    }
                } catch (error) {
                    console.error('Failed to load charities:', error);
                }
            }

            const input = document.getElementById('donationCharity');
            const dropdown = document.getElementById('charityDropdown');
            const hiddenInput = document.getElementById('selectedCharityId');

            if (!input || !dropdown) {
                console.error('Charity input or dropdown not found', 'Input:', input, 'Dropdown:', dropdown);
                return;
            }

            // Remove any existing listeners first to avoid duplicates
            if (input._charityListenersAdded) {
                console.log('Charity listeners already added');
                return; // Already initialized
            }

            // Setup event listeners - use anonymous functions to ensure they're attached
            input.addEventListener('input', function(e) {
                console.log('Input event fired');
                handleCharitySearch(e);
            });
            input.addEventListener('focus', function(e) {
                console.log('Focus event fired');
                handleCharitySearch(e);
            });
            input.addEventListener('keydown', function(e) {
                handleCharityKeydown(e);
            });

            // Mark as initialized
            input._charityListenersAdded = true;
            console.log('Charity autocomplete initialized - listeners attached to:', input);
        }

        function handleCharitySearch(e) {
            const query = e.target.value.toLowerCase();
            const dropdown = document.getElementById('charityDropdown');
            console.log('Charity search for:', query);

            // Clear the selected charity ID when user is typing
            document.getElementById('selectedCharityId').value = '';

            clearTimeout(searchTimeout);
            selectedCharityIndex = -1;

            if (query.length < 2) {
                dropdown.classList.remove('show');
                dropdown.style.display = 'none';
                return;
            }

            // Show loading state
            dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
            dropdown.classList.add('show');
            dropdown.style.display = 'block';

            // Debounce search
            searchTimeout = setTimeout(async () => {
                // First, filter local charities for immediate results
                let results = allCharities.filter(charity =>
                    charity.name.toLowerCase().includes(query) ||
                    (charity.ein && charity.ein.toLowerCase().includes(query))
                ).slice(0, 10);

                // If we have fewer than 10 results, search the full database
                if (results.length < 10) {
                    try {
                        const response = await fetch(`/api/charities?search=${encodeURIComponent(query)}&limit=10`);
                        const data = await response.json();
                        if (data.success && data.charities) {
                            // Merge results, avoiding duplicates
                            const existingIds = new Set(results.map(r => r.id));
                            const newResults = data.charities.filter(c => !existingIds.has(c.id));
                            results = [...results, ...newResults].slice(0, 10);
                        }
                    } catch (error) {
                        console.error('Search failed:', error);
                    }
                }

                displayCharityResults(results, query);
            }, 300);
        }

        function displayCharityResults(results, query) {
            const dropdown = document.getElementById('charityDropdown');

            if (results.length === 0) {
                dropdown.innerHTML = `
                    <div class="autocomplete-add-new" onclick="showAddCharityFromSearch('${query}')">
                        + Add new charity "${query}"
                    </div>
                `;
            } else {
                let html = '';
                results.forEach((charity, index) => {
                    html += `
                        <div class="autocomplete-item ${index === selectedCharityIndex ? 'selected' : ''}"
                             data-id="${charity.id}"
                             data-index="${index}"
                             onclick="selectCharity('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')">
                            <div class="autocomplete-item-name">${charity.name}</div>
                            ${charity.ein ? `<span class="autocomplete-item-ein">EIN: ${charity.ein}</span>` : ''}
                            ${charity.category ? `<span class="autocomplete-item-category">${charity.category}</span>` : ''}
                        </div>
                    `;
                });

                // Add "Add new charity" option at the end
                html += `
                    <div class="autocomplete-add-new" onclick="showAddCharityFromSearch('${query}')">
                        + Add new charity
                    </div>
                `;

                dropdown.innerHTML = html;
            }

            dropdown.classList.add('show');
            dropdown.style.display = 'block';
        }

        function handleCharityKeydown(e) {
            const dropdown = document.getElementById('charityDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (!dropdown.classList.contains('show') || items.length === 0) return;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedCharityIndex = Math.min(selectedCharityIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedCharityIndex = Math.max(selectedCharityIndex - 1, -1);
                    updateSelectedItem(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedCharityIndex >= 0 && items[selectedCharityIndex]) {
                        items[selectedCharityIndex].click();
                    }
                    break;
                case 'Escape':
                    dropdown.classList.remove('show');
                    selectedCharityIndex = -1;
                    break;
            }
        }

        function updateSelectedItem(items) {
            items.forEach((item, index) => {
                if (index === selectedCharityIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectCharity(id, name) {
            document.getElementById('selectedCharityId').value = id;
            document.getElementById('donationCharity').value = name;
            const dropdown = document.getElementById('charityDropdown');
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
            selectedCharityIndex = -1;
            console.log('Selected charity:', name, 'ID:', id);
        }

        function showAddCharityFromSearch(searchQuery) {
            // Close donation modal
            closeDonationModal();
            // Open charity modal with pre-filled name
            showAddCharity();
            document.getElementById('charityName').value = searchQuery;
        }

        // Form submissions
        document.getElementById('donationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const charityId = document.getElementById('selectedCharityId').value;
            if (!charityId) {
                alert('Please select a charity from the dropdown');
                return;
            }

            const donationType = document.getElementById('donationType').value;
            const isEditing = window.editingDonationId !== null && window.editingDonationId !== undefined;
            const formData = {
                charity_id: charityId,
                donation_type: donationType,
                donation_date: document.getElementById('donationDate').value,  // API will map this to 'date'
                notes: document.getElementById('donationNotes').value
            };

            // Add type-specific data
            switch(donationType) {
                case 'cash':
                    formData.amount = parseFloat(document.getElementById('donationAmount').value);
                    break;
                case 'items':
                    formData.item_description = document.getElementById('itemDescription').value;
                    formData.amount = parseFloat(document.getElementById('estimatedValue').value);
                    formData.estimated_value = formData.amount;
                    break;
                case 'miles':
                    const miles = parseFloat(document.getElementById('milesDriven').value);
                    const rate = 0.14; // 2024 IRS rate
                    formData.miles_driven = miles;
                    formData.mileage_rate = rate;
                    formData.mileage_purpose = document.getElementById('mileagePurpose').value;
                    formData.amount = miles * rate; // Calculate deduction amount
                    break;
                case 'stock':
                    const shares = parseFloat(document.getElementById('stockQuantity').value);
                    const pricePerShare = parseFloat(document.getElementById('fairMarketValue').value);
                    formData.stock_name = document.getElementById('stockName').value;
                    formData.stock_symbol = document.getElementById('stockSymbol').value.toUpperCase();
                    formData.shares_donated = shares;
                    formData.fair_market_value = pricePerShare;
                    formData.cost_basis = parseFloat(document.getElementById('costBasis').value) || null;
                    formData.amount = shares * pricePerShare; // Total donation = shares √ó price per share
                    break;
                case 'crypto':
                    const cryptoQuantity = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
                    const cryptoPricePerUnit = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
                    const cryptoDate = document.getElementById('donationDate').value;
                    const cryptoTime = document.getElementById('cryptoDonationTime').value || '12:00:00';

                    formData.crypto_name = document.getElementById('cryptoName').value;
                    formData.crypto_symbol = document.getElementById('cryptoSymbol').value.toUpperCase();
                    formData.crypto_quantity = cryptoQuantity;
                    formData.crypto_price_per_unit = cryptoPricePerUnit;
                    formData.crypto_exchange = document.getElementById('cryptoExchange').value;
                    formData.crypto_cost_basis = parseFloat(document.getElementById('cryptoCostBasis').value) || null;
                    formData.crypto_holding_period = document.getElementById('cryptoHoldingPeriod').value;
                    formData.amount = cryptoQuantity * cryptoPricePerUnit;
                    // Store exact donation timestamp
                    formData.crypto_donation_datetime = cryptoDate + 'T' + cryptoTime;
                    // Override the donation date with crypto-specific date
                    formData.donation_date = cryptoDate;
                    break;
            }

            try {
                const url = isEditing ? `/api/donations/${window.editingDonationId}` : '/api/donations';
                const method = isEditing ? 'PUT' : 'POST';

                // Get user token for authorization
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    closeDonationModal();
                    // Clear editing flag
                    delete window.editingDonationId;
                    // Reset modal title
                    document.querySelector('#donationModal .modal-header h2').textContent = 'Add Donation';

                    // Show success message
                    showToast(isEditing ? 'Donation updated successfully!' : '‚úÖ Donation added successfully!', 'success');

                    // Switch to dashboard view
                    showSection('dashboard');

                    // Refresh the dashboard to show new donation
                    loadDonations();
                    loadStats();
                    loadCharities(); // Refresh charities to show the one with donation
                } else {
                    showToast(`Failed to ${isEditing ? 'update' : 'add'} donation: ` + data.error, 'error');
                }
            } catch (error) {
                console.error(`Error ${isEditing ? 'updating' : 'adding'} donation:`, error);
                alert(`Failed to ${isEditing ? 'update' : 'add'} donation. Please try again.`);
            }
        });

        document.getElementById('charityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // TODO: Implement charity submission to API
            alert('Charity management will be fully implemented once all APIs are connected!');
            closeCharityModal();
        });

        // Update year filter
        function updateYearFilter() {
            const year = document.getElementById('globalYearFilter').value;
            // Sync with report year dropdown
            const reportYear = document.getElementById('reportYear');
            if (reportYear) {
                reportYear.value = year;
            }
            // Reload data with new filter
            loadDonations();
            loadStats();
            loadCharities();
        }

        // Load and display donations
        async function loadDonations() {
            const container = document.getElementById('donationsContent');
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            try {
                let url = '/api/donations?limit=10';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    let html = '<table class="table"><thead><tr><th>Date</th><th>Charity</th><th>Type</th><th>Amount</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
                    data.donations.forEach(donation => {
                        // Parse date correctly to avoid timezone issues
                        const dateStr = donation.date || donation.donation_date;
                        let date;
                        if (dateStr) {
                            // If date is in YYYY-MM-DD format, parse it correctly
                            if (dateStr.includes('-')) {
                                const [year, month, day] = dateStr.split('-');
                                date = `${month}/${day}/${year}`;
                            } else {
                                date = new Date(dateStr).toLocaleDateString();
                            }
                        } else {
                            date = 'Unknown';
                        }
                        const typeIcons = {
                            'cash': 'üíµ',
                            'items': 'üì¶',
                            'miles': 'üöó',
                            'stock': 'üìà',
                            'crypto': '‚Çø'
                        };
                        const typeIcon = typeIcons[donation.donation_type] || 'üíµ';

                        // Build type display with details
                        let typeDisplay = `${typeIcon} ${donation.donation_type || 'cash'}`;
                        if (donation.donation_type === 'miles') {
                            typeDisplay = `${typeIcon} ${donation.miles_driven || 0} miles`;
                        } else if (donation.donation_type === 'stock' && donation.stock_symbol) {
                            typeDisplay = `${typeIcon} ${donation.stock_symbol}`;
                        } else if (donation.donation_type === 'crypto' && donation.crypto_symbol) {
                            typeDisplay = `${typeIcon} ${donation.crypto_symbol}`;
                        }

                        // Only show user-entered notes, nothing else
                        let displayNotes = donation.notes || '';

                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${donation.charity_name || 'Unknown'}</td>
                                <td>${typeDisplay}</td>
                                <td>$${formatCurrency(donation.amount, true)}</td>
                                <td>${displayNotes}</td>
                                <td>
                                    <button class="btn-action" onclick="editDonation('${donation.id}')">‚úèÔ∏è</button>
                                    <button class="btn-action btn-danger" onclick="deleteDonation('${donation.id}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    // Keep empty state
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>No donations yet. Add your first donation to get started!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load donations:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            // Update labels with selected year
            if (year === 'all') {
                document.getElementById('totalDonationsLabel').textContent = 'Total Donations (All Years)';
                document.getElementById('taxSavingsLabel').textContent = 'Est. Tax Savings (All Years)';
            } else {
                document.getElementById('totalDonationsLabel').textContent = `Total Donations (${year})`;
                document.getElementById('taxSavingsLabel').textContent = `Est. Tax Savings (${year})`;
            }

            try {
                // Fetch donations for the selected year
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations) {
                    // Calculate totals from donations
                    const totalAmount = data.donations.reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);

                    // Count unique charities
                    const uniqueCharities = new Set(data.donations.map(d => d.charity_id)).size;

                    // Calculate tax savings based on current tax rate
                    const taxRate = currentTaxRate || 0.22;
                    const estimatedSavings = totalAmount * taxRate;

                    // Update display with proper formatting
                    document.getElementById('totalDonations').textContent = `$${formatCurrency(totalAmount)}`;
                    document.getElementById('charityCount').textContent = uniqueCharities.toString();
                    document.getElementById('taxSavings').textContent = `$${formatCurrency(estimatedSavings)}`;
                } else {
                    // No donations, show zeros
                    document.getElementById('totalDonations').textContent = '$0';
                    document.getElementById('charityCount').textContent = '0';
                    document.getElementById('taxSavings').textContent = '$0';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
                // Show zeros on error
                document.getElementById('totalDonations').textContent = '$0';
                document.getElementById('charityCount').textContent = '0';
                document.getElementById('taxSavings').textContent = '$0';
            }
        }

        // Load and display charities (only those with donations)
        async function loadCharities() {
            const container = document.getElementById('charitiesContent');

            try {
                // Only show charities that have donations
                const response = await fetch('/api/charities?with_donations=true&limit=10');
                const data = await response.json();

                if (data.success && data.charities && data.charities.length > 0) {
                    let html = '<div class="charity-grid">';
                    data.charities.forEach(charity => {
                        html += `
                            <div class="charity-card">
                                <h3>${charity.name}</h3>
                                ${charity.ein ? `<p class="charity-ein">EIN: ${charity.ein}</p>` : ''}
                                ${charity.category ? `<p class="charity-category">${charity.category}</p>` : ''}
                                ${charity.description ? `<p class="charity-description">${charity.description}</p>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    if (data.total > 10) {
                        html += `<p class="charity-count">Showing 10 of ${data.total} charities</p>`;
                    }
                    container.innerHTML = html;
                } else {
                    // Show empty state when no charities have donations
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üèõÔ∏è</div>
                            <p>No charities with donations yet. Add your first donation to see charities here!</p>
                        </div>
                    `;
                }

                // Update charity count in stats
                document.getElementById('charityCount').textContent = data.total || '0';

            } catch (error) {
                console.error('Failed to load charities:', error);
            }
        }

        // Export functions
        async function exportCSV() {
            try {
                // Fetch all donations for the selected year
                const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    alert('No donations to export');
                    return;
                }

                // Create CSV content
                let csvContent = 'Date,Charity,Type,Amount,Description,Notes\n';

                data.donations.forEach(donation => {
                    const date = new Date(donation.donation_date).toLocaleDateString();
                    const charity = (donation.charity_name || 'Unknown').replace(/,/g, ';');
                    const type = donation.donation_type || 'cash';
                    const amount = parseFloat(donation.amount).toFixed(2);
                    const description = getDescriptionForType(donation);
                    const notes = (donation.notes || '').replace(/,/g, ';');

                    csvContent += `${date},"${charity}",${type},${amount},"${description}","${notes}"\n`;
                });

                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const filename = selectedYear === 'all' ? 'donations_all.csv' : `donations_${selectedYear}.csv`;
                link.download = filename;
                link.click();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export donations. Please try again.');
            }
        }

        async function exportPDF() {
            try {
                // Fetch all donations for the selected year
                const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    alert('No donations to export');
                    return;
                }

                // Create HTML content for PDF
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Donation Report ${selectedYear === 'all' ? 'All Years' : selectedYear}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; }
                            h1 { color: #667eea; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .summary { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
                            .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                        </style>
                    </head>
                    <body>
                        <h1>Tax Deductible Donations - ${selectedYear === 'all' ? 'All Years' : selectedYear}</h1>
                        <div class="summary">
                            <h2>Summary</h2>
                            <p><strong>Total Donations:</strong> $${data.donations.reduce((sum, d) => sum + parseFloat(d.amount), 0).toFixed(2)}</p>
                            <p><strong>Number of Donations:</strong> ${data.donations.length}</p>
                            <p><strong>Report Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Charity</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.donations.forEach(donation => {
                    const date = new Date(donation.donation_date).toLocaleDateString();
                    const description = getDescriptionForType(donation);
                    htmlContent += `
                        <tr>
                            <td>${date}</td>
                            <td>${donation.charity_name || 'Unknown'}</td>
                            <td>${donation.donation_type || 'cash'}</td>
                            <td>$${formatCurrency(donation.amount, true)}</td>
                            <td>${description}</td>
                            <td>${donation.notes || ''}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>This report is for tax preparation purposes. Please consult with your tax advisor.</p>
                            <p>Generated by Charity Tracker v1.5.0</p>
                        </div>
                    </body>
                    </html>
                `;

                // Open in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export donations. Please try again.');
            }
        }

        function getDescriptionForType(donation) {
            switch(donation.donation_type) {
                case 'items':
                    return donation.item_description || 'Donated items';
                case 'miles':
                    return `${donation.miles_driven || 0} miles @ $${donation.mileage_rate || 0.14}/mile - ${donation.mileage_purpose || 'Charity work'}`;
                case 'stock':
                    const stockTotal = (donation.shares_donated || 0) * (donation.fair_market_value || 0);
                    return `${donation.stock_symbol || 'Stock'}: ${donation.shares_donated || 0} shares @ $${donation.fair_market_value || 0}/share = $${stockTotal.toFixed(2)}`;
                case 'crypto':
                    const cryptoTotal = (donation.crypto_quantity || 0) * (donation.crypto_price_per_unit || 0);
                    const cryptoTime = donation.crypto_donation_datetime ? new Date(donation.crypto_donation_datetime).toLocaleTimeString() : '';
                    return `${donation.crypto_symbol || 'Crypto'}: ${donation.crypto_quantity || 0} units @ $${donation.crypto_price_per_unit || 0}/unit = $${cryptoTotal.toFixed(2)} (${cryptoTime})`;
                case 'cash':
                default:
                    return 'Cash donation';
            }
        }

        // Tax rate calculations (2024 rates)
        const taxBrackets = {
            single: [
                {min: 0, max: 11600, rate: 0.10},
                {min: 11600, max: 47150, rate: 0.12},
                {min: 47150, max: 100525, rate: 0.22},
                {min: 100525, max: 191950, rate: 0.24},
                {min: 191950, max: 243725, rate: 0.32},
                {min: 243725, max: 609350, rate: 0.35},
                {min: 609350, max: Infinity, rate: 0.37}
            ],
            married_jointly: [
                {min: 0, max: 23200, rate: 0.10},
                {min: 23200, max: 94300, rate: 0.12},
                {min: 94300, max: 201050, rate: 0.22},
                {min: 201050, max: 383900, rate: 0.24},
                {min: 383900, max: 487450, rate: 0.32},
                {min: 487450, max: 731200, rate: 0.35},
                {min: 731200, max: Infinity, rate: 0.37}
            ],
            married_separately: [
                {min: 0, max: 11600, rate: 0.10},
                {min: 11600, max: 47150, rate: 0.12},
                {min: 47150, max: 100525, rate: 0.22},
                {min: 100525, max: 191950, rate: 0.24},
                {min: 191950, max: 243725, rate: 0.32},
                {min: 243725, max: 365600, rate: 0.35},
                {min: 365600, max: Infinity, rate: 0.37}
            ],
            head_of_household: [
                {min: 0, max: 16550, rate: 0.10},
                {min: 16550, max: 63100, rate: 0.12},
                {min: 63100, max: 100500, rate: 0.22},
                {min: 100500, max: 191950, rate: 0.24},
                {min: 191950, max: 243700, rate: 0.32},
                {min: 243700, max: 609350, rate: 0.35},
                {min: 609350, max: Infinity, rate: 0.37}
            ]
        };

        const standardDeductions = {
            single: 14600,
            married_jointly: 29200,
            married_separately: 14600,
            head_of_household: 21900
        };

        let currentTaxRate = 0.22; // Default 22%

        function updateTaxRate() {
            const filingStatus = document.getElementById('filingStatus').value;
            const income = parseInt(document.getElementById('incomeBracket').value);

            const brackets = taxBrackets[filingStatus] || taxBrackets.single;
            let rate = 0.10;

            for (const bracket of brackets) {
                if (income >= bracket.min && income <= bracket.max) {
                    rate = bracket.rate;
                    break;
                }
            }

            currentTaxRate = rate;
            const percentage = Math.round(rate * 100);

            // Update profile display
            document.getElementById('marginalTaxRate').textContent = percentage + '%';
            document.getElementById('savingsPerHundred').textContent = '$' + percentage;
            document.getElementById('standardDeduction').textContent =
                '$' + (standardDeductions[filingStatus] || 14600).toLocaleString();

            // Update donation form display
            document.getElementById('taxRateDisplay').textContent = percentage;
            updateTaxSavings();

            // Save to localStorage
            localStorage.setItem('taxRate', rate);
            localStorage.setItem('filingStatus', filingStatus);
            localStorage.setItem('income', income);
        }

        // Save profile information
        function saveProfile() {
            const profileData = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                address: document.getElementById('profileAddress').value,
                city: document.getElementById('profileCity').value,
                state: document.getElementById('profileState').value,
                zip: document.getElementById('profileZip').value,
                filingStatus: document.getElementById('filingStatus').value,
                income: document.getElementById('incomeBracket').value
            };

            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(profileData));

            // Also update tax settings
            updateTaxRate();

            showToast('‚úÖ Profile saved successfully!', 'success');
        }

        // Load profile information
        function loadProfile() {
            const savedProfile = localStorage.getItem('userProfile');
            const userEmail = localStorage.getItem('userEmail');

            if (savedProfile) {
                const profile = JSON.parse(savedProfile);

                // Load personal information
                document.getElementById('profileName').value = profile.name || '';
                document.getElementById('profileEmail').value = userEmail || profile.email || '';
                document.getElementById('profileAddress').value = profile.address || '';
                document.getElementById('profileCity').value = profile.city || '';
                document.getElementById('profileState').value = profile.state || '';
                document.getElementById('profileZip').value = profile.zip || '';

                // Load tax information
                document.getElementById('filingStatus').value = profile.filingStatus || 'single';
                document.getElementById('incomeBracket').value = profile.income || '50000';
            } else {
                // Just set the email if we have it
                document.getElementById('profileEmail').value = userEmail || '';
            }

            // Update tax calculations
            updateTaxRate();
        }

        function updateTaxSavings() {
            let amount = 0;
            const donationType = document.getElementById('donationType').value;

            // Get amount based on donation type
            switch(donationType) {
                case 'cash':
                    amount = parseFloat(document.getElementById('donationAmount').value) || 0;
                    break;
                case 'items':
                    amount = parseFloat(document.getElementById('estimatedValue').value) || 0;
                    break;
                case 'miles':
                    const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
                    amount = miles * 0.14;
                    break;
                case 'stock':
                    const stockShares = parseFloat(document.getElementById('stockQuantity').value) || 0;
                    const stockPrice = parseFloat(document.getElementById('fairMarketValue').value) || 0;
                    amount = stockShares * stockPrice; // Total = shares √ó price
                    break;
                case 'crypto':
                    const cryptoQty = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
                    const cryptoPrice = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
                    amount = cryptoQty * cryptoPrice;
                    break;
            }

            const savings = amount * currentTaxRate;

            document.getElementById('donationAmountDisplay').textContent = '$' + amount.toFixed(2);
            document.getElementById('taxSavingsDisplay').textContent = '$' + savings.toFixed(2);
        }

        // CSV Import functionality
        let importData = [];

        function showImportDonations() {
            document.getElementById('importDonationsPanel').style.display = 'block';
        }

        // Setup drag and drop
        const dropZone = document.getElementById('csvDropZone');
        const fileInput = document.getElementById('csvFileInput');

        dropZone?.addEventListener('click', () => fileInput.click());

        dropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#e0e7ff';
        });

        dropZone?.addEventListener('dragleave', () => {
            dropZone.style.background = '#f9fafb';
        });

        dropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#f9fafb';
            const files = e.dataTransfer.files;
            if (files.length) handleCSVFile(files[0]);
        });

        fileInput?.addEventListener('change', (e) => {
            if (e.target.files.length) handleCSVFile(e.target.files[0]);
        });

        function handleCSVFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim());

            importData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const donation = {};
                headers.forEach((header, index) => {
                    donation[header] = values[index];
                });
                importData.push(donation);
            }

            showPreview();
        }

        function showPreview() {
            const preview = document.getElementById('importPreview');
            const table = document.getElementById('previewTable');

            let html = '<table class="table"><thead><tr><th>Charity ID</th><th>Amount</th><th>Date</th><th>Type</th><th>Notes</th></tr></thead><tbody>';

            importData.slice(0, 10).forEach(donation => {
                html += `<tr>
                    <td>${donation.charity_id}</td>
                    <td>$${parseFloat(donation.amount).toFixed(2)}</td>
                    <td>${donation.donation_date}</td>
                    <td>${donation.donation_type || 'cash'}</td>
                    <td>${donation.notes || ''}</td>
                </tr>`;
            });

            if (importData.length > 10) {
                html += `<tr><td colspan="5" style="text-align: center; font-style: italic;">... and ${importData.length - 10} more</td></tr>`;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
            preview.style.display = 'block';
        }

        async function confirmImport() {
            const successCount = { success: 0, failed: 0 };

            for (const donation of importData) {
                try {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const token = user.token || localStorage.getItem('token') || 'test-token';

                    const response = await fetch('/api/donations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            charity_id: donation.charity_id,
                            amount: parseFloat(donation.amount),
                            donation_date: donation.donation_date,
                            donation_type: donation.donation_type || 'cash',
                            notes: donation.notes || ''
                        })
                    });

                    if (response.ok) {
                        successCount.success++;
                    } else {
                        successCount.failed++;
                    }
                } catch (error) {
                    successCount.failed++;
                }
            }

            alert(`Import Complete!\nSuccessful: ${successCount.success}\nFailed: ${successCount.failed}`);
            cancelImport();
            loadDonations();
            loadStats();
        }

        function cancelImport() {
            document.getElementById('importDonationsPanel').style.display = 'none';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            importData = [];
        }

        // Load saved tax settings
        function loadTaxSettings() {
            const savedRate = localStorage.getItem('taxRate');
            const savedStatus = localStorage.getItem('filingStatus');
            const savedIncome = localStorage.getItem('income');

            if (savedRate) {
                currentTaxRate = parseFloat(savedRate);
            }
            if (savedStatus) {
                document.getElementById('filingStatus').value = savedStatus;
            }
            if (savedIncome) {
                document.getElementById('incomeBracket').value = savedIncome;
            }

            updateTaxRate();
        }

        // View Summary function
        async function viewSummary() {
            const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
            const summaryDiv = document.getElementById('reportSummary');

            summaryDiv.innerHTML = '<p>Loading summary...</p>';

            try {
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    summaryDiv.innerHTML = '<p style="color: #666;">No donations found for the selected year.</p>';
                    return;
                }

                // Calculate summary statistics
                const donations = data.donations;
                const totalAmount = donations.reduce((sum, d) => sum + parseFloat(d.amount), 0);
                const taxSavings = totalAmount * currentTaxRate;

                // Group by charity
                const charityTotals = {};
                donations.forEach(d => {
                    const charity = d.charity_name || 'Unknown';
                    charityTotals[charity] = (charityTotals[charity] || 0) + parseFloat(d.amount);
                });

                // Group by type
                const typeTotals = {
                    cash: 0,
                    items: 0,
                    miles: 0,
                    stock: 0,
                    crypto: 0
                };
                donations.forEach(d => {
                    const type = d.donation_type || 'cash';
                    typeTotals[type] = (typeTotals[type] || 0) + parseFloat(d.amount);
                });

                // Generate HTML summary
                let html = `
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">Tax Year ${selectedYear === 'all' ? 'All Years' : selectedYear} Summary</h3>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Total Donations</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #667eea;">$${totalAmount.toFixed(2)}</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Est. Tax Savings</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #16a34a;">$${taxSavings.toFixed(2)}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Number of Donations</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #dc2626;">${donations.length}</div>
                            </div>
                        </div>

                        <h4 style="color: #4b5563; margin-bottom: 0.5rem;">Donations by Type</h4>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                `;

                Object.entries(typeTotals).forEach(([type, amount]) => {
                    if (amount > 0) {
                        const percentage = ((amount / totalAmount) * 100).toFixed(1);
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="text-transform: capitalize;">${type}</span>
                                <span><strong>$${amount.toFixed(2)}</strong> (${percentage}%)</span>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>

                        <h4 style="color: #4b5563; margin-bottom: 0.5rem;">Top Charities</h4>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                `;

                // Sort charities by total amount
                const sortedCharities = Object.entries(charityTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                sortedCharities.forEach(([charity, amount]) => {
                    const percentage = ((amount / totalAmount) * 100).toFixed(1);
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                            <span>${charity}</span>
                            <span><strong>$${amount.toFixed(2)}</strong> (${percentage}%)</span>
                        </div>
                    `;
                });

                html += `
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <p style="font-size: 0.875rem; color: #92400e;">
                                <strong>Note:</strong> Tax savings shown are estimates based on your ${Math.round(currentTaxRate * 100)}% marginal tax rate.
                                Actual savings depend on itemizing deductions vs. standard deduction ($${(standardDeductions[localStorage.getItem('filingStatus')] || 14600).toLocaleString()}).
                            </p>
                        </div>
                    </div>
                `;

                summaryDiv.innerHTML = html;

            } catch (error) {
                console.error('Failed to generate summary:', error);
                summaryDiv.innerHTML = '<p style="color: #dc2626;">Failed to generate summary. Please try again.</p>';
            }
        }

        // Item donation management
        let itemCategories = [];
        let currentItems = [];
        let selectedDonationItems = [];

        // Load categories on page load
        async function loadItemCategories() {
            console.log('Loading item categories...');
            try {
                const response = await fetch('/api/items?type=categories');
                const data = await response.json();
                console.log('Categories response:', data);

                if (data.success) {
                    itemCategories = data.categories;
                    console.log(`Loaded ${itemCategories.length} categories`);

                    // Populate the category dropdown
                    const categorySelect = document.getElementById('itemCategory');
                    if (categorySelect) {
                        categorySelect.innerHTML = '<option value="">Select category...</option>';
                        itemCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = `${cat.icon || ''} ${cat.name}`;
                            categorySelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        // Handle category selection change
        async function categoryChanged() {
            const categoryId = document.getElementById('itemCategory').value;
            const itemSearch = document.getElementById('itemSearch');
            const itemQuality = document.getElementById('itemQuality');
            const itemQuantity = document.getElementById('itemQuantity');
            const addBtn = document.getElementById('addItemBtn');

            if (!categoryId) {
                // No category selected, disable everything
                itemSearch.disabled = true;
                itemSearch.placeholder = 'Select category first';
                itemSearch.value = '';
                itemQuality.disabled = true;
                itemQuantity.disabled = true;
                addBtn.disabled = true;
                addBtn.style.background = '#9ca3af';
                addBtn.style.cursor = 'not-allowed';
                currentItems = [];
                document.getElementById('itemValueDisplay').style.display = 'none';
                return;
            }

            // Category selected, enable item search and clear previous selection
            itemSearch.disabled = false;
            itemSearch.placeholder = 'Type to search items...';
            itemSearch.value = '';  // Clear any previous item selection
            document.getElementById('itemSelect').value = '';  // Clear hidden select
            document.getElementById('itemValueDisplay').style.display = 'none';  // Hide value display

            // Load items for this category
            console.log(`Loading items for category ${categoryId}`);
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                console.log('Items API response status:', response.status);
                const data = await response.json();
                console.log('Items data:', data);

                if (data.success) {
                    currentItems = data.items || [];
                    console.log(`Loaded ${currentItems.length} items`);
                } else {
                    console.error('Failed to load items:', data.error);
                    currentItems = [];
                }
            } catch (error) {
                console.error('Failed to load items:', error);
                currentItems = [];
            }
        }

        // Show category dropdown (for backwards compatibility)
        function showCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            const searchValue = document.getElementById('itemCategorySearch') ? document.getElementById('itemCategorySearch').value.toLowerCase() : '';

            let html = '';
            const filteredCategories = searchValue
                ? itemCategories.filter(cat => cat.name.toLowerCase().includes(searchValue))
                : itemCategories;

            if (filteredCategories.length === 0) {
                html = '<div style="padding:0.75rem;color:#6b7280;text-align:center;">No categories found</div>';
            } else {
                filteredCategories.forEach(cat => {
                    html += `
                        <div onclick="selectCategory(${cat.id}, '${cat.name}', '${cat.icon}')"
                             style="padding:0.75rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;transition:background 0.2s;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='white'">
                            <span style="font-size:1.25rem;">${cat.icon}</span>
                            <span style="flex:1;">${cat.name}</span>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        // Search categories
        function searchCategories(value) {
            showCategoryDropdown();
        }

        // Select a category
        async function selectCategory(categoryId, categoryName, categoryIcon) {
            document.getElementById('itemCategory').value = categoryId;
            document.getElementById('itemCategorySearch').value = categoryName;
            document.getElementById('selectedCategoryIcon').textContent = categoryIcon;
            document.getElementById('categoryDropdown').style.display = 'none';

            // Check if element exists before setting
            const categoryNameElement = document.getElementById('selectedCategoryName');
            if (categoryNameElement) {
                categoryNameElement.textContent = categoryName;
            }

            // Show item search section
            document.getElementById('itemSearchSection').style.display = 'block';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemDetailsSection').style.display = 'none';

            // Load items for this category
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                console.log('Items API response status:', response.status);
                const data = await response.json();
                console.log('Items data:', data);

                if (data.success) {
                    currentItems = data.items || [];
                    console.log(`Loaded ${currentItems.length} items for category ${categoryName}`);
                    // Show dropdown immediately if there are items
                    if (currentItems.length > 0) {
                        showItemDropdown();
                    }
                } else {
                    console.error('Failed to load items:', data.error);
                    currentItems = [];
                }
            } catch (error) {
                console.error('Failed to load items:', error);
            }
        }

        // Show item dropdown
        function showItemDropdown() {
            const dropdown = document.getElementById('itemDropdown');
            const searchValue = document.getElementById('itemSearch').value.toLowerCase();

            let html = '';
            const filteredItems = searchValue
                ? currentItems.filter(item =>
                    item.name.toLowerCase().includes(searchValue) ||
                    (item.description && item.description.toLowerCase().includes(searchValue))
                  )
                : currentItems;

            if (filteredItems.length === 0) {
                html = '<div style="padding:0.75rem;color:#6b7280;text-align:center;">No items found</div>';
            } else {
                filteredItems.forEach(item => {
                    const veryGoodValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
                    const priceRange = `Fair: $0 | Good: $${item.value_good || 0} | Very Good: $${veryGoodValue.toFixed(0)} | Excellent: $${item.value_excellent || 0}`;
                    html += `
                        <div onclick="selectItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')"
                             style="padding:0.75rem;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='white'">
                            <div style="font-weight:500;">${item.name}</div>
                            <div style="font-size:0.75rem;color:#6b7280;">${item.description || ''}</div>
                            <div style="font-size:0.75rem;color:#667eea;margin-top:0.25rem;">${priceRange}</div>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            console.log('Showing dropdown with', filteredItems.length, 'items');
        }

        // Search items
        function searchItems(value) {
            console.log('Searching items with value:', value);
            showItemDropdown();
        }

        // Select an item
        function selectItem(itemId, itemName) {
            const item = currentItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('itemSelect').value = itemId;
            document.getElementById('itemSearch').value = itemName;
            document.getElementById('itemDropdown').style.display = 'none';

            // Enable quality, quantity, and add button
            document.getElementById('itemQuality').disabled = false;
            document.getElementById('itemQuantity').disabled = false;
            const addBtn = document.getElementById('addItemBtn');
            addBtn.disabled = false;
            addBtn.style.background = '#667eea';
            addBtn.style.cursor = 'pointer';

            // Show value display
            document.getElementById('itemValueDisplay').style.display = 'block';
            document.getElementById('selectedItemName').textContent = `${item.name} - ${item.description || ''}`;

            // Reset quality and quantity
            document.getElementById('itemQuality').value = 'very_good';
            document.getElementById('itemQuantity').value = '1';

            // Update value preview
            updateItemValue();
        }

        // Update value based on selected item and quality
        function updateItemValue() {
            const itemId = document.getElementById('itemSelect').value;
            const quality = document.getElementById('itemQuality').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

            if (!itemId) return;

            const item = currentItems.find(i => i.id == itemId);
            if (!item) return;

            // Use quality-specific values from database (IRS only accepts good or better)
            let unitValue = 0;
            if (quality === 'fair') {
                // Fair items are not IRS deductible
                unitValue = 0;
            } else if (quality === 'good') {
                unitValue = item.value_good || 0;
            } else if (quality === 'very_good') {
                // Very good is the average of good and excellent
                unitValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
            } else if (quality === 'excellent') {
                unitValue = item.value_excellent || 0;
            }
            const totalValue = unitValue * quantity;

            // Update the preview
            document.getElementById('itemValuePreview').textContent = `$${totalValue.toFixed(2)}`;
        }

        // Add item to list
        function addItemToList() {
            const categoryId = document.getElementById('itemCategory').value;
            const itemId = document.getElementById('itemSelect').value;
            const quality = document.getElementById('itemQuality').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

            if (!categoryId || !itemId) {
                alert('Please select category and item');
                return;
            }

            const category = itemCategories.find(c => c.id == categoryId);
            const item = currentItems.find(i => i.id == itemId);

            // Determine quality label (IRS only accepts good or better)
            let qualityLabel;
            if (quality === 'fair') {
                qualityLabel = 'Fair (Not Deductible)';
            } else if (quality === 'good') {
                qualityLabel = 'Good';
            } else if (quality === 'very_good') {
                qualityLabel = 'Very Good';
            } else if (quality === 'excellent') {
                qualityLabel = 'Excellent';
            }

            // Use quality-specific values from database (IRS only accepts good or better)
            let unitValue = 0;
            if (quality === 'fair') {
                // Fair items are not IRS deductible
                unitValue = 0;
            } else if (quality === 'good') {
                unitValue = item.value_good || 0;
            } else if (quality === 'very_good') {
                // Very good is the average of good and excellent
                unitValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
            } else if (quality === 'excellent') {
                unitValue = item.value_excellent || 0;
            }

            selectedDonationItems.push({
                categoryName: category.name,
                itemName: item.name,
                quality: qualityLabel,
                quantity: quantity,
                unitValue: unitValue,
                totalValue: unitValue * quantity
            });

            updateSelectedItemsDisplay();

            // Reset form for next item
            document.getElementById('itemSelect').value = '';
            document.getElementById('itemSearch').value = '';  // Clear item search field
            document.getElementById('itemQuality').value = 'very_good';  // Reset to default
            document.getElementById('itemQuality').disabled = true;  // Disable until next item selected
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemQuantity').disabled = true;
            document.getElementById('itemValueDisplay').style.display = 'none';  // Hide value display

            // Disable add button until next item is selected
            const addBtn = document.getElementById('addItemBtn');
            addBtn.disabled = true;
            addBtn.style.background = '#9ca3af';
            addBtn.style.cursor = 'not-allowed';
        }

        function updateSelectedItemsDisplay() {
            const container = document.getElementById('selectedItemsList');
            const receiptTotal = document.getElementById('receiptTotal');
            const addItemBtn = document.getElementById('addItemBtn');
            const saveBtn = document.getElementById('saveItemsDonationBtn');

            if (selectedDonationItems.length === 0) {
                container.innerHTML = '<div class="empty-state" style="color:#9ca3af;text-align:center;padding:2rem;">No items added yet</div>';
                document.getElementById('estimatedValue').value = '0.00';
                if (receiptTotal) receiptTotal.textContent = '0.00';  // No $ needed, already in HTML
                if (addItemBtn) addItemBtn.style.display = 'block';
                if (saveBtn) saveBtn.style.display = 'none';  // Hide save button when no items
                return;
            }

            // Create receipt-style display
            let html = '<div style="font-family:monospace;font-size:0.875rem;background:#f9fafb;padding:0.75rem;border-radius:4px;">';
            html += '<div style="border-bottom:1px dashed #d1d5db;padding-bottom:0.5rem;margin-bottom:0.5rem;">';
            html += '<div style="text-align:center;font-weight:bold;margin-bottom:0.25rem;">DONATION RECEIPT</div>';
            html += '<div style="text-align:center;font-size:0.75rem;color:#6b7280;">Items for Tax Deduction</div>';
            html += '</div>';

            let totalValue = 0;

            selectedDonationItems.forEach((item, index) => {
                const lineTotal = item.totalValue;
                totalValue += lineTotal;

                html += `
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.375rem;font-size:0.8125rem;">
                        <div style="flex:1;padding-right:0.5rem;">
                            <div style="display:flex;justify-content:space-between;">
                                <span>${item.quantity}x ${item.itemName}</span>
                                <span>$${lineTotal.toFixed(2)}</span>
                            </div>
                            <div style="color:#6b7280;font-size:0.75rem;margin-left:1rem;">
                                ${item.categoryName} ‚Ä¢ ${item.quality.replace('_', ' ')}
                            </div>
                        </div>
                        <button type="button" onclick="removeItemFromList(${index})" style="color:#ef4444;background:none;border:none;cursor:pointer;padding:0;margin-left:0.25rem;font-size:1rem;line-height:1;">√ó</button>
                    </div>
                `;
            });

            html += '<div style="border-top:1px dashed #d1d5db;margin-top:0.5rem;padding-top:0.5rem;">';
            html += `<div style="display:flex;justify-content:space-between;font-weight:bold;">
                        <span>TOTAL VALUE:</span>
                        <span style="color:#667eea;">$${totalValue.toFixed(2)}</span>
                     </div>`;
            html += `<div style="font-size:0.75rem;color:#6b7280;margin-top:0.25rem;text-align:center;">
                        ${selectedDonationItems.length} item${selectedDonationItems.length > 1 ? 's' : ''}
                     </div>`;
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            document.getElementById('estimatedValue').value = totalValue.toFixed(2);
            if (receiptTotal) receiptTotal.textContent = totalValue.toFixed(2);  // No $ needed, already in HTML

            // Show save button when there are items
            if (saveBtn) saveBtn.style.display = 'block';

            // Show add item button when there are items
            if (addItemBtn) addItemBtn.style.display = selectedDonationItems.length > 0 ? 'block' : 'none';

            // Update item description for database
            const descriptions = selectedDonationItems.map(i =>
                `${i.itemName} (${i.quality}, qty: ${i.quantity})`
            ).join('; ');
            document.getElementById('itemDescription').value = descriptions;
        }

        function removeItemFromList(index) {
            selectedDonationItems.splice(index, 1);
            updateSelectedItemsDisplay();
        }

        // Helper function to handle donation type changes
        function handleDonationTypeChange(event) {
            updateDonationFields();
        }

        // Edit donation function
        async function editDonation(donationId) {
            try {
                // Fetch the donation details
                const response = await fetch(`/api/donations/${donationId}`);
                const data = await response.json();

                if (data.success && data.donation) {
                    const donation = data.donation;

                    // Store the donation ID for update
                    window.editingDonationId = donationId;

                    // Populate the form with existing data
                    document.getElementById('selectedCharityId').value = donation.charity_id;
                    document.getElementById('donationCharity').value = donation.charity_name || '';
                    document.getElementById('donationType').value = donation.donation_type || 'cash';
                    document.getElementById('donationDate').value = donation.date || donation.donation_date;
                    document.getElementById('donationNotes').value = donation.notes || '';

                    // Set type-specific fields
                    updateDonationFields();

                    if (donation.donation_type === 'cash') {
                        document.getElementById('donationAmount').value = donation.amount;
                    } else if (donation.donation_type === 'items') {
                        // For editing, we can't recreate the item list from the description alone
                        // Just show the description and value
                        document.getElementById('itemCategory').value = '';
                        selectedDonationItems = [];
                        updateSelectedItemsDisplay();
                        document.getElementById('itemDescription').value = donation.item_description || '';
                        document.getElementById('estimatedValue').value = donation.estimated_value || donation.amount;
                    } else if (donation.donation_type === 'miles') {
                        document.getElementById('milesDriven').value = donation.miles_driven || '';
                        document.getElementById('mileagePurpose').value = donation.mileage_purpose || '';
                    } else if (donation.donation_type === 'stock') {
                        document.getElementById('stockQuantity').value = donation.quantity || '';
                        document.getElementById('fairMarketValue').value = donation.fair_market_value || donation.amount;
                        document.getElementById('costBasis').value = donation.cost_basis || '';
                    } else if (donation.donation_type === 'crypto') {
                        document.getElementById('cryptoType').value = donation.crypto_type || '';
                        document.getElementById('cryptoQuantity').value = donation.quantity || '';
                        document.getElementById('cryptoValue').value = donation.amount;
                    }

                    // Change the modal title and show it
                    document.querySelector('#donationModal .modal-header h2').textContent = 'Edit Donation';
                    showAddDonation();
                }
            } catch (error) {
                console.error('Error fetching donation:', error);
                alert('Failed to load donation details');
            }
        }

        // Delete donation function
        async function deleteDonation(donationId) {
            if (!confirm('Are you sure you want to delete this donation?')) {
                return;
            }

            try {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Donation deleted successfully');
                    // Refresh the dashboard
                    loadDonations();
                    loadStats();
                    loadCharities();
                } else {
                    alert('Failed to delete donation: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting donation:', error);
                alert('Failed to delete donation');
            }
        }

        // Helper function to open donation modal with specific type
        function openDonationModal(type) {
            const typeInfo = {
                cash: {
                    title: 'Add Cash Donation',
                    icon: 'üíµ',
                    label: 'Cash/Check Donation',
                    desc: 'Record a monetary donation'
                },
                items: {
                    title: 'Add Item Donation',
                    icon: 'üì¶',
                    label: 'Item/Goods Donation',
                    desc: 'Record donated items with values'
                },
                miles: {
                    title: 'Add Mileage Donation',
                    icon: 'üöó',
                    label: 'Mileage Donation',
                    desc: 'Record miles driven for charity'
                },
                stock: {
                    title: 'Add Stock Donation',
                    icon: 'üìà',
                    label: 'Stock/Securities Donation',
                    desc: 'Record donated stocks or securities'
                },
                crypto: {
                    title: 'Add Crypto Donation',
                    icon: '‚Çø',
                    label: 'Cryptocurrency Donation',
                    desc: 'Record cryptocurrency donations'
                }
            };

            const info = typeInfo[type] || typeInfo.cash;

            // Clear the form including charity fields
            document.getElementById('donationForm').reset();
            document.getElementById('selectedCharityId').value = '';
            document.getElementById('donationCharity').value = '';
            document.getElementById('charityDropdown').classList.remove('show');

            // Reset item selection
            selectedDonationItems = [];
            updateSelectedItemsDisplay();
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSearch').disabled = true;
            document.getElementById('itemQuality').disabled = true;
            document.getElementById('itemQuantity').disabled = true;
            document.getElementById('addItemBtn').disabled = true;

            // Update modal header and type display
            document.getElementById('donationModalTitle').textContent = info.title;
            document.getElementById('donationTypeIcon').textContent = info.icon;
            document.getElementById('donationTypeLabel').textContent = info.label;
            document.getElementById('donationTypeDesc').textContent = info.desc;
            document.getElementById('donationType').value = type;

            updateDonationFields();
            showAddDonation();
        }

        // Section navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show the selected section
            const sectionMap = {
                'dashboard': 'dashboardSection',
                'donations': 'addDonationSection',
                'reports': 'reportsSection',
                'profile': 'profileSection',
                'tools': 'toolsSection'
            };

            const sectionId = sectionMap[sectionName];
            if (sectionId) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }

                // Mark nav item as active
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // If showing dashboard, reload data
            if (sectionName === 'dashboard') {
                loadCharities();
                loadDonations();
                loadStats();
            }

            // If showing profile, reload profile data
            if (sectionName === 'profile') {
                loadProfile();
            }
        }

        // Add event listeners for tax savings updates
        document.getElementById('donationAmount')?.addEventListener('input', updateTaxSavings);
        document.getElementById('estimatedValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('milesDriven')?.addEventListener('input', updateTaxSavings);
        document.getElementById('fairMarketValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('cryptoValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('donationType')?.addEventListener('change', updateTaxSavings);

        // Items Import Functions
        let itemsImportData = [];

        function showImportItems() {
            document.getElementById('importItemsPanel').style.display = 'block';
            document.getElementById('importDonationsPanel').style.display = 'none';
        }

        function handleItemsCsvSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processItemsCsvFile(file);
            }
        }

        function processItemsCsvFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseItemsCsv(csvText);
            };
            reader.readAsText(file);
        }

        function parseItemsCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            itemsImportData = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = [];
                let current = '';
                let inQuotes = false;

                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                const item = {};
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });

                itemsImportData.push(item);
            }

            // Show preview
            const preview = document.getElementById('itemsImportPreview');
            const table = document.getElementById('itemsPreviewTable');

            let html = '<table class="table"><thead><tr><th>Category</th><th>Name</th><th>Good</th><th>Very Good</th><th>Excellent</th></tr></thead><tbody>';

            itemsImportData.slice(0, 10).forEach(item => {
                const categoryNames = {
                    '1': 'Women\'s', '2': 'Men\'s', '3': 'Children\'s',
                    '4': 'Household', '5': 'Electronics', '6': 'Furniture',
                    '7': 'Books', '8': 'Sports', '9': 'Toys',
                    '10': 'Appliances', '11': 'Jewelry', '12': 'Tools'
                };
                html += `<tr>
                    <td>${categoryNames[item.category_id] || item.category_id}</td>
                    <td>${item.name}</td>
                    <td>$${parseFloat(item.value_good || 0).toFixed(2)}</td>
                    <td>$${parseFloat(item.value_very_good || 0).toFixed(2)}</td>
                    <td>$${parseFloat(item.value_excellent || 0).toFixed(2)}</td>
                </tr>`;
            });

            if (itemsImportData.length > 10) {
                html += `<tr><td colspan="5" style="text-align: center; font-style: italic;">... and ${itemsImportData.length - 10} more items</td></tr>`;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
            preview.style.display = 'block';
        }

        async function confirmItemsImport() {
            const updateExisting = document.getElementById('updateExistingItems').checked;
            const resultsDiv = document.getElementById('itemsImportResults');
            const resultsContent = document.getElementById('itemsResultsContent');

            resultsContent.innerHTML = '<p>Importing items...</p>';
            resultsDiv.style.display = 'block';

            try {
                const response = await fetch('/api/items/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        csvData: [Object.keys(itemsImportData[0]).join(',')]
                            .concat(itemsImportData.map(row =>
                                Object.keys(itemsImportData[0]).map(k => row[k]).join(',')
                            )).join('\n'),
                        updateExisting: updateExisting
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultsContent.innerHTML = `
                        <div style="color: #10b981; margin-bottom: 1rem;">
                            <strong>‚úÖ Import Successful!</strong>
                        </div>
                        <div>
                            <p>Processed: ${data.results.processed} items</p>
                            <p>Added: ${data.results.added} new items</p>
                            <p>Updated: ${data.results.updated} existing items</p>
                            <p>Failed: ${data.results.failed} items</p>
                        </div>
                        ${data.results.errors.length > 0 ? `
                            <div style="margin-top: 1rem; color: #ef4444;">
                                <strong>Errors:</strong>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    ${data.results.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `;

                    // Reload item categories if we're on the donation form
                    loadItemCategories();
                } else {
                    resultsContent.innerHTML = `
                        <div style="color: #ef4444;">
                            <strong>‚ùå Import Failed</strong>
                            <p style="margin-top: 0.5rem;">${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsContent.innerHTML = `
                    <div style="color: #ef4444;">
                        <strong>‚ùå Import Error</strong>
                        <p style="margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }

            document.getElementById('itemsImportPreview').style.display = 'none';
        }

        function cancelItemsImport() {
            document.getElementById('itemsImportPreview').style.display = 'none';
            document.getElementById('itemsCsvFileInput').value = '';
            itemsImportData = [];
        }

        function closeItemsImport() {
            document.getElementById('importItemsPanel').style.display = 'none';
            document.getElementById('itemsImportResults').style.display = 'none';
            document.getElementById('itemsCsvFileInput').value = '';
            itemsImportData = [];
        }

        // Setup drag and drop for items CSV
        document.addEventListener('DOMContentLoaded', function() {
            const itemsDropZone = document.getElementById('itemsCsvDropZone');
            if (itemsDropZone) {
                itemsDropZone.addEventListener('click', () => {
                    document.getElementById('itemsCsvFileInput').click();
                });

                itemsDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    itemsDropZone.style.borderColor = '#059669';
                    itemsDropZone.style.background = '#d1fae5';
                });

                itemsDropZone.addEventListener('dragleave', () => {
                    itemsDropZone.style.borderColor = '#10b981';
                    itemsDropZone.style.background = '#f0fdf4';
                });

                itemsDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    itemsDropZone.style.borderColor = '#10b981';
                    itemsDropZone.style.background = '#f0fdf4';

                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].name.endsWith('.csv')) {
                        processItemsCsvFile(files[0]);
                    }
                });
            }
        });

        // Calculate stock donation total
        function calculateStockTotal() {
            const shares = parseFloat(document.getElementById('stockQuantity').value) || 0;
            const pricePerShare = parseFloat(document.getElementById('fairMarketValue').value) || 0;
            const total = shares * pricePerShare;

            document.getElementById('stockTotalDisplay').textContent = '$' + total.toFixed(2);
            document.getElementById('stockCalculation').textContent =
                `${shares} shares √ó $${pricePerShare.toFixed(2)} = $${total.toFixed(2)}`;
        }

        // Calculate crypto donation total
        function calculateCryptoTotal() {
            const quantity = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
            const pricePerUnit = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
            const total = quantity * pricePerUnit;
            const costBasis = parseFloat(document.getElementById('cryptoCostBasis').value) || 0;
            const holdingPeriod = document.getElementById('cryptoHoldingPeriod').value;

            document.getElementById('cryptoTotalDisplay').textContent = '$' + total.toFixed(2);
            document.getElementById('cryptoCalculation').textContent =
                `${quantity} units √ó $${pricePerUnit.toFixed(2)} = $${total.toFixed(2)}`;

            // Update tax savings display
            updateTaxSavings();

            // Calculate tax deduction based on holding period
            let deduction = total;
            let note = '';
            if (holdingPeriod === 'short' && costBasis > 0) {
                deduction = Math.min(costBasis, total);
                note = deduction === costBasis ? ' (limited to cost basis)' : ' (at fair market value)';
            }

            document.getElementById('cryptoDeductionAmount').textContent = '$' + deduction.toFixed(2) + note;
        }

        // Calculate mileage deduction
        function calculateMileageDeduction() {
            const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
            const rate = 0.14; // 2024 IRS rate
            const deduction = miles * rate;
            document.getElementById('mileageDeduction').textContent = deduction.toFixed(2);
        }

        // Function to populate year dropdowns dynamically
        function populateYearSelectors() {
            const currentYear = new Date().getFullYear();
            const years = [
                { value: currentYear - 1, label: (currentYear - 1).toString() },
                { value: currentYear, label: currentYear.toString() },
                { value: currentYear + 1, label: (currentYear + 1).toString() },
                { value: 'all', label: 'All Years' }
            ];

            // Populate global year filter
            const globalFilter = document.getElementById('globalYearFilter');
            if (globalFilter) {
                globalFilter.innerHTML = years.map(year =>
                    `<option value="${year.value}" ${year.value === currentYear ? 'selected' : ''}>${year.label}</option>`
                ).join('');
            }

            // Populate report year filter
            const reportFilter = document.getElementById('reportYear');
            if (reportFilter) {
                reportFilter.innerHTML = years.map(year =>
                    `<option value="${year.value}" ${year.value === currentYear ? 'selected' : ''}>${year.label}</option>`
                ).join('');
            }
        }

        // Common cryptocurrencies list
        const cryptoList = [
            { name: 'Bitcoin', symbol: 'BTC' },
            { name: 'Ethereum', symbol: 'ETH' },
            { name: 'Tether', symbol: 'USDT' },
            { name: 'BNB', symbol: 'BNB' },
            { name: 'Solana', symbol: 'SOL' },
            { name: 'XRP', symbol: 'XRP' },
            { name: 'USDC', symbol: 'USDC' },
            { name: 'Cardano', symbol: 'ADA' },
            { name: 'Avalanche', symbol: 'AVAX' },
            { name: 'Dogecoin', symbol: 'DOGE' },
            { name: 'TRON', symbol: 'TRX' },
            { name: 'Chainlink', symbol: 'LINK' },
            { name: 'Polygon', symbol: 'MATIC' },
            { name: 'Polkadot', symbol: 'DOT' },
            { name: 'Wrapped Bitcoin', symbol: 'WBTC' },
            { name: 'Shiba Inu', symbol: 'SHIB' },
            { name: 'Dai', symbol: 'DAI' },
            { name: 'Litecoin', symbol: 'LTC' },
            { name: 'Bitcoin Cash', symbol: 'BCH' },
            { name: 'Uniswap', symbol: 'UNI' },
            { name: 'Stellar', symbol: 'XLM' },
            { name: 'Cosmos', symbol: 'ATOM' },
            { name: 'Ethereum Classic', symbol: 'ETC' },
            { name: 'Monero', symbol: 'XMR' },
            { name: 'Internet Computer', symbol: 'ICP' },
            { name: 'Aptos', symbol: 'APT' },
            { name: 'Filecoin', symbol: 'FIL' },
            { name: 'Hedera', symbol: 'HBAR' },
            { name: 'Arbitrum', symbol: 'ARB' },
            { name: 'VeChain', symbol: 'VET' },
            { name: 'Near Protocol', symbol: 'NEAR' },
            { name: 'Optimism', symbol: 'OP' },
            { name: 'Aave', symbol: 'AAVE' },
            { name: 'Algorand', symbol: 'ALGO' },
            { name: 'The Graph', symbol: 'GRT' },
            { name: 'Fantom', symbol: 'FTM' },
            { name: 'Decentraland', symbol: 'MANA' },
            { name: 'Axie Infinity', symbol: 'AXS' },
            { name: 'The Sandbox', symbol: 'SAND' },
            { name: 'Theta', symbol: 'THETA' },
            { name: 'Tezos', symbol: 'XTZ' },
            { name: 'Flow', symbol: 'FLOW' },
            { name: 'Zcash', symbol: 'ZEC' },
            { name: 'Enjin Coin', symbol: 'ENJ' },
            { name: 'Maker', symbol: 'MKR' },
            { name: 'Compound', symbol: 'COMP' },
            { name: 'Curve', symbol: 'CRV' },
            { name: 'Pancakeswap', symbol: 'CAKE' },
            { name: 'Yearn Finance', symbol: 'YFI' },
            { name: 'Basic Attention Token', symbol: 'BAT' }
        ];

        // Function to search cryptocurrencies
        function searchCrypto(query) {
            const dropdown = document.getElementById('cryptoDropdown');
            if (!query) {
                dropdown.style.display = 'none';
                return;
            }

            const filtered = cryptoList.filter(crypto =>
                crypto.name.toLowerCase().includes(query.toLowerCase()) ||
                crypto.symbol.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding:0.5rem;color:#6b7280;">No cryptocurrencies found</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = filtered.map(crypto => `
                <div style="padding:0.5rem;cursor:pointer;hover:background:#f3f4f6;"
                     onmouseover="this.style.background='#f3f4f6'"
                     onmouseout="this.style.background='white'"
                     onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                    <strong>${crypto.name}</strong> (${crypto.symbol})
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        // Function to show all cryptos when field is focused
        function showCryptoDropdown() {
            const query = document.getElementById('cryptoName').value;
            if (!query) {
                // Show top cryptos if no query
                const dropdown = document.getElementById('cryptoDropdown');
                const topCryptos = cryptoList.slice(0, 10);
                dropdown.innerHTML = topCryptos.map(crypto => `
                    <div style="padding:0.5rem;cursor:pointer;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='white'"
                         onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                        <strong>${crypto.name}</strong> (${crypto.symbol})
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            } else {
                searchCrypto(query);
            }
        }

        // Function to select a cryptocurrency
        function selectCrypto(name, symbol) {
            document.getElementById('cryptoName').value = name;
            document.getElementById('cryptoSymbol').value = symbol;
            document.getElementById('cryptoDropdown').style.display = 'none';
            // Focus on next field
            document.getElementById('cryptoDonationTime').focus();
        }

        // Hide crypto dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#cryptoName') && !e.target.closest('#cryptoDropdown')) {
                const dropdown = document.getElementById('cryptoDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });

        // Initialize everything when DOM is ready
        function initializeApp() {
            // Populate year selectors first
            populateYearSelectors();

            // Load data
            loadTaxSettings();
            loadProfile(); // Load user profile
            loadCharities();
            loadDonations();
            loadStats();
            loadItemCategories(); // Load item categories for donation form

            // Categories are now handled by a select dropdown, no search listeners needed

            // Setup event listeners for item search
            const itemSearchInput = document.getElementById('itemSearch');
            if (itemSearchInput) {
                itemSearchInput.addEventListener('input', function() {
                    searchItems();
                });
                itemSearchInput.addEventListener('focus', function() {
                    searchItems();
                });
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Close modals and dropdowns when clicking outside
        window.onclick = function(event) {
            // Close modals
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }

            // Close category dropdown
            if (!event.target.closest('#itemCategorySearch') && !event.target.closest('#categoryDropdown')) {
                const dropdown = document.getElementById('categoryDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Close item dropdown
            if (!event.target.closest('#itemSearch') && !event.target.closest('#itemDropdown')) {
                const dropdown = document.getElementById('itemDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Close charity search dropdown
            if (!event.target.closest('#charitySearch') && !event.target.closest('#charityDropdown')) {
                const dropdown = document.getElementById('charityDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');

            // Style based on type
            const styles = {
                success: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;',
                error: 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;',
                info: 'background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;'
            };

            toast.style.cssText = `
                ${styles[type]}
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease-out;
                min-width: 250px;
            `;

            toast.innerHTML = message;

            toastContainer.appendChild(toast);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
    </main>
</body>
</html>