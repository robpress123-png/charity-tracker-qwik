<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Charity Tracker v2.0.6</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            height: 100vh;
            background: #f3f4f6;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header-top {
            padding: 0.3rem 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .version {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation menu */
        .nav-menu {
            background: rgba(0,0,0,0.1);
            padding: 0 1rem;
        }

        .nav-menu-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
        }

        .nav-item {
            color: white;
            padding: 0.6rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background 0.2s;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: white;
        }

        .main-content {
            flex: 1;
            overflow: hidden;
            padding: 0.5rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .section h2 {
            color: #333;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            background: white;
        }

        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .btn-action {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            margin: 0 0.125rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            font-size: 0.875rem;
        }

        .btn-action:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }

        .btn-danger {
            background: #fee2e2;
            border-color: #fecaca;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Date input specific styling */
        input[type="date"] {
            max-width: 200px;
        }

        /* Autocomplete styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 100;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #f3f4f6;
        }

        .autocomplete-item-name {
            font-weight: 500;
            color: #111827;
        }

        .autocomplete-item-ein {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .autocomplete-item-category {
            display: inline-block;
            font-size: 0.75rem;
            color: #667eea;
            margin-left: 0.5rem;
        }

        .autocomplete-add-new {
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            cursor: pointer;
            font-weight: 500;
            color: #667eea;
        }

        .autocomplete-add-new:hover {
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        .autocomplete-loading {
            padding: 0.75rem;
            text-align: center;
            color: #6b7280;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .charity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .charity-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s;
        }

        .charity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .charity-card h3 {
            color: #111827;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
        }

        .charity-ein {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0.25rem 0;
        }

        .charity-category {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 0.5rem 0;
        }

        /* Responsive improvements */
        @media (min-width: 1400px) {
            .container {
                max-width: 1800px;
            }
            .header-content,
            .nav-menu-content {
                max-width: 1800px;
            }
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .stat-card {
                padding: 0.75rem;
            }
            .stat-value {
                font-size: 1.25rem;
            }
        }

        .charity-description {
            color: #4b5563;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .charity-count {
            text-align: center;
            color: #6b7280;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        /* Enhanced charity card styles */
        .charity-card.enhanced {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .charity-card.enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .charity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .charity-name {
            margin: 0 !important;
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: #1e293b !important;
            line-height: 1.3 !important;
            flex: 1;
            margin-right: 1rem !important;
        }

        .charity-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid currentColor;
            white-space: nowrap;
        }

        .charity-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
        }

        .charity-card.enhanced .charity-ein,
        .charity-card.enhanced .charity-category {
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }

        .charity-card.enhanced .charity-ein strong,
        .charity-card.enhanced .charity-category strong {
            color: #475569;
        }

        .charity-card.enhanced .charity-description {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0.75rem 0;
        }

        /* Enhanced Tools Section Styles */
        .tool-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tool-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .tool-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
            font-size: 2rem;
            color: white;
            margin-bottom: 0;
        }

        .tool-content {
            padding: 1.5rem;
        }

        .tool-title {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 0.75rem 0;
            line-height: 1.3;
        }

        .tool-description {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.6;
            margin: 0 0 1rem 0;
        }

        .tool-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feature-tag {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #475569;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
        }

        .tools-grid {
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }

            .tool-content {
                padding: 1rem;
            }

            .tool-icon {
                height: 60px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Version Announcement Banner -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.75rem; text-align: center; font-size: 0.875rem; border-bottom: 2px solid rgba(255,255,255,0.3);">
        <strong>🎯 Charity Tracker v2.0.6</strong> - Proper relational items tracking with donation_items table!
    </div>
    <header class="header">
        <div class="header-top">
            <div class="header-content">
                <div>
                    <h1>🎯 Charity Tracker <span class="version">v2.0.6</span></h1>
                </div>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-menu-content">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    📊 Dashboard
                </button>
                <button class="nav-item" onclick="showSection('donations')">
                    ➕ Add Donation
                </button>
                <button class="nav-item" onclick="showSection('reports')">
                    📈 Reports
                </button>
                <button class="nav-item" onclick="showSection('profile')">
                    👤 Profile
                </button>
                <button class="nav-item" onclick="showSection('tools')">
                    🔧 Tools
                </button>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; padding-right: 1rem;">
                    <label style="color: white; font-size: 0.9rem; font-weight: 500;">Tax Year:</label>
                    <select id="globalYearFilter" onchange="updateYearFilter()" style="padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem; cursor: pointer;">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; gap: 0.5rem;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div>
                        <div class="stat-label" id="totalDonationsLabel">Total Donations</div>
                        <div class="stat-value" id="totalDonations">$0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Charities Supported</div>
                        <div class="stat-value" id="charityCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label" id="taxSavingsLabel">Est. Tax Savings</div>
                        <div class="stat-value" id="taxSavings">$0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="stat-label">Donation Count</div>
                        <div class="stat-value" id="donationCount">0</div>
                    </div>
                </div>
            </div>

            <div class="section" style="flex: 1; display: flex; flex-direction: column; min-height: 0; max-height: calc(60vh - 120px);">
                <div class="section-header" style="flex-shrink: 0;">
                    <h2 id="donationHistoryTitle">Donation History</h2>
                </div>
                <!-- Search/Filter Bar -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                    <input type="text" id="donationSearch" placeholder="Search by charity or notes..."
                           style="flex: 1; padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;"
                           oninput="filterDonations()">
                    <select id="donationTypeFilter" onchange="filterDonations()"
                            style="padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;">
                        <option value="all">All Types</option>
                        <option value="cash">Cash</option>
                        <option value="items">Items</option>
                        <option value="miles">Mileage</option>
                        <option value="stock">Stock</option>
                        <option value="crypto">Crypto</option>
                    </select>
                    <input type="month" id="donationMonthFilter" onchange="filterDonations()"
                           style="padding: 0.4rem; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem;">
                </div>
                <div id="donationsContent" style="overflow-y: auto; flex: 1; min-height: 0;">
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <p>No donations yet. Add your first donation to get started!</p>
                    </div>
                </div>
            </div>

            <div class="section" style="display: flex; flex-direction: column; min-height: 0; max-height: calc(40vh - 80px);">
                <div class="section-header" style="flex-shrink: 0;">
                    <h2>My Charities</h2>
                </div>
                <div id="charitiesContent" style="overflow-y: auto; flex: 1; min-height: 0;">
                    <div class="empty-state">
                        <div class="empty-state-icon">🏛️</div>
                        <p>Loading your charities...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Donation Section (hidden by default) -->
        <div id="addDonationSection" class="section-content" style="display:none;">
            <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem;">
                <!-- Left: Donation Type Selection -->
                <div class="section">
                    <div class="section-header">
                        <h2>➕ Add New Donation</h2>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p style="margin-bottom: 1.5rem;">Select the type of donation:</p>
                        <div style="display: grid; gap: 1rem;">
                            <button class="btn-primary" onclick="openDonationModal('cash')">
                                💵 Cash Donation
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('items')">
                                📦 Donated Items
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('miles')">
                                🚗 Mileage
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('stock')">
                                📈 Stock/Securities
                            </button>
                            <button class="btn-primary" onclick="openDonationModal('crypto')">
                                ₿ Cryptocurrency
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right: My Charities Quick Select -->
                <div class="section">
                    <div class="section-header">
                        <h2>⚡ Quick Add from My Charities</h2>
                    </div>
                    <div id="myCharitiesQuickAdd" style="padding: 1rem; max-height: 400px; overflow-y: auto;">
                        <p style="text-align: center; color: #6b7280;">Loading your charities...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section (hidden by default) -->
        <div id="reportsSection" class="section-content" style="display:none;">
            <div class="section">
            <div class="section-header">
                <h2>📈 Tax Reports & Export</h2>
            </div>
            <div style="display: grid; gap: 1rem;">
                <div class="form-group">
                    <label>Report Tax Year</label>
                    <select id="reportYear" style="width: 200px;">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="exportCSV()">
                        📄 Download CSV
                    </button>
                    <button class="btn-primary" onclick="exportPDF()">
                        📑 Download PDF Report
                    </button>
                    <button class="btn-primary" onclick="viewSummary()">
                        👁️ View Summary
                    </button>
                </div>
                <div id="reportSummary" style="margin-top: 2rem;"></div>
                </div>
            </div>
        </div>

        <!-- Profile Section (hidden by default) -->
        <div id="profileSection" class="section-content" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <h2>👤 Profile Settings</h2>
                </div>
                <div style="padding: 1rem;">
                    <!-- Personal Information Section -->
                    <h3 style="color: #667eea; margin-bottom: 1rem; font-size: 1.1rem;">📝 Personal Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="profileName" placeholder="Enter your full name" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="profileEmail" placeholder="your@email.com" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Street Address</label>
                            <input type="text" id="profileAddress" placeholder="123 Main Street" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="profileCity" placeholder="Your City" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <select id="profileState" style="width: 100%;">
                                <option value="">Select State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ZIP Code</label>
                            <input type="text" id="profileZip" placeholder="12345" maxlength="10" style="width: 100%;">
                        </div>
                    </div>

                    <!-- Tax Information Section -->
                    <h3 style="color: #667eea; margin-bottom: 1rem; margin-top: 2rem; font-size: 1.1rem;">💰 Tax Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Filing Status</label>
                        <select id="filingStatus" style="width: 100%;" onchange="updateTaxRate()">
                            <option value="single">Single</option>
                            <option value="married_jointly">Married Filing Jointly</option>
                            <option value="married_separately">Married Filing Separately</option>
                            <option value="head_of_household">Head of Household</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Annual Income</label>
                        <select id="incomeBracket" style="width: 100%;" onchange="updateTaxRate()">
                            <option value="22000">Up to $22,000</option>
                            <option value="50000">$22,001 - $50,000</option>
                            <option value="89075">$50,001 - $89,075</option>
                            <option value="100000">$89,076 - $100,000</option>
                            <option value="190750">$100,001 - $190,750</option>
                            <option value="200000">$190,751 - $200,000</option>
                            <option value="364200">$200,001 - $364,200</option>
                            <option value="500000">$364,201 - $500,000</option>
                            <option value="600000">$500,001+</option>
                        </select>
                    </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
                        <h3 style="margin-bottom: 0.5rem;">Your Tax Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Federal Marginal Tax Rate</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="marginalTaxRate">22%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Est. Tax Savings per $100</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="savingsPerHundred">$22</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 0.875rem; opacity: 0.9;">Standard Deduction (2024)</div>
                            <div style="font-size: 1.25rem; font-weight: 600;" id="standardDeduction">$14,600</div>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveProfile()">
                        Save Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Tools Section (hidden by default) -->
        <div id="toolsSection" class="section-content" style="display:none; max-width: 100%; overflow-x: hidden;">
            <div class="section" style="max-width: 1200px; margin: 0 auto;">
                <div class="section-header">
                    <h2>🛠️ Tools & Utilities</h2>
                </div>
                <div style="padding: 2rem;">
                    <!-- Tools Introduction -->
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #cbd5e1;">
                        <h3 style="color: #334155; margin: 0 0 0.5rem 0; font-size: 1.1rem;">Powerful Tools to Manage Your Charitable Giving</h3>
                        <p style="color: #64748b; margin: 0; font-size: 0.875rem; line-height: 1.5;">Streamline your donation tracking with our comprehensive suite of tools designed to make charitable giving easier and more organized.</p>
                    </div>

                    <!-- Tools Grid -->
                    <div class="tools-grid" style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">

                        <!-- Import Donations Tool -->
                        <div class="tool-card" onclick="showImportDonations()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                📥
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Import Donations</h4>
                                <p class="tool-description">Upload CSV files to bulk import your donation records. Automatically matches charity names to our database.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">CSV Upload</span>
                                    <span class="feature-tag">Auto-matching</span>
                                    <span class="feature-tag">Bulk Import</span>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Charity Management Tool -->
                        <div class="tool-card" onclick="showPersonalCharities()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                🏛️
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Personal Charities</h4>
                                <p class="tool-description">Manage your personal charity list. Add, edit, and track charities not in our database.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Add Custom</span>
                                    <span class="feature-tag">Edit Details</span>
                                    <span class="feature-tag">Track Status</span>
                                </div>
                            </div>
                        </div>

                        <!-- Verify Charity Tool -->
                        <div class="tool-card" onclick="showCharityVerification()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                🔍
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Verify Charity</h4>
                                <p class="tool-description">Check if a charity is IRS-approved and eligible for tax-deductible donations.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">IRS Database</span>
                                    <span class="feature-tag">EIN Lookup</span>
                                    <span class="feature-tag">Instant Verify</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tax Calculator Tool -->
                        <div class="tool-card" onclick="calculateTaxSavings()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                💰
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Tax Savings Calculator</h4>
                                <p class="tool-description">Calculate potential tax deductions and savings from your charitable donations based on your tax bracket.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Tax Deductions</span>
                                    <span class="feature-tag">Savings Analysis</span>
                                    <span class="feature-tag">Bracket Aware</span>
                                </div>
                            </div>
                        </div>

                        <!-- Receipt Manager Tool -->
                        <div class="tool-card" onclick="manageReceipts()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                📸
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Receipt Manager</h4>
                                <p class="tool-description">Upload, organize, and manage receipt photos for your donations. Keep digital records for tax purposes.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Photo Upload</span>
                                    <span class="feature-tag">Organization</span>
                                    <span class="feature-tag">Tax Records</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data Export Tool -->
                        <div class="tool-card" onclick="backupData()">
                            <div class="tool-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                💾
                            </div>
                            <div class="tool-content">
                                <h4 class="tool-title">Data Export & Backup</h4>
                                <p class="tool-description">Export all your donation data for backup or use in external applications. Multiple formats supported.</p>
                                <div class="tool-features">
                                    <span class="feature-tag">Full Export</span>
                                    <span class="feature-tag">Backup Ready</span>
                                    <span class="feature-tag">Multiple Formats</span>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Personal Charities Panel -->
                    <div id="personalCharitiesPanel" style="display:none; margin-top: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">🏛️ Manage Personal Charities</h3>
                        <div style="margin-bottom: 1.5rem;">
                            <button class="btn-primary" onclick="showAddPersonalCharity()">+ Add Personal Charity</button>
                        </div>
                        <div id="personalCharitiesList"></div>
                    </div>

                    <!-- Charity Verification Panel -->
                    <div id="charityVerificationPanel" style="display:none; margin-top: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">🔍 Verify Charity Status</h3>
                        <div class="form-group">
                            <label>Enter Charity Name or EIN</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="verifyCharityInput" placeholder="e.g., Red Cross or 53-0196605" style="flex: 1;">
                                <button class="btn-primary" onclick="performCharityVerification()">Verify</button>
                            </div>
                        </div>
                        <div id="verificationResults" style="margin-top: 1.5rem;"></div>
                    </div>

                    <!-- Import Donations Panel -->
                    <div id="importDonationsPanel" style="display:none; margin-top: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">Import Donations from CSV</h3>

                        <div id="csvDropZone" style="border: 2px dashed #667eea; border-radius: 12px; padding: 3rem; text-align: center; background: #f9fafb; cursor: pointer;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                            <p style="font-size: 1.1rem; color: #4b5563; margin-bottom: 0.5rem;">Drag & Drop CSV File Here</p>
                            <p style="color: #9ca3af;">or click to browse</p>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        </div>

                        <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <p style="font-size: 0.875rem; color: #92400e;"><strong>CSV Format:</strong></p>
                            <code style="font-size: 0.75rem;">charity_name,donation_date,donation_type,amount,notes</code>
                            <p style="font-size: 0.75rem; color: #92400e; margin-top: 0.5rem;">
                                Example: American Red Cross,2025-01-15,cash,500.00,New Year donation
                            </p>
                            <p style="font-size: 0.75rem; color: #10b981; margin-top: 0.5rem;">
                                ✅ Charity names are automatically matched to the database!
                            </p>
                        </div>

                        <div id="importPreview" style="display:none; margin-top: 1rem;">
                            <h4>Preview</h4>
                            <div id="previewTable" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;"></div>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                <button class="btn-primary" onclick="confirmImport()">
                                    ✅ Import Donations
                                </button>
                                <button class="btn-secondary" onclick="cancelImport()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Add Donation Modal -->
    <div id="donationModal" class="modal">
        <div class="modal-content" style="max-width: 1400px; width: 95%;">
            <div class="modal-header">
                <h2 id="donationModalTitle">Add Cash Donation</h2>
            </div>
            <div>
                    <form id="donationForm">
                <input type="hidden" id="donationType" value="cash">
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0284c7; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="donationTypeIcon" style="font-size: 2rem;">💵</span>
                        <div>
                            <div style="font-weight: 600; color: #075985; font-size: 1.1rem;" id="donationTypeLabel">Cash/Check Donation</div>
                            <div style="font-size: 0.875rem; color: #0369a1; margin-top: 0.25rem;" id="donationTypeDesc">Record a monetary donation</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="donationCharity">Charity *</label>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                        <div class="autocomplete-wrapper" style="flex: 1;">
                            <input type="text"
                                   id="donationCharity"
                                   class="autocomplete-input"
                                   placeholder="Start typing to search charities..."
                                   required
                                   autocomplete="off">
                            <input type="hidden" id="selectedCharityId">
                            <div id="charityDropdown" class="autocomplete-dropdown"></div>
                        </div>
                        <button type="button"
                                onclick="verifyCharity()"
                                class="btn btn-secondary"
                                style="padding: 0.5rem 1rem; white-space: nowrap;"
                                title="Verify if this charity is IRS-approved">
                            🔍 Verify
                        </button>
                    </div>
                    <div id="charityVerificationResult" style="margin-top: 0.5rem; display: none;"></div>
                </div>
                <!-- Cash donation fields -->
                <div id="cashFields" class="donation-type-fields">
                    <div class="form-group">
                        <label for="donationAmount">Amount</label>
                        <input type="number" id="donationAmount" step="0.01" min="0" required>
                    </div>
                </div>
                <!-- Item donation fields -->
                <div id="itemsFields" class="donation-type-fields" style="display:none;">
                    <!-- IRS Compliance Warning -->
                    <div class="alert" style="background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-size:0.875rem;">
                        <strong>⚠️ IRS:</strong> Only "good condition or better" items qualify for tax deductions
                    </div>

                    <!-- Two column layout: Entry on left, Receipt on right -->
                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.5rem;">
                        <!-- Left Column: Item Entry -->
                        <div>
                            <!-- Horizontal layout for category, item, quality selection -->
                            <div style="display: grid; grid-template-columns: 1.8fr 2.2fr 1.2fr 0.6fr auto; gap: 0.75rem; align-items: end; margin-bottom: 1rem;">
                        <!-- Category Dropdown -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Category</label>
                            <select id="itemCategory" onchange="categoryChanged()" style="font-size:0.875rem;width:100%;padding:0.375rem;">
                                <option value="">Select category...</option>
                            </select>
                        </div>

                        <!-- Item Search -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Item</label>
                            <div style="position:relative;">
                                <input type="text"
                                       id="itemSearch"
                                       placeholder="Search items (select category first)"
                                       oninput="searchItems(this.value)"
                                       onfocus="showItemDropdown()"
                                       disabled
                                       style="font-size:0.875rem;width:100%;padding:0.375rem;">
                                <input type="hidden" id="itemSelect">
                                <!-- Item Dropdown -->
                                <div id="itemDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Quality -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Condition</label>
                            <select id="itemQuality" onchange="updateItemValue()" style="font-size:0.875rem;width:100%;padding:0.375rem;" disabled>
                                <option value="fair">Fair (Not IRS Deductible)</option>
                                <option value="good">Good</option>
                                <option value="very_good" selected>Very Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div>
                            <label style="font-size:0.75rem;font-weight:600;color:#374151;">Qty</label>
                            <input type="number" id="itemQuantity" value="1" min="1" onchange="updateItemValue()" style="font-size:0.875rem;width:100%;padding:0.375rem;" disabled>
                        </div>

                        <!-- Add Button -->
                        <div>
                            <button type="button" id="addItemBtn" onclick="addItemToList()" disabled style="padding:0.5rem 1rem;background:#9ca3af;color:white;border:none;border-radius:6px;cursor:not-allowed;font-size:0.875rem;font-weight:600;white-space:nowrap;">
                                + Add Item
                            </button>
                        </div>
                            </div>

                            <!-- Value Preview (shown when item selected) -->
                            <div id="itemValueDisplay" style="display:none;background:#f0f9ff;padding:0.5rem;border-radius:6px;border:1px solid #bae6fd;margin-bottom:1rem;">
                                <span id="selectedItemName" style="font-weight:600;color:#075985;"></span>
                                <span style="margin-left:1rem;color:#0369a1;">Value: <strong id="itemValuePreview">$0.00</strong></span>
                            </div>
                        </div>

                        <!-- Right Column: Receipt Display -->
                        <div>
                            <div style="background:white; border:2px solid #e5e7eb; border-radius:8px; padding:1rem; min-height:300px;">
                                <div style="border-bottom:2px dashed #d1d5db; padding-bottom:0.5rem; margin-bottom:0.75rem;">
                                    <h4 style="font-size:1rem;font-weight:700;color:#374151;text-align:center;margin:0;">📋 DONATION RECEIPT</h4>
                                    <p style="font-size:0.75rem;color:#6b7280;text-align:center;margin-top:0.25rem;">Items for Tax Deduction</p>
                                </div>
                                <div id="selectedItemsList" style="min-height:180px; max-height:250px; overflow-y:auto;font-size:0.875rem;">
                                    <div class="empty-state" style="color:#9ca3af; text-align:center; padding:2rem; font-size:0.875rem;">
                                        No items added yet
                                    </div>
                                </div>
                                <div style="border-top:2px solid #374151; margin-top:0.75rem; padding-top:0.75rem; display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="font-size:1rem;">Total Value:</strong>
                                    <span style="font-size:1.5rem; font-weight:bold; color:#667eea;">$<span id="receiptTotal">0.00</span></span>
                                </div>
                                <!-- Save button appears when items are added -->
                                <div id="saveItemsDonationBtn" style="display:none; margin-top:1rem;">
                                    <button type="submit" style="width:100%; padding:0.75rem; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;">
                                        💾 Save Donation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="estimatedValue">
                    <input type="hidden" id="itemDescription">
                </div>
                <!-- Mileage donation fields -->
                <div id="milesFields" class="donation-type-fields" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="milesDriven">Miles Driven</label>
                            <input type="number" id="milesDriven" step="0.1" min="0" onchange="calculateMileageDeduction()" oninput="calculateMileageDeduction()">
                        </div>
                        <div class="form-group">
                            <label for="mileagePurpose">Purpose</label>
                            <input type="text" id="mileagePurpose" placeholder="e.g., Deliver meals">
                        </div>
                    </div>
                    <div style="background:#f3f4f6; padding:0.5rem; border-radius:8px; margin-top:0.5rem;">
                        <small>2024 IRS Rate: $0.14/mile | Deduction: $<span id="mileageDeduction">0.00</span></small>
                    </div>
                </div>
                <!-- Stock donation fields -->
                <div id="stockFields" class="donation-type-fields" style="display:none;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="stockName">Stock Name</label>
                            <input type="text" id="stockName" placeholder="e.g., Apple Inc." required>
                        </div>
                        <div class="form-group">
                            <label for="stockSymbol">Stock Symbol</label>
                            <input type="text" id="stockSymbol" placeholder="e.g., AAPL" style="text-transform:uppercase;" required>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="stockQuantity">Number of Shares</label>
                            <input type="number" id="stockQuantity" step="0.001" min="0" onchange="calculateStockTotal()" oninput="calculateStockTotal()" required>
                        </div>
                        <div class="form-group">
                            <label for="fairMarketValue">Closing Price per Share</label>
                            <input type="number" id="fairMarketValue" step="0.01" min="0" placeholder="$ per share" onchange="calculateStockTotal()" oninput="calculateStockTotal()" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="costBasis">Cost Basis (optional)</label>
                        <input type="number" id="costBasis" step="0.01" min="0" placeholder="Total cost basis">
                        <small style="color:#6b7280;">Automatic price lookup coming soon</small>
                    </div>
                    <div style="background:#f0f9ff; padding:0.75rem; border-radius:6px; margin-top:1rem; border:1px solid #bae6fd;">
                        <div style="font-size:0.875rem; color:#0369a1; font-weight:600;">Total Stock Donation:</div>
                        <div id="stockTotalDisplay" style="font-size:1.5rem; font-weight:bold; color:#075985;">$0.00</div>
                        <div style="font-size:0.75rem; color:#0c4a6e; margin-top:0.25rem;">
                            <span id="stockCalculation">0 shares × $0.00 = $0.00</span>
                        </div>
                    </div>
                </div>
                <!-- Crypto donation fields -->
                <div id="cryptoFields" class="donation-type-fields" style="display:none;">
                    <!-- IRS Notice -->
                    <div class="alert" style="background:#e0f2fe;border:1px solid #0284c7;color:#075985;padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-size:0.875rem;">
                        <strong>📊 IRS Rule:</strong> Use fair market value at exact time of donation. For crypto held >1 year, deduct full FMV. For ≤1 year, deduct lesser of cost basis or FMV.
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group" style="position:relative;">
                            <label for="cryptoName">Cryptocurrency Name</label>
                            <input type="text" id="cryptoName" placeholder="Start typing to search..." required
                                   oninput="searchCrypto(this.value)" onfocus="showCryptoDropdown()" autocomplete="off">
                            <!-- Crypto Dropdown -->
                            <div id="cryptoDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #d1d5db;border-radius:6px;margin-top:2px;max-height:200px;overflow-y:auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:100;">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cryptoSymbol">Symbol/Ticker</label>
                            <input type="text" id="cryptoSymbol" placeholder="Auto-populated or enter manually" style="text-transform:uppercase;" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cryptoDonationTime">Exact Time (for price verification)</label>
                        <input type="time" id="cryptoDonationTime" step="1" required>
                        <small style="color:#6b7280;">Critical for IRS valuation - use with date field below</small>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="cryptoQuantity">Quantity</label>
                            <input type="number" id="cryptoQuantity" step="0.00000001" min="0" onchange="calculateCryptoTotal()" oninput="calculateCryptoTotal()" placeholder="Amount" required>
                        </div>
                        <div class="form-group">
                            <label for="cryptoPricePerUnit">Price per Unit (USD)</label>
                            <input type="number" id="cryptoPricePerUnit" step="0.01" min="0" onchange="calculateCryptoTotal()" oninput="calculateCryptoTotal()" placeholder="$ per coin/token at exact time" required>
                        </div>
                        <div class="form-group">
                            <label for="cryptoExchange">Exchange/Source</label>
                            <input type="text" id="cryptoExchange" placeholder="e.g., Coinbase, Binance" required>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label for="cryptoCostBasis">Cost Basis (optional)</label>
                            <input type="number" id="cryptoCostBasis" step="0.01" min="0" placeholder="Total purchase cost">
                            <small style="color:#6b7280;">Your original purchase price</small>
                        </div>
                        <div class="form-group">
                            <label for="cryptoHoldingPeriod">Holding Period</label>
                            <select id="cryptoHoldingPeriod">
                                <option value="long">Over 1 year (Long-term)</option>
                                <option value="short">1 year or less (Short-term)</option>
                            </select>
                            <small style="color:#6b7280;">Affects deduction calculation</small>
                        </div>
                    </div>

                    <!-- Total Display -->
                    <div style="background:#f0f9ff; padding:0.75rem; border-radius:6px; margin-top:1rem; border:1px solid #bae6fd;">
                        <div style="font-size:0.875rem; color:#0369a1; font-weight:600;">Total Crypto Donation Value:</div>
                        <div id="cryptoTotalDisplay" style="font-size:1.5rem; font-weight:bold; color:#075985;">$0.00</div>
                        <div style="font-size:0.75rem; color:#0c4a6e; margin-top:0.25rem;">
                            <span id="cryptoCalculation">0 units × $0.00 = $0.00</span>
                        </div>
                        <div id="cryptoDeductionNote" style="font-size:0.75rem; color:#0c4a6e; margin-top:0.5rem; padding-top:0.5rem; border-top:1px solid #bae6fd;">
                            <strong>Tax Deduction:</strong> <span id="cryptoDeductionAmount">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="donationDate">Date</label>
                    <input type="date" id="donationDate" required style="max-width: 180px;">
                </div>
                <div class="form-group">
                    <label for="donationNotes">Notes (optional)</label>
                    <textarea id="donationNotes" rows="3"></textarea>
                </div>
                <!-- Tax Savings Calculator -->
                <div style="background: #f0fdf4; border: 2px solid #86efac; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;">💰 Estimated Tax Savings</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Donation Amount</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="donationAmountDisplay">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #666;">Tax Savings (<span id="taxRateDisplay">22</span>%)</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #166534;" id="taxSavingsDisplay">$0</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #666;">
                        * Based on your marginal tax rate. Actual savings depend on itemizing deductions.
                    </div>
                </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" onclick="closeDonationModal()">Cancel</button>
                            <button type="submit" class="btn-primary" id="donationSubmitBtn">Add Donation</button>
                        </div>
                    </form>
            </div>
        </div>
    </div>

    <!-- Add Charity Modal -->
    <div id="charityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Charity</h2>
            </div>
            <form id="charityForm">
                <div class="form-group">
                    <label for="charityName">Charity Name</label>
                    <input type="text" id="charityName" required>
                </div>
                <div class="form-group">
                    <label for="charityEIN">EIN (optional)</label>
                    <input type="text" id="charityEIN">
                </div>
                <div class="form-group">
                    <label for="charityCategory">Category</label>
                    <select id="charityCategory">
                        <option value="">Select category...</option>
                        <option value="Arts & Culture">Arts & Culture</option>
                        <option value="Community">Community</option>
                        <option value="Education">Education</option>
                        <option value="Environment">Environment</option>
                        <option value="Health">Health</option>
                        <option value="Human Services">Human Services</option>
                        <option value="International">International</option>
                        <option value="Religion">Religion</option>
                        <option value="Research">Research</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="charityAddress">Street Address</label>
                    <input type="text" id="charityAddress" placeholder="123 Main St">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <label for="charityCity">City</label>
                        <input type="text" id="charityCity" placeholder="New York">
                    </div>
                    <div>
                        <label for="charityState">State</label>
                        <input type="text" id="charityState" placeholder="NY" maxlength="2">
                    </div>
                    <div>
                        <label for="charityZip">ZIP Code</label>
                        <input type="text" id="charityZip" placeholder="10001" pattern="[0-9]{5}(-[0-9]{4})?">
                    </div>
                </div>
                <div class="form-group">
                    <label for="charityPhone">Phone Number</label>
                    <input type="tel" id="charityPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="charityWebsite">Website (optional)</label>
                    <input type="url" id="charityWebsite" placeholder="https://example.org">
                </div>
                <div class="form-group">
                    <label for="charityDescription">Description (optional)</label>
                    <textarea id="charityDescription" rows="3" placeholder="Brief description of the charity's mission"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeCharityModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Charity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Charity Modal -->
    <div id="editCharityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Charity</h2>
            </div>
            <form id="editCharityForm">
                <input type="hidden" id="editCharityId">
                <div class="form-group">
                    <label for="editCharityName">Charity Name</label>
                    <input type="text" id="editCharityName" required>
                </div>
                <div class="form-group">
                    <label for="editCharityEIN">EIN (optional)</label>
                    <input type="text" id="editCharityEIN">
                </div>
                <div class="form-group">
                    <label for="editCharityCategory">Category</label>
                    <select id="editCharityCategory">
                        <option value="">Select category...</option>
                        <option value="Arts & Culture">Arts & Culture</option>
                        <option value="Community">Community</option>
                        <option value="Education">Education</option>
                        <option value="Environment">Environment</option>
                        <option value="Health">Health</option>
                        <option value="Human Services">Human Services</option>
                        <option value="International">International</option>
                        <option value="Religion">Religion</option>
                        <option value="Research">Research</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCharityAddress">Street Address</label>
                    <input type="text" id="editCharityAddress" placeholder="123 Main St">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <label for="editCharityCity">City</label>
                        <input type="text" id="editCharityCity" placeholder="New York">
                    </div>
                    <div>
                        <label for="editCharityState">State</label>
                        <input type="text" id="editCharityState" placeholder="NY" maxlength="2">
                    </div>
                    <div>
                        <label for="editCharityZip">ZIP Code</label>
                        <input type="text" id="editCharityZip" placeholder="10001" pattern="[0-9]{5}(-[0-9]{4})?">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editCharityPhone">Phone Number</label>
                    <input type="tel" id="editCharityPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="editCharityWebsite">Website (optional)</label>
                    <input type="url" id="editCharityWebsite" placeholder="https://example.org">
                </div>
                <div class="form-group">
                    <label for="editCharityDescription">Description (optional)</label>
                    <textarea id="editCharityDescription" rows="3" placeholder="Brief description of the charity's mission"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditCharityModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Update Charity</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) {
            window.location.href = '/login.html';
        } else {
            // Try to get name from profile first, then fall back to user data
            const savedProfile = localStorage.getItem('userProfile');
            let displayName = user.email;
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                displayName = profile.name || user.name || user.email;
            } else {
                displayName = user.name || user.email;
            }
            document.getElementById('userName').textContent = displayName;
        }

        // Set today's date as default for donation form (use local date string to avoid timezone issues)
        const today = new Date();
        const localDate = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');
        document.getElementById('donationDate').value = localDate;

        // Format currency with commas and optional cents
        function formatCurrency(amount, includeCents = false) {
            const num = parseFloat(amount) || 0;
            if (includeCents) {
                return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
        }

        // Helper function to parse donation notes safely
        function parseNotesDisplay(notes) {
            if (!notes) return '';

            if (typeof notes === 'string' && notes.startsWith('{')) {
                try {
                    const notesObj = JSON.parse(notes);
                    return notesObj.notes || '';
                } catch (e) {
                    // Use as-is if not valid JSON
                    return notes;
                }
            }
            return notes;
        }

        // Function to update donation type (for edit form)
        function updateDonationType(type) {
            // Update the hidden field
            const donationType = document.getElementById('donationType');
            if (donationType) {
                donationType.value = type;
            }

            // Update the display elements
            const typeIcon = document.getElementById('donationTypeIcon');
            const typeLabel = document.getElementById('donationTypeLabel');
            const modalTitle = document.getElementById('donationModalTitle');

            const typeConfig = {
                cash: { icon: '💵', label: 'Cash/Check Donation', title: 'Add Cash Donation' },
                items: { icon: '📦', label: 'Item Donation', title: 'Add Item Donation' },
                miles: { icon: '🚗', label: 'Mileage Donation', title: 'Add Mileage Donation' },
                stock: { icon: '📈', label: 'Stock/Securities Donation', title: 'Add Stock Donation' },
                crypto: { icon: '₿', label: 'Cryptocurrency Donation', title: 'Add Crypto Donation' }
            };

            const config = typeConfig[type] || typeConfig.cash;

            if (typeIcon) typeIcon.textContent = config.icon;
            if (typeLabel) typeLabel.textContent = config.label;
            if (modalTitle) modalTitle.textContent = config.title;

            // Update the form fields
            updateDonationFields();
        }

        // Function to update donation fields based on type
        function updateDonationFields() {
            const donationType = document.getElementById('donationType').value;
            console.log('Updating donation fields for type:', donationType);

            // Hide all type-specific fields
            document.querySelectorAll('.donation-type-fields').forEach(el => {
                el.style.display = 'none';
                // Remove required from hidden fields
                el.querySelectorAll('input, textarea, select').forEach(field => {
                    field.removeAttribute('required');
                });
            });

            // Show relevant fields and set required
            const fieldsToShow = document.getElementById(donationType + 'Fields');
            console.log('Looking for element:', donationType + 'Fields', 'Found:', fieldsToShow);
            if (fieldsToShow) {
                fieldsToShow.style.display = 'block';
                console.log('Showing fields for', donationType);

                // Show/hide crypto time field
                const cryptoTimeField = document.getElementById('cryptoTimeField');
                if (cryptoTimeField) {
                    cryptoTimeField.style.display = donationType === 'crypto' ? 'block' : 'none';
                    if (donationType === 'crypto') {
                        document.getElementById('cryptoDonationTime').setAttribute('required', '');
                    } else {
                        document.getElementById('cryptoDonationTime').removeAttribute('required');
                    }
                }

                // Add required to visible amount fields
                if (donationType === 'cash') {
                    document.getElementById('donationAmount').setAttribute('required', '');
                } else if (donationType === 'miles') {
                    document.getElementById('milesDriven').setAttribute('required', '');
                } else if (donationType === 'items') {
                    document.getElementById('itemDescription').setAttribute('required', '');
                    document.getElementById('estimatedValue').setAttribute('required', '');
                } else if (donationType === 'stock') {
                    document.getElementById('stockQuantity').setAttribute('required', '');
                    document.getElementById('fairMarketValue').setAttribute('required', '');
                } else if (donationType === 'crypto') {
                    // Fix: Use correct crypto field IDs
                    const cryptoSymbol = document.getElementById('cryptoSymbol');
                    const cryptoQty = document.getElementById('cryptoQuantity');
                    const cryptoPricePerUnit = document.getElementById('cryptoPricePerUnit');
                    if (cryptoSymbol) cryptoSymbol.setAttribute('required', '');
                    if (cryptoQty) cryptoQty.setAttribute('required', '');
                    if (cryptoPricePerUnit) cryptoPricePerUnit.setAttribute('required', '');
                }
            }
        }

        // Calculate mileage deduction
        document.getElementById('milesDriven')?.addEventListener('input', (e) => {
            const miles = parseFloat(e.target.value) || 0;
            const rate = 0.14; // 2024 IRS rate
            const deduction = (miles * rate).toFixed(2);
            document.getElementById('mileageDeduction').textContent = deduction;
        });

        // Modal functions
        function showAddDonation() {
            document.getElementById('donationModal').classList.add('active');
            // Initialize charity autocomplete every time modal opens
            initCharityAutocomplete();
            // Also initialize item categories if it's an item donation
            if (document.getElementById('donationType').value === 'items') {
                loadItemCategories();
            }

            // Set default date for crypto donations too
            const today = new Date();
            const localDate = today.getFullYear() + '-' +
                           String(today.getMonth() + 1).padStart(2, '0') + '-' +
                           String(today.getDate()).padStart(2, '0');
            // Crypto now uses the general date field

            // Don't load My Charities in modal anymore - removed that section
        }

        // Load charities for quick add in donation modal
        async function loadMyCharitiesQuickAdd() {
            // Can be called for either the modal or the Add Donation page
            const containerModal = document.getElementById('myCharitiesQuickList');
            const containerPage = document.getElementById('myCharitiesQuickAdd');
            const container = containerModal || containerPage;

            if (!container) return;
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            try {
                const token = localStorage.getItem('token');

                // Fetch all donations to get unique charities
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    // Group donations by charity
                    const charitiesMap = new Map();
                    data.donations.forEach(donation => {
                        const charityId = donation.unified_charity_id || donation.charity_id || donation.user_charity_id;
                        if (!charityId) return;

                        if (!charitiesMap.has(charityId)) {
                            charitiesMap.set(charityId, {
                                id: charityId,
                                name: donation.charity_name || 'Unknown',
                                source: donation.charity_source || 'system',
                                total: 0,
                                count: 0
                            });
                        }
                        const charity = charitiesMap.get(charityId);
                        charity.total += parseFloat(donation.amount || 0);
                        charity.count++;
                    });

                    // Convert to array and sort alphabetically
                    const charities = Array.from(charitiesMap.values())
                        .sort((a, b) => a.name.localeCompare(b.name));

                    // Check if we're in the modal or the page
                    const isModal = container.id === 'myCharitiesQuickList';
                    const onClickFunc = isModal ? 'quickSelectCharity' : 'quickAddDonation';

                    let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                    charities.forEach(charity => {
                        const personalBadge = charity.source === 'personal'
                            ? '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">Personal</span>'
                            : '';

                        html += `
                            <div style="padding: 0.75rem; background: #f9fafb; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                                 onmouseover="this.style.background='#f3f4f6'"
                                 onmouseout="this.style.background='#f9fafb'"
                                 onclick="${onClickFunc}('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')">
                                <div style="font-weight: 500; color: #111827;">${charity.name}${personalBadge}</div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${charity.count} donation${charity.count !== 1 ? 's' : ''} · $${formatCurrency(charity.total, true)}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 2rem;">No charities with donations yet</div>';
                }
            } catch (error) {
                console.error('Failed to load My Charities for quick add:', error);
                container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 2rem;">Failed to load charities</div>';
            }
        }

        // Quick select charity from My Charities list
        function quickSelectCharity(charityId, charityName) {
            // Get selected donation type from quick selector
            const donationType = document.getElementById('quickDonationType').value;

            // Open donation modal with pre-filled charity
            openDonationModal(donationType, charityId, charityName);

            // Focus on amount field for quick entry
            setTimeout(() => {
                const amountField = document.getElementById('donationAmount') ||
                                  document.getElementById('stockQuantity') ||
                                  document.getElementById('cryptoQuantity') ||
                                  document.getElementById('milesDriven');
                if (amountField) amountField.focus();
            }, 100);
        }

        // Update quick donation type (just for visual feedback)
        function updateQuickDonationType() {
            // This is just to track what type will be used when clicking a charity
            const selectedType = document.getElementById('quickDonationType').value;
            console.log('Quick donation type changed to:', selectedType);
        }

        function closeDonationModal() {
            document.getElementById('donationModal').classList.remove('active');
            document.getElementById('donationForm').reset();
            document.getElementById('selectedCharityId').value = '';
            document.getElementById('charityDropdown').classList.remove('show');
            // Clear edit mode
            window.editingDonationId = null;
            window.isEditing = false;
            // Reset item selection
            selectedDonationItems = [];
            updateSelectedItemsDisplay();
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSearch').disabled = true;
            document.getElementById('itemQuality').disabled = true;
            document.getElementById('itemQuantity').disabled = true;
            document.getElementById('addItemBtn').disabled = true;
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSelect').value = '';
            // Clear editing flag
            window.editingDonationId = null;
        }

        function showAddCharity() {
            document.getElementById('charityModal').classList.add('active');
        }

        function closeCharityModal() {
            document.getElementById('charityModal').classList.remove('active');
            document.getElementById('charityForm').reset();
        }

        // Edit charity functions
        function closeEditCharityModal() {
            document.getElementById('editCharityModal').classList.remove('active');
            document.getElementById('editCharityForm').reset();
        }

        async function editPersonalCharity(charityId) {
            try {
                console.log('Opening edit modal for charity ID:', charityId);

                // Get auth token
                const token = localStorage.getItem('token');

                // Fetch charity data
                const response = await fetch(`/api/charities/personal/${charityId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.charity) {
                    const charity = data.charity;

                    // Populate form fields
                    document.getElementById('editCharityId').value = charity.id;
                    document.getElementById('editCharityName').value = charity.name || '';
                    document.getElementById('editCharityEIN').value = charity.ein || '';
                    document.getElementById('editCharityCategory').value = charity.category || '';
                    document.getElementById('editCharityAddress').value = charity.address || '';
                    document.getElementById('editCharityCity').value = charity.city || '';
                    document.getElementById('editCharityState').value = charity.state || '';
                    document.getElementById('editCharityZip').value = charity.zip_code || '';
                    document.getElementById('editCharityPhone').value = charity.phone || '';
                    document.getElementById('editCharityWebsite').value = charity.website || '';
                    document.getElementById('editCharityDescription').value = charity.description || '';

                    // Show modal
                    document.getElementById('editCharityModal').classList.add('active');
                } else {
                    showToast('Failed to load charity data: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error loading charity for edit:', error);
                showToast('Failed to load charity data. Please try again.', 'error');
            }
        }

        async function deletePersonalCharity(charityId) {
            if (!confirm('Are you sure you want to delete this charity? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('Deleting charity ID:', charityId);

                // Get auth token
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/charities/delete-personal/${charityId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Charity deleted successfully!', 'success');
                    loadCharities(); // Refresh the main charity list
                    loadPersonalCharities(); // Refresh the personal charities panel if open
                } else {
                    // Show more detailed error message for donation conflicts
                    if (data.error && data.error.includes('existing donation')) {
                        showToast(data.error, 'warning');
                    } else {
                        showToast('Failed to delete charity: ' + (data.error || 'Unknown error'), 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting charity:', error);
                showToast('Failed to delete charity. Please try again.', 'error');
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Autocomplete functionality
        let allCharities = [];
        let selectedCharityIndex = -1;
        let searchTimeout;

        async function initCharityAutocomplete() {
            console.log('Initializing charity autocomplete...');

            // Load top charities for quick access
            if (allCharities.length === 0) {
                try {
                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const token = user.token || localStorage.getItem('token') || 'test-token';

                    const response = await fetch('/api/charities?limit=500', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (data.success && data.charities) {
                        allCharities = data.charities;
                        console.log(`Loaded ${allCharities.length} charities (including personal)`);
                    }
                } catch (error) {
                    console.error('Failed to load charities:', error);
                }
            }

            const input = document.getElementById('donationCharity');
            const dropdown = document.getElementById('charityDropdown');
            const hiddenInput = document.getElementById('selectedCharityId');

            if (!input || !dropdown) {
                console.error('Charity input or dropdown not found', 'Input:', input, 'Dropdown:', dropdown);
                return;
            }

            // Remove any existing listeners first to avoid duplicates
            if (input._charityListenersAdded) {
                console.log('Charity listeners already added');
                return; // Already initialized
            }

            // Setup event listeners - use anonymous functions to ensure they're attached
            input.addEventListener('input', function(e) {
                console.log('Input event fired');
                handleCharitySearch(e);
            });
            input.addEventListener('focus', function(e) {
                console.log('Focus event fired');
                handleCharitySearch(e);
            });
            input.addEventListener('keydown', function(e) {
                handleCharityKeydown(e);
            });

            // Mark as initialized
            input._charityListenersAdded = true;
            console.log('Charity autocomplete initialized - listeners attached to:', input);
        }

        function handleCharitySearch(e) {
            const query = e.target.value.toLowerCase();
            const dropdown = document.getElementById('charityDropdown');
            console.log('Charity search for:', query);

            // Clear the selected charity ID when user is typing
            document.getElementById('selectedCharityId').value = '';

            clearTimeout(searchTimeout);
            selectedCharityIndex = -1;

            if (query.length < 2) {
                dropdown.classList.remove('show');
                dropdown.style.display = 'none';
                return;
            }

            // Show loading state
            dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
            dropdown.classList.add('show');
            dropdown.style.display = 'block';

            // Debounce search
            searchTimeout = setTimeout(async () => {
                // First, filter local charities for immediate results
                let results = allCharities.filter(charity =>
                    charity.name.toLowerCase().includes(query) ||
                    (charity.ein && charity.ein.toLowerCase().includes(query))
                ).slice(0, 10);

                // If we have fewer than 10 results, search the full database
                if (results.length < 10) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/api/charities?search=${encodeURIComponent(query)}&limit=10`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const data = await response.json();
                        if (data.success && data.charities) {
                            // Merge results, avoiding duplicates
                            const existingIds = new Set(results.map(r => r.id));
                            const newResults = data.charities.filter(c => !existingIds.has(c.id));
                            results = [...results, ...newResults].slice(0, 10);
                        }
                    } catch (error) {
                        console.error('Search failed:', error);
                    }
                }

                displayCharityResults(results, query);
            }, 300);
        }

        function displayCharityResults(results, query) {
            const dropdown = document.getElementById('charityDropdown');

            if (results.length === 0) {
                dropdown.innerHTML = `
                    <div class="autocomplete-add-new" onclick="showAddCharityFromSearch('${query}')">
                        + Add new charity "${query}"
                    </div>
                `;
            } else {
                let html = '';
                results.forEach((charity, index) => {
                    html += `
                        <div class="autocomplete-item ${index === selectedCharityIndex ? 'selected' : ''}"
                             data-id="${charity.id}"
                             data-index="${index}"
                             onclick="selectCharity('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')">
                            <div class="autocomplete-item-name">${charity.name}</div>
                            ${charity.ein ? `<span class="autocomplete-item-ein">EIN: ${charity.ein}</span>` : ''}
                            ${charity.category ? `<span class="autocomplete-item-category">${charity.category}</span>` : ''}
                        </div>
                    `;
                });

                // Add "Add new charity" option at the end
                html += `
                    <div class="autocomplete-add-new" onclick="showAddCharityFromSearch('${query}')">
                        + Add new charity
                    </div>
                `;

                dropdown.innerHTML = html;
            }

            dropdown.classList.add('show');
            dropdown.style.display = 'block';
        }

        function handleCharityKeydown(e) {
            const dropdown = document.getElementById('charityDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (!dropdown.classList.contains('show') || items.length === 0) return;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedCharityIndex = Math.min(selectedCharityIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedCharityIndex = Math.max(selectedCharityIndex - 1, -1);
                    updateSelectedItem(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedCharityIndex >= 0 && items[selectedCharityIndex]) {
                        items[selectedCharityIndex].click();
                    }
                    break;
                case 'Escape':
                    dropdown.classList.remove('show');
                    selectedCharityIndex = -1;
                    break;
            }
        }

        function updateSelectedItem(items) {
            items.forEach((item, index) => {
                if (index === selectedCharityIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectCharity(id, name) {
            document.getElementById('selectedCharityId').value = id;
            document.getElementById('donationCharity').value = name;
            const dropdown = document.getElementById('charityDropdown');
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
            selectedCharityIndex = -1;
            console.log('Selected charity:', name, 'ID:', id);
        }

        // Quick add donation from My Charities
        function quickAddDonation(charityId, charityName) {
            // Store the selected charity
            document.getElementById('selectedCharityId').value = charityId;
            document.getElementById('donationCharity').value = charityName;

            // Show a quick donation type selector
            const donationTypes = [
                { type: 'cash', label: '💵 Cash', desc: 'Cash/Check' },
                { type: 'items', label: '📦 Items', desc: 'Donated Items' },
                { type: 'miles', label: '🚗 Miles', desc: 'Mileage' },
                { type: 'stock', label: '📈 Stock', desc: 'Securities' },
                { type: 'crypto', label: '₿ Crypto', desc: 'Cryptocurrency' }
            ];

            let html = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 10001; max-width: 400px;">
                    <h3 style="margin-bottom: 1rem; color: #333;">Quick Donation to ${charityName}</h3>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Select donation type:</p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
            `;

            donationTypes.forEach(dt => {
                html += `
                    <button onclick="quickSelectType('${dt.type}', '${charityId}', '${charityName.replace(/'/g, "\\\\'")}')"
                            style="padding: 0.75rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;"
                            onmouseover="this.style.background='#e5e7eb'"
                            onmouseout="this.style.background='#f3f4f6'">
                        <div style="font-size: 1.5rem;">${dt.label.split(' ')[0]}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">${dt.desc}</div>
                    </button>
                `;
            });

            html += `
                    </div>
                    <button onclick="document.getElementById('quickDonationSelector').remove()"
                            style="margin-top: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
                        Cancel
                    </button>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="document.getElementById('quickDonationSelector').remove()"></div>
            `;

            const selector = document.createElement('div');
            selector.id = 'quickDonationSelector';
            selector.innerHTML = html;
            document.body.appendChild(selector);
        }

        function quickSelectType(type, charityId, charityName) {
            // Remove the selector
            const selector = document.getElementById('quickDonationSelector');
            if (selector) selector.remove();

            // Open the donation modal with the selected type and pre-filled charity
            openDonationModal(type, charityId, charityName);
        }

        function showAddCharityFromSearch(searchQuery) {
            // Mark that we're adding from donation modal
            window.addingCharityFromDonation = true;
            // Close donation modal
            closeDonationModal();
            // Open charity modal with pre-filled name
            showAddCharity();
            document.getElementById('charityName').value = searchQuery;
        }

        // Form submissions
        document.getElementById('donationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const charityId = document.getElementById('selectedCharityId').value;
            console.log('[DEBUG] Selected charity ID:', charityId);
            console.log('[DEBUG] Selected charity name:', document.getElementById('donationCharity').value);

            if (!charityId) {
                alert('Please select a charity from the dropdown');
                return;
            }

            const donationType = document.getElementById('donationType').value;
            const isEditing = window.editingDonationId !== null && window.editingDonationId !== undefined;
            const formData = {
                charity_id: charityId,
                donation_type: donationType,
                donation_date: document.getElementById('donationDate').value,  // API will map this to 'date'
                notes: document.getElementById('donationNotes').value
            };

            console.log('[DEBUG] Form data being submitted:', formData);
            console.log('[DEBUG] Is editing?', isEditing);

            // Add type-specific data
            switch(donationType) {
                case 'cash':
                    formData.amount = parseFloat(document.getElementById('donationAmount').value);
                    break;
                case 'items':
                    formData.item_description = document.getElementById('itemDescription').value;
                    formData.amount = parseFloat(document.getElementById('estimatedValue').value);
                    formData.estimated_value = formData.amount;
                    break;
                case 'miles':
                    const miles = parseFloat(document.getElementById('milesDriven').value);
                    const rate = 0.14; // 2024 IRS rate
                    formData.miles_driven = miles;
                    formData.mileage_rate = rate;
                    formData.mileage_purpose = document.getElementById('mileagePurpose').value;
                    formData.amount = miles * rate; // Calculate deduction amount
                    break;
                case 'stock':
                    const shares = parseFloat(document.getElementById('stockQuantity').value);
                    const pricePerShare = parseFloat(document.getElementById('fairMarketValue').value);
                    formData.stock_name = document.getElementById('stockName').value;
                    formData.stock_symbol = document.getElementById('stockSymbol').value.toUpperCase();
                    formData.shares_donated = shares;
                    formData.fair_market_value = pricePerShare;
                    formData.cost_basis = parseFloat(document.getElementById('costBasis').value) || null;
                    formData.amount = shares * pricePerShare; // Total donation = shares × price per share
                    break;
                case 'crypto':
                    const cryptoQuantity = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
                    const cryptoPricePerUnit = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
                    const cryptoDate = document.getElementById('donationDate').value;
                    const cryptoTime = document.getElementById('cryptoDonationTime').value || '12:00:00';

                    formData.crypto_name = document.getElementById('cryptoName').value;
                    formData.crypto_symbol = document.getElementById('cryptoSymbol').value.toUpperCase();
                    formData.crypto_quantity = cryptoQuantity;
                    formData.crypto_price_per_unit = cryptoPricePerUnit;
                    formData.crypto_exchange = document.getElementById('cryptoExchange').value;
                    formData.crypto_cost_basis = parseFloat(document.getElementById('cryptoCostBasis').value) || null;
                    formData.crypto_holding_period = document.getElementById('cryptoHoldingPeriod').value;
                    formData.amount = cryptoQuantity * cryptoPricePerUnit;
                    // Store exact donation timestamp
                    formData.crypto_donation_datetime = cryptoDate + 'T' + cryptoTime;
                    // Override the donation date with crypto-specific date
                    formData.donation_date = cryptoDate;
                    break;
            }

            try {
                const url = isEditing ? `/api/donations/${window.editingDonationId}` : '/api/donations';
                const method = isEditing ? 'PUT' : 'POST';

                // Get user token for authorization
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                console.log('[DEBUG] Sending request to:', url);
                console.log('[DEBUG] Request method:', method);
                console.log('[DEBUG] Request body:', JSON.stringify(formData, null, 2));

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('[DEBUG] Response status:', response.status);

                // Check if response is JSON (API available) or HTML (404)
                const contentType = response.headers.get("content-type");
                let data;

                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    // API endpoint not available - simulate success for demo
                    if (isEditing) {
                        showToast('⚠️ Edit saved locally only (API endpoint not yet implemented)', 'info');
                    }
                    data = { success: true };
                }

                if (data.success) {
                    closeDonationModal();
                    // Clear editing flag
                    delete window.editingDonationId;
                    // Reset modal title
                    document.querySelector('#donationModal .modal-header h2').textContent = 'Add Donation';

                    // Show success message
                    showToast(isEditing ? 'Donation updated successfully!' : '✅ Donation added successfully!', 'success');

                    // Switch to dashboard view
                    showSection('dashboard');

                    // Refresh the dashboard to show new donation
                    loadDonations();
                    loadStats();
                    loadCharities(); // Refresh charities to show the one with donation
                } else {
                    console.error('[DEBUG] API error response:', data);
                    showToast(`Failed to ${isEditing ? 'update' : 'add'} donation: ` + data.error, 'error');
                }
            } catch (error) {
                console.error(`[DEBUG] Error ${isEditing ? 'updating' : 'adding'} donation:`, error);
                console.error('[DEBUG] Error stack:', error.stack);
                alert(`Failed to ${isEditing ? 'update' : 'add'} donation. Check console for details.`);
            }
        });

        document.getElementById('charityForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('=== ADD CHARITY FORM SUBMISSION ===');

            // Check for missing form elements
            const requiredFields = ['charityName', 'charityEIN', 'charityCategory', 'charityAddress',
                                   'charityCity', 'charityState', 'charityZip', 'charityPhone',
                                   'charityWebsite', 'charityDescription'];

            for (const fieldId of requiredFields) {
                const element = document.getElementById(fieldId);
                if (!element) {
                    const errorMsg = `ERROR: Missing form element with ID: ${fieldId}`;
                    console.error(errorMsg);
                    showToast(`Form error: Missing field ${fieldId}. Please refresh the page.`, 'error');
                    return;
                }
            }

            const formData = {
                name: document.getElementById('charityName').value,
                ein: document.getElementById('charityEIN').value,
                category: document.getElementById('charityCategory').value,
                address: document.getElementById('charityAddress').value,
                city: document.getElementById('charityCity').value,
                state: document.getElementById('charityState').value,
                zip_code: document.getElementById('charityZip').value,
                phone: document.getElementById('charityPhone').value,
                website: document.getElementById('charityWebsite').value,
                description: document.getElementById('charityDescription').value
            };

            console.log('Form data collected:', formData);

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                console.log('Sending request to /api/charities/add-personal');
                console.log('Auth token:', token ? 'Present' : 'Missing');

                const response = await fetch('/api/charities/add-personal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Response was:', responseText);
                    showToast('Server error: Invalid response format', 'error');
                    return;
                }

                console.log('Parsed response data:', data);

                if (data.success) {
                    console.log('SUCCESS: Charity added successfully');
                    showToast('Personal charity added successfully! It\'s now available for your donations.', 'success');
                    closeCharityModal();

                    // If we came from the donation modal, re-open it with the new charity selected
                    if (window.addingCharityFromDonation) {
                        showAddDonation();
                        // Pre-select the new charity
                        const charityInput = document.getElementById('donationCharity');
                        const charityIdInput = document.getElementById('selectedCharityId');
                        if (charityInput && charityIdInput) {
                            charityInput.value = formData.name;
                            charityIdInput.value = data.charity.id;
                        }
                        window.addingCharityFromDonation = false;
                    }
                } else {
                    showToast('Failed to add charity: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error adding charity:', error);
                showToast('Failed to add charity. Please try again.', 'error');
            }
        });

        // Edit charity form submission handler
        document.getElementById('editCharityForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('=== EDIT CHARITY FORM SUBMISSION ===');

            // Check for missing form elements
            const requiredFields = ['editCharityId', 'editCharityName', 'editCharityEIN', 'editCharityCategory',
                                   'editCharityAddress', 'editCharityCity', 'editCharityState', 'editCharityZip',
                                   'editCharityPhone', 'editCharityWebsite', 'editCharityDescription'];

            for (const fieldId of requiredFields) {
                const element = document.getElementById(fieldId);
                if (!element) {
                    const errorMsg = `ERROR: Missing form element with ID: ${fieldId}`;
                    console.error(errorMsg);
                    showToast(`Form error: Missing field ${fieldId}. Please refresh the page.`, 'error');
                    return;
                }
            }

            const charityId = document.getElementById('editCharityId').value;
            const formData = {
                name: document.getElementById('editCharityName').value,
                ein: document.getElementById('editCharityEIN').value,
                category: document.getElementById('editCharityCategory').value,
                address: document.getElementById('editCharityAddress').value,
                city: document.getElementById('editCharityCity').value,
                state: document.getElementById('editCharityState').value,
                zip_code: document.getElementById('editCharityZip').value,
                phone: document.getElementById('editCharityPhone').value,
                website: document.getElementById('editCharityWebsite').value,
                description: document.getElementById('editCharityDescription').value
            };

            console.log('Edit form data collected:', formData);
            console.log('Charity ID:', charityId);

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                console.log(`Sending request to /api/charities/update-personal/${charityId}`);
                console.log('Auth token:', token ? 'Present' : 'Missing');

                const response = await fetch(`/api/charities/update-personal/${charityId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response as JSON:', parseError);
                    console.error('Response was:', responseText);
                    showToast('Server error: Invalid response format', 'error');
                    return;
                }

                console.log('Parsed response data:', data);

                if (data.success) {
                    console.log('SUCCESS: Charity updated successfully');
                    showToast('Charity updated successfully!', 'success');
                    closeEditCharityModal();
                    loadCharities(); // Refresh the charity list
                } else {
                    showToast('Failed to update charity: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error updating charity:', error);
                showToast('Failed to update charity. Please try again.', 'error');
            }
        });

        // Update year filter
        function updateYearFilter() {
            const year = document.getElementById('globalYearFilter').value;
            // Sync with report year dropdown
            const reportYear = document.getElementById('reportYear');
            if (reportYear) {
                reportYear.value = year;
            }
            // Reload data with new filter
            loadDonations();
            loadStats();
            loadCharities();
        }

        // Load and display donations
        async function loadDonations() {
            const container = document.getElementById('donationsContent');
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            // Update the title to show the year
            const titleElement = document.getElementById('donationHistoryTitle');
            if (titleElement) {
                titleElement.textContent = `Donation History (${year === 'all' ? 'All Years' : year})`;
            }

            try {
                // Load ALL donations for the year, not just 10
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    // Store ALL donations for search/filter functionality
                    localStorage.setItem('recentDonations', JSON.stringify(data.donations));
                    allDonations = data.donations; // Update global variable for filtering

                    // Display ALL donations for the selected year (no limit)
                    let html = `<div style="margin-bottom: 0.5rem; color: #6b7280; font-size: 0.875rem;">Showing ${data.donations.length} donation${data.donations.length !== 1 ? 's' : ''} for ${year === 'all' ? 'all years' : year}</div>`;
                    html += '<table class="table"><thead><tr><th>Date</th><th>Charity</th><th>Type</th><th>Amount</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
                    data.donations.forEach(donation => {
                        // Parse date correctly to avoid timezone issues
                        const dateStr = donation.date || donation.donation_date;
                        let date;
                        if (dateStr) {
                            // If date is in YYYY-MM-DD format, parse it correctly
                            if (dateStr.includes('-')) {
                                const [year, month, day] = dateStr.split('-');
                                date = `${month}/${day}/${year}`;
                            } else {
                                date = new Date(dateStr).toLocaleDateString();
                            }
                        } else {
                            date = 'Unknown';
                        }
                        const typeIcons = {
                            'cash': '💵',
                            'items': '📦',
                            'miles': '🚗',
                            'stock': '📈',
                            'crypto': '₿'
                        };
                        const typeIcon = typeIcons[donation.donation_type] || '💵';

                        // Build type display with details
                        let typeDisplay = `${typeIcon} ${donation.donation_type || 'cash'}`;
                        if (donation.donation_type === 'miles') {
                            typeDisplay = `${typeIcon} ${donation.miles_driven || 0} miles`;
                        } else if (donation.donation_type === 'stock' && donation.stock_symbol) {
                            typeDisplay = `${typeIcon} ${donation.stock_symbol}`;
                        } else if (donation.donation_type === 'crypto' && donation.crypto_symbol) {
                            typeDisplay = `${typeIcon} ${donation.crypto_symbol}`;
                        }

                        // Only show user-entered notes, nothing else
                        let displayNotes = donation.notes || '';

                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${donation.charity_name || 'Unknown'}</td>
                                <td>${typeDisplay}</td>
                                <td>$${formatCurrency(donation.amount, true)}</td>
                                <td>${displayNotes}</td>
                                <td style="white-space: nowrap; position: relative;">
                                    <div class="dropdown" style="display: inline-block;">
                                        <button class="btn-action" onclick="toggleActionMenu(event, '${donation.id}')" title="Actions">⋮</button>
                                        <div id="actionMenu-${donation.id}" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; min-width: 150px;">
                                            <button onclick="viewDonationDetails('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; hover: background: #f3f4f6;">👁️ View Details</button>
                                            <button onclick="editDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">✏️ Edit</button>
                                            <button onclick="addReceipt('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">📎 Add Receipt</button>
                                            <hr style="margin: 0; border: none; border-top: 1px solid #e5e7eb;">
                                            <button onclick="deleteDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: #ef4444;">🗑️ Delete</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    // Keep empty state
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>No donations yet. Add your first donation to get started!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load donations:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            // Update labels with selected year
            if (year === 'all') {
                document.getElementById('totalDonationsLabel').textContent = 'Total Donations (All Years)';
                document.getElementById('taxSavingsLabel').textContent = 'Est. Tax Savings (All Years)';
            } else {
                document.getElementById('totalDonationsLabel').textContent = `Total Donations (${year})`;
                document.getElementById('taxSavingsLabel').textContent = `Est. Tax Savings (${year})`;
            }

            try {
                // Fetch donations for the selected year
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations) {
                    // Calculate totals from donations
                    const totalAmount = data.donations.reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);

                    // Count unique charities
                    const uniqueCharities = new Set(data.donations.map(d => d.charity_id)).size;

                    // Calculate tax savings based on current tax rate
                    const taxRate = currentTaxRate || 0.22;
                    const estimatedSavings = totalAmount * taxRate;

                    // Update display with proper formatting
                    document.getElementById('totalDonations').textContent = `$${formatCurrency(totalAmount)}`;
                    document.getElementById('donationCount').textContent = (data.total || data.donations.length).toString();
                    document.getElementById('charityCount').textContent = uniqueCharities.toString();
                    document.getElementById('taxSavings').textContent = `$${formatCurrency(estimatedSavings)}`;
                } else {
                    // No donations, show zeros
                    document.getElementById('totalDonations').textContent = '$0';
                    document.getElementById('donationCount').textContent = '0';
                    document.getElementById('charityCount').textContent = '0';
                    document.getElementById('taxSavings').textContent = '$0';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
                // Show zeros on error
                document.getElementById('totalDonations').textContent = '$0';
                document.getElementById('donationCount').textContent = '0';
                document.getElementById('charityCount').textContent = '0';
                document.getElementById('taxSavings').textContent = '$0';
            }
        }

        // Load and display all charities with donations
        async function loadCharities() {
            const container = document.getElementById('charitiesContent');
            const year = document.getElementById('globalYearFilter')?.value || '2025';

            try {
                // Get auth token
                const token = localStorage.getItem('token');

                // Fetch all donations to get unique charities
                let url = '/api/donations?limit=10000';
                if (year && year !== 'all') {
                    url += `&year=${year}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.donations && data.donations.length > 0) {
                    // Group donations by charity
                    const charitiesMap = new Map();
                    data.donations.forEach(donation => {
                        // Use unified_charity_id which combines charity_id and user_charity_id
                        const charityId = donation.unified_charity_id || donation.charity_id || donation.user_charity_id;
                        if (!charityId) return; // Skip if no charity ID

                        if (!charitiesMap.has(charityId)) {
                            charitiesMap.set(charityId, {
                                id: charityId,
                                name: donation.charity_name || 'Unknown',
                                ein: donation.charity_ein,
                                category: donation.charity_category || 'Other',
                                source: donation.charity_source || 'system',
                                total: 0,
                                count: 0,
                                lastDonation: donation.date || donation.donation_date
                            });
                        }
                        const charity = charitiesMap.get(charityId);
                        charity.total += parseFloat(donation.amount || 0);
                        charity.count++;
                        if ((donation.date || donation.donation_date) > charity.lastDonation) {
                            charity.lastDonation = donation.date || donation.donation_date;
                        }
                    });

                    // Convert to array and sort alphabetically by name
                    const charities = Array.from(charitiesMap.values())
                        .sort((a, b) => a.name.localeCompare(b.name));

                    let html = '<div class="charity-grid">';
                    charities.forEach(charity => {
                        // Indicate if it's a personal charity
                        const personalBadge = charity.source === 'personal'
                            ? '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Personal</span>'
                            : '';

                        // Parse last donation date
                        let lastDonationDate = '';
                        if (charity.lastDonation) {
                            if (charity.lastDonation.includes('-')) {
                                const [year, month, day] = charity.lastDonation.split('-');
                                lastDonationDate = `${month}/${day}/${year}`;
                            } else {
                                lastDonationDate = new Date(charity.lastDonation).toLocaleDateString();
                            }
                        }

                        html += `
                            <div class="charity-card enhanced">
                                <div class="charity-header">
                                    <h3 class="charity-name">
                                        ${charity.name}
                                        ${charity.category ? `<span style="background: #3b82f6; color: white; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.7rem; margin-left: 0.5rem; font-weight: normal;">${charity.category}</span>` : ''}
                                        ${personalBadge}
                                    </h3>
                                </div>

                                <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.75rem 0;">
                                    ${charity.ein ? `<p class="charity-ein" style="margin: 0; font-size: 0.875rem;"><strong>EIN:</strong> ${charity.ein}</p>` : '<span></span>'}
                                    <button class="btn-primary" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;" onclick="quickAddDonation('${charity.id}', '${charity.name.replace(/'/g, "\\'")}')">+ Quick Donation</button>
                                </div>

                                <div class="charity-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">Donations:</span>
                                        <span class="stat-value">${charity.count}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Total Donated:</span>
                                        <span class="stat-value">$${formatCurrency(charity.total, true)}</span>
                                    </div>
                                    ${lastDonationDate ? `
                                    <div class="stat-item">
                                        <span class="stat-label">Last Donation:</span>
                                        <span class="stat-value">${lastDonationDate}</span>
                                    </div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    // Show empty state when no donations exist
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🏛️</div>
                            <p>No charities with donations yet. Add your first donation to get started!</p>
                        </div>
                    `;
                }

                // Update charity count in stats if not already updated
                // This is handled in loadStats() so we don't need to do it again

            } catch (error) {
                console.error('Failed to load charities:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <p>Failed to load charities. Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        // Export functions
        async function exportCSV() {
            try {
                // Fetch all donations for the selected year
                const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    alert('No donations to export');
                    return;
                }

                // Create CSV content
                let csvContent = 'Date,Charity,Type,Amount,Description,Notes\n';

                data.donations.forEach(donation => {
                    const date = new Date(donation.donation_date).toLocaleDateString();
                    const charity = (donation.charity_name || 'Unknown').replace(/,/g, ';');
                    const type = donation.donation_type || 'cash';
                    const amount = parseFloat(donation.amount).toFixed(2);
                    const description = getDescriptionForType(donation);
                    const notes = parseNotesDisplay(donation.notes || '').replace(/,/g, ';');

                    csvContent += `${date},"${charity}",${type},${amount},"${description}","${notes}"\n`;
                });

                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const filename = selectedYear === 'all' ? 'donations_all.csv' : `donations_${selectedYear}.csv`;
                link.download = filename;
                link.click();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export donations. Please try again.');
            }
        }

        async function exportPDF() {
            try {
                // Fetch all donations for the selected year
                const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    alert('No donations to export');
                    return;
                }

                // Create HTML content for PDF
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Donation Report ${selectedYear === 'all' ? 'All Years' : selectedYear}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; }
                            h1 { color: #667eea; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .summary { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
                            .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                        </style>
                    </head>
                    <body>
                        <h1>Tax Deductible Donations - ${selectedYear === 'all' ? 'All Years' : selectedYear}</h1>
                        <div class="summary">
                            <h2>Summary</h2>
                            <p><strong>Total Donations:</strong> $${data.donations.reduce((sum, d) => sum + parseFloat(d.amount), 0).toFixed(2)}</p>
                            <p><strong>Number of Donations:</strong> ${data.donations.length}</p>
                            <p><strong>Report Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Charity</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.donations.forEach(donation => {
                    const date = new Date(donation.donation_date).toLocaleDateString();
                    const description = getDescriptionForType(donation);
                    htmlContent += `
                        <tr>
                            <td>${date}</td>
                            <td>${donation.charity_name || 'Unknown'}</td>
                            <td>${donation.donation_type || 'cash'}</td>
                            <td>$${formatCurrency(donation.amount, true)}</td>
                            <td>${description}</td>
                            <td>${parseNotesDisplay(donation.notes)}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>This report is for tax preparation purposes. Please consult with your tax advisor.</p>
                            <p>Generated by Charity Tracker v2.0.6</p>
                        </div>
                    </body>
                    </html>
                `;

                // Open in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export donations. Please try again.');
            }
        }

        function getDescriptionForType(donation) {
            switch(donation.donation_type) {
                case 'items':
                    return donation.item_description || 'Donated items';
                case 'miles':
                    return `${donation.miles_driven || 0} miles @ $${donation.mileage_rate || 0.14}/mile - ${donation.mileage_purpose || 'Charity work'}`;
                case 'stock':
                    const stockTotal = (donation.shares_donated || 0) * (donation.fair_market_value || 0);
                    return `${donation.stock_symbol || 'Stock'}: ${donation.shares_donated || 0} shares @ $${donation.fair_market_value || 0}/share = $${stockTotal.toFixed(2)}`;
                case 'crypto':
                    const cryptoTotal = (donation.crypto_quantity || 0) * (donation.crypto_price_per_unit || 0);
                    const cryptoTime = donation.crypto_donation_datetime ? new Date(donation.crypto_donation_datetime).toLocaleTimeString() : '';
                    return `${donation.crypto_symbol || 'Crypto'}: ${donation.crypto_quantity || 0} units @ $${donation.crypto_price_per_unit || 0}/unit = $${cryptoTotal.toFixed(2)} (${cryptoTime})`;
                case 'cash':
                default:
                    return 'Cash donation';
            }
        }

        // Tax rate calculations (2024 rates)
        const taxBrackets = {
            single: [
                {min: 0, max: 11600, rate: 0.10},
                {min: 11600, max: 47150, rate: 0.12},
                {min: 47150, max: 100525, rate: 0.22},
                {min: 100525, max: 191950, rate: 0.24},
                {min: 191950, max: 243725, rate: 0.32},
                {min: 243725, max: 609350, rate: 0.35},
                {min: 609350, max: Infinity, rate: 0.37}
            ],
            married_jointly: [
                {min: 0, max: 23200, rate: 0.10},
                {min: 23200, max: 94300, rate: 0.12},
                {min: 94300, max: 201050, rate: 0.22},
                {min: 201050, max: 383900, rate: 0.24},
                {min: 383900, max: 487450, rate: 0.32},
                {min: 487450, max: 731200, rate: 0.35},
                {min: 731200, max: Infinity, rate: 0.37}
            ],
            married_separately: [
                {min: 0, max: 11600, rate: 0.10},
                {min: 11600, max: 47150, rate: 0.12},
                {min: 47150, max: 100525, rate: 0.22},
                {min: 100525, max: 191950, rate: 0.24},
                {min: 191950, max: 243725, rate: 0.32},
                {min: 243725, max: 365600, rate: 0.35},
                {min: 365600, max: Infinity, rate: 0.37}
            ],
            head_of_household: [
                {min: 0, max: 16550, rate: 0.10},
                {min: 16550, max: 63100, rate: 0.12},
                {min: 63100, max: 100500, rate: 0.22},
                {min: 100500, max: 191950, rate: 0.24},
                {min: 191950, max: 243700, rate: 0.32},
                {min: 243700, max: 609350, rate: 0.35},
                {min: 609350, max: Infinity, rate: 0.37}
            ]
        };

        const standardDeductions = {
            single: 14600,
            married_jointly: 29200,
            married_separately: 14600,
            head_of_household: 21900
        };

        let currentTaxRate = 0.22; // Default 22%

        function updateTaxRate() {
            const filingStatus = document.getElementById('filingStatus').value;
            const income = parseInt(document.getElementById('incomeBracket').value);

            const brackets = taxBrackets[filingStatus] || taxBrackets.single;
            let rate = 0.10;

            for (const bracket of brackets) {
                if (income >= bracket.min && income <= bracket.max) {
                    rate = bracket.rate;
                    break;
                }
            }

            currentTaxRate = rate;
            const percentage = Math.round(rate * 100);

            // Update profile display
            document.getElementById('marginalTaxRate').textContent = percentage + '%';
            document.getElementById('savingsPerHundred').textContent = '$' + percentage;
            document.getElementById('standardDeduction').textContent =
                '$' + (standardDeductions[filingStatus] || 14600).toLocaleString();

            // Update donation form display
            document.getElementById('taxRateDisplay').textContent = percentage;
            updateTaxSavings();

            // Save to localStorage
            localStorage.setItem('taxRate', rate);
            localStorage.setItem('filingStatus', filingStatus);
            localStorage.setItem('income', income);
        }

        // Save profile information
        function saveProfile() {
            const profileData = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                address: document.getElementById('profileAddress').value,
                city: document.getElementById('profileCity').value,
                state: document.getElementById('profileState').value,
                zip: document.getElementById('profileZip').value,
                filingStatus: document.getElementById('filingStatus').value,
                income: document.getElementById('incomeBracket').value
            };

            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(profileData));

            // Also update tax settings
            updateTaxRate();

            showToast('✅ Profile saved successfully!', 'success');
        }

        // Load profile information
        function loadProfile() {
            const savedProfile = localStorage.getItem('userProfile');
            const userEmail = localStorage.getItem('userEmail');

            if (savedProfile) {
                const profile = JSON.parse(savedProfile);

                // Load personal information
                document.getElementById('profileName').value = profile.name || '';
                document.getElementById('profileEmail').value = userEmail || profile.email || '';
                document.getElementById('profileAddress').value = profile.address || '';
                document.getElementById('profileCity').value = profile.city || '';
                document.getElementById('profileState').value = profile.state || '';
                document.getElementById('profileZip').value = profile.zip || '';

                // Load tax information
                document.getElementById('filingStatus').value = profile.filingStatus || 'single';
                document.getElementById('incomeBracket').value = profile.income || '50000';
            } else {
                // Just set the email if we have it
                document.getElementById('profileEmail').value = userEmail || '';
            }

            // Update tax calculations
            updateTaxRate();
        }

        function updateTaxSavings() {
            let amount = 0;
            const donationType = document.getElementById('donationType').value;

            // Get amount based on donation type
            switch(donationType) {
                case 'cash':
                    amount = parseFloat(document.getElementById('donationAmount').value) || 0;
                    break;
                case 'items':
                    amount = parseFloat(document.getElementById('estimatedValue').value) || 0;
                    break;
                case 'miles':
                    const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
                    amount = miles * 0.14;
                    break;
                case 'stock':
                    const stockShares = parseFloat(document.getElementById('stockQuantity').value) || 0;
                    const stockPrice = parseFloat(document.getElementById('fairMarketValue').value) || 0;
                    amount = stockShares * stockPrice; // Total = shares × price
                    break;
                case 'crypto':
                    const cryptoQty = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
                    const cryptoPrice = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
                    amount = cryptoQty * cryptoPrice;
                    break;
            }

            const savings = amount * currentTaxRate;

            document.getElementById('donationAmountDisplay').textContent = '$' + amount.toFixed(2);
            document.getElementById('taxSavingsDisplay').textContent = '$' + savings.toFixed(2);
        }

        // CSV Import functionality
        let importData = [];

        function showImportDonations() {
            // Navigate to tools section first
            showSection('tools');
            // Hide other panels
            document.getElementById('personalCharitiesPanel').style.display = 'none';
            document.getElementById('charityVerificationPanel').style.display = 'none';
            // Show import panel
            document.getElementById('importDonationsPanel').style.display = 'block';
            // Scroll to the panel
            document.getElementById('importDonationsPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function showPersonalCharities() {
            // Navigate to tools section first
            showSection('tools');
            // Hide other panels
            document.getElementById('importDonationsPanel').style.display = 'none';
            document.getElementById('charityVerificationPanel').style.display = 'none';
            // Show personal charities panel
            document.getElementById('personalCharitiesPanel').style.display = 'block';
            // Load personal charities
            loadPersonalCharities();
            // Scroll to the panel
            document.getElementById('personalCharitiesPanel').scrollIntoView({ behavior: 'smooth' });
        }

        function showCharityVerification() {
            // Navigate to tools section first
            showSection('tools');
            // Hide other panels
            document.getElementById('importDonationsPanel').style.display = 'none';
            document.getElementById('personalCharitiesPanel').style.display = 'none';
            // Show verification panel
            document.getElementById('charityVerificationPanel').style.display = 'block';
            // Scroll to the panel
            document.getElementById('charityVerificationPanel').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadPersonalCharities() {
            const container = document.getElementById('personalCharitiesList');
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/charities/personal', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (data.success && data.charities && data.charities.length > 0) {
                    let html = '<div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">';
                    data.charities.forEach(charity => {
                        const statusColor = charity.is_approved ? '#10b981' : '#f59e0b';
                        const statusText = charity.is_approved ? 'Approved' : 'Pending';
                        html += `
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: #1f2937;">${charity.name}</h4>
                                    <span style="background: ${statusColor}22; color: ${statusColor}; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${statusText}</span>
                                </div>
                                ${charity.ein ? `<p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0;">EIN: ${charity.ein}</p>` : ''}
                                ${charity.category ? `<p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0;">Category: ${charity.category}</p>` : ''}
                                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                    <button class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="editPersonalCharity('${charity.id}')">Edit</button>
                                    <button class="btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;" onclick="deletePersonalCharity('${charity.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No personal charities yet. Click "Add Personal Charity" to get started!</div>';
                }
            } catch (error) {
                console.error('Error loading personal charities:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Failed to load personal charities</div>';
            }
        }

        function showAddPersonalCharity() {
            // Open the add charity modal
            document.getElementById('addCharityModal').style.display = 'flex';
        }

        async function performCharityVerification() {
            const input = document.getElementById('verifyCharityInput').value.trim();
            const resultsDiv = document.getElementById('verificationResults');

            if (!input) {
                showToast('Please enter a charity name or EIN', 'warning');
                return;
            }

            resultsDiv.innerHTML = '<div style="padding: 1rem; background: #f3f4f6; border-radius: 8px;">🔍 Verifying...</div>';

            try {
                const response = await fetch(`/api/charities/verify?name=${encodeURIComponent(input)}`);
                const data = await response.json();

                if (data.success && data.verification) {
                    const v = data.verification;
                    if (v.isVerified) {
                        resultsDiv.innerHTML = `
                            <div style="padding: 1.5rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px;">
                                <h4 style="color: #065f46; margin: 0 0 1rem 0;">✅ Charity Verified!</h4>
                                <div style="color: #047857;">
                                    <p><strong>Name:</strong> ${v.name}</p>
                                    <p><strong>EIN:</strong> ${v.ein}</p>
                                    <p><strong>City:</strong> ${v.city}, ${v.state}</p>
                                    <p><strong>Status:</strong> IRS 501(c)(3) Approved</p>
                                </div>
                            </div>
                        `;
                    } else {
                        let html = `
                            <div style="padding: 1.5rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">
                                <h4 style="color: #92400e; margin: 0 0 1rem 0;">⚠️ Not Found in IRS Database</h4>
                                <p style="color: #92400e;">This charity was not found in the IRS Publication 78 database.</p>
                        `;
                        if (v.suggestions && v.suggestions.length > 0) {
                            html += '<p style="color: #92400e; margin-top: 1rem;"><strong>Did you mean:</strong></p><ul style="color: #92400e;">';
                            v.suggestions.forEach(s => {
                                html += `<li>${s.name} (${s.city}, ${s.state})</li>`;
                            });
                            html += '</ul>';
                        }
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    }
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 1rem; background: #fee; color: #c00; border-radius: 8px;">Verification failed. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error verifying charity:', error);
                resultsDiv.innerHTML = '<div style="padding: 1rem; background: #fee; color: #c00; border-radius: 8px;">Error verifying charity. Please try again.</div>';
            }
        }

        // Setup drag and drop
        const dropZone = document.getElementById('csvDropZone');
        const fileInput = document.getElementById('csvFileInput');

        dropZone?.addEventListener('click', () => fileInput.click());

        dropZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#e0e7ff';
        });

        dropZone?.addEventListener('dragleave', () => {
            dropZone.style.background = '#f9fafb';
        });

        dropZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#f9fafb';
            const files = e.dataTransfer.files;
            if (files.length) handleCSVFile(files[0]);
        });

        fileInput?.addEventListener('change', (e) => {
            if (e.target.files.length) handleCSVFile(e.target.files[0]);
        });

        function handleCSVFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const csv = e.target.result;
                parseCSV(csv);
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            // Proper CSV parsing that handles quoted fields
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            const lines = csv.split('\n').filter(line => line.trim());
            const headers = parseCSVLine(lines[0].toLowerCase()).map(h => h.trim());

            importData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const donation = {};
                headers.forEach((header, index) => {
                    donation[header] = values[index] || '';
                });
                importData.push(donation);
            }

            showPreview();
        }

        function showPreview() {
            const preview = document.getElementById('importPreview');
            const table = document.getElementById('previewTable');

            // Calculate totals
            let totalAmount = 0;
            const typeCount = {};
            importData.forEach(d => {
                totalAmount += parseFloat(d.amount) || 0;
                const type = d.donation_type || 'cash';
                typeCount[type] = (typeCount[type] || 0) + 1;
            });

            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px;">
                    <p><strong>Total Donations:</strong> ${importData.length}</p>
                    <p><strong>Total Amount:</strong> $${totalAmount.toFixed(2)}</p>
                    <p><strong>Types:</strong> ${Object.entries(typeCount).map(([type, count]) => `${type} (${count})`).join(', ')}</p>
                </div>
            `;

            html += '<table class="table"><thead><tr><th>Charity Name</th><th>Date</th><th>Type</th><th>Amount</th><th>Notes</th></tr></thead><tbody>';

            importData.slice(0, 10).forEach(donation => {
                html += `<tr>
                    <td>${donation.charity_name || 'Unknown'}</td>
                    <td>${donation.donation_date || ''}</td>
                    <td>${donation.donation_type || 'cash'}</td>
                    <td>$${(parseFloat(donation.amount) || 0).toFixed(2)}</td>
                    <td>${(() => {
                        const parsed = parseNotesDisplay(donation.notes);
                        return parsed.length > 50 ? parsed.substring(0, 50) + '...' : parsed;
                    })()}</td>
                </tr>`;
            });

            if (importData.length > 10) {
                html += `<tr><td colspan="5" style="text-align: center; font-style: italic;">... and ${importData.length - 10} more</td></tr>`;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
            preview.style.display = 'block';
        }

        async function confirmImport() {
            const resultsDiv = document.getElementById('previewTable');
            resultsDiv.innerHTML = `
                <div style="padding: 2rem; text-align: center;">
                    <div class="loading" style="display: inline-block;">
                        <h3>Importing donations...</h3>
                        <p>Matching charity names to database IDs...</p>
                    </div>
                </div>
            `;

            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                // Use the smart import API
                const response = await fetch('/api/donations/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        donations: importData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let resultHtml = `
                        <div style="padding: 1rem; background: #d1fae5; border-radius: 8px; margin-bottom: 1rem;">
                            <h3 style="color: #065f46;">✅ Import Complete!</h3>
                            <p>Successfully added: <strong>${data.results.added}</strong> donations</p>
                            ${data.results.failed > 0 ? `<p style="color: #dc2626;">Failed: ${data.results.failed} donations</p>` : ''}
                        </div>
                    `;

                    if (data.results.charityMatches?.notFound?.length > 0) {
                        resultHtml += `
                            <details style="margin-top: 1rem;">
                                <summary style="color: #f59e0b; cursor: pointer;">
                                    ⚠️ Unmatched Charities (${data.results.charityMatches.notFound.length})
                                </summary>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    ${data.results.charityMatches.notFound.map(name => `<li>${name}</li>`).join('')}
                                </ul>
                                <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                    These charities need to be added to your database first.
                                </p>
                            </details>
                        `;
                    }

                    resultsDiv.innerHTML = resultHtml;

                    // Reload data after successful import
                    setTimeout(() => {
                        cancelImport();
                        loadDonations();
                        loadStats();
                        loadCharities();
                    }, 3000);
                } else {
                    resultsDiv.innerHTML = `
                        <div style="padding: 1rem; background: #fee2e2; border-radius: 8px;">
                            <h3 style="color: #dc2626;">❌ Import Failed</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="padding: 1rem; background: #fee2e2; border-radius: 8px;">
                        <h3 style="color: #dc2626;">❌ Import Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function cancelImport() {
            document.getElementById('importDonationsPanel').style.display = 'none';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            importData = [];
        }

        // Load saved tax settings
        function loadTaxSettings() {
            const savedRate = localStorage.getItem('taxRate');
            const savedStatus = localStorage.getItem('filingStatus');
            const savedIncome = localStorage.getItem('income');

            if (savedRate) {
                currentTaxRate = parseFloat(savedRate);
            }
            if (savedStatus) {
                document.getElementById('filingStatus').value = savedStatus;
            }
            if (savedIncome) {
                document.getElementById('incomeBracket').value = savedIncome;
            }

            updateTaxRate();
        }

        // View Summary function
        async function viewSummary() {
            const selectedYear = document.getElementById('reportYear')?.value || document.getElementById('globalYearFilter')?.value || '2025';
            const summaryDiv = document.getElementById('reportSummary');

            summaryDiv.innerHTML = '<p>Loading summary...</p>';

            try {
                let url = '/api/donations?limit=10000';
                if (selectedYear && selectedYear !== 'all') {
                    url = `/api/donations?year=${selectedYear}&limit=10000`;
                }

                // Get auth token
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const token = user.token || localStorage.getItem('token') || 'test-token';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();

                if (!data.success || !data.donations || data.donations.length === 0) {
                    summaryDiv.innerHTML = '<p style="color: #666;">No donations found for the selected year.</p>';
                    return;
                }

                // Calculate summary statistics
                const donations = data.donations;
                const totalAmount = donations.reduce((sum, d) => sum + parseFloat(d.amount), 0);
                const taxSavings = totalAmount * currentTaxRate;

                // Group by charity
                const charityTotals = {};
                donations.forEach(d => {
                    const charity = d.charity_name || 'Unknown';
                    charityTotals[charity] = (charityTotals[charity] || 0) + parseFloat(d.amount);
                });

                // Group by type
                const typeTotals = {
                    cash: 0,
                    items: 0,
                    miles: 0,
                    stock: 0,
                    crypto: 0
                };
                donations.forEach(d => {
                    const type = d.donation_type || 'cash';
                    typeTotals[type] = (typeTotals[type] || 0) + parseFloat(d.amount);
                });

                // Generate HTML summary
                let html = `
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">Tax Year ${selectedYear === 'all' ? 'All Years' : selectedYear} Summary</h3>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Total Donations</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #667eea;">$${totalAmount.toFixed(2)}</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Est. Tax Savings</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #16a34a;">$${taxSavings.toFixed(2)}</div>
                            </div>
                            <div style="background: #fef2f2; padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 0.875rem; color: #6b7280;">Number of Donations</div>
                                <div style="font-size: 1.75rem; font-weight: bold; color: #dc2626;">${donations.length}</div>
                            </div>
                        </div>

                        <h4 style="color: #4b5563; margin-bottom: 0.5rem;">Donations by Type</h4>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                `;

                Object.entries(typeTotals).forEach(([type, amount]) => {
                    if (amount > 0) {
                        const percentage = ((amount / totalAmount) * 100).toFixed(1);
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span style="text-transform: capitalize;">${type}</span>
                                <span><strong>$${amount.toFixed(2)}</strong> (${percentage}%)</span>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>

                        <h4 style="color: #4b5563; margin-bottom: 0.5rem;">Top Charities</h4>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                `;

                // Sort charities by total amount
                const sortedCharities = Object.entries(charityTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                sortedCharities.forEach(([charity, amount]) => {
                    const percentage = ((amount / totalAmount) * 100).toFixed(1);
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                            <span>${charity}</span>
                            <span><strong>$${amount.toFixed(2)}</strong> (${percentage}%)</span>
                        </div>
                    `;
                });

                html += `
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <p style="font-size: 0.875rem; color: #92400e;">
                                <strong>Note:</strong> Tax savings shown are estimates based on your ${Math.round(currentTaxRate * 100)}% marginal tax rate.
                                Actual savings depend on itemizing deductions vs. standard deduction ($${(standardDeductions[localStorage.getItem('filingStatus')] || 14600).toLocaleString()}).
                            </p>
                        </div>
                    </div>
                `;

                summaryDiv.innerHTML = html;

            } catch (error) {
                console.error('Failed to generate summary:', error);
                summaryDiv.innerHTML = '<p style="color: #dc2626;">Failed to generate summary. Please try again.</p>';
            }
        }

        // Item donation management
        let itemCategories = [];
        let currentItems = [];
        let selectedDonationItems = [];

        // Load categories on page load
        async function loadItemCategories() {
            console.log('Loading item categories...');
            try {
                const response = await fetch('/api/items?type=categories');
                const data = await response.json();
                console.log('Categories response:', data);

                if (data.success) {
                    itemCategories = data.categories;
                    console.log(`Loaded ${itemCategories.length} categories`);

                    // Populate the category dropdown
                    const categorySelect = document.getElementById('itemCategory');
                    if (categorySelect) {
                        categorySelect.innerHTML = '<option value="">Select category...</option>';
                        itemCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.id;
                            option.textContent = `${cat.icon || ''} ${cat.name}`;
                            categorySelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }

        // Handle category selection change
        async function categoryChanged() {
            const categoryId = document.getElementById('itemCategory').value;
            const itemSearch = document.getElementById('itemSearch');
            const itemQuality = document.getElementById('itemQuality');
            const itemQuantity = document.getElementById('itemQuantity');
            const addBtn = document.getElementById('addItemBtn');

            if (!categoryId) {
                // No category selected, disable everything
                itemSearch.disabled = true;
                itemSearch.placeholder = 'Select category first';
                itemSearch.value = '';
                itemQuality.disabled = true;
                itemQuantity.disabled = true;
                addBtn.disabled = true;
                addBtn.style.background = '#9ca3af';
                addBtn.style.cursor = 'not-allowed';
                currentItems = [];
                document.getElementById('itemValueDisplay').style.display = 'none';
                return;
            }

            // Category selected, enable item search and clear previous selection
            itemSearch.disabled = false;
            itemSearch.placeholder = 'Type to search items...';
            itemSearch.value = '';  // Clear any previous item selection
            document.getElementById('itemSelect').value = '';  // Clear hidden select
            document.getElementById('itemValueDisplay').style.display = 'none';  // Hide value display

            // Load items for this category
            console.log(`Loading items for category ${categoryId}`);
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                console.log('Items API response status:', response.status);
                const data = await response.json();
                console.log('Items data:', data);

                if (data.success) {
                    currentItems = data.items || [];
                    console.log(`Loaded ${currentItems.length} items`);
                } else {
                    console.error('Failed to load items:', data.error);
                    currentItems = [];
                }
            } catch (error) {
                console.error('Failed to load items:', error);
                currentItems = [];
            }
        }

        // Show category dropdown (for backwards compatibility)
        function showCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            const searchValue = document.getElementById('itemCategorySearch') ? document.getElementById('itemCategorySearch').value.toLowerCase() : '';

            let html = '';
            const filteredCategories = searchValue
                ? itemCategories.filter(cat => cat.name.toLowerCase().includes(searchValue))
                : itemCategories;

            if (filteredCategories.length === 0) {
                html = '<div style="padding:0.75rem;color:#6b7280;text-align:center;">No categories found</div>';
            } else {
                filteredCategories.forEach(cat => {
                    html += `
                        <div onclick="selectCategory(${cat.id}, '${cat.name}', '${cat.icon}')"
                             style="padding:0.75rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;transition:background 0.2s;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='white'">
                            <span style="font-size:1.25rem;">${cat.icon}</span>
                            <span style="flex:1;">${cat.name}</span>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        // Search categories
        function searchCategories(value) {
            showCategoryDropdown();
        }

        // Select a category
        async function selectCategory(categoryId, categoryName, categoryIcon) {
            document.getElementById('itemCategory').value = categoryId;
            document.getElementById('itemCategorySearch').value = categoryName;
            document.getElementById('selectedCategoryIcon').textContent = categoryIcon;
            document.getElementById('categoryDropdown').style.display = 'none';

            // Check if element exists before setting
            const categoryNameElement = document.getElementById('selectedCategoryName');
            if (categoryNameElement) {
                categoryNameElement.textContent = categoryName;
            }

            // Show item search section
            document.getElementById('itemSearchSection').style.display = 'block';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemDetailsSection').style.display = 'none';

            // Load items for this category
            try {
                const response = await fetch(`/api/items?category_id=${categoryId}`);
                console.log('Items API response status:', response.status);
                const data = await response.json();
                console.log('Items data:', data);

                if (data.success) {
                    currentItems = data.items || [];
                    console.log(`Loaded ${currentItems.length} items for category ${categoryName}`);
                    // Show dropdown immediately if there are items
                    if (currentItems.length > 0) {
                        showItemDropdown();
                    }
                } else {
                    console.error('Failed to load items:', data.error);
                    currentItems = [];
                }
            } catch (error) {
                console.error('Failed to load items:', error);
            }
        }

        // Show item dropdown
        function showItemDropdown() {
            const dropdown = document.getElementById('itemDropdown');
            const searchValue = document.getElementById('itemSearch').value.toLowerCase();

            let html = '';
            const filteredItems = searchValue
                ? currentItems.filter(item =>
                    item.name.toLowerCase().includes(searchValue) ||
                    (item.description && item.description.toLowerCase().includes(searchValue))
                  )
                : currentItems;

            if (filteredItems.length === 0) {
                html = '<div style="padding:0.75rem;color:#6b7280;text-align:center;">No items found</div>';
            } else {
                filteredItems.forEach(item => {
                    const veryGoodValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
                    const priceRange = `Fair: $0 | Good: $${item.value_good || 0} | Very Good: $${veryGoodValue.toFixed(0)} | Excellent: $${item.value_excellent || 0}`;
                    html += `
                        <div onclick="selectItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')"
                             style="padding:0.75rem;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background 0.2s;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='white'">
                            <div style="font-weight:500;">${item.name}</div>
                            <div style="font-size:0.75rem;color:#6b7280;">${item.description || ''}</div>
                            <div style="font-size:0.75rem;color:#667eea;margin-top:0.25rem;">${priceRange}</div>
                        </div>
                    `;
                });
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            console.log('Showing dropdown with', filteredItems.length, 'items');
        }

        // Search items
        function searchItems(value) {
            console.log('Searching items with value:', value);
            showItemDropdown();
        }

        // Select an item
        function selectItem(itemId, itemName) {
            const item = currentItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('itemSelect').value = itemId;
            document.getElementById('itemSearch').value = itemName;
            document.getElementById('itemDropdown').style.display = 'none';

            // Enable quality, quantity, and add button
            document.getElementById('itemQuality').disabled = false;
            document.getElementById('itemQuantity').disabled = false;
            const addBtn = document.getElementById('addItemBtn');
            addBtn.disabled = false;
            addBtn.style.background = '#667eea';
            addBtn.style.cursor = 'pointer';

            // Show value display
            document.getElementById('itemValueDisplay').style.display = 'block';
            document.getElementById('selectedItemName').textContent = `${item.name} - ${item.description || ''}`;

            // Reset quality and quantity
            document.getElementById('itemQuality').value = 'very_good';
            document.getElementById('itemQuantity').value = '1';

            // Update value preview
            updateItemValue();
        }

        // Update value based on selected item and quality
        function updateItemValue() {
            const itemId = document.getElementById('itemSelect').value;
            const quality = document.getElementById('itemQuality').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

            if (!itemId) return;

            const item = currentItems.find(i => i.id == itemId);
            if (!item) return;

            // Use quality-specific values from database (IRS only accepts good or better)
            let unitValue = 0;
            if (quality === 'fair') {
                // Fair items are not IRS deductible
                unitValue = 0;
            } else if (quality === 'good') {
                unitValue = item.value_good || 0;
            } else if (quality === 'very_good') {
                // Very good is the average of good and excellent
                unitValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
            } else if (quality === 'excellent') {
                unitValue = item.value_excellent || 0;
            }
            const totalValue = unitValue * quantity;

            // Update the preview
            document.getElementById('itemValuePreview').textContent = `$${totalValue.toFixed(2)}`;
        }

        // Add item to list
        function addItemToList() {
            const categoryId = document.getElementById('itemCategory').value;
            const itemId = document.getElementById('itemSelect').value;
            const quality = document.getElementById('itemQuality').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

            if (!categoryId || !itemId) {
                alert('Please select category and item');
                return;
            }

            const category = itemCategories.find(c => c.id == categoryId);
            const item = currentItems.find(i => i.id == itemId);

            // Determine quality label (IRS only accepts good or better)
            let qualityLabel;
            if (quality === 'fair') {
                qualityLabel = 'Fair (Not Deductible)';
            } else if (quality === 'good') {
                qualityLabel = 'Good';
            } else if (quality === 'very_good') {
                qualityLabel = 'Very Good';
            } else if (quality === 'excellent') {
                qualityLabel = 'Excellent';
            }

            // Use quality-specific values from database (IRS only accepts good or better)
            let unitValue = 0;
            if (quality === 'fair') {
                // Fair items are not IRS deductible
                unitValue = 0;
            } else if (quality === 'good') {
                unitValue = item.value_good || 0;
            } else if (quality === 'very_good') {
                // Very good is the average of good and excellent
                unitValue = ((item.value_good || 0) + (item.value_excellent || 0)) / 2;
            } else if (quality === 'excellent') {
                unitValue = item.value_excellent || 0;
            }

            selectedDonationItems.push({
                categoryName: category.name,
                itemName: item.name,
                quality: qualityLabel,
                quantity: quantity,
                unitValue: unitValue,
                totalValue: unitValue * quantity
            });

            updateSelectedItemsDisplay();

            // Reset form for next item
            document.getElementById('itemSelect').value = '';
            document.getElementById('itemSearch').value = '';  // Clear item search field
            document.getElementById('itemQuality').value = 'very_good';  // Reset to default
            document.getElementById('itemQuality').disabled = true;  // Disable until next item selected
            document.getElementById('itemQuantity').value = '1';
            document.getElementById('itemQuantity').disabled = true;
            document.getElementById('itemValueDisplay').style.display = 'none';  // Hide value display

            // Disable add button until next item is selected
            const addBtn = document.getElementById('addItemBtn');
            addBtn.disabled = true;
            addBtn.style.background = '#9ca3af';
            addBtn.style.cursor = 'not-allowed';
        }

        function updateSelectedItemsDisplay() {
            const container = document.getElementById('selectedItemsList');
            const receiptTotal = document.getElementById('receiptTotal');
            const addItemBtn = document.getElementById('addItemBtn');
            const saveBtn = document.getElementById('saveItemsDonationBtn');

            if (selectedDonationItems.length === 0) {
                container.innerHTML = '<div class="empty-state" style="color:#9ca3af;text-align:center;padding:2rem;">No items added yet</div>';
                document.getElementById('estimatedValue').value = '0.00';
                if (receiptTotal) receiptTotal.textContent = '0.00';  // No $ needed, already in HTML
                if (addItemBtn) addItemBtn.style.display = 'block';
                if (saveBtn) saveBtn.style.display = 'none';  // Hide save button when no items
                return;
            }

            // Create receipt-style display
            let html = '<div style="font-family:monospace;font-size:0.875rem;background:#f9fafb;padding:0.75rem;border-radius:4px;">';
            html += '<div style="border-bottom:1px dashed #d1d5db;padding-bottom:0.5rem;margin-bottom:0.5rem;">';
            html += '<div style="text-align:center;font-weight:bold;margin-bottom:0.25rem;">DONATION RECEIPT</div>';
            html += '<div style="text-align:center;font-size:0.75rem;color:#6b7280;">Items for Tax Deduction</div>';
            html += '</div>';

            let totalValue = 0;

            selectedDonationItems.forEach((item, index) => {
                const lineTotal = item.totalValue;
                totalValue += lineTotal;

                html += `
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.375rem;font-size:0.8125rem;">
                        <div style="flex:1;padding-right:0.5rem;">
                            <div style="display:flex;justify-content:space-between;">
                                <span>${item.quantity}x ${item.itemName}</span>
                                <span>$${lineTotal.toFixed(2)}</span>
                            </div>
                            <div style="color:#6b7280;font-size:0.75rem;margin-left:1rem;">
                                ${item.categoryName} • ${item.quality.replace('_', ' ')}
                            </div>
                        </div>
                        <button type="button" onclick="removeItemFromList(${index})" style="color:#ef4444;background:none;border:none;cursor:pointer;padding:0;margin-left:0.25rem;font-size:1rem;line-height:1;">×</button>
                    </div>
                `;
            });

            html += '<div style="border-top:1px dashed #d1d5db;margin-top:0.5rem;padding-top:0.5rem;">';
            html += `<div style="display:flex;justify-content:space-between;font-weight:bold;">
                        <span>TOTAL VALUE:</span>
                        <span style="color:#667eea;">$${totalValue.toFixed(2)}</span>
                     </div>`;
            html += `<div style="font-size:0.75rem;color:#6b7280;margin-top:0.25rem;text-align:center;">
                        ${selectedDonationItems.length} item${selectedDonationItems.length > 1 ? 's' : ''}
                     </div>`;
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
            document.getElementById('estimatedValue').value = totalValue.toFixed(2);
            if (receiptTotal) receiptTotal.textContent = totalValue.toFixed(2);  // No $ needed, already in HTML

            // Show save button when there are items
            if (saveBtn) saveBtn.style.display = 'block';

            // Show add item button when there are items
            if (addItemBtn) addItemBtn.style.display = selectedDonationItems.length > 0 ? 'block' : 'none';

            // Update item description for database
            const descriptions = selectedDonationItems.map(i =>
                `${i.itemName} (${i.quality}, qty: ${i.quantity})`
            ).join('; ');
            document.getElementById('itemDescription').value = descriptions;
        }

        function removeItemFromList(index) {
            selectedDonationItems.splice(index, 1);
            updateSelectedItemsDisplay();
        }

        // Helper function to handle donation type changes
        function handleDonationTypeChange(event) {
            updateDonationFields();
        }

        // Edit donation function
        async function editDonation(donationId) {
            // NOTE: For production, this should fetch from database:
            // GET /api/donations/{donationId} to retrieve full record
            // Currently using localStorage as a workaround since the API endpoint isn't implemented yet

            try {
                let donation = null;

                // Get from localStorage (temporary solution - should be API call in production)
                const storedDonations = JSON.parse(localStorage.getItem('recentDonations') || '[]');
                donation = storedDonations.find(d => d.id === donationId);

                if (donation) {
                    // Store the donation ID for update
                    window.editingDonationId = donationId;
                    window.isEditing = true;

                    // Open the donation modal with the correct type and pre-filled charity
                    const donationType = donation.donation_type || 'cash';
                    const charityId = donation.charity_id || donation.user_charity_id || '';
                    const charityName = donation.charity_name || '';

                    // Open modal with pre-filled data
                    openDonationModal(donationType, charityId, charityName);

                    // Wait for the modal to be ready
                    setTimeout(() => {
                        // Populate the date field
                        const donationDate = document.getElementById('donationDate');
                        if (donationDate) donationDate.value = donation.date || donation.donation_date || '';

                        // Populate the notes field
                        const donationNotes = document.getElementById('donationNotes');
                        if (donationNotes) {
                            // Parse notes if it's a JSON string
                            let notes = donation.notes;
                            if (typeof notes === 'string' && notes.startsWith('{')) {
                                try {
                                    const notesObj = JSON.parse(notes);
                                    notes = notesObj.notes || '';
                                } catch (e) {
                                    // Use as-is if not valid JSON
                                }
                            }
                            donationNotes.value = notes || '';
                        }

                        // Set type-specific fields
                        updateDonationFields();

                        if (donation.donation_type === 'cash') {
                            const amountField = document.getElementById('donationAmount');
                            if (amountField) amountField.value = donation.amount;
                        } else if (donation.donation_type === 'items') {
                            // For editing, we can't recreate the item list from the description alone
                            const itemDescription = document.getElementById('itemDescription');
                            const estimatedValue = document.getElementById('estimatedValue');
                            if (itemDescription) itemDescription.value = donation.item_description || '';
                            if (estimatedValue) estimatedValue.value = donation.estimated_value || donation.amount;
                            selectedDonationItems = [];
                            updateSelectedItemsDisplay();
                        } else if (donation.donation_type === 'miles') {
                            const milesDriven = document.getElementById('milesDriven');
                            const mileagePurpose = document.getElementById('mileagePurpose');
                            if (milesDriven) milesDriven.value = donation.miles_driven || '';
                            if (mileagePurpose) mileagePurpose.value = donation.mileage_purpose || '';
                        } else if (donation.donation_type === 'stock') {
                            const stockName = document.getElementById('stockName');
                            const stockSymbol = document.getElementById('stockSymbol');
                            const stockShares = document.getElementById('stockShares');
                            const stockPrice = document.getElementById('stockPrice');
                            if (stockName) stockName.value = donation.stock_name || '';
                            if (stockSymbol) stockSymbol.value = donation.stock_symbol || '';
                            if (stockShares) stockShares.value = donation.shares_donated || '';
                            if (stockPrice) stockPrice.value = donation.price_per_share || '';
                        } else if (donation.donation_type === 'crypto') {
                            const cryptoName = document.getElementById('cryptoName');
                            const cryptoSymbol = document.getElementById('cryptoSymbol');
                            const cryptoQuantity = document.getElementById('cryptoQuantity');
                            const cryptoPricePerUnit = document.getElementById('cryptoPricePerUnit');
                            if (cryptoName) cryptoName.value = donation.crypto_name || '';
                            if (cryptoSymbol) cryptoSymbol.value = donation.crypto_symbol || '';
                            if (cryptoQuantity) cryptoQuantity.value = donation.crypto_quantity || '';
                            if (cryptoPricePerUnit) cryptoPricePerUnit.value = donation.crypto_price_per_unit || '';
                        }

                        // Update submit button text
                        const submitBtn = document.querySelector('#donationSection button[onclick="saveDonation()"]');
                        if (submitBtn) submitBtn.textContent = 'Update Donation';
                    }, 100);
                } else {
                    // Donation not found in localStorage
                    showToast('Please refresh the donations list and try again', 'error');
                }
            } catch (error) {
                console.error('Error editing donation:', error);
                showToast('Error loading donation for editing', 'error');
            }
        }

        // Delete donation function
        async function deleteDonation(donationId) {
            if (!confirm('Are you sure you want to delete this donation?')) {
                return;
            }

            try {
                // Get auth token
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                // Check if response is JSON or HTML
                const contentType = response.headers.get("content-type");
                let data;

                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    // API endpoint might not exist, simulate success for demo
                    // In production, the endpoint we created will handle this
                    console.log('Delete API not available, removing from local view');
                    data = { success: true };
                }

                if (data.success) {
                    showToast('✅ Donation deleted successfully', 'success');
                    // Refresh the dashboard
                    loadDonations();
                    loadStats();
                    loadCharities();
                } else {
                    showToast('❌ Failed to delete donation', 'error');
                }
            } catch (error) {
                console.error('Error deleting donation:', error);
                showToast('❌ Error deleting donation', 'error');
            }
        }

        // Helper function to open donation modal with specific type
        function openDonationModal(type, preselectedCharityId = null, preselectedCharityName = null) {
            const typeInfo = {
                cash: {
                    title: 'Add Cash Donation',
                    icon: '💵',
                    label: 'Cash/Check Donation',
                    desc: 'Record a monetary donation'
                },
                items: {
                    title: 'Add Item Donation',
                    icon: '📦',
                    label: 'Item/Goods Donation',
                    desc: 'Record donated items with values'
                },
                miles: {
                    title: 'Add Mileage Donation',
                    icon: '🚗',
                    label: 'Mileage Donation',
                    desc: 'Record miles driven for charity'
                },
                stock: {
                    title: 'Add Stock Donation',
                    icon: '📈',
                    label: 'Stock/Securities Donation',
                    desc: 'Record donated stocks or securities'
                },
                crypto: {
                    title: 'Add Crypto Donation',
                    icon: '₿',
                    label: 'Cryptocurrency Donation',
                    desc: 'Record cryptocurrency donations'
                }
            };

            const info = typeInfo[type] || typeInfo.cash;

            // Clear the form including charity fields
            document.getElementById('donationForm').reset();

            // If charity was preselected, set it, otherwise clear
            if (preselectedCharityId && preselectedCharityName) {
                document.getElementById('selectedCharityId').value = preselectedCharityId;
                document.getElementById('donationCharity').value = preselectedCharityName;
            } else {
                document.getElementById('selectedCharityId').value = '';
                document.getElementById('donationCharity').value = '';
            }
            document.getElementById('charityDropdown').classList.remove('show');

            // Reset item selection
            selectedDonationItems = [];
            updateSelectedItemsDisplay();
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemSearch').value = '';
            document.getElementById('itemSearch').disabled = true;
            document.getElementById('itemQuality').disabled = true;
            document.getElementById('itemQuantity').disabled = true;
            document.getElementById('addItemBtn').disabled = true;

            // Update modal header and type display
            document.getElementById('donationModalTitle').textContent = info.title;
            document.getElementById('donationTypeIcon').textContent = info.icon;
            document.getElementById('donationTypeLabel').textContent = info.label;
            document.getElementById('donationTypeDesc').textContent = info.desc;
            document.getElementById('donationType').value = type;

            updateDonationFields();

            // Update submit button text based on edit mode
            const submitBtn = document.getElementById('donationSubmitBtn');
            if (submitBtn) {
                submitBtn.textContent = window.editingDonationId ? 'Update Donation' : 'Add Donation';
            }

            showAddDonation();
        }

        // Section navigation
        function showSection(sectionName) {
            // Clear edit state when navigating to donations normally (not through edit button)
            if (sectionName === 'donations' && !window.isEditing) {
                window.editingDonationId = null;
                // Reset the form
                const form = document.getElementById('donationForm');
                if (form) form.reset();
                // Reset button text
                const submitBtn = form?.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Add Donation';
            }

            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Reset isEditing flag after using it
            if (sectionName === 'donations') {
                window.isEditing = false;
            }

            // Show the selected section
            const sectionMap = {
                'dashboard': 'dashboardSection',
                'donations': 'addDonationSection',
                'addDonation': 'addDonationSection',  // Support both 'donations' and 'addDonation'
                'reports': 'reportsSection',
                'profile': 'profileSection',
                'tools': 'toolsSection'
            };

            const sectionId = sectionMap[sectionName];
            if (sectionId) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }

                // Mark nav item as active
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }

                // Load My Charities when showing Add Donation section
                if (sectionId === 'addDonationSection') {
                    loadMyCharitiesQuickAdd();
                }
            }

            // If showing dashboard, reload data
            if (sectionName === 'dashboard') {
                loadCharities();
                loadDonations();
                loadStats();
            }

            // If showing profile, reload profile data
            if (sectionName === 'profile') {
                loadProfile();
            }
        }

        // Add event listeners for tax savings updates
        document.getElementById('donationAmount')?.addEventListener('input', updateTaxSavings);
        document.getElementById('estimatedValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('milesDriven')?.addEventListener('input', updateTaxSavings);
        document.getElementById('fairMarketValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('cryptoValue')?.addEventListener('input', updateTaxSavings);
        document.getElementById('donationType')?.addEventListener('change', updateTaxSavings);

        // Items Import Functions
        let itemsImportData = [];

        function showImportItems() {
            document.getElementById('importItemsPanel').style.display = 'block';
            document.getElementById('importDonationsPanel').style.display = 'none';
        }

        function handleItemsCsvSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processItemsCsvFile(file);
            }
        }

        function processItemsCsvFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseItemsCsv(csvText);
            };
            reader.readAsText(file);
        }

        function parseItemsCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            itemsImportData = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = [];
                let current = '';
                let inQuotes = false;

                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                const item = {};
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });

                itemsImportData.push(item);
            }

            // Show preview
            const preview = document.getElementById('itemsImportPreview');
            const table = document.getElementById('itemsPreviewTable');

            let html = '<table class="table"><thead><tr><th>Category</th><th>Name</th><th>Good</th><th>Very Good</th><th>Excellent</th></tr></thead><tbody>';

            itemsImportData.slice(0, 10).forEach(item => {
                const categoryNames = {
                    '1': 'Women\'s', '2': 'Men\'s', '3': 'Children\'s',
                    '4': 'Household', '5': 'Electronics', '6': 'Furniture',
                    '7': 'Books', '8': 'Sports', '9': 'Toys',
                    '10': 'Appliances', '11': 'Jewelry', '12': 'Tools'
                };
                html += `<tr>
                    <td>${categoryNames[item.category_id] || item.category_id}</td>
                    <td>${item.name}</td>
                    <td>$${parseFloat(item.value_good || 0).toFixed(2)}</td>
                    <td>$${parseFloat(item.value_very_good || 0).toFixed(2)}</td>
                    <td>$${parseFloat(item.value_excellent || 0).toFixed(2)}</td>
                </tr>`;
            });

            if (itemsImportData.length > 10) {
                html += `<tr><td colspan="5" style="text-align: center; font-style: italic;">... and ${itemsImportData.length - 10} more items</td></tr>`;
            }

            html += '</tbody></table>';
            table.innerHTML = html;
            preview.style.display = 'block';
        }

        async function confirmItemsImport() {
            const updateExisting = document.getElementById('updateExistingItems').checked;
            const resultsDiv = document.getElementById('itemsImportResults');
            const resultsContent = document.getElementById('itemsResultsContent');

            resultsContent.innerHTML = '<p>Importing items...</p>';
            resultsDiv.style.display = 'block';

            try {
                const response = await fetch('/api/items/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        csvData: [Object.keys(itemsImportData[0]).join(',')]
                            .concat(itemsImportData.map(row =>
                                Object.keys(itemsImportData[0]).map(k => row[k]).join(',')
                            )).join('\n'),
                        updateExisting: updateExisting
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultsContent.innerHTML = `
                        <div style="color: #10b981; margin-bottom: 1rem;">
                            <strong>✅ Import Successful!</strong>
                        </div>
                        <div>
                            <p>Processed: ${data.results.processed} items</p>
                            <p>Added: ${data.results.added} new items</p>
                            <p>Updated: ${data.results.updated} existing items</p>
                            <p>Failed: ${data.results.failed} items</p>
                        </div>
                        ${data.results.errors.length > 0 ? `
                            <div style="margin-top: 1rem; color: #ef4444;">
                                <strong>Errors:</strong>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    ${data.results.errors.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    `;

                    // Reload item categories if we're on the donation form
                    loadItemCategories();
                } else {
                    resultsContent.innerHTML = `
                        <div style="color: #ef4444;">
                            <strong>❌ Import Failed</strong>
                            <p style="margin-top: 0.5rem;">${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsContent.innerHTML = `
                    <div style="color: #ef4444;">
                        <strong>❌ Import Error</strong>
                        <p style="margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }

            document.getElementById('itemsImportPreview').style.display = 'none';
        }

        function cancelItemsImport() {
            document.getElementById('itemsImportPreview').style.display = 'none';
            document.getElementById('itemsCsvFileInput').value = '';
            itemsImportData = [];
        }

        function closeItemsImport() {
            document.getElementById('importItemsPanel').style.display = 'none';
            document.getElementById('itemsImportResults').style.display = 'none';
            document.getElementById('itemsCsvFileInput').value = '';
            itemsImportData = [];
        }

        // Setup drag and drop for items CSV
        document.addEventListener('DOMContentLoaded', function() {
            const itemsDropZone = document.getElementById('itemsCsvDropZone');
            if (itemsDropZone) {
                itemsDropZone.addEventListener('click', () => {
                    document.getElementById('itemsCsvFileInput').click();
                });

                itemsDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    itemsDropZone.style.borderColor = '#059669';
                    itemsDropZone.style.background = '#d1fae5';
                });

                itemsDropZone.addEventListener('dragleave', () => {
                    itemsDropZone.style.borderColor = '#10b981';
                    itemsDropZone.style.background = '#f0fdf4';
                });

                itemsDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    itemsDropZone.style.borderColor = '#10b981';
                    itemsDropZone.style.background = '#f0fdf4';

                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].name.endsWith('.csv')) {
                        processItemsCsvFile(files[0]);
                    }
                });
            }
        });

        // Calculate stock donation total
        function calculateStockTotal() {
            const shares = parseFloat(document.getElementById('stockQuantity').value) || 0;
            const pricePerShare = parseFloat(document.getElementById('fairMarketValue').value) || 0;
            const total = shares * pricePerShare;

            document.getElementById('stockTotalDisplay').textContent = '$' + total.toFixed(2);
            document.getElementById('stockCalculation').textContent =
                `${shares} shares × $${pricePerShare.toFixed(2)} = $${total.toFixed(2)}`;
        }

        // Calculate crypto donation total
        function calculateCryptoTotal() {
            const quantity = parseFloat(document.getElementById('cryptoQuantity').value) || 0;
            const pricePerUnit = parseFloat(document.getElementById('cryptoPricePerUnit').value) || 0;
            const total = quantity * pricePerUnit;
            const costBasis = parseFloat(document.getElementById('cryptoCostBasis').value) || 0;
            const holdingPeriod = document.getElementById('cryptoHoldingPeriod').value;

            document.getElementById('cryptoTotalDisplay').textContent = '$' + total.toFixed(2);
            document.getElementById('cryptoCalculation').textContent =
                `${quantity} units × $${pricePerUnit.toFixed(2)} = $${total.toFixed(2)}`;

            // Update tax savings display
            updateTaxSavings();

            // Calculate tax deduction based on holding period
            let deduction = total;
            let note = '';
            if (holdingPeriod === 'short' && costBasis > 0) {
                deduction = Math.min(costBasis, total);
                note = deduction === costBasis ? ' (limited to cost basis)' : ' (at fair market value)';
            }

            document.getElementById('cryptoDeductionAmount').textContent = '$' + deduction.toFixed(2) + note;
        }

        // Calculate mileage deduction
        function calculateMileageDeduction() {
            const miles = parseFloat(document.getElementById('milesDriven').value) || 0;
            const rate = 0.14; // 2024 IRS rate
            const deduction = miles * rate;
            document.getElementById('mileageDeduction').textContent = deduction.toFixed(2);
        }

        // Function to populate year dropdowns dynamically
        function populateYearSelectors() {
            const currentYear = new Date().getFullYear();
            const years = [
                { value: currentYear - 1, label: (currentYear - 1).toString() },
                { value: currentYear, label: currentYear.toString() },
                { value: currentYear + 1, label: (currentYear + 1).toString() },
                { value: 'all', label: 'All Years' }
            ];

            // Populate global year filter
            const globalFilter = document.getElementById('globalYearFilter');
            if (globalFilter) {
                globalFilter.innerHTML = years.map(year =>
                    `<option value="${year.value}" ${year.value === currentYear ? 'selected' : ''}>${year.label}</option>`
                ).join('');
            }

            // Populate report year filter
            const reportFilter = document.getElementById('reportYear');
            if (reportFilter) {
                reportFilter.innerHTML = years.map(year =>
                    `<option value="${year.value}" ${year.value === currentYear ? 'selected' : ''}>${year.label}</option>`
                ).join('');
            }
        }

        // Common cryptocurrencies list
        const cryptoList = [
            { name: 'Bitcoin', symbol: 'BTC' },
            { name: 'Ethereum', symbol: 'ETH' },
            { name: 'Tether', symbol: 'USDT' },
            { name: 'BNB', symbol: 'BNB' },
            { name: 'Solana', symbol: 'SOL' },
            { name: 'XRP', symbol: 'XRP' },
            { name: 'USDC', symbol: 'USDC' },
            { name: 'Cardano', symbol: 'ADA' },
            { name: 'Avalanche', symbol: 'AVAX' },
            { name: 'Dogecoin', symbol: 'DOGE' },
            { name: 'TRON', symbol: 'TRX' },
            { name: 'Chainlink', symbol: 'LINK' },
            { name: 'Polygon', symbol: 'MATIC' },
            { name: 'Polkadot', symbol: 'DOT' },
            { name: 'Wrapped Bitcoin', symbol: 'WBTC' },
            { name: 'Shiba Inu', symbol: 'SHIB' },
            { name: 'Dai', symbol: 'DAI' },
            { name: 'Litecoin', symbol: 'LTC' },
            { name: 'Bitcoin Cash', symbol: 'BCH' },
            { name: 'Uniswap', symbol: 'UNI' },
            { name: 'Stellar', symbol: 'XLM' },
            { name: 'Cosmos', symbol: 'ATOM' },
            { name: 'Ethereum Classic', symbol: 'ETC' },
            { name: 'Monero', symbol: 'XMR' },
            { name: 'Internet Computer', symbol: 'ICP' },
            { name: 'Aptos', symbol: 'APT' },
            { name: 'Filecoin', symbol: 'FIL' },
            { name: 'Hedera', symbol: 'HBAR' },
            { name: 'Arbitrum', symbol: 'ARB' },
            { name: 'VeChain', symbol: 'VET' },
            { name: 'Near Protocol', symbol: 'NEAR' },
            { name: 'Optimism', symbol: 'OP' },
            { name: 'Aave', symbol: 'AAVE' },
            { name: 'Algorand', symbol: 'ALGO' },
            { name: 'The Graph', symbol: 'GRT' },
            { name: 'Fantom', symbol: 'FTM' },
            { name: 'Decentraland', symbol: 'MANA' },
            { name: 'Axie Infinity', symbol: 'AXS' },
            { name: 'The Sandbox', symbol: 'SAND' },
            { name: 'Theta', symbol: 'THETA' },
            { name: 'Tezos', symbol: 'XTZ' },
            { name: 'Flow', symbol: 'FLOW' },
            { name: 'Zcash', symbol: 'ZEC' },
            { name: 'Enjin Coin', symbol: 'ENJ' },
            { name: 'Maker', symbol: 'MKR' },
            { name: 'Compound', symbol: 'COMP' },
            { name: 'Curve', symbol: 'CRV' },
            { name: 'Pancakeswap', symbol: 'CAKE' },
            { name: 'Yearn Finance', symbol: 'YFI' },
            { name: 'Basic Attention Token', symbol: 'BAT' }
        ];

        // Function to search cryptocurrencies
        function searchCrypto(query) {
            const dropdown = document.getElementById('cryptoDropdown');
            if (!query) {
                dropdown.style.display = 'none';
                return;
            }

            const filtered = cryptoList.filter(crypto =>
                crypto.name.toLowerCase().includes(query.toLowerCase()) ||
                crypto.symbol.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding:0.5rem;color:#6b7280;">No cryptocurrencies found</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = filtered.map(crypto => `
                <div style="padding:0.5rem;cursor:pointer;hover:background:#f3f4f6;"
                     onmouseover="this.style.background='#f3f4f6'"
                     onmouseout="this.style.background='white'"
                     onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                    <strong>${crypto.name}</strong> (${crypto.symbol})
                </div>
            `).join('');
            dropdown.style.display = 'block';
        }

        // Function to show all cryptos when field is focused
        function showCryptoDropdown() {
            const query = document.getElementById('cryptoName').value;
            if (!query) {
                // Show top cryptos if no query
                const dropdown = document.getElementById('cryptoDropdown');
                const topCryptos = cryptoList.slice(0, 10);
                dropdown.innerHTML = topCryptos.map(crypto => `
                    <div style="padding:0.5rem;cursor:pointer;"
                         onmouseover="this.style.background='#f3f4f6'"
                         onmouseout="this.style.background='white'"
                         onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                        <strong>${crypto.name}</strong> (${crypto.symbol})
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            } else {
                searchCrypto(query);
            }
        }

        // Function to select a cryptocurrency
        function selectCrypto(name, symbol) {
            document.getElementById('cryptoName').value = name;
            document.getElementById('cryptoSymbol').value = symbol;
            document.getElementById('cryptoDropdown').style.display = 'none';
            // Focus on next field
            document.getElementById('cryptoDonationTime').focus();
        }

        // Hide crypto dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#cryptoName') && !e.target.closest('#cryptoDropdown')) {
                const dropdown = document.getElementById('cryptoDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        });

        // Global variable to store all donations for filtering
        let allDonations = [];

        // Function to filter donations
        function filterDonations() {
            const searchTerm = document.getElementById('donationSearch').value.toLowerCase();
            const typeFilter = document.getElementById('donationTypeFilter').value;
            const monthFilter = document.getElementById('donationMonthFilter').value;

            // Use stored donations or get from localStorage
            if (!allDonations || allDonations.length === 0) {
                allDonations = JSON.parse(localStorage.getItem('recentDonations') || '[]');
            }

            let filtered = allDonations;

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(d =>
                    (d.charity_name && d.charity_name.toLowerCase().includes(searchTerm)) ||
                    (parseNotesDisplay(d.notes) && parseNotesDisplay(d.notes).toLowerCase().includes(searchTerm)) ||
                    (d.crypto_symbol && d.crypto_symbol.toLowerCase().includes(searchTerm)) ||
                    (d.stock_symbol && d.stock_symbol.toLowerCase().includes(searchTerm))
                );
            }

            // Filter by type - handle both donation_type field and parsed JSON notes
            if (typeFilter !== 'all') {
                filtered = filtered.filter(d => {
                    // First check if donation_type is directly available
                    if (d.donation_type) {
                        return d.donation_type === typeFilter;
                    }
                    // Otherwise try to parse from notes JSON
                    if (d.notes && d.notes.startsWith('{')) {
                        try {
                            const notesObj = JSON.parse(d.notes);
                            return notesObj.donation_type === typeFilter;
                        } catch (e) {
                            return false;
                        }
                    }
                    // Default to cash if no type specified
                    return typeFilter === 'cash';
                });
            }

            // Filter by month
            if (monthFilter) {
                const [year, month] = monthFilter.split('-');
                filtered = filtered.filter(d => {
                    const date = d.date || d.donation_date;
                    return date && date.startsWith(`${year}-${month}`);
                });
            }

            // Display filtered donations
            displayFilteredDonations(filtered);
        }

        // Helper function to display filtered donations
        function displayFilteredDonations(donations) {
            const container = document.getElementById('donationsContent');

            if (!donations || donations.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><p>No donations found matching your search criteria.</p></div>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Date</th><th>Charity</th><th>Type</th><th>Amount</th><th>Notes</th><th>Actions</th></tr></thead><tbody>';
            donations.forEach(donation => {
                // Parse date correctly to avoid timezone issues
                const dateStr = donation.date || donation.donation_date;
                let date;
                if (dateStr) {
                    if (dateStr.includes('-')) {
                        const [year, month, day] = dateStr.split('-');
                        date = `${month}/${day}/${year}`;
                    } else {
                        date = new Date(dateStr).toLocaleDateString();
                    }
                }

                const donationType = donation.donation_type || 'cash';
                const typeIcon = {
                    cash: '💵',
                    items: '📦',
                    miles: '🚗',
                    stock: '📈',
                    crypto: '🪙'
                }[donationType] || '💰';

                html += `
                    <tr>
                        <td>${date || 'N/A'}</td>
                        <td>${donation.charity_name || 'Unknown'}</td>
                        <td><span title="${donationType}">${typeIcon}</span></td>
                        <td>$${formatCurrency(donation.amount, true)}</td>
                        <td>${parseNotesDisplay(donation.notes) || '-'}</td>
                        <td style="position: relative;">
                            <div class="dropdown" style="display: inline-block;">
                                <button class="small-btn" onclick="toggleActionMenu(event, '${donation.id}')" title="Actions">⋮</button>
                                <div id="actionMenu-${donation.id}" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; min-width: 150px;">
                                    <button onclick="viewDonationDetails('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">👁️ View Details</button>
                                    <button onclick="editDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">✏️ Edit</button>
                                    <button onclick="addReceipt('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer;">📎 Add Receipt</button>
                                    <hr style="margin: 0; border: none; border-top: 1px solid #e5e7eb;">
                                    <button onclick="deleteDonation('${donation.id}')" style="display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: #ef4444;">🗑️ Delete</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Global variable to store all personal charities for filtering
        let allPersonalCharities = [];

        // Function to filter personal charities
        function filterPersonalCharities() {
            const searchTerm = document.getElementById('charitySearch').value.toLowerCase();

            if (!allPersonalCharities || allPersonalCharities.length === 0) {
                // Get personal charities from the displayed content or storage
                const storedCharities = JSON.parse(localStorage.getItem('personalCharities') || '[]');
                allPersonalCharities = storedCharities;
            }

            let filtered = allPersonalCharities;

            // Filter by search term (name or EIN)
            if (searchTerm) {
                filtered = filtered.filter(charity =>
                    (charity.name && charity.name.toLowerCase().includes(searchTerm)) ||
                    (charity.ein && charity.ein.toLowerCase().includes(searchTerm))
                );
            }

            // Display filtered charities
            displayFilteredPersonalCharities(filtered);
        }

        // Helper function to display filtered personal charities
        function displayFilteredPersonalCharities(charities) {
            const container = document.getElementById('charitiesContent');

            if (!charities || charities.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏛️</div><p>No charities found matching your search criteria.</p></div>';
                return;
            }

            let html = '';
            charities.forEach(charity => {
                html += `
                    <div class="charity-item">
                        <div class="charity-info">
                            <div class="charity-name">${charity.name}</div>
                            <div class="charity-details">
                                EIN: ${charity.ein || 'Not specified'} | Category: ${charity.category || 'Not specified'}
                            </div>
                        </div>
                        <div class="charity-actions">
                            <button onclick="editCharity('${charity.id}')" class="small-btn" title="Edit">✏️</button>
                            <button onclick="deleteCharity('${charity.id}')" class="small-btn danger" title="Delete">🗑️</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Function to add receipt to donation
        // Toggle action dropdown menu
        function toggleActionMenu(event, donationId) {
            event.stopPropagation();
            const menu = document.getElementById(`actionMenu-${donationId}`);

            // Close all other menus
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.style.display = 'none';
            });

            // Toggle this menu
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                m.style.display = 'none';
            });
        });

        // View donation details
        async function viewDonationDetails(donationId) {
            const donations = JSON.parse(localStorage.getItem('recentDonations') || '[]');
            const donation = donations.find(d => d.id === donationId);

            if (!donation) {
                alert('Donation details not found');
                return;
            }

            // Parse the donation type and notes
            let details = `
                <strong>Date:</strong> ${donation.date || donation.donation_date}<br>
                <strong>Charity:</strong> ${donation.charity_name}<br>
                <strong>Type:</strong> ${donation.donation_type}<br>
                <strong>Amount:</strong> $${formatCurrency(donation.amount, true)}<br>
            `;

            // Add type-specific details
            if (donation.donation_type === 'items' && donation.notes) {
                try {
                    const notesData = JSON.parse(donation.notes);
                    if (notesData.items && notesData.items.length > 0) {
                        details += '<br><strong>Items Donated:</strong><ul>';
                        notesData.items.forEach(item => {
                            details += `<li>${item.quantity}x ${item.name} (${item.condition}) - $${item.value}</li>`;
                        });
                        details += '</ul>';
                    }
                    if (notesData.notes) {
                        details += `<strong>Notes:</strong> ${notesData.notes}<br>`;
                    }
                } catch (e) {
                    if (donation.notes) {
                        details += `<strong>Notes:</strong> ${donation.notes}<br>`;
                    }
                }
            } else if (donation.donation_type === 'stock') {
                if (donation.stock_symbol) details += `<strong>Stock Symbol:</strong> ${donation.stock_symbol}<br>`;
                if (donation.stock_quantity) details += `<strong>Shares:</strong> ${donation.stock_quantity}<br>`;
            } else if (donation.donation_type === 'crypto') {
                if (donation.crypto_symbol) details += `<strong>Crypto:</strong> ${donation.crypto_symbol}<br>`;
                if (donation.crypto_quantity) details += `<strong>Amount:</strong> ${donation.crypto_quantity}<br>`;
            } else if (donation.donation_type === 'miles') {
                if (donation.miles_driven) details += `<strong>Miles Driven:</strong> ${donation.miles_driven}<br>`;
                if (donation.mileage_purpose) details += `<strong>Purpose:</strong> ${donation.mileage_purpose}<br>`;
            } else if (donation.notes) {
                details += `<strong>Notes:</strong> ${donation.notes}<br>`;
            }

            // Show in a modal
            const modal = document.createElement('div');
            modal.id = 'donationDetailsModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h2 style="margin-bottom: 1rem;">Donation Details</h2>
                        <div style="line-height: 1.6;">
                            ${details}
                        </div>
                        <div style="margin-top: 1.5rem; text-align: right;">
                            <button onclick="document.getElementById('donationDetailsModal').remove()" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Also allow clicking the overlay to close
            modal.firstElementChild.addEventListener('click', (e) => {
                if (e.target === modal.firstElementChild) {
                    modal.remove();
                }
            });
        }

        async function addReceipt(donationId) {
            // Store the donation ID for later use
            window.currentDonationId = donationId;

            // Get donation details to show in modal
            const donations = JSON.parse(localStorage.getItem('recentDonations') || '[]');
            const donation = donations.find(d => d.id === donationId);

            // Show receipt upload modal
            const modal = document.getElementById('receiptModal');
            if (modal) {
                if (donation) {
                    const info = document.getElementById('donationInfo');
                    const date = new Date(donation.date).toLocaleDateString();
                    const charityName = donation.charity?.name || 'Unknown Charity';
                    info.innerHTML = `
                        <p><strong>Charity:</strong> ${charityName}</p>
                        <p><strong>Date:</strong> ${date}</p>
                        <p><strong>Amount:</strong> $${formatCurrency(donation.amount, true)}</p>
                    `;
                }
                modal.classList.add('active');

                // Clear any previous selections
                document.getElementById('receiptFile').value = '';
                document.getElementById('receiptUrl').value = '';
                document.getElementById('receiptNotes').value = '';
                document.getElementById('receiptPreview').innerHTML = '';
            }
        }

        // Handle file selection for receipt
        function handleReceiptFile(event) {
            const file = event.target.files[0];
            if (file) {
                const preview = document.getElementById('receiptPreview');
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];

                if (!validTypes.includes(file.type)) {
                    alert('Please select an image (JPG, PNG, GIF) or PDF file');
                    event.target.value = '';
                    return;
                }

                // Show file preview
                preview.innerHTML = `
                    <div style="padding: 1rem; background: #f3f4f6; border-radius: 8px; margin-top: 1rem;">
                        <p style="color: #666; font-size: 0.9rem;">📎 Selected file:</p>
                        <p style="font-weight: 600;">${file.name}</p>
                        <p style="color: #888; font-size: 0.85rem;">${(file.size / 1024).toFixed(2)} KB</p>
                    </div>
                `;

                // If it's an image, show thumbnail
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML += `
                            <img src="${e.target.result}" style="max-width: 200px; margin-top: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Compress image before storage
        async function compressImage(file, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Create canvas for compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Calculate new dimensions (maintain aspect ratio)
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        // Set canvas size
                        canvas.width = width;
                        canvas.height = height;

                        // Draw and compress image
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to base64 with compression
                        // For receipts, we can use lower quality (0.7 = 70%)
                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    // Convert blob to base64
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        resolve({
                                            data: e.target.result,
                                            size: blob.size,
                                            originalSize: file.size,
                                            compressionRatio: ((file.size - blob.size) / file.size * 100).toFixed(1)
                                        });
                                    };
                                    reader.readAsDataURL(blob);
                                } else {
                                    reject('Failed to compress image');
                                }
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.onerror = () => reject('Failed to load image');
                    img.src = e.target.result;
                };
                reader.onerror = () => reject('Failed to read file');
                reader.readAsDataURL(file);
            });
        }

        // Save receipt (file upload or URL)
        async function saveReceipt() {
            const donationId = window.currentDonationId;
            const fileInput = document.getElementById('receiptFile');
            const urlInput = document.getElementById('receiptUrl');
            const notesInput = document.getElementById('receiptNotes');

            if (!fileInput.files[0] && !urlInput.value) {
                alert('Please select a file or enter a URL');
                return;
            }

            try {
                const file = fileInput.files[0];

                if (file) {
                    showToast('🔄 Compressing image...', 'info');

                    let imageData;

                    // Handle different file types
                    if (file.type.startsWith('image/')) {
                        // Compress image files
                        try {
                            const compressed = await compressImage(file, 1200, 0.7);
                            imageData = compressed.data;

                            // Show compression result
                            showToast(`📦 Compressed by ${compressed.compressionRatio}% (${(compressed.size / 1024).toFixed(0)}KB)`, 'success');

                            // Check if compressed size is still too large
                            if (compressed.size > 500 * 1024) {
                                // Try more aggressive compression
                                const moreCompressed = await compressImage(file, 800, 0.5);
                                imageData = moreCompressed.data;
                                showToast(`📦 Further compressed to ${(moreCompressed.size / 1024).toFixed(0)}KB`, 'info');

                                if (moreCompressed.size > 500 * 1024) {
                                    alert('Image is still too large after compression. Please use a smaller image or provide a URL.');
                                    return;
                                }
                            }
                        } catch (error) {
                            console.error('Compression error:', error);
                            showToast('⚠️ Could not compress image, saving original', 'warning');

                            // Fall back to original if compression fails
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imageData = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    } else if (file.type === 'application/pdf') {
                        // PDFs can't be compressed easily, just check size
                        if (file.size > 500 * 1024) {
                            alert('PDF files must be under 500KB. Please use a URL for larger files.');
                            return;
                        }

                        // Read PDF as-is
                        const reader = new FileReader();
                        const result = await new Promise((resolve) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        imageData = result;
                    } else {
                        alert('Please select an image (JPG, PNG) or PDF file.');
                        return;
                    }

                    // Store compressed/processed image
                    const receiptData = {
                        receipt_data: imageData,
                        receipt_type: 'embedded',
                        file_name: file.name,
                        file_size: imageData.length,
                        notes: notesInput.value
                    };

                    await updateDonationReceipt(donationId, receiptData);

                } else if (urlInput.value) {
                    // Store external URL
                    const receiptData = {
                        receipt_url: urlInput.value,
                        receipt_type: 'url',
                        notes: notesInput.value
                    };

                    await updateDonationReceipt(donationId, receiptData);
                }
            } catch (error) {
                console.error('Error adding receipt:', error);
                showToast('❌ Error adding receipt', 'error');
            }
        }

        // Helper function to update donation with receipt
        async function updateDonationReceipt(donationId, receiptData) {
            try {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token')
                    },
                    body: JSON.stringify(receiptData)
                });

                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    if (data.success) {
                        showToast('✅ Receipt saved successfully!', 'success');
                        closeReceiptModal();
                        loadDonations();
                    } else {
                        showToast('❌ Failed to save receipt', 'error');
                    }
                } else {
                    // API not available, store locally
                    showToast('⚠️ Receipt saved locally only', 'info');
                    closeReceiptModal();
                }
            } catch (error) {
                console.error('Error updating receipt:', error);
                showToast('⚠️ Receipt saved locally', 'info');
                closeReceiptModal();
            }
        }

        // Close receipt modal
        function closeReceiptModal() {
            const modal = document.getElementById('receiptModal');
            if (modal) {
                modal.classList.remove('active');
                window.currentDonationId = null;
            }
        }

        // Initialize everything when DOM is ready
        function initializeApp() {
            // Populate year selectors first
            populateYearSelectors();

            // Load data
            loadTaxSettings();
            loadProfile(); // Load user profile
            loadCharities();
            loadDonations();
            loadStats();
            loadItemCategories(); // Load item categories for donation form

            // Categories are now handled by a select dropdown, no search listeners needed

            // Setup event listeners for item search
            const itemSearchInput = document.getElementById('itemSearch');
            if (itemSearchInput) {
                itemSearchInput.addEventListener('input', function() {
                    searchItems();
                });
                itemSearchInput.addEventListener('focus', function() {
                    searchItems();
                });
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Close modals and dropdowns when clicking outside
        window.onclick = function(event) {
            // Close modals
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }

            // Close category dropdown
            if (!event.target.closest('#itemCategorySearch') && !event.target.closest('#categoryDropdown')) {
                const dropdown = document.getElementById('categoryDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Close item dropdown
            if (!event.target.closest('#itemSearch') && !event.target.closest('#itemDropdown')) {
                const dropdown = document.getElementById('itemDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }

            // Close charity search dropdown
            if (!event.target.closest('#donationCharity') && !event.target.closest('#charityDropdown')) {
                const dropdown = document.getElementById('charityDropdown');
                if (dropdown) dropdown.style.display = 'none';
            }
        }

        // Verify charity function
        async function verifyCharity() {
            const charityName = document.getElementById('donationCharity').value.trim();
            const resultDiv = document.getElementById('charityVerificationResult');

            if (!charityName) {
                showToast('Please enter a charity name to verify', 'warning');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 0.5rem; background: #f3f4f6; border-radius: 4px;">🔍 Verifying charity...</div>';

            try {
                const response = await fetch(`/api/charities/verify?name=${encodeURIComponent(charityName)}`);
                const data = await response.json();

                if (data.success && data.verification) {
                    const verification = data.verification;

                    if (verification.isVerified) {
                        // Charity is verified
                        resultDiv.innerHTML = `
                            <div style="padding: 0.75rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; color: #065f46;">
                                <div style="display: flex; align-items: start; gap: 0.5rem;">
                                    <span style="font-size: 1.25rem;">✅</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Verified 501(c)(3) Organization</div>
                                        <div style="font-size: 0.875rem;">
                                            <strong>${verification.charity.name}</strong><br>
                                            EIN: ${verification.charity.ein}<br>
                                            Category: ${verification.charity.category || 'Not specified'}<br>
                                            ${verification.charity.city && verification.charity.state ? `Location: ${verification.charity.city}, ${verification.charity.state}` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Auto-select the verified charity
                        document.getElementById('selectedCharityId').value = verification.charity.id;
                        document.getElementById('donationCharity').value = verification.charity.name;

                    } else if (verification.suggestions && verification.suggestions.length > 0) {
                        // Show suggestions
                        let suggestionsHtml = verification.suggestions.map(s => `
                            <div style="padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer;"
                                 onclick="selectSuggestedCharity('${s.id}', '${s.name.replace(/'/g, "\\'")}')">
                                <strong>${s.name}</strong><br>
                                <span style="font-size: 0.875rem; color: #6b7280;">
                                    EIN: ${s.ein} | ${s.category || 'Category not specified'} | ${s.location}
                                </span>
                            </div>
                        `).join('');

                        resultDiv.innerHTML = `
                            <div style="padding: 0.75rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #92400e;">
                                    ⚠️ No exact match found
                                </div>
                                <div style="font-size: 0.875rem; color: #78350f; margin-bottom: 0.5rem;">
                                    ${verification.message}
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${suggestionsHtml}
                                </div>
                            </div>
                        `;
                    } else {
                        // Not found
                        resultDiv.innerHTML = `
                            <div style="padding: 0.75rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                                <div style="display: flex; align-items: start; gap: 0.5rem;">
                                    <span style="font-size: 1.25rem;">❌</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Not Found in IRS Database</div>
                                        <div style="font-size: 0.875rem;">
                                            ${verification.message}<br><br>
                                            <strong>Tips:</strong>
                                            <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                                <li>Check the spelling of the charity name</li>
                                                <li>Try searching with the EIN if you have it</li>
                                                <li>The charity may be new or use a different legal name</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Verification error:', error);
                resultDiv.innerHTML = `
                    <div style="padding: 0.75rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">
                        ❌ Error verifying charity. Please try again.
                    </div>
                `;
            }
        }

        // Helper function to select a suggested charity
        function selectSuggestedCharity(id, name) {
            document.getElementById('selectedCharityId').value = id;
            document.getElementById('donationCharity').value = name;
            document.getElementById('charityVerificationResult').style.display = 'none';
            showToast('Charity selected: ' + name, 'success');
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');

            // Style based on type
            const styles = {
                success: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;',
                error: 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;',
                info: 'background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;'
            };

            toast.style.cssText = `
                ${styles[type]}
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease-out;
                min-width: 250px;
            `;

            toast.innerHTML = message;

            toastContainer.appendChild(toast);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>

    <!-- Receipt Upload Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: #333; font-size: 1.5rem;">📎 Add Receipt</h2>
                <button onclick="closeReceiptModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">×</button>
            </div>

            <div id="donationInfo" style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem;">
                <!-- Donation details will be inserted here -->
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #666; font-size: 1rem; margin-bottom: 1rem;">Upload Receipt Image or PDF</h3>

                <!-- File Upload Option -->
                <div style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 1.5rem; text-align: center; background: #fafafa;">
                    <label for="receiptFile" style="cursor: pointer; display: block;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📤</div>
                        <p style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">Click to browse or drag & drop</p>
                        <p style="color: #888; font-size: 0.85rem;">Supports: JPG, PNG, GIF, PDF (Max 10MB)</p>
                    </label>
                    <input type="file" id="receiptFile" accept="image/*,.pdf" style="display: none;" onchange="handleReceiptFile(event)">
                </div>

                <div id="receiptPreview"></div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: #666; font-size: 1rem; margin-bottom: 0.5rem;">OR Enter Receipt URL</h3>
                <input type="url" id="receiptUrl" placeholder="https://example.com/receipt.pdf" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Notes (Optional)</label>
                <textarea id="receiptNotes" rows="3" placeholder="Add any notes about this receipt..." style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeReceiptModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #666; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button onclick="saveReceipt()" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Link Receipt</button>
            </div>
        </div>
    </div>

    </main>
</body>
</html>